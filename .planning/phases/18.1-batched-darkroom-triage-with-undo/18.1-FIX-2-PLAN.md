---
phase: 18.1-batched-darkroom-triage-with-undo
plan: 18.1-FIX-2
type: fix
---

<objective>
Fix UAT-002: Black flash persists when next card transitions to front position.

Source: 18.1-ISSUES.md
Priority: 1 blocker

Root cause: When a card is swiped, removing it from the photos array causes React to re-render all remaining cards. This array mutation changes each card's stackIndex, triggering re-renders that cause the brief black flash - even with the blur overlay timing fix from 18.1-FIX.

Solution (user-suggested): Don't remove cards from the photos array after swipe. Instead, track "hidden" cards separately. Cards that have been swiped stay in the array but are:
1. Marked as hidden and not rendered
2. Not counted when calculating which cards are "visible"
3. Only removed when batch save completes (or undo removes the hidden state)

This prevents array index changes from triggering re-renders on remaining visible cards.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-ISSUES.md

**Original implementation:**
@src/screens/DarkroomScreen.js
@src/components/SwipeablePhotoCard.js
</context>

<tasks>
<task type="auto">
  <name>Task 1: Refactor photo state management to use hidden tracking</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Replace the current approach of removing photos from the array with a hidden state tracking approach:

1. Add a new state: `const [hiddenPhotoIds, setHiddenPhotoIds] = useState(new Set());`

2. In handleTriage(), instead of calling `setPhotos(prev => prev.filter(...))`:
   - Add the photoId to hiddenPhotoIds: `setHiddenPhotoIds(prev => new Set([...prev, photoId]))`
   - Do NOT modify the photos array

3. Create a computed "visiblePhotos" array for rendering:
   - `const visiblePhotos = photos.filter(p => !hiddenPhotoIds.has(p.id));`
   - Use this for: currentPhoto, photos.length checks, rendering the card stack

4. Update handleUndo() to remove from hiddenPhotoIds instead of adding to photos:
   - Remove the photoId from hiddenPhotoIds: `setHiddenPhotoIds(prev => { const next = new Set(prev); next.delete(lastDecision.photo.id); return next; });`
   - Remove the line that adds the photo back to the photos array since it was never removed

5. Update all places that check photos.length or render photos to use visiblePhotos:
   - Success state condition: `visiblePhotos.length === 0 && undoStack.length > 0`
   - Empty state condition: `visiblePhotos.length === 0`
   - Header subtitle: `{visiblePhotos.length} photos ready`
   - Card rendering map: `visiblePhotos.slice(0, 3).reverse().map(...)`
   - currentPhoto: `const currentPhoto = visiblePhotos[0];`

6. When handleDone() successfully saves, the navigation.goBack() already handles cleanup (no changes needed).

WHY this approach works:
- The photos array never changes during triage, preventing React from re-rendering all cards
- Only the card being swiped has any state changes (it exits via animation, then becomes invisible via hiddenPhotoIds)
- Stack cards maintain stable array positions (no stackIndex changes from array mutations)
- The blur overlay timing fix from 18.1-FIX remains in place as an additional safeguard
  </action>
  <verify>
1. Load Darkroom with 3+ photos
2. Swipe the front card
3. Observe NO black flash when next card moves to front
4. Animation should feel smooth and natural
5. Verify undo still works (card reappears smoothly)
6. Verify Done button still saves all decisions correctly
  </verify>
  <done>
- Swiping cards produces smooth cascade animation with no black flash
- Hidden photos are tracked via Set, not removed from array
- Undo correctly reveals the hidden photo
- Done button batch saves all triaged photos
  </done>
</task>

<task type="auto">
  <name>Task 2: Reset hiddenPhotoIds when photos reload</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Ensure hiddenPhotoIds is cleared when photos are reloaded (e.g., when screen regains focus):

In loadDevelopingPhotos(), after `setPhotos(revealedPhotos)`:
- Add: `setHiddenPhotoIds(new Set());`

This ensures that if the user navigates away and back, the hidden state doesn't persist from a previous session with different photos.

Also clear hiddenPhotoIds when undoStack is cleared:
- In handleDone() after successful save and before navigation.goBack(), add cleanup (though navigation will unmount, being explicit is cleaner).
  </action>
  <verify>
1. Triage some photos (don't tap Done)
2. Navigate away from Darkroom
3. Return to Darkroom
4. Verify photos reload fresh with no hidden state from before
  </verify>
  <done>
- hiddenPhotoIds is reset when photos reload
- No stale hidden state persists across screen visits
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Refactored photo state management to prevent array mutations that cause black flash during card transitions</what-built>
  <how-to-verify>
1. Run `npx expo start` and open app on device
2. Take 3+ photos to have multiple in Darkroom
3. Wait for photos to reveal
4. Open Darkroom
5. Swipe the front card left or right
6. **Critical check:** Watch the next card as it transitions to front position - NO black flash should occur
7. Continue swiping remaining cards - each transition should be smooth
8. Tap Undo - card should reappear smoothly
9. Swipe that card again - still no black flash
10. Tap Done - decisions should save correctly
11. (Optional) Test with very rapid swipes to stress-test the animation
  </how-to-verify>
  <resume-signal>Type "approved" if black flash is resolved, or describe any remaining issues</resume-signal>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] All critical issues fixed (UAT-002 black flash resolved)
- [ ] Original acceptance criteria from issues met
- [ ] Card transitions are smooth with no visual artifacts
- [ ] Undo functionality still works correctly
- [ ] Done button batch save still works correctly
- [ ] No TypeScript errors (if applicable)
- [ ] No console errors during swipe animations
</verification>

<success_criteria>
- Black flash during card transition is eliminated
- Card cascade animation is smooth and satisfying
- All existing functionality (triage, undo, batch save) still works
- No regressions introduced
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-FIX-2-SUMMARY.md`
</output>
