---
phase: 18.1-batched-darkroom-triage-with-undo
plan: FIX-4
type: fix
---

<objective>
Fix 1 UAT issue from 18.1-FIX-3 verification testing.

Source: 18.1-ISSUES.md
Priority: 0 critical, 0 major, 1 cosmetic

**UAT-004:** Card cascade animation snaps instead of smooth transition - front card snaps into place abruptly, and new 3rd card appears abruptly instead of fading in.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-ISSUES.md

**Relevant code:**
@src/components/SwipeablePhotoCard.js
@src/screens/DarkroomScreen.js

**Root cause analysis:**

1. **Front card snap**: When cascade animation triggers, stack cards animate from their current position to the next position forward using `withSpring()`. The spring config `{ damping: 15, stiffness: 150 }` creates a quick bounce but the animation starts from the current animated value, which may already be at or near target due to timing issues. The real problem is the useEffect on stackIndex fires AFTER the cascade useEffect, causing a "jump".

2. **New 3rd card abrupt appearance**: Cards beyond the first 3 visible are not rendered, so when a new card enters the visible stack (position 2), it just appears with static opacity 0.7. There's no entry animation for cards entering the visible stack from position 3+.
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add smooth cascade animation for front card transition</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
Improve the cascade animation smoothness for cards transitioning to front position:

1. Change spring animation config to be slower/smoother:
   - Reduce stiffness from 150 to 100 for a more gradual transition
   - Increase damping from 15 to 18 for less bounce
   - This creates a settling feel rather than snap

2. Add a slight delay (100ms) to the cascade animation when transitioning to front position:
   - When cascading and targetIndex === 0, use `withDelay(100, withSpring(...))`
   - This gives the exiting card time to clear visual space before the next card settles
   - Import `withDelay` from react-native-reanimated

The key insight: the cascade effect triggers immediately when front card starts exiting, but the settling animation should feel like the card is sliding into place, not jumping.
  </action>
  <verify>
Visual test: Swipe a card and watch the next card smoothly settle into front position with a gradual, non-snappy motion.
  </verify>
  <done>
Card cascade animation feels smooth - next card glides to front position without snapping or jarring motion.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add fade-in animation for new cards entering visible stack</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
Add entry animation for cards entering the visible stack at position 2 (furthest back):

1. Track when a card is newly visible using a new prop `isNewlyVisible` or by detecting stackIndex === 2 with a new entry state.

2. When a card first appears at stackIndex 2:
   - Start with opacity 0 and animate to getStackOpacity(2) which is 0.7
   - Use withTiming for a 300ms fade-in

3. Implementation approach - in the cascade useEffect:
   - Add condition: if stackIndex === 2 and previous stackIndex was undefined/higher (card entering visible stack)
   - Animate opacity from 0 to 0.7 with withTiming(0.7, { duration: 300 })

4. Alternative simpler approach: Track `wasRendered` state
   - If this is the first render for this card instance at stackIndex 2, animate opacity from 0
   - Use a ref or shared value to track first render

The goal is that when a card goes from not-rendered to rendered at the back of the stack, it fades in smoothly instead of appearing abruptly.
  </action>
  <verify>
Visual test: Swipe a card when there are 4+ photos. Watch the new 3rd card fade in smoothly at the back of the stack.
  </verify>
  <done>
New cards entering visible stack fade in smoothly over 300ms instead of appearing abruptly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
1. Smoother cascade animation with adjusted spring config and slight delay for front card transition
2. Fade-in animation for new cards entering the visible stack at the back position
  </what-built>
  <how-to-verify>
1. Rebuild app and open Darkroom with 4+ photos
2. Swipe front card in any direction
3. Watch the cascade animation:
   - Next card should smoothly glide to front (no snap)
   - New 3rd card should fade in at the back (not abruptly appear)
4. Test button-triggered triage (Archive/Journal buttons)
5. Test Undo animation (card returns, stack animates back)
6. Verify no black flash or other visual glitches introduced
  </how-to-verify>
  <resume-signal>Type "approved" or describe any remaining issues</resume-signal>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Cascade animation feels smooth, no snapping
- [ ] New cards entering stack fade in smoothly
- [ ] No regression to black flash fix (expo-image still working)
- [ ] Undo animation still works correctly
- [ ] Button-triggered triage animations work correctly
</verification>

<success_criteria>
- UAT-004 resolved: Card cascade is smooth, no snapping
- New stack cards fade in instead of appearing abruptly
- All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-FIX-4-SUMMARY.md`
</output>
