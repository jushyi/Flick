---
phase: 18.1-batched-darkroom-triage-with-undo
plan: FIX-5
type: fix
---

<objective>
Fix UAT-005: Card cascade animation still snaps abruptly.

Source: 18.1-ISSUES.md
Priority: 0 critical, 0 major, 1 minor

**Root Cause Analysis:**
The cascade animation is being interrupted by a race condition:

1. When card is swiped, `cascading=true` triggers cascade useEffect → starts animation
2. React re-renders with new `stackIndex` values (array indices changed)
3. The `stackIndex` useEffect fires and OVERWRITES the cascade animation
4. The `cascadeHandledTransition` flag doesn't work reliably because:
   - The stackIndex useEffect may run BEFORE cascade useEffect (React batching)
   - Or the shared value update doesn't propagate in time

The animation gets canceled mid-flight and replaced with a new animation starting from current position → appears as a "snap".

**Solution:**
Remove the dual-animation approach entirely. Instead:
1. Only animate in the `stackIndex` useEffect (single source of truth)
2. Remove the `cascading` prop and related useEffect
3. Add a small delay before animating in stackIndex useEffect to let the exiting card clear

This eliminates the race condition by having ONE animation trigger point.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-ISSUES.md

**Key file:**
@src/components/SwipeablePhotoCard.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove cascading prop and consolidate to single animation trigger</name>
  <files>src/components/SwipeablePhotoCard.js, src/screens/DarkroomScreen.js</files>
  <action>
**In SwipeablePhotoCard.js:**

1. Remove `cascading` from the props destructuring (line ~73)

2. Delete the entire `cascading` useEffect block (lines ~128-151):
   ```js
   // DELETE THIS ENTIRE BLOCK:
   useEffect(() => {
     if (cascading && !isActive && stackIndex > 0) {
       // ... cascade animation code
     }
   }, [cascading]);
   ```

3. Remove the `cascadeHandledTransition` shared value and related logic in stackIndex useEffect

4. Update the `stackIndex` useEffect to be the SINGLE source of animation:
   ```js
   const prevStackIndex = useSharedValue(stackIndex);

   useEffect(() => {
     // Only animate if stackIndex actually changed
     if (prevStackIndex.value === stackIndex) return;

     const movingToFront = stackIndex === 0 && prevStackIndex.value > 0;

     // Use timing animation with delay for cards moving to front
     const config = {
       duration: 350,
       easing: Easing.out(Easing.cubic),
     };

     if (movingToFront) {
       // Card becoming front - add delay to let exiting card clear
       stackScaleAnim.value = withDelay(100, withTiming(getStackScale(stackIndex), config));
       stackOffsetAnim.value = withDelay(100, withTiming(getStackOffset(stackIndex), config));
       stackOpacityAnim.value = withDelay(100, withTiming(getStackOpacity(stackIndex), config));
     } else {
       // Other transitions - animate immediately
       stackScaleAnim.value = withTiming(getStackScale(stackIndex), config);
       stackOffsetAnim.value = withTiming(getStackOffset(stackIndex), config);
       stackOpacityAnim.value = withTiming(getStackOpacity(stackIndex), config);
     }

     prevStackIndex.value = stackIndex;
   }, [stackIndex]);
   ```

5. Clean up unused constants: Remove CASCADE_SPRING_CONFIG if no longer used

**In DarkroomScreen.js:**

1. Find where `cascading` prop is passed to SwipeablePhotoCard
2. Remove the `cascading={...}` prop from the component
3. Remove any state/logic related to setting `cascading` (e.g., `setCascading(true)`)
  </action>
  <verify>npx expo export --platform ios builds without errors</verify>
  <done>
- cascading prop removed from SwipeablePhotoCard
- cascading useEffect deleted
- cascadeHandledTransition shared value removed
- stackIndex useEffect is now the single animation source
- withTiming used instead of withSpring (350ms, ease-out)
- DarkroomScreen no longer passes cascading prop
- Build succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Consolidated cascade animation to single trigger point, eliminating race condition</what-built>
  <how-to-verify>
    1. Open the app on your device
    2. Go to darkroom with 3+ photos
    3. Swipe a card away (Archive or Journal)
    4. Watch the next card transition to front position
    5. Verify: The card should now GLIDE smoothly into position over ~350ms
    6. The motion should feel gradual and controlled, not snappy
    7. No animation interruption or "jump" mid-flight
    8. Test multiple swipes to confirm consistent smooth behavior
    9. Test undo to verify it still works correctly
    10. Test button-triggered triage (Archive/Journal/Delete buttons)
  </how-to-verify>
  <resume-signal>Type "approved" if cascade is now smooth, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx expo export --platform ios` succeeds without errors
- [ ] cascading prop removed from SwipeablePhotoCard
- [ ] Single animation source (stackIndex useEffect only)
- [ ] User verified smooth gliding motion on device
- [ ] No regression to existing functionality (undo, fade-in, swipe gestures, button triage)
</verification>

<success_criteria>
- UAT-005 resolved: Card cascade animation glides smoothly instead of snapping
- Race condition eliminated by single animation trigger
- All existing card animations still work correctly
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-FIX-5-SUMMARY.md`
</output>
