---
phase: 18.1-batched-darkroom-triage-with-undo
plan: FIX-5
subsystem: ui
tags: [react-native-reanimated, animation, cascade, timing]

# Dependency graph
requires:
  - phase: 18.1-FIX-4
    provides: Spring-based cascade animation with delay
provides:
  - Single source of truth for stack card animation (stackIndex useEffect)
  - Race-condition-free cascade transitions
  - Timing-based animation (350ms) instead of spring
affects: [darkroom-triage, card-animations]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Single animation trigger pattern (eliminates race conditions)"
    - "Timing animation over spring for predictable cascade motion"

key-files:
  created: []
  modified:
    - src/components/SwipeablePhotoCard.js
    - src/screens/DarkroomScreen.js

key-decisions:
  - "Removed cascading prop and consolidated to single stackIndex useEffect trigger"
  - "Switched from spring to timing animation (350ms, ease-out) for predictable motion"
  - "Removed onSwipeStart callback - animation driven by natural stackIndex changes"

patterns-established:
  - "Single source of truth for related animations eliminates race conditions"

issues-created: []

# Metrics
duration: 8min
completed: 2026-01-23
---

# Phase 18.1 FIX-5: UAT-005 Card Cascade Animation Consolidation Summary

**Consolidated cascade animation to single trigger point, eliminating race condition that caused mid-flight animation snaps**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-23T15:30:00Z
- **Completed:** 2026-01-23T15:38:00Z
- **Tasks:** 2 (1 auto + 1 checkpoint)
- **Files modified:** 2

## Accomplishments

- Eliminated race condition between cascading useEffect and stackIndex useEffect
- Single source of truth for stack animations (stackIndex useEffect only)
- Smooth 350ms timing animation replaces unpredictable spring animation
- Cascade animation now glides smoothly without mid-flight interruptions

## Task Commits

1. **Task 1: Consolidate cascade animation** - `33d79e1` (fix)

**Plan metadata:** (this commit)

## Files Created/Modified

- `src/components/SwipeablePhotoCard.js` - Removed cascading prop, cascading useEffect, cascadeHandledTransition flag, and onSwipeStart callback; consolidated to single stackIndex useEffect with timing animation
- `src/screens/DarkroomScreen.js` - Removed cascading state, setCascading calls, handleSwipeStart, and cascading prop from SwipeablePhotoCard

## Decisions Made

- **Timing over spring animation:** Changed from withSpring to withTiming (350ms, ease-out cubic) for predictable, interruptible motion
- **Single trigger pattern:** stackIndex useEffect is now the only animation source, triggered naturally when visible photo array changes

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## Root Cause Analysis

The race condition was caused by two competing animation triggers:
1. **cascading useEffect** - fired immediately when setCascading(true) was called
2. **stackIndex useEffect** - fired when React re-rendered with new stack indices

Both useEffects tried to animate the same shared values (stackScaleAnim, stackOffsetAnim, stackOpacityAnim). Due to React batching, the order was unpredictable - sometimes cascading ran first and then stackIndex overwrote it mid-animation, causing the "snap" effect.

The solution was to remove the dual-trigger approach entirely and let stackIndex changes be the single source of truth. When a card is hidden, React re-renders with new stackIndex values, and the consolidated useEffect handles the animation without competition.

## Next Phase Readiness

- UAT-005 resolved: Card cascade animation now glides smoothly
- All existing functionality preserved (undo, fade-in, button triage)
- Ready for Phase 18.2 (Success Sound Effect)

---
*Phase: 18.1-batched-darkroom-triage-with-undo*
*Completed: 2026-01-23*
