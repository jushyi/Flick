# Summary: 18.1-FIX-4 - UAT-004 Card Cascade Animation Fix

**Phase:** 18.1-batched-darkroom-triage-with-undo
**Plan:** FIX-4
**Type:** Fix
**Date:** 2026-01-23
**Duration:** ~15 minutes

## What Was Built

Fixed UAT-004: Card cascade animation snaps instead of smooth transition

### Task 1: Smooth Cascade Animation for Front Card Transition
- Added `withDelay` import from react-native-reanimated
- Created smoother spring config: `CASCADE_SPRING_CONFIG = { damping: 18, stiffness: 100 }` (was damping: 15, stiffness: 150)
- Added `CASCADE_DELAY_MS = 100` constant for front card transition delay
- Updated both stackIndex useEffect and cascade useEffect to use new config
- Added 100ms delay specifically when card transitions to front position (`targetIndex === 0`)

**Commit:** `f799e77` - fix(18.1-FIX-4): smooth cascade animation for front card transition

### Task 2: Fade-in Animation for New Cards Entering Visible Stack
- Added `STACK_ENTRY_FADE_DURATION = 300` constant
- Added `isNewlyVisible` prop to SwipeablePhotoCard component
- Added `hasAnimatedEntry` shared value to track entry animation state
- Added useEffect to handle 300ms fade-in when card enters at stackIndex 2
- In DarkroomScreen: Added `prevVisiblePhotoIdsRef` to track previously rendered cards
- Computed `newlyVisibleIds` set to pass `isNewlyVisible` prop to newly visible cards

**Commit:** `09b2a04` - fix(18.1-FIX-4): add fade-in animation for new cards entering stack

## Files Changed

| File | Changes |
|------|---------|
| `src/components/SwipeablePhotoCard.js` | Added withDelay import, CASCADE_SPRING_CONFIG, CASCADE_DELAY_MS, STACK_ENTRY_FADE_DURATION constants; added isNewlyVisible prop and hasAnimatedEntry shared value; updated cascade animation with delay for front card; added fade-in useEffect for new cards |
| `src/screens/DarkroomScreen.js` | Added prevVisiblePhotoIdsRef for tracking previously visible cards; computed newlyVisibleIds set; pass isNewlyVisible prop to SwipeablePhotoCard |

## Technical Details

### Spring Animation Config Change
- **Before:** `{ damping: 15, stiffness: 150 }` - Quick bounce, snappy feel
- **After:** `{ damping: 18, stiffness: 100 }` - Smoother settling, gradual feel

### Front Card Delay
- 100ms delay allows exiting card to clear visual space before next card settles
- Uses `withDelay(CASCADE_DELAY_MS, withSpring(...))` pattern
- Only applies when `targetIndex === 0` (card becoming front)

### New Card Entry Animation
- Cards entering visible stack at position 2 (back of stack) fade in over 300ms
- Uses `withTiming` with `Easing.out(Easing.cubic)` for smooth fade
- `hasAnimatedEntry` shared value prevents re-animating on subsequent renders
- `prevVisiblePhotoIdsRef` tracks which cards were previously rendered to detect new entries

## Testing Performed

- User verified on physical device:
  - [x] Cascade animation feels smooth - next card glides to front position without snapping
  - [x] New 3rd card fades in smoothly at back of stack (not abrupt appearance)
  - [x] Button-triggered triage animations work correctly
  - [x] Undo animation still works correctly
  - [x] No regression to black flash fix (expo-image still working)

## Issue Resolution

| Issue | Status |
|-------|--------|
| UAT-004: Card cascade animation snaps instead of smooth transition | âœ… Resolved |

## Next Steps

- Phase 18.1 complete - all UAT issues resolved
- Next phase: 18.2 Success Sound Effect on Triage Completion
