---
phase: 18.1-batched-darkroom-triage-with-undo
plan: 18.1-FIX
type: fix
---

<objective>
Fix 1 UAT issue from Phase 18.1 verify-work.

Source: 18.1-ISSUES.md
Priority: 0 critical, 1 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-ISSUES.md

**Original plans for reference:**
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-01-PLAN.md
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-02-PLAN.md

**Key files:**
@src/components/SwipeablePhotoCard.js
@src/screens/DarkroomScreen.js
</context>

<tasks>
<task type="auto">
  <name>Fix UAT-001: Black flash after cascade animation</name>
  <files>src/components/SwipeablePhotoCard.js, src/screens/DarkroomScreen.js</files>
  <action>
The black flash occurs after the cascade animation completes when the front card exits. The issue is a timing mismatch between:
1. The exit animation completing and triggering the callback
2. The `photos` array updating (removing the front card)
3. The stack card at index 1 becoming the new front card (index 0)

During this transition, the card that was at stackIndex=1 briefly shows its black background before the image fully renders in the front position.

**Investigation steps:**
1. Add console logging to identify exact timing of:
   - When exit animation completes
   - When `cascading` is set to false
   - When `photos` array updates
   - When stack cards re-render with new stackIndex

2. **Potential fixes to try:**
   a. **Delay resetting cascading**: Wait for a frame after photos update before resetting `cascading=false`
   b. **Pre-render front card**: Ensure the card that will become front has its image fully loaded before the transition
   c. **Keep stackBlurOverlay during transition**: Don't immediately remove the blur overlay when becoming front card - fade it out with a timing animation
   d. **Use opacity transition**: Instead of instant stackIndex change, animate opacity from 0.85 to 1 with a timing animation

3. **Most likely fix**: The `stackBlurOverlayStyle` immediately sets opacity to 0 when `stackIndex` becomes 0. This reveals any rendering delay on the underlying image. Add a brief timing animation when transitioning from stack to front position.

**Implementation:**
- In SwipeablePhotoCard.js, modify the useEffect that responds to stackIndex changes
- When stackIndex changes from >0 to 0 (card becoming front), add a small delay or timing animation for the blur overlay fade-out
- This gives the Image component time to fully render before the overlay disappears

**Alternative approach if above doesn't work:**
- Ensure the Image is fully rendered before any cascade starts by preloading
- Use `Image.prefetch()` for stack cards
  </action>
  <verify>
1. Open darkroom with multiple photos
2. Swipe a card to triage
3. Watch cascade animation - NO black flash should occur
4. Repeat for button-triggered triage (archive/journal/delete)
5. No console errors
  </verify>
  <done>Cascade animation completes smoothly with no black flash visible on the card that moves to front position</done>
</task>
</tasks>

<verification>
Before declaring plan complete:
- [ ] Black flash no longer visible after cascade animation
- [ ] Cascade animation still feels smooth and responsive
- [ ] Stack cards still animate properly (scale, offset, opacity)
- [ ] Undo animation still works correctly
- [ ] No regressions in triage functionality
- [ ] `npx expo export --platform ios` builds without errors
</verification>

<success_criteria>
- UAT-001 resolved: No black flash after cascade animation
- Animation timing feels natural, not delayed
- All existing triage functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-FIX-SUMMARY.md`
</output>
