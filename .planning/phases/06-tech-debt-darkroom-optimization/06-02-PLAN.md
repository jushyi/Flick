---
phase: 06-tech-debt-darkroom-optimization
plan: 02
type: execute
wave: 2
depends_on:
  - '06-01'
files_modified:
  - src/services/firebase/darkroomService.js
  - App.js
  - src/hooks/useDarkroom.js
  - src/services/uploadQueueService.js
autonomous: true
requirements:
  - DARK-01
  - DARK-02

must_haves:
  truths:
    - 'isDarkroomReadyToReveal skips Firestore reads when cache is fresh and nextRevealAt is in the future'
    - 'clearRevealCache is exported from darkroomService and resets the cache'
    - 'App.js calls clearRevealCache after scheduleNextReveal completes'
    - 'useDarkroom.js calls clearRevealCache after scheduleNextReveal completes'
    - 'uploadQueueService.js calls clearRevealCache after ensureDarkroomInitialized'
    - 'All darkroomService tests pass (GREEN)'
  artifacts:
    - path: 'src/services/firebase/darkroomService.js'
      provides: 'Module-level _revealCache object, CACHE_MAX_AGE_MS constant, clearRevealCache export, updated isDarkroomReadyToReveal with cache logic'
      contains: 'clearRevealCache'
    - path: 'App.js'
      provides: 'clearRevealCache call after scheduleNextReveal in foreground AppState handler'
      contains: 'clearRevealCache'
    - path: 'src/hooks/useDarkroom.js'
      provides: 'clearRevealCache call after scheduleNextReveal in loadDevelopingPhotos'
      contains: 'clearRevealCache'
    - path: 'src/services/uploadQueueService.js'
      provides: 'clearRevealCache call after ensureDarkroomInitialized in photo upload path'
      contains: 'clearRevealCache'
  key_links:
    - from: 'App.js'
      to: 'src/services/firebase/darkroomService.js'
      via: 'clearRevealCache import'
      pattern: 'clearRevealCache'
    - from: 'src/hooks/useDarkroom.js'
      to: 'src/services/firebase/darkroomService.js'
      via: 'clearRevealCache import'
      pattern: 'clearRevealCache'
    - from: 'src/services/uploadQueueService.js'
      to: 'src/services/firebase/darkroomService.js'
      via: 'clearRevealCache import'
      pattern: 'clearRevealCache'
---

<objective>
Implement the darkroom reveal cache in darkroomService.js (GREEN phase for Plan 01 tests) and wire clearRevealCache invalidation at all required call sites. This eliminates redundant Firestore reads on every app foreground and DarkroomScreen focus event.

Purpose: After this plan, isDarkroomReadyToReveal will skip Firestore when the cache shows the reveal time hasn't elapsed (5-minute freshness window). Cloud function continues to run server-side every 2 minutes as the safety net — this change only optimizes the client-side trigger.

Output: Updated darkroomService.js with cache, updated App.js + useDarkroom.js + uploadQueueService.js with cache invalidation calls.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/06-tech-debt-darkroom-optimization/06-CONTEXT.md
@.planning/phases/06-tech-debt-darkroom-optimization/06-RESEARCH.md
@.planning/phases/06-tech-debt-darkroom-optimization/06-01-SUMMARY.md
@src/services/firebase/darkroomService.js
@App.js
@src/hooks/useDarkroom.js
@src/services/uploadQueueService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add module-level cache and clearRevealCache to darkroomService.js</name>
  <files>src/services/firebase/darkroomService.js</files>
  <action>
Add the module-level cache and update `isDarkroomReadyToReveal` in `src/services/firebase/darkroomService.js`.

STEP 1 — Add cache variables and clearRevealCache export immediately before the `isDarkroomReadyToReveal` function:

```javascript
// Module-level cache for darkroom reveal timing — shared across all callers (App.js + useDarkroom.js)
let _revealCache = { nextRevealAt: null, cachedAt: null };
const CACHE_MAX_AGE_MS = 5 * 60 * 1000; // 5 minutes

/**
 * Clear the reveal cache. Call after new photo capture and after reveal processing.
 * This forces the next isDarkroomReadyToReveal call to re-fetch from Firestore.
 */
export const clearRevealCache = () => {
  _revealCache = { nextRevealAt: null, cachedAt: null };
  logger.debug('darkroomService: Reveal cache cleared');
};
```

STEP 2 — Replace the body of `isDarkroomReadyToReveal` with the cache-aware version. Keep the JSDoc comment and function signature exactly the same — only replace the try/catch body:

```javascript
export const isDarkroomReadyToReveal = async userId => {
  try {
    const now = Date.now();

    // Cache hit: skip Firestore if cache is fresh and reveal time hasn't elapsed yet
    if (
      _revealCache.nextRevealAt !== null &&
      _revealCache.cachedAt !== null &&
      now - _revealCache.cachedAt < CACHE_MAX_AGE_MS &&
      _revealCache.nextRevealAt.toMillis() > now
    ) {
      logger.debug('isDarkroomReadyToReveal: cache hit — not ready yet', {
        userId,
        cachedNextRevealAt: _revealCache.nextRevealAt.toDate().toISOString(),
        cacheAgeMs: now - _revealCache.cachedAt,
      });
      return false;
    }

    // Cache miss, stale, or cached time elapsed — fetch from Firestore
    const result = await getDarkroom(userId);
    if (!result.success) return false;

    const { nextRevealAt } = result.darkroom;

    // Update cache with new value (even if null — null means no scheduled reveal)
    _revealCache = { nextRevealAt: nextRevealAt ?? null, cachedAt: now };

    const isReady = nextRevealAt && nextRevealAt.toMillis() <= now;
    logger.debug('isDarkroomReadyToReveal: Firestore check', {
      userId,
      isReady,
      nextRevealAt: nextRevealAt?.toDate().toISOString(),
    });

    return isReady;
  } catch (error) {
    logger.error('Error checking darkroom reveal status', error);
    return false;
  }
};
```

NOTE: The existing implementation uses `nextRevealAt.seconds` for comparison. The new version uses `.toMillis()` which is consistent with the cache logic and matches the test mock setup. The Firestore Timestamp object in production has both `.seconds` and `.toMillis()` methods.

IMPORTANT: Do not change any other functions in darkroomService.js.
</action>
<verify>
<automated>cd "/c/Users/maser/Lapse Clone" && npx jest **tests**/services/darkroomService.test.js --no-coverage 2>&1 | tail -20</automated>
<manual>Confirm all tests pass including the new cache behavior tests from Plan 01 — this is the GREEN phase.</manual>
<sampling_rate>Run immediately after this task</sampling_rate>
</verify>
<done>All darkroomService.test.js tests pass (existing + new cache tests); clearRevealCache is exported; \_revealCache module variable exists</done>
</task>

<task type="auto">
  <name>Task 2: Wire clearRevealCache in App.js, useDarkroom.js, and uploadQueueService.js</name>
  <files>App.js, src/hooks/useDarkroom.js, src/services/uploadQueueService.js</files>
  <action>
Add `clearRevealCache` imports and call sites at the three required invalidation points.

PITFALL AVOIDANCE: Always call `clearRevealCache()` AFTER `scheduleNextReveal()` resolves — not before. Clearing before scheduleNextReveal completes means the next reveal check would fetch from Firestore and get the OLD nextRevealAt before it's been updated.

**App.js changes:**

1. Add `clearRevealCache` to the existing darkroomService import. The current import line is:

   ```javascript
   import {
     isDarkroomReadyToReveal,
     scheduleNextReveal,
     // ...possibly more
   } from './src/services/firebase/darkroomService';
   ```

   Add `clearRevealCache` to that import.

2. In the `AppState.addEventListener('change', ...)` handler, after `await scheduleNextReveal(currentUser.uid)`, add:
   ```javascript
   clearRevealCache(); // Invalidate cache so next foreground check re-fetches fresh nextRevealAt
   ```
   The surrounding code looks like:
   ```javascript
   const revealResult = await revealPhotos(currentUser.uid);
   await scheduleNextReveal(currentUser.uid);
   // ← add clearRevealCache() here
   logger.info('App: Foreground reveal complete', { ... });
   ```

**useDarkroom.js changes:**

1. Add `clearRevealCache` to the existing darkroomService import at the top of the file.

2. In `loadDevelopingPhotos`, after `await scheduleNextReveal(user.uid)` at line ~133, add:
   ```javascript
   clearRevealCache(); // Invalidate cache after reveal so next check fetches updated nextRevealAt
   ```
   The surrounding code looks like:
   ```javascript
   await scheduleNextReveal(user.uid);
   // ← add clearRevealCache() here
   logger.debug('useDarkroom: Next reveal scheduled');
   ```

**uploadQueueService.js changes:**

1. Add `clearRevealCache` to the existing darkroomService import.

2. After `await ensureDarkroomInitialized(userId)` at line ~303, add:
   ```javascript
   clearRevealCache(); // New photo captured — clear cache so darkroom checks re-evaluate fresh timing
   ```

Use the logger from each file's existing logger import for any additional logging. Do NOT add extra logger calls unless necessary — keep the diff minimal.
</action>
<verify>
<automated>cd "/c/Users/maser/Lapse Clone" && npx jest --no-coverage 2>&1 | tail -30</automated>
<manual>Search for clearRevealCache in App.js, useDarkroom.js, uploadQueueService.js to confirm it's imported and called after the expected operations.</manual>
<sampling_rate>Run full suite after this task</sampling_rate>
</verify>
<done>clearRevealCache imported and called in App.js (after scheduleNextReveal in foreground handler), useDarkroom.js (after scheduleNextReveal in loadDevelopingPhotos), and uploadQueueService.js (after ensureDarkroomInitialized); full test suite passes</done>
</task>

</tasks>

<verification>
1. `npx jest __tests__/services/darkroomService.test.js --no-coverage` — all tests pass (GREEN)
2. `npx jest --no-coverage` — full suite passes (no regressions)
3. `grep -n "clearRevealCache" src/services/firebase/darkroomService.js App.js src/hooks/useDarkroom.js src/services/uploadQueueService.js` — clearRevealCache appears in all four files
</verification>

<success_criteria>

- darkroomService.js exports clearRevealCache and has module-level \_revealCache with CACHE_MAX_AGE_MS = 5 _ 60 _ 1000
- isDarkroomReadyToReveal uses Date.now() for cache age check and toMillis() for timestamp comparison
- All cache behavior tests from Plan 01 pass (GREEN phase complete)
- App.js, useDarkroom.js, and uploadQueueService.js import and call clearRevealCache at correct sites
- Full test suite passes with no regressions
  </success_criteria>

<output>
After completion, create `.planning/phases/06-tech-debt-darkroom-optimization/06-02-SUMMARY.md`
</output>
