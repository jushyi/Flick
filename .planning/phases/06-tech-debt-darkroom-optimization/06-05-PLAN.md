---
phase: 06-tech-debt-darkroom-optimization
plan: 05
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false
requirements:
  - DEBT-03
  - DEBT-04

must_haves:
  truths:
    - 'Firestore TTL policy exists on the messages collection group targeting the expiresAt field'
    - 'GCS lifecycle rule exists on the Firebase Storage bucket targeting snap-photos/ prefix with 14-day age'
  artifacts: []
  key_links: []
---

<objective>
Configure Firestore TTL auto-deletion for snap messages and GCS lifecycle auto-deletion for orphaned snap photos. Both are console/CLI configurations — no code changes required.

Purpose: After this plan, expired snap message documents in Firestore will auto-delete 7 days after their expiresAt timestamp, and orphaned snap photos in Firebase Storage will auto-delete 14 days after upload. Both serve as passive safety nets alongside the existing Cloud Function cleanup.

Output: Firestore TTL policy active on messages.expiresAt; GCS lifecycle rule active on snap-photos/ prefix.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-tech-debt-darkroom-optimization/06-CONTEXT.md
@.planning/phases/06-tech-debt-darkroom-optimization/06-RESEARCH.md
</context>

<tasks>

<task type="manual">
  <name>Task 1: Attempt Firestore TTL configuration via gcloud CLI</name>
  <files></files>
  <action>
Attempt to configure the Firestore TTL policy for the messages collection group using the gcloud CLI. If CLI authentication fails or gcloud is not installed, fall through to the checkpoint task.

Run the following to check if gcloud is available and authenticated:

```bash
gcloud auth list 2>&1
gcloud config get-value project 2>&1
```

If authenticated and the correct project is active (flick-prod-49615 for production), apply the TTL:

```bash
gcloud firestore fields ttls update expiresAt \
  --collection-group=messages \
  --project=flick-prod-49615 \
  --enable-ttl
```

Verify TTL was created:

```bash
gcloud firestore fields ttls describe expiresAt \
  --collection-group=messages \
  --project=flick-prod-49615
```

PITFALL: The collection group is `messages` (the subcollection inside conversations/{id}/messages). Do NOT use `conversations` — the TTL must target the subcollection where snap messages and their expiresAt field live.

If gcloud is not available or authentication fails, note the failure and proceed to the checkpoint task below with manual instructions.

For GCS lifecycle — attempt CLI approach:

```bash
# Identify the bucket name
firebase storage:config --project flick-prod-49615 2>&1 || echo "Check Firebase console for bucket name"
```

The bucket name follows the pattern: `flick-prod-49615.firebasestorage.app` or `flick-prod-49615.appspot.com`.

Create a lifecycle config file at `/tmp/snap-lifecycle.json`:

```json
{
  "rule": [
    {
      "action": { "type": "Delete" },
      "condition": {
        "age": 14,
        "matchesPrefix": ["snap-photos/"]
      }
    }
  ]
}
```

Apply it:

```bash
gsutil lifecycle set /tmp/snap-lifecycle.json gs://flick-prod-49615.firebasestorage.app
```

Verify:

```bash
gsutil lifecycle get gs://flick-prod-49615.firebasestorage.app
```

PITFALL: Use `"snap-photos/"` (with trailing slash) not `"snap-photos"` (without) — the trailing slash prevents accidentally matching a prefix like `snap-photos-backup/`.
</action>
<verify>
<automated>gcloud firestore fields ttls describe expiresAt --collection-group=messages --project=flick-prod-49615 2>&1 || echo "gcloud not available — manual configuration needed"</automated>
<manual>If gcloud succeeded: confirm TTL state is ENABLED. If gcloud failed: proceed to checkpoint task below.</manual>
<sampling_rate>Run once before checkpoint</sampling_rate>
</verify>
<done>Either: Firestore TTL and GCS lifecycle configured via CLI with verification output; OR: gcloud unavailable and checkpoint task will handle manual configuration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Firestore TTL and GCS lifecycle rule configuration</name>
  <action>
Review Task 1 output above. If CLI succeeded for both DEBT-03 and DEBT-04, verify the configurations match the requirements in the verify section below and mark complete.

If Task 1 CLI failed (gcloud not available or authentication error), manually configure both settings:

DEBT-03 — Firestore TTL via Firebase Console:

1. Go to Firebase Console (console.firebase.google.com) and select project flick-prod-49615
2. Navigate to Firestore Database, find TTL policies panel
3. Add TTL policy: Collection group = `messages`, Timestamp field = `expiresAt`
4. Save — policy shows as CREATING initially, activates within 24 hours

DEBT-04 — GCS Lifecycle via Google Cloud Console:

1. Go to console.cloud.google.com, select project flick-prod-49615
2. Navigate to Cloud Storage, find the Firebase Storage bucket (flick-prod-49615.firebasestorage.app)
3. Click Lifecycle tab, Add a rule: Action = Delete, Age = 14 days, Prefix = `snap-photos/` (trailing slash required)
4. Save rule

NOTE — reactionBatches TTL intentionally excluded: The CONTEXT.md locked decision states TTL scope includes `reactionBatches`. However, `reactionBatches` documents do NOT have an `expiresAt` Timestamp field — they use `sentAt` plus a `status='sent'` filter. The existing `cleanupOldNotifications` Cloud Function (runs daily at 2 AM UTC) already handles 7-day cleanup of sent reaction batches via `.where('status', '==', 'sent').where('sentAt', '<', sevenDaysAgo)`. Configuring a Firestore TTL policy for `reactionBatches` is not possible without adding an `expiresAt` field to the documents, which is out of scope for this phase. The Cloud Function cleanup is the correct and sufficient mechanism — no additional TTL policy is needed.
</action>
<verify>
<automated>gcloud firestore fields ttls describe expiresAt --collection-group=messages --project=flick-prod-49615 2>&1 && gsutil lifecycle get gs://flick-prod-49615.firebasestorage.app 2>&1 || echo "CLI verification requires gcloud/gsutil — check consoles manually"</automated>
<manual>
DEBT-03 check: Firebase Console shows TTL policy on collection group `messages`, field `expiresAt`, state ACTIVE or CREATING.
DEBT-04 check: GCS console shows lifecycle rule on bucket with Delete action, 14-day age, snap-photos/ prefix.
</manual>
</verify>
<done>Both Firestore TTL policy (messages/expiresAt) and GCS lifecycle rule (snap-photos/, 14 days, Delete) are confirmed configured.</done>
</task>

</tasks>

<verification>
Both configurations verified — either via CLI output from Task 1, or visually confirmed in Firebase/GCS consoles during the checkpoint.
</verification>

<success_criteria>

- DEBT-03: Firestore TTL policy exists on collection group `messages`, field `expiresAt`, state ACTIVE or CREATING
- DEBT-04: GCS lifecycle rule exists on the Firebase Storage bucket for the snap-photos/ prefix with 14-day age condition, Delete action
  </success_criteria>

<output>
After completion, create `.planning/phases/06-tech-debt-darkroom-optimization/06-05-SUMMARY.md` including the verification evidence (TTL state, lifecycle rule details).
</output>
