---
phase: 06-tech-debt-darkroom-optimization
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/index.js
autonomous: true
requirements:
  - DEBT-02
  - DEBT-05

must_haves:
  truths:
    - 'All 15 snapFunctions tests pass with no fragile assertions'
    - 'Variable daysSinceLastMutual is used in functions/index.js instead of hoursSinceLastMutual'
    - 'An inline comment explains that daysSinceLastMutual < 1 means less than one full day'
  artifacts:
    - path: 'functions/index.js'
      provides: 'Renamed variable daysSinceLastMutual with inline comment at line ~2880'
      contains: 'daysSinceLastMutual'
  key_links:
    - from: 'functions/index.js'
      to: 'functions/__tests__/triggers/streakFunctions.test.js'
      via: 'variable rename does not break tests'
      pattern: 'daysSinceLastMutual'
---

<objective>
Close two independent tech debt items: (1) audit snapFunctions.test.js to confirm all 15 tests pass cleanly with no fragile assertions, and (2) rename hoursSinceLastMutual to daysSinceLastMutual in functions/index.js with a clarifying comment.

Purpose: DEBT-02 is an audit-and-confirm task (the stale assertion was already fixed in v1.0 — research confirmed this). DEBT-05 fixes a misleading variable name that divides by DAY_MS, making the value fractional days not hours.

Output: Audit report embedded in SUMMARY.md; functions/index.js updated with correct variable name and comment.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-tech-debt-darkroom-optimization/06-CONTEXT.md
@.planning/phases/06-tech-debt-darkroom-optimization/06-RESEARCH.md
@functions/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit snapFunctions.test.js and rename hoursSinceLastMutual in functions/index.js</name>
  <files>functions/index.js</files>
  <action>
PART A — DEBT-02 Audit:

Run the snapFunctions tests and audit for fragile assertions:

```bash
cd functions && npx jest __tests__/snapFunctions.test.js 2>&1
```

Review the output. Per RESEARCH.md:

- Line 522: `expect(data.type).toBe('snap')` — already correct
- Line 520: `const validBodies = ['sent you a snap', 'just snapped you', 'New snap']; expect(validBodies).toContain(body);` — flexible array check, not fragile
- Lines 523-524: ID checks against `'msg-123'` and `'user-a_user-b'` — correct (match test fixture setup)

If all 15 tests pass and no assertions are hardcoded against values that will drift (like notification template strings without the validBodies array pattern), the audit is complete. Record the result in the SUMMARY.md.

If any tests FAIL, investigate and fix. The RESEARCH.md finding is that they should all pass — but verify this before proceeding to the rename.

PART B — DEBT-05 Variable Rename:

In `functions/index.js` at line 2880, rename `hoursSinceLastMutual` to `daysSinceLastMutual` in TWO places (the declaration and the if-check one line later). Add an inline comment on the declaration line.

Current code (lines 2880-2882):

```javascript
const hoursSinceLastMutual = lastMutualAt ? (nowMs - lastMutualMs) / DAY_MS : Infinity;
if (hoursSinceLastMutual < 1) {
  // Less than 24h since last mutual exchange — just record the snap
```

Replace with:

```javascript
// daysSinceLastMutual < 1 means less than one full day (< 24h) since last mutual exchange
const daysSinceLastMutual = lastMutualAt ? (nowMs - lastMutualMs) / DAY_MS : Infinity;
if (daysSinceLastMutual < 1) {
  // Less than 24h since last mutual exchange — just record the snap
```

Do NOT change the logic, the `< 1` threshold, or any surrounding code. Only the variable name and the addition of the inline comment change.

After the rename, run the streak functions tests to verify no breakage:

```bash
cd functions && npx jest __tests__/triggers/streakFunctions.test.js 2>&1
```

And run the full functions test suite:

```bash
cd functions && npx jest 2>&1
```

  </action>
  <verify>
    <automated>cd "/c/Users/maser/Lapse Clone/functions" && npx jest 2>&1 | tail -20</automated>
    <manual>Confirm: (1) all 15 snapFunctions tests pass; (2) grep for "hoursSinceLastMutual" in functions/index.js returns no results; (3) grep for "daysSinceLastMutual" returns exactly 2 results (declaration + if-check).</manual>
    <sampling_rate>Run after this task before moving to any Wave 2 work</sampling_rate>
  </verify>
  <done>All functions tests pass; hoursSinceLastMutual replaced by daysSinceLastMutual with inline comment; no other code changes</done>
</task>

</tasks>

<verification>
1. `cd functions && npx jest __tests__/snapFunctions.test.js` — 15 tests pass
2. `cd functions && npx jest` — full functions suite passes
3. `grep "hoursSinceLastMutual" functions/index.js` — no results (renamed)
4. `grep -n "daysSinceLastMutual" functions/index.js` — exactly 2 results
</verification>

<success_criteria>

- DEBT-02: All 15 snapFunctions tests pass; audit confirms no fragile assertions; result documented in SUMMARY.md
- DEBT-05: functions/index.js uses daysSinceLastMutual with an inline comment explaining the unit; all functions tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/06-tech-debt-darkroom-optimization/06-04-SUMMARY.md`
</output>
