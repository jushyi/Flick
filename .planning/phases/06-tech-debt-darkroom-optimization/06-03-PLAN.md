---
phase: 06-tech-debt-darkroom-optimization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - __tests__/hooks/useConversation.test.js
autonomous: true
requirements:
  - DEBT-01

must_haves:
  truths:
    - 'handleSendReaction calls sendReaction with conversationId, currentUserId, targetMessageId, emoji'
    - 'handleRemoveReaction calls removeReaction with conversationId, currentUserId, targetMessageId'
    - 'handleSendReply calls sendReply with conversationId, currentUserId, text, gifUrl, imageUrl, replyToMessage'
    - 'handleDeleteForMe calls deleteMessageForMe with conversationId, currentUserId, messageId'
  artifacts:
    - path: '__tests__/hooks/useConversation.test.js'
      provides: 'Phase 2 describe blocks for reactions, replies, soft deletion'
      contains: 'Phase 2: reactions'
  key_links:
    - from: '__tests__/hooks/useConversation.test.js'
      to: 'src/services/firebase/messageService'
      via: 'jest.mock with sendReaction, removeReaction, sendReply, deleteMessageForMe'
      pattern: 'mockSendReaction|mockRemoveReaction|mockSendReply|mockDeleteMessageForMe'
---

<objective>
Add dedicated unit tests for the Phase 2 features of the useConversation hook: reactions, reaction removal, replies, and soft deletion. These features were implemented in v1.0 but never had dedicated test coverage.

Purpose: Close the test gap for DEBT-01. The handlers (handleSendReaction, handleRemoveReaction, handleSendReply, handleDeleteForMe) are already implemented in useConversation.js — these tests verify that they delegate correctly to messageService with the right arguments.

Output: New describe blocks appended to `__tests__/hooks/useConversation.test.js`. Existing 8 tests remain untouched.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-tech-debt-darkroom-optimization/06-CONTEXT.md
@.planning/phases/06-tech-debt-darkroom-optimization/06-RESEARCH.md
@__tests__/hooks/useConversation.test.js
@src/hooks/useConversation.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 2 mock wiring and test describe blocks to useConversation.test.js</name>
  <files>__tests__/hooks/useConversation.test.js</files>
  <action>
Append Phase 2 test coverage to the EXISTING test file. Two changes are required:

CHANGE 1 — Add four new mock variable declarations at the top of the file alongside the existing mock declarations (after line 37, before the jest.mock block):

```javascript
const mockSendReaction = jest.fn();
const mockRemoveReaction = jest.fn();
const mockSendReply = jest.fn();
const mockDeleteMessageForMe = jest.fn();
```

CHANGE 2 — Add these four functions to the `jest.mock('../../src/services/firebase/messageService', ...)` factory return object. The current factory returns only `subscribeToMessages`, `loadMoreMessages`, `sendMessage`, `markConversationRead`. Add the new ones to the same object:

```javascript
sendReaction: (...args) => mockSendReaction(...args),
removeReaction: (...args) => mockRemoveReaction(...args),
sendReply: (...args) => mockSendReply(...args),
deleteMessageForMe: (...args) => mockDeleteMessageForMe(...args),
```

CHANGE 3 — Append three new describe blocks AFTER the closing `});` of the main `describe('useConversation', () => { ... })` block. These blocks live at the TOP level (same nesting as the main describe, not inside it) OR can be appended inside the main describe block as sibling sections — use the same pattern as existing sections:

```javascript
// ===========================================================================
// Phase 2: reactions
// ===========================================================================
describe('Phase 2: reactions', () => {
  it('should call sendReaction with conversationId, currentUserId, targetMessageId, emoji', async () => {
    mockSendReaction.mockResolvedValue({ success: true, messageId: 'rxn-1' });

    const { result } = renderHook(() => useConversation(mockConversationId, mockCurrentUserId));

    await act(async () => {
      await result.current.handleSendReaction('msg-1', 'heart');
    });

    expect(mockSendReaction).toHaveBeenCalledWith(
      mockConversationId,
      mockCurrentUserId,
      'msg-1',
      'heart'
    );
  });

  it('should call removeReaction with conversationId, currentUserId, targetMessageId', async () => {
    mockRemoveReaction.mockResolvedValue({ success: true });

    const { result } = renderHook(() => useConversation(mockConversationId, mockCurrentUserId));

    await act(async () => {
      await result.current.handleRemoveReaction('msg-1');
    });

    expect(mockRemoveReaction).toHaveBeenCalledWith(mockConversationId, mockCurrentUserId, 'msg-1');
  });
});

// ===========================================================================
// Phase 2: replies
// ===========================================================================
describe('Phase 2: replies', () => {
  it('should call sendReply with correct arguments including replyToMessage', async () => {
    mockSendReply.mockResolvedValue({ success: true, messageId: 'reply-1' });
    const replyToMessage = { id: 'orig-1', senderId: 'user2', type: 'text' };

    const { result } = renderHook(() => useConversation(mockConversationId, mockCurrentUserId));

    await act(async () => {
      await result.current.handleSendReply('reply text', null, null, replyToMessage);
    });

    expect(mockSendReply).toHaveBeenCalledWith(
      mockConversationId,
      mockCurrentUserId,
      'reply text',
      null,
      null,
      replyToMessage
    );
  });
});

// ===========================================================================
// Phase 2: soft deletion
// ===========================================================================
describe('Phase 2: soft deletion', () => {
  it('should call deleteMessageForMe with conversationId, currentUserId, messageId', async () => {
    mockDeleteMessageForMe.mockResolvedValue({ success: true });

    const { result } = renderHook(() => useConversation(mockConversationId, mockCurrentUserId));

    await act(async () => {
      await result.current.handleDeleteForMe('msg-to-delete');
    });

    expect(mockDeleteMessageForMe).toHaveBeenCalledWith(
      mockConversationId,
      mockCurrentUserId,
      'msg-to-delete'
    );
  });
});
```

IMPORTANT: Place these three describe blocks INSIDE the main `describe('useConversation', () => { ... })` block, as the last sections before its closing `});`. This is consistent with the existing section structure (conversation document subscription, first-read-only guard, foreground-only guard, AppState listener cleanup).

Also add `mockSendReaction.mockReset()`, `mockRemoveReaction.mockReset()`, `mockSendReply.mockReset()`, `mockDeleteMessageForMe.mockReset()` inside the existing `beforeEach(() => { jest.clearAllMocks(); ... })` block — or just rely on `jest.clearAllMocks()` which already clears all mock state.

CLAUDE.md pattern reminder: "Mock functions are defined outside jest.mock() blocks and referenced inside mock returns." — this is exactly what CHANGE 1 + CHANGE 2 do.
</action>
<verify>
<automated>cd "/c/Users/maser/Lapse Clone" && npx jest __tests__/hooks/useConversation.test.js --no-coverage 2>&1 | tail -20</automated>
<manual>All 8 existing tests plus the 4 new Phase 2 tests should pass (12 total). Confirm no "not a function" errors on sendReaction, removeReaction, sendReply, deleteMessageForMe.</manual>
<sampling_rate>Run immediately after this task</sampling_rate>
</verify>
<done>All useConversation tests pass (12 total); Phase 2 describe blocks exist in the file; mock wiring for all four Phase 2 functions is correct</done>
</task>

</tasks>

<verification>
`npx jest __tests__/hooks/useConversation.test.js --no-coverage` — all 12 tests pass (8 original + 4 new)
</verification>

<success_criteria>

- 4 new mock variables declared at module scope before jest.mock block
- jest.mock messageService factory updated with sendReaction, removeReaction, sendReply, deleteMessageForMe
- 3 new describe blocks inside the main describe: Phase 2 reactions, Phase 2 replies, Phase 2 soft deletion
- All 12 tests pass
  </success_criteria>

<output>
After completion, create `.planning/phases/06-tech-debt-darkroom-optimization/06-03-SUMMARY.md`
</output>
