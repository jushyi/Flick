---
phase: 35-stories-redesign
plan: 02
type: execute
domain: react-native
---

<objective>
Add view state tracking so friends move to end of stories row after viewing.

Purpose: Prioritize unviewed content and provide clear visual distinction between new and seen stories.
Output: AsyncStorage-based view tracking, automatic marking on viewer close, sorted stories row.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/35-stories-redesign/35-CONTEXT.md
@.planning/phases/35-stories-redesign/35-01-SUMMARY.md

# Key files to modify:

@src/screens/FeedScreen.js
@src/components/FriendStoryCard.js
@src/components/StoriesViewerModal.js

**Tech stack available:**

- AsyncStorage for persistent local storage
- React hooks for state management

**Design requirements from CONTEXT.md:**

- Viewed: Gray ring, card moves to end of stories row
- Sorting: Unviewed friends first, viewed friends at end
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create useViewedStories hook for view state management</name>
  <files>src/hooks/useViewedStories.js</files>
  <action>
Create a new hook `useViewedStories` that manages viewed state with AsyncStorage:

```javascript
import { useState, useEffect, useCallback } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';
import logger from '../utils/logger';

const STORAGE_KEY = '@viewed_stories';
const EXPIRY_HOURS = 24; // Reset viewed state after 24 hours

export const useViewedStories = () => {
  const [viewedFriends, setViewedFriends] = useState(new Set());
  const [loading, setLoading] = useState(true);

  // Load viewed state on mount
  useEffect(() => {
    loadViewedState();
  }, []);

  const loadViewedState = async () => {
    try {
      const stored = await AsyncStorage.getItem(STORAGE_KEY);
      if (stored) {
        const data = JSON.parse(stored);
        const now = Date.now();
        // Filter out expired entries (older than 24 hours)
        const valid = Object.entries(data)
          .filter(([_, timestamp]) => now - timestamp < EXPIRY_HOURS * 60 * 60 * 1000)
          .map(([friendId]) => friendId);
        setViewedFriends(new Set(valid));
        logger.debug('useViewedStories: Loaded viewed state', { count: valid.length });
      }
    } catch (error) {
      logger.error('useViewedStories: Failed to load', { error: error.message });
    } finally {
      setLoading(false);
    }
  };

  const markAsViewed = useCallback(async friendId => {
    try {
      // Update local state immediately
      setViewedFriends(prev => new Set([...prev, friendId]));

      // Persist to AsyncStorage
      const stored = await AsyncStorage.getItem(STORAGE_KEY);
      const data = stored ? JSON.parse(stored) : {};
      data[friendId] = Date.now();
      await AsyncStorage.setItem(STORAGE_KEY, JSON.stringify(data));

      logger.info('useViewedStories: Marked as viewed', { friendId });
    } catch (error) {
      logger.error('useViewedStories: Failed to mark as viewed', { error: error.message });
    }
  }, []);

  const isViewed = useCallback(
    friendId => {
      return viewedFriends.has(friendId);
    },
    [viewedFriends]
  );

  return { isViewed, markAsViewed, loading };
};
```

**Key features:**

- Persists to AsyncStorage with 24-hour expiry
- Returns `isViewed(friendId)` to check state
- Returns `markAsViewed(friendId)` to mark as viewed
- Loading state for initial hydration
  </action>
  <verify>File exists: ls src/hooks/useViewedStories.js</verify>
  <done>useViewedStories hook created with AsyncStorage persistence and 24-hour expiry</done>
  </task>

<task type="auto">
  <name>Task 2: Integrate view tracking into FeedScreen</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Update FeedScreen to use view tracking and sort stories:

1. **Import the hook:**

   ```javascript
   import { useViewedStories } from '../hooks/useViewedStories';
   ```

2. **Use the hook:**

   ```javascript
   const { isViewed, markAsViewed } = useViewedStories();
   ```

3. **Sort friends by viewed state:**
   In `renderStoriesRow()`, before mapping friendStories, sort them:

   ```javascript
   const sortedFriends = [...friendStories].sort((a, b) => {
     const aViewed = isViewed(a.userId);
     const bViewed = isViewed(b.userId);
     if (aViewed === bViewed) return 0;
     return aViewed ? 1 : -1; // Unviewed first
   });
   ```

   Then map over `sortedFriends` instead of `friendStories`.

4. **Pass isViewed prop to FriendStoryCard:**

   ```javascript
   <FriendStoryCard
     key={friend.userId}
     friend={friend}
     onPress={() => handleOpenStories(friend)}
     isFirst={index === 0}
     isViewed={isViewed(friend.userId)}
   />
   ```

5. **Mark as viewed when closing StoriesViewerModal:**
   Update `handleCloseStories` to mark the friend as viewed:
   ```javascript
   const handleCloseStories = () => {
     logger.debug('FeedScreen: Closing stories viewer');
     if (selectedFriend) {
       markAsViewed(selectedFriend.userId);
     }
     setStoriesModalVisible(false);
     setSelectedFriend(null);
   };
   ```
     </action>
     <verify>App runs without errors; closing story viewer changes card appearance and position</verify>
     <done>FeedScreen passes isViewed prop, sorts stories, and marks friends as viewed on close</done>
   </task>

<task type="auto">
  <name>Task 3: Update FriendStoryCard to use isViewed for styling</name>
  <files>src/components/FriendStoryCard.js</files>
  <action>
Ensure FriendStoryCard uses the isViewed prop correctly (may already be done in 35-01):

1. Accept `isViewed` prop with default `false`
2. Use gradient border when `!isViewed` (purple/pink glow)
3. Use solid gray border when `isViewed`

If not already implemented in 35-01, add the conditional:

```javascript
{
  isViewed ? (
    <View style={styles.viewedBorder}>{/* Card content */}</View>
  ) : (
    <LinearGradient
      colors={colors.brand.gradient.developing}
      start={{ x: 0, y: 0 }}
      end={{ x: 1, y: 1 }}
      style={styles.gradientBorder}
    >
      {/* Card content */}
    </LinearGradient>
  );
}
```

Also update PropTypes/defaultProps if used.
</action>
<verify>Viewed cards have gray border, unviewed cards have gradient glow</verify>
<done>FriendStoryCard renders different border styles based on isViewed prop</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] No ESLint errors in modified files
- [ ] Stories row displays with unviewed cards first
- [ ] Viewing a friend's story changes their card to gray border
- [ ] Viewed friend moves to end of row on next render
- [ ] View state persists across app restarts (within 24 hours)
</verification>

<success_criteria>

- All tasks completed
- useViewedStories hook created and working
- Stories sorted with unviewed first
- Marking as viewed works on modal close
- Visual distinction between viewed/unviewed cards
  </success_criteria>

<output>
After completion, create `.planning/phases/35-stories-redesign/35-02-SUMMARY.md`
</output>
