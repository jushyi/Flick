---
phase: 35.4-stories-feed-data-resume-fix
plan: 01
subsystem: feed
tags: [stories, feed, firestore, async-storage, react-hooks]

# Dependency graph
requires:
  - phase: 35.3-stories-performance-view-state-fix
    provides: expo-image performance, hasViewedAllPhotos tracking
provides:
  - All journaled photos in stories (not just top 5)
  - Chronological photo ordering (oldest first)
  - Correct friend row ordering (newest photo first)
  - Working resume position tracking
  - Accurate ring color based on ALL photos viewed
affects: [stories, feed, photo-modal]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - 'useRef for synchronous state access in React hooks'
    - 'Chronological sorting for timeline viewing (ascending)'

key-files:
  created: []
  modified:
    - src/services/firebase/feedService.js
    - src/screens/FeedScreen.js
    - src/hooks/useViewedStories.js
    - src/components/FriendStoryCard.js

key-decisions:
  - 'Fetch ALL journal photos instead of top 5 by engagement'
  - 'Sort photos ascending by capturedAt for timeline viewing'
  - 'Use thumbnailURL (most recent photo) for story card preview'
  - 'Use ref for immediate sync access to viewed photos (avoids React state async issues)'
  - 'Only mark friend as viewed (gray ring) when ALL photos viewed'

patterns-established:
  - 'useRef pattern for synchronous state access in hooks where timing matters'

issues-created: []

# Metrics
duration: 12min
completed: 2026-01-26
---

# Phase 35.4 Plan 01: Stories Feed Data & Resume Fix Summary

**Fixed stories to show ALL journaled photos in chronological order with working resume position tracking**

## Performance

- **Duration:** 12 min
- **Started:** 2026-01-26T04:00:00Z
- **Completed:** 2026-01-26T04:12:00Z
- **Tasks:** 3 (2 auto + 1 checkpoint)
- **Files modified:** 4

## Accomplishments

- Stories now fetch ALL journal photos per friend (not just top 5 by engagement)
- Photos sorted chronologically (oldest first) for natural timeline viewing
- Story card thumbnail shows most recent photo (newest)
- Friend row sorted by most recent photo (friends with new content first)
- Resume position works correctly (starts at first unviewed photo)
- Ring color accurate (gradient until ALL photos viewed, then gray)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fetch all photos in chronological order** - `38673d5` (feat)
2. **Task 2: Fix resume tracking with ref-based sync** - `71c16a8` (feat)

## Files Created/Modified

- `src/services/firebase/feedService.js` - Replace getTopPhotosByEngagement with direct query for ALL photos, sort ascending, add thumbnailURL
- `src/screens/FeedScreen.js` - Only mark photos up to current index as viewed, only mark friend viewed at end
- `src/hooks/useViewedStories.js` - Add viewedPhotosRef for immediate sync access, update getFirstUnviewedIndex/hasViewedAllPhotos to use ref
- `src/components/FriendStoryCard.js` - Use thumbnailURL if available for story card preview

## Decisions Made

1. **All photos vs top 5** - Fetch ALL journal photos to show complete content, not just engagement-ranked subset
2. **Chronological order** - Sort ascending by capturedAt for natural timeline viewing (oldest to newest)
3. **Thumbnail = most recent** - Story card shows newest photo as preview (last in sorted array)
4. **useRef for sync access** - React state updates are async; ref provides immediate access for resume calculation
5. **Partial view tracking** - Only mark photos up to current index as viewed, preserving resume position

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] React state async causing stale resume position**

- **Found during:** Task 2 verification (checkpoint)
- **Issue:** Resume was starting on the photo user left on, not the next unviewed one
- **Root cause:** React's setState is async; getFirstUnviewedIndex was reading stale viewedPhotos state
- **Fix:** Added viewedPhotosRef that updates synchronously, changed getFirstUnviewedIndex to use ref
- **Files modified:** src/hooks/useViewedStories.js
- **Verification:** Resume now correctly starts at first unviewed photo
- **Committed in:** 71c16a8 (amended)

---

**Total deviations:** 1 auto-fixed (bug)
**Impact on plan:** Fix was essential for correct resume behavior. No scope creep.

## Issues Encountered

None - plan executed as specified after the React state async fix.

## Next Phase Readiness

- Stories feature complete with all photos, correct ordering, and resume
- Ready for Phase 36 (Comments Feature) or Phase 37 (Profile Placeholder)
- No blockers

---

_Phase: 35.4-stories-feed-data-resume-fix_
_Completed: 2026-01-26_
