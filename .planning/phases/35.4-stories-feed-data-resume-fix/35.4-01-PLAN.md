---
phase: 35.4-stories-feed-data-resume-fix
plan: 01
type: execute
---

<objective>
Fix stories data fetching to show ALL journaled photos, correct story row ordering, and implement proper resume position tracking.

Purpose: Stories should show complete content in chronological order, with accurate ordering and resume behavior.
Output: Working stories experience with all photos, correct ordering, and functional resume.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35.4-stories-feed-data-resume-fix/35.4-CONTEXT.md

# Prior phase summaries (stories implementation):

@.planning/phases/35-stories-redesign/35-02-SUMMARY.md
@.planning/phases/35-stories-redesign/35-03-SUMMARY.md
@.planning/phases/35.3-stories-performance-view-state-fix/35.3-01-SUMMARY.md

# Key source files:

@src/services/firebase/feedService.js
@src/screens/FeedScreen.js
@src/hooks/useViewedStories.js
@src/components/FriendStoryCard.js

**Issues being fixed:**

1. Stories only show top 5 photos by engagement, not ALL journaled photos
2. Story row ordering incorrect - newly journaled photos don't move friend to front
3. Photos displayed in engagement order, not chronological (capturedAt) order
4. Resume tracking marks ALL photos viewed on close instead of just viewed ones

**Root causes identified:**

- `getTopPhotosByEngagement(friendId, 5)` limits to 5 photos sorted by reactionCount
- `mostRecentCapturedAt` calculated from limited topPhotos, missing new photos
- `handleCloseStories` marks ALL photos viewed, breaking resume functionality
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Fix stories data to fetch all photos in chronological order</name>
  <files>src/services/firebase/feedService.js, src/components/FriendStoryCard.js</files>
  <action>
Modify `getFriendStoriesData` in feedService.js:

1. Replace the `getTopPhotosByEngagement(friendId, 5)` call with a direct query that fetches ALL journal photos for the friend:

   ```javascript
   const photosQuery = query(
     collection(db, 'photos'),
     where('userId', '==', friendId),
     where('photoState', '==', 'journal')
   );
   const photosSnapshot = await getDocs(photosQuery);
   ```

2. Map and sort photos by `capturedAt` ASCENDING (oldest first for timeline viewing):

   ```javascript
   const allPhotos = photosSnapshot.docs
     .map(doc => ({
       id: doc.id,
       ...doc.data(),
     }))
     .sort((a, b) => {
       const aTime = a.capturedAt?.seconds || 0;
       const bTime = b.capturedAt?.seconds || 0;
       return aTime - bTime; // Ascending - oldest first
     });
   ```

3. Add `thumbnailURL` field using the MOST RECENT photo (last in array after sorting):

   ```javascript
   const thumbnailURL = allPhotos.length > 0 ? allPhotos[allPhotos.length - 1].imageURL : null;
   ```

4. Calculate `mostRecentCapturedAt` from ALL photos (already have allPhotos sorted, use last item):

   ```javascript
   const mostRecentCapturedAt =
     allPhotos.length > 0 ? allPhotos[allPhotos.length - 1].capturedAt?.seconds || 0 : 0;
   ```

5. Remove the separate `totalPhotosQuery` since we already have all photos - use `allPhotos.length` for `totalPhotoCount`.

6. In the returned friend object, keep `topPhotos` name but assign `allPhotos` to it (for backwards compatibility with FeedScreen):

   ```javascript
   topPhotos: allPhotos,
   thumbnailURL,
   ```

7. Update FriendStoryCard.js to use `thumbnailURL` if available:
   ```javascript
   const thumbnailUrl = friend.thumbnailURL || topPhotos?.[0]?.imageURL || null;
   ```

This shows the newest photo as preview while modal displays all photos oldest-to-newest.
</action>
<verify>
Add debug logging in getFriendStoriesData:

- Log photo count per friend (should be ALL journal photos, not just 5)
- Log photo order (first photo should be oldest by capturedAt)
- Log thumbnailURL (should be most recent photo)
  Test in app: Open a friend's story - should show all their photos in chronological order.
  </verify>
  <done>
- getFriendStoriesData returns ALL journal photos per friend
- Photos sorted by capturedAt ascending (oldest first)
- Story row sorted by mostRecentCapturedAt (friends with newest photos first)
- Thumbnail shows most recent photo
  </done>
  </task>

<task type="auto">
  <name>Task 2: Fix resume tracking to only mark viewed photos</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Modify `handleCloseStories` in FeedScreen.js to only mark photos up to current position as viewed:

1. Replace the current logic that marks ALL photos as viewed:

   ```javascript
   // OLD: Mark all photos as viewed
   const photoIds = (selectedFriend.topPhotos || []).map(p => p.id);
   if (photoIds.length > 0) {
     markPhotosAsViewed(photoIds);
   }
   ```

   With logic that only marks photos up to and including the current index:

   ```javascript
   // NEW: Only mark photos up to current position as viewed
   const allPhotos = selectedFriend.topPhotos || [];
   const isAtEnd = storiesCurrentIndex >= allPhotos.length - 1;

   if (isAtEnd) {
     // User viewed all photos - mark all as viewed (reset for next time)
     const photoIds = allPhotos.map(p => p.id);
     if (photoIds.length > 0) {
       markPhotosAsViewed(photoIds);
     }
     logger.info('FeedScreen: All photos viewed - marking all as viewed', {
       friendId: selectedFriend.userId,
       photoCount: photoIds.length,
     });
   } else {
     // User closed mid-story - only mark photos up to current index
     const viewedPhotoIds = allPhotos.slice(0, storiesCurrentIndex + 1).map(p => p.id);
     if (viewedPhotoIds.length > 0) {
       markPhotosAsViewed(viewedPhotoIds);
     }
     logger.info('FeedScreen: Partial view - marking photos up to current index', {
       friendId: selectedFriend.userId,
       currentIndex: storiesCurrentIndex,
       markedCount: viewedPhotoIds.length,
       totalCount: allPhotos.length,
     });
   }
   ```

2. Keep the `markAsViewed(selectedFriend.userId)` call for friend-level tracking (used for ring color when ALL photos viewed).

3. Note: The friend-level "viewed" state should only be set when ALL photos are viewed. Update to only call `markAsViewed` when at end:
   ```javascript
   if (isAtEnd) {
     markAsViewed(selectedFriend.userId);
     // ... mark all photos
   }
   ```

This ensures:

- Resume works: closing mid-story preserves position for next open
- Ring color accurate: only turns gray when ALL photos viewed
- Clean reset: when user finishes all photos, next open starts fresh
  </action>
  <verify>
  Test resume behavior:

1. Open a friend's story with 3+ photos
2. Navigate to photo 2, then close
3. Reopen the same friend's story
4. Should start at photo 3 (first unviewed), not photo 1
5. Navigate to the end, close
6. Reopen - should start at photo 1 (all were viewed, reset)
   </verify>
   <done>

- Closing mid-story only marks photos up to current index as viewed
- Resume position works correctly (starts at first unviewed photo)
- Ring color only changes to gray when ALL photos viewed
- Viewing all photos resets for next session
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stories data fetching and resume tracking fixes</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open Feed screen

    **Test 1: All photos showing**
    3. Find a friend with multiple journaled photos
    4. Tap their story card
    5. Verify: All photos appear (not just top 5)
    6. Verify: Photos are in chronological order (oldest first, progress through time)

    **Test 2: Story row ordering**
    7. If possible, have a friend journal a new photo
    8. Verify: Their story jumps to the front of the stories row

    **Test 3: Resume position**
    9. Open a friend's story with 3+ photos
    10. Navigate to photo 2 (middle), then close (swipe down)
    11. Reopen the same friend's story
    12. Verify: Starts at photo 3 (first unviewed), NOT photo 1

    **Test 4: Ring color**
    13. With the above partial view, check the story card ring
    14. Verify: Ring is still gradient (not gray) since not all photos viewed

    **Test 5: Full view reset**
    15. Open story, navigate to the very end (last photo)
    16. Close
    17. Check ring color - should now be gray (all viewed)
    18. Reopen - should start at photo 1 (reset)

  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Stories show ALL journaled photos from friends (not just top 5)
- [ ] Photos within stories are in chronological order (oldest to newest)
- [ ] Story row ordering: friends with newest photos appear first
- [ ] Resume position works (close mid-story, reopen at last position)
- [ ] Ring color accurate (gradient until ALL photos viewed)
- [ ] No TypeScript errors
- [ ] No console errors during navigation
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Stories data correctly fetched and ordered
- Resume tracking works as expected
- No regressions to stories functionality
  </success_criteria>

<output>
After completion, create `.planning/phases/35.4-stories-feed-data-resume-fix/35.4-01-SUMMARY.md`
</output>
