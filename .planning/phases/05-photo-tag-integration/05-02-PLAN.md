---
phase: 05-photo-tag-integration
plan: 02
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/components/TaggedPhotoBubble.js
  - src/styles/TaggedPhotoBubble.styles.js
  - src/components/MessageBubble.js
  - src/services/firebase/photoTagService.js
  - __tests__/components/TaggedPhotoBubble.test.js
  - __tests__/services/photoTagService.test.js
autonomous: true
requirements: [TAG-02, TAG-03]

must_haves:
  truths:
    - 'Tagged photo messages render as large photo cards in the DM conversation'
    - "Card shows header text: '[Name] tagged you in a photo' for recipient, 'You tagged [Name]' for sender"
    - 'Caption is NOT shown on the card (only visible in PhotoDetail)'
    - 'Photo card has distinct visual styling different from snap messages and regular messages'
    - "Inline 'Add to feed' button is visible on the card for recipient only"
    - "After adding, button becomes greyed-out 'Added to feed' (disabled state)"
    - 'Tapping the photo card calls onPress to open PhotoDetail'
    - 'Sender sees the same large photo card (no compact version)'
    - 'photoTagService.addTaggedPhotoToFeed calls httpsCallable and returns { success, newPhotoId } or { success: false, error }'
  artifacts:
    - path: 'src/components/TaggedPhotoBubble.js'
      provides: 'Tagged photo message rendering component'
      min_lines: 80
    - path: 'src/styles/TaggedPhotoBubble.styles.js'
      provides: 'Styles for tagged photo card'
      min_lines: 40
    - path: 'src/components/MessageBubble.js'
      provides: 'Extended with tagged_photo delegation'
      contains: 'isTaggedPhoto'
    - path: 'src/services/firebase/photoTagService.js'
      provides: 'Client-side addTaggedPhotoToFeed callable wrapper'
      exports: ['addTaggedPhotoToFeed']
    - path: '__tests__/components/TaggedPhotoBubble.test.js'
      provides: 'Tests for TaggedPhotoBubble rendering'
    - path: '__tests__/services/photoTagService.test.js'
      provides: 'Tests for photoTagService'
  key_links:
    - from: 'src/components/MessageBubble.js'
      to: 'src/components/TaggedPhotoBubble.js'
      via: 'component delegation for type:tagged_photo'
      pattern: 'isTaggedPhoto.*TaggedPhotoBubble'
    - from: 'src/components/TaggedPhotoBubble.js'
      to: 'src/services/firebase/photoTagService.js'
      via: 'addTaggedPhotoToFeed on button press'
      pattern: 'addTaggedPhotoToFeed'
    - from: 'src/services/firebase/photoTagService.js'
      to: 'functions/index.js addTaggedPhotoToFeed'
      via: 'httpsCallable'
      pattern: 'httpsCallable.*addTaggedPhotoToFeed'
---

<objective>
Build the TaggedPhotoBubble component for rendering tagged photo messages in DM conversations, the photoTagService client-side service for the add-to-feed flow, and the MessageBubble delegation. This creates the complete client-side rendering and interaction layer.

Purpose: Users see tagged photo messages as large, distinct photo cards in conversations with an inline "Add to feed" action button.

Output: TaggedPhotoBubble component + styles, photoTagService, MessageBubble delegation, tests.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-tag-integration/05-CONTEXT.md
@.planning/phases/05-photo-tag-integration/05-RESEARCH.md
@.planning/phases/05-photo-tag-integration/05-01-SUMMARY.md
@src/components/MessageBubble.js
@src/components/SnapBubble.js
@src/styles/SnapBubble.styles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TaggedPhotoBubble component + styles + photoTagService + MessageBubble delegation</name>
  <files>src/components/TaggedPhotoBubble.js, src/styles/TaggedPhotoBubble.styles.js, src/services/firebase/photoTagService.js, src/components/MessageBubble.js</files>
  <action>
**Part A: Create photoTagService.js**

Create `src/services/firebase/photoTagService.js` following the existing service layer pattern (`{ success, error }` returns):

```javascript
import { getFunctions, httpsCallable } from '@react-native-firebase/functions';
import logger from '../../utils/logger';

export const addTaggedPhotoToFeed = async (photoId, conversationId, messageId) => {
  try {
    const functions = getFunctions();
    const addToFeed = httpsCallable(functions, 'addTaggedPhotoToFeed');
    const result = await addToFeed({ photoId, conversationId, messageId });
    return { success: true, newPhotoId: result.data.newPhotoId };
  } catch (error) {
    logger.error('addTaggedPhotoToFeed failed', { error: error.message, photoId });
    return { success: false, error: error.message };
  }
};
```

**Part B: Create TaggedPhotoBubble.styles.js**

Create `src/styles/TaggedPhotoBubble.styles.js`. The card should have:

- Container: full message width (similar to image messages), with distinct border styling -- use a subtle colored border (e.g., `colors.accent` or a soft blue/teal, NOT amber which is snap-themed) to differentiate from snaps and regular messages. Use `Platform.select` for shadows (iOS shadow props, Android elevation).
- Header text area: padding, text styled with Silkscreen font (12px), `colors.text.secondary` color
- Photo: `aspectRatio: 4/3`, full card width, `borderRadius: 8`, uses `expo-image` with `contentFit: 'cover'` and `cachePolicy: 'memory-disk'`
- Button area: row layout, "Add to feed" button styled as a pill with pixel art aesthetics (Silkscreen font, colored background, ~32px height). Disabled state: grey background, "Added to feed" text.
- Timestamp: small text below the card, same style as other message timestamps

**Part C: Create TaggedPhotoBubble.js**

Create `src/components/TaggedPhotoBubble.js` following the SnapBubble delegation pattern.

Props: `message, isCurrentUser, showTimestamp, onPress, reactions, onReactionPress, currentUserId`

Component structure:

1. Import `useAuth` to get current user profile (for determining header text)
2. Import `addTaggedPhotoToFeed` from photoTagService
3. Track local state: `isAdding` (loading), `hasAdded` (derived from `message.addedToFeedBy?.[currentUserId]`)
4. Header text logic:
   - If recipient (not current user sent): "[senderName] tagged you in a photo"
   - If sender (current user sent): "You tagged a friend in a photo"
   - Need sender display name -- accept via message or look up from conversation context. The message has `senderId`; for simplicity, show "tagged you in a photo" for recipient and "You tagged in a photo" for sender.
5. Photo: render `message.photoURL` using `expo-image` with `cachePolicy: 'memory-disk'`. Include error handling (fallback to a placeholder icon if image fails).
6. "Add to feed" button:
   - Only visible for recipient (`!isCurrentUser`)
   - Disabled when `hasAdded` is true or `isAdding` is true
   - On press: set `isAdding = true`, call `addTaggedPhotoToFeed(message.photoId, conversationId, messageId)`. The `conversationId` is not directly on the message -- extract from the message's parent path, or pass it as a prop. Decision: pass `conversationId` as a prop from ConversationScreen (it already has it).
   - On success: `hasAdded` will update via real-time Firestore subscription when `addedToFeedBy` is written
   - On error: set `isAdding = false`, show nothing special (button remains tappable for retry)
   - Use `expo-haptics` (ImpactFeedbackStyle.Light) on successful add
7. Tapping the photo card: call `onPress(message)` to open PhotoDetail
8. Render `ReactionBadges` below the card if `reactions` exist (same pattern as SnapBubble)
9. Timestamp if `showTimestamp` is true

**Important:** Do NOT show caption on the card (per locked user decision -- caption only visible in PhotoDetail).

**Part D: Extend MessageBubble.js**

Add tagged_photo delegation following the exact same pattern as snap delegation:

1. After the existing `const isSnap = ...` line, add:

   ```javascript
   const isTaggedPhoto = message.type === 'tagged_photo';
   ```

2. After the existing snap delegation block (after `if (isSnap) { ... }`), add:

   ```javascript
   // Delegate tagged photo messages to dedicated TaggedPhotoBubble component
   // Placed after all hooks to satisfy Rules of Hooks
   if (isTaggedPhoto) {
     return (
       <TaggedPhotoBubble
         message={message}
         isCurrentUser={isCurrentUser}
         showTimestamp={showTimestamp}
         onPress={onPress}
         reactions={reactions}
         onReactionPress={onReactionPress}
         currentUserId={currentUserId}
         conversationId={conversationId}
       />
     );
   }
   ```

3. Ensure `conversationId` is available as a prop in MessageBubble. Check if it already receives it; if not, it will need to be passed from ConversationScreen. The existing MessageBubble receives props from `renderMessage` in ConversationScreen -- add `conversationId` to that render call.

Follow import organization per CLAUDE.md: React first, then third-party, then internal services, then components, then context/hooks, then utils.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern="TaggedPhotoBubble|photoTagService" --bail --no-coverage 2>&1 | tail -15</automated>
<manual>TaggedPhotoBubble component renders without errors. MessageBubble delegation works for tagged_photo type.</manual>
</verify>
<done> - TaggedPhotoBubble renders large photo card with header text, photo, and "Add to feed" button (recipient only) - Distinct visual styling differentiates from snaps and regular messages - Caption NOT shown on card - Sender sees same large card (no compact version) - photoTagService wraps httpsCallable with { success, error } pattern - MessageBubble delegates to TaggedPhotoBubble for type:tagged_photo (after all hooks)
</done>
</task>

<task type="auto">
  <name>Task 2: Tests for TaggedPhotoBubble and photoTagService</name>
  <files>__tests__/components/TaggedPhotoBubble.test.js, __tests__/services/photoTagService.test.js</files>
  <action>
**Part A: Create TaggedPhotoBubble.test.js**

Create `__tests__/components/TaggedPhotoBubble.test.js` following the existing component test patterns (jest-expo preset, Firebase mocked via setup):

1. "renders photo card with tagged photo image" -- Verify Image component receives message.photoURL
2. "shows 'tagged you in a photo' header for recipient" -- Render with isCurrentUser=false, verify header text
3. "shows sender header text for current user" -- Render with isCurrentUser=true, verify different header
4. "shows 'Add to feed' button for recipient only" -- isCurrentUser=false shows button, isCurrentUser=true does not
5. "shows 'Added to feed' disabled state when addedToFeedBy includes current user" -- Provide message with addedToFeedBy map, verify disabled button
6. "does NOT show caption text" -- Verify no caption text rendered even if message has photo caption data
7. "calls onPress when photo card is tapped" -- Verify onPress callback fired
8. "renders ReactionBadges when reactions exist" -- Pass reactions prop, verify rendered

Mock `useAuth` to return a test user profile. Mock `expo-image` Image component. Mock `addTaggedPhotoToFeed` from photoTagService.

**Part B: Create photoTagService.test.js**

Create `__tests__/services/photoTagService.test.js`:

1. "calls httpsCallable with correct function name" -- Verify 'addTaggedPhotoToFeed' passed to httpsCallable
2. "passes photoId, conversationId, messageId to callable" -- Verify correct params
3. "returns { success: true, newPhotoId } on success" -- Mock successful response
4. "returns { success: false, error } on failure" -- Mock callable rejection
5. "logs error on failure" -- Verify logger.error called

Mock `@react-native-firebase/functions` following the existing mock patterns in jest.setup.js.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest **tests**/components/TaggedPhotoBubble.test.js **tests**/services/photoTagService.test.js --bail --no-coverage 2>&1 | tail -15</automated>
<manual>All 13 tests pass.</manual>
</verify>
<done> - 8 TaggedPhotoBubble tests covering rendering, header variants, button states, no-caption, press handlers, reactions - 5 photoTagService tests covering callable invocation, params, success/error returns, logging - All tests pass
</done>
</task>

</tasks>

<verification>
```bash
# Run all phase 5 client-side tests
cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern="TaggedPhotoBubble|photoTagService" --bail --no-coverage

# Verify MessageBubble still passes existing tests

cd "C:/Users/maser/Lapse Clone" && npx jest **tests**/components/MessageBubble.test.js --bail --no-coverage

```
</verification>

<success_criteria>
- TaggedPhotoBubble renders as a large photo card with distinct styling
- Header text correctly shows "tagged you in a photo" or sender variant
- "Add to feed" button visible for recipient, greyed-out after adding
- Caption NOT displayed on card
- MessageBubble delegates tagged_photo to TaggedPhotoBubble after all hooks
- photoTagService correctly wraps httpsCallable
- All tests pass (client + existing MessageBubble tests unbroken)
</success_criteria>

<output>
After completion, create `.planning/phases/05-photo-tag-integration/05-02-SUMMARY.md`
</output>
```
