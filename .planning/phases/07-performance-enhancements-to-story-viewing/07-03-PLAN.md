---
phase: 07-performance-enhancements-to-story-viewing
plan: 03
type: execute
wave: 2
depends_on:
  - 07-01
  - 07-02
files_modified:
  - src/screens/PhotoDetailScreen.js
  - src/hooks/usePhotoDetailModal.js
  - src/context/PhotoDetailContext.js
autonomous: false
requirements:
  - PERF-01
  - PERF-02
  - PERF-04
  - PERF-06
  - PERF-07
must_haves:
  truths:
    - "When tapping to next photo, screen immediately shows dark background + spinner instead of lingering on previous image"
    - "New photos with thumbnails show a blurred placeholder that crossfades to full resolution over 200ms"
    - "Existing photos without thumbnails show dark background + spinner while loading"
    - "Cube transition rotates into dark background + spinner if next friend's photo is not yet loaded"
    - "Next friend's first photo is prefetched while viewing current friend"
    - "Within-friend next 2-3 photo prefetch (existing behavior) is preserved and functional"
    - "Firestore photo subscription pauses during transitions and resumes after settling"
    - "If an image fails to load after 5 seconds, auto-skips to next photo"
    - "Back-navigation to previously viewed photos loads instantly from cache"
  artifacts:
    - path: "src/screens/PhotoDetailScreen.js"
      provides: "Dark loading overlay, progressive placeholder, subscription pause/resume, prefetch next friend"
      contains: "thumbnailDataURL"
    - path: "src/hooks/usePhotoDetailModal.js"
      provides: "Auto-skip timeout on load failure, next-friend prefetch trigger"
      contains: "LOAD_FAILURE_TIMEOUT"
    - path: "src/context/PhotoDetailContext.js"
      provides: "Next friend's first photo data exposed for prefetching"
      contains: "nextFriendFirstPhoto"
  key_links:
    - from: "src/screens/PhotoDetailScreen.js"
      to: "src/services/firebase/photoService.js"
      via: "subscriptionRef.current = subscribePhoto(photoId, callback) with local pauseSubscription/resumeSubscription wrappers"
      pattern: "subscribePhoto.*photoId"
    - from: "src/hooks/usePhotoDetailModal.js"
      to: "expo-image"
      via: "Image.prefetch for next friend's first photo"
      pattern: "Image\\.prefetch"
    - from: "src/screens/PhotoDetailScreen.js"
      to: "thumbnailDataURL"
      via: "expo-image placeholder prop reads thumbnail from photo document"
      pattern: "placeholder.*thumbnailDataURL"
---

<objective>
Implement progressive image loading, immediate dark loading states, Firestore subscription management during transitions, auto-skip on failure, and next-friend prefetching.

Purpose: Deliver the visual loading improvements (dark bg + spinner on tap, blurred placeholder crossfade) and the performance optimizations (subscription pausing, smarter prefetching, auto-skip) that complete the story viewing experience. This plan builds on the Reanimated cube (Plan 02) and thumbnail generation (Plan 01).
Output: PhotoDetailScreen shows progressive loading with placeholder crossfade, immediately shows dark bg on photo change, pauses subscriptions during transitions, auto-skips failed images, and prefetches next friend's photo.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-CONTEXT.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-RESEARCH.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-01-SUMMARY.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-02-SUMMARY.md
@src/screens/PhotoDetailScreen.js
@src/hooks/usePhotoDetailModal.js
@src/context/PhotoDetailContext.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement dark loading overlay and progressive placeholder on PhotoDetailScreen</name>
  <files>src/screens/PhotoDetailScreen.js</files>
  <action>
Add immediate dark background + spinner loading state and progressive loading via expo-image placeholder:

1. **Immediate dark overlay on photo change (within-friend taps):**
   The existing code already tracks `imageLoading` state and resets it when `contextPhoto?.id` changes. Currently, the loading spinner overlays the Image component but the old image still shows through (expo-image keeps the previous image until the new one loads with `transition={0}`).

   Change the loading overlay to be a full dark background that completely covers the image:
   ```jsx
   {/* Photo container */}
   <View style={styles.photoScrollView}>
     {/* Dark loading overlay — covers photo completely during loading */}
     {imageLoading && (
       <View style={localStyles.darkLoadingOverlay}>
         <ActivityIndicator size="small" color="rgba(255, 255, 255, 0.6)" />
       </View>
     )}
     <Image
       source={{ uri: imageURL, cacheKey: `photo-${currentPhoto?.id}` }}
       placeholder={currentPhoto?.thumbnailDataURL ? { uri: currentPhoto.thumbnailDataURL } : undefined}
       placeholderContentFit="cover"
       style={styles.photo}
       contentFit="cover"
       cachePolicy="memory-disk"
       transition={currentPhoto?.thumbnailDataURL ? 200 : 0}
       priority={isTransitioning ? 'normal' : 'high'}
       onLoadStart={handleImageLoadStart}
       onLoadEnd={handleImageLoadEnd}
     />
   </View>
   ```

   Update `localStyles.darkLoadingOverlay`:
   ```javascript
   darkLoadingOverlay: {
     ...StyleSheet.absoluteFillObject,
     backgroundColor: '#000',
     justifyContent: 'center',
     alignItems: 'center',
     zIndex: 2,
   },
   ```

   Remove the old `imageLoadingSpinner` style — it's replaced by the dark overlay.

   IMPORTANT: When `thumbnailDataURL` exists, expo-image will show the placeholder first and crossfade to the full image over 200ms (via `transition={200}`). The dark overlay still shows on top until the image (or placeholder) triggers `onLoadEnd`. Since the placeholder is a tiny base64 data URL, it loads nearly instantly, so the dark overlay flashes briefly then reveals the blurred placeholder, which then crossfades to the full image. This gives the perceived speed improvement.

   When `thumbnailDataURL` is NOT present (existing photos), the dark overlay shows until the full image loads (transition stays at 0 — no crossfade needed since there's no placeholder to fade from).

2. **Cube transition shows dark + spinner on incoming face:**
   The cube transition already shows the incoming face. When it rotates in, if the next friend's first photo hasn't loaded yet, the dark overlay + spinner will naturally be visible (since `imageLoading` starts true on photo change). No additional work needed for this — it's handled by the same loading overlay.

   However, make sure the snapshot outgoing face does NOT show a loading overlay. The outgoing face should show the frozen image (already correct — snapshot uses the cached imageURL).

3. **Update snapshot to include thumbnailDataURL:**
   In the snapshot ref update block:
   ```javascript
   snapshotRef.current = {
     ...existing fields,
     thumbnailDataURL: currentPhoto?.thumbnailDataURL || null,
   };
   ```

   In the outgoing face Image component, add the placeholder prop:
   ```jsx
   <Image
     source={{
       uri: snapshotRef.current.imageURL,
       cacheKey: snapshotRef.current.photoId ? `photo-${snapshotRef.current.photoId}` : undefined,
     }}
     placeholder={snapshotRef.current.thumbnailDataURL ? { uri: snapshotRef.current.thumbnailDataURL } : undefined}
     placeholderContentFit="cover"
     style={styles.photo}
     contentFit="cover"
     cachePolicy="memory-disk"
     transition={0}
   />
   ```
   The outgoing face uses `transition={0}` always — it shows the already-loaded image, no crossfade needed.

CRITICAL: Do NOT change the expand/collapse animation, dismiss animation, or cube animation code. Only change the Image component props and loading overlay rendering.
  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npx eslint src/screens/PhotoDetailScreen.js --no-error-on-unmatched-pattern && npm test -- --testPathPattern="PhotoDetailScreen" --bail</automated>
    <manual>In stories mode: (1) Tap to next photo — should immediately show dark bg + spinner, NOT linger on previous image. (2) If viewing a new photo with thumbnail, see blurred placeholder that crossfades to full image. (3) Cube transition — incoming face shows dark bg + spinner until image loads.</manual>
  </verify>
  <done>Tapping to next photo immediately shows dark background + spinner. New photos with thumbnails show blurred placeholder that crossfades over 200ms. Cube incoming face shows dark overlay until image loads. Old photos without thumbnails show dark bg + spinner fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Add subscription pause/resume, auto-skip on failure, and next-friend prefetching</name>
  <files>src/screens/PhotoDetailScreen.js, src/hooks/usePhotoDetailModal.js, src/context/PhotoDetailContext.js</files>
  <action>
Implement three remaining performance features: subscription management during transitions, auto-skip on load failure, and next-friend photo prefetching.

**A. Firestore subscription pause/resume (PhotoDetailScreen.js):**

1. Refactor the existing photo subscription `useEffect` into pause/resume functions:
   ```javascript
   const subscriptionRef = useRef(null);

   const pauseSubscription = useCallback(() => {
     if (subscriptionRef.current) {
       logger.debug('PhotoDetailScreen: Pausing photo subscription');
       subscriptionRef.current();
       subscriptionRef.current = null;
     }
   }, []);

   const resumeSubscription = useCallback((photoId) => {
     pauseSubscription();
     if (!photoId) return;

     logger.debug('PhotoDetailScreen: Resuming photo subscription', { photoId });
     subscriptionRef.current = subscribePhoto(photoId, result => {
       if (result.success && result.photo) {
         updateCurrentPhoto(result.photo);
       } else {
         logger.warn('PhotoDetailScreen: Photo subscription error', { error: result.error });
       }
     });
   }, [pauseSubscription, updateCurrentPhoto]);
   ```

2. Replace the existing subscription `useEffect` with one that uses these functions:
   ```javascript
   useEffect(() => {
     if (!contextPhoto?.id) return;
     resumeSubscription(contextPhoto.id);
     return () => pauseSubscription();
   }, [contextPhoto?.id, resumeSubscription, pauseSubscription]);
   ```

3. Call `pauseSubscription()` at the START of cube transitions:
   - In `handleFriendTransition`, add `pauseSubscription()` before `cubeProgress.value = 0;`
   - In `handlePreviousFriendTransition`, add `pauseSubscription()` before `cubeProgress.value = 0;`
   - In `handlePrepareSwipeTransition`, add `pauseSubscription()` before `cubeProgress.value = 0;`

   The subscription will auto-resume when contextPhoto.id changes (via the useEffect).

**B. Auto-skip on load failure (usePhotoDetailModal.js):**

4. Add a load failure timeout constant and ref:
   ```javascript
   const LOAD_FAILURE_TIMEOUT = 5000; // ms — auto-skip after 5 seconds
   const loadFailureTimeoutRef = useRef(null);
   ```

5. Add `startLoadTimer` and `clearLoadTimer` functions:
   ```javascript
   const clearLoadTimer = useCallback(() => {
     if (loadFailureTimeoutRef.current) {
       clearTimeout(loadFailureTimeoutRef.current);
       loadFailureTimeoutRef.current = null;
     }
   }, []);

   const startLoadTimer = useCallback(() => {
     clearLoadTimer();
     if (mode !== 'stories') return;
     loadFailureTimeoutRef.current = setTimeout(() => {
       logger.warn('usePhotoDetailModal: Image load timeout, auto-skipping', {
         photoId: currentPhoto?.id,
       });
       goNext();
     }, LOAD_FAILURE_TIMEOUT);
   }, [clearLoadTimer, mode, goNext, currentPhoto?.id]);
   ```

6. Expose `startLoadTimer` and `clearLoadTimer` from the hook return so PhotoDetailScreen can call them:
   ```javascript
   return {
     // ... existing returns
     startLoadTimer,
     clearLoadTimer,
   };
   ```

7. Clean up on unmount:
   ```javascript
   useEffect(() => {
     return () => {
       // ... existing cleanup
       clearLoadTimer();
     };
   }, [clearLoadTimer]);
   ```

**In PhotoDetailScreen.js:**

8. Destructure `startLoadTimer` and `clearLoadTimer` from the hook.

9. Update `handleImageLoadStart` to start the timer:
   ```javascript
   const handleImageLoadStart = useCallback(() => {
     setImageLoading(true);
     startLoadTimer();
   }, [startLoadTimer]);
   ```

10. Update `handleImageLoadEnd` to clear the timer:
    ```javascript
    const handleImageLoadEnd = useCallback(() => {
      setImageLoading(false);
      clearLoadTimer();
    }, [clearLoadTimer]);
    ```

**C. Within-friend photo prefetch — verify existing implementation (usePhotoDetailModal.js):**

NOTE: The codebase already prefetches the next 2 photos within the current friend's story (usePhotoDetailModal.js lines ~206-223: a useEffect that runs on `currentIndex` change, calling `Image.prefetch` for the next 2 photos). This satisfies the within-friend portion of PERF-04 ("next 2-3 photos within current friend are prefetched"). Do NOT remove or duplicate this existing prefetch logic. Verify it still works after the auto-skip timer changes above. If the `goNext` function signature or the `photos` array handling changed in Task B, ensure the existing prefetch useEffect still references the correct variables.

**D. Next-friend photo prefetching (PhotoDetailContext.js + usePhotoDetailModal.js):**

12. In `PhotoDetailContext.js`, find where the story sequence is stored. Look for `storySequenceRef` or equivalent. Add a function or value that exposes the next friend's first photo URL:
    - In the context provider, add a `getNextFriendFirstPhotoURL` function (or compute it from the sequence data when mode is 'stories')
    - This should return the imageURL of the first photo of the next friend in the sequence, or null if at the last friend

    If the sequence data is managed entirely in FeedScreen (not in context), an alternative approach:
    - In `usePhotoDetailModal.js`, accept a new `nextFriendFirstPhotoURL` prop
    - Have FeedScreen compute and pass this when opening stories

    Choose the simpler approach: since FeedScreen already manages `storySequenceRef` and handles `handleRequestNextFriend`, add a `getNextFriendFirstPhotoURL` callback to the context. FeedScreen provides this callback via `setCallbacks`:
    ```javascript
    // In FeedScreen, when setting callbacks:
    setCallbacks({
      // ... existing callbacks
      getNextFriendFirstPhotoURL: () => {
        const sequence = storySequenceRef.current;
        // Find current friend index in sequence
        // Return first photo URL of next friend, or null
      },
    });
    ```

    In PhotoDetailContext, expose this via `getCallbacks()`.

13. In `usePhotoDetailModal.js`, add a prefetch effect that runs when currentIndex changes (at the last photo of current friend, prefetch next friend's first photo):
    ```javascript
    // Prefetch next friend's first photo when near the end of current friend's story
    useEffect(() => {
      if (mode !== 'stories' || !visible) return;
      if (currentIndex >= photos.length - 2) {
        // Near end of current friend's story — prefetch next friend's first photo
        const callbacks = getCallbacksRef?.current?.();
        const nextURL = callbacks?.getNextFriendFirstPhotoURL?.();
        if (nextURL) {
          Image.prefetch([nextURL], 'memory-disk').catch(() => {});
          logger.debug('usePhotoDetailModal: Prefetched next friend first photo');
        }
      }
    }, [mode, visible, currentIndex, photos.length]);
    ```

    Pass `getCallbacks` (or a ref to it) into the hook via a new parameter. Since `getCallbacks` is already available on the context, either pass it as a prop to the hook or access it inside the hook.

    The simplest approach: accept an `onGetNextFriendPhotoURL` callback prop:
    ```javascript
    // In hook params:
    onGetNextFriendPhotoURL, // () => string|null — returns next friend's first photo URL
    ```

    In PhotoDetailScreen, pass it:
    ```javascript
    onGetNextFriendPhotoURL: () => {
      const callbacks = getCallbacks();
      return callbacks?.getNextFriendFirstPhotoURL?.();
    },
    ```

CRITICAL CONSTRAINTS:
- Subscription pause/resume must not leak listeners — always call pauseSubscription before resumeSubscription
- Auto-skip timeout must be cleared on unmount, on successful load, and on manual navigation
- Next-friend prefetch is best-effort — failures are silently ignored
- Do NOT modify the cube animation code or gesture handler (done in Plan 02)
  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npx eslint src/screens/PhotoDetailScreen.js src/hooks/usePhotoDetailModal.js src/context/PhotoDetailContext.js --no-error-on-unmatched-pattern && npm test -- --bail</automated>
    <manual>(1) View stories, note smooth transitions without visible subscription flicker. (2) Simulate slow network — after 5 seconds on a loading photo, it should auto-skip to next. (3) In stories near the last photo of a friend, check network tab — next friend's first photo should be prefetching.</manual>
  </verify>
  <done>Firestore subscription pauses during cube transitions and resumes on settle. Failed image loads auto-skip after 5 seconds. Next friend's first photo is prefetched when near end of current friend's story. All existing navigation and animation behavior preserved.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete story viewing performance on device</name>
  <files>N/A</files>
  <action>
Human verification of the complete Phase 7 story viewing performance optimization across all three plans.

What was built:
- Feed story card pagination with "Load more" button (Plan 01)
- Thumbnail generation at upload for progressive loading (Plan 01)
- 60fps Reanimated cube transitions with Gesture Handler (Plan 02)
- Progressive loading with blurred placeholder crossfade (Plan 03)
- Dark background + spinner on photo navigation (Plan 03)
- Firestore subscription pause/resume during transitions (Plan 03)
- Auto-skip on load failure after 5 seconds (Plan 03)
- Next-friend photo prefetching (Plan 03)

Verify on a real device (both iOS and Android if possible):
1. Open the feed — story cards appear in batches with "More" button at the end
2. Tap "More" — next batch of friend story cards loads
3. Tap a friend's story card — photo detail opens with expand animation
4. Tap right to advance within a friend — previous image immediately replaced by dark bg + spinner, then new image loads (with placeholder crossfade if thumbnail exists)
5. Advance past last photo — cube rotates to next friend at 60fps
6. Swipe horizontally between friends — interactive cube tracks finger smoothly
7. Half-swipe then release — cube springs back
8. Wait for a photo that takes >5s to load — auto-skips to next photo
9. Swipe down to dismiss — suck-back animation works as before
10. Test on Android device — cube is smooth, android back button dismisses
  </action>
  <verify>Visual inspection on real device</verify>
  <done>All story viewing performance features verified on device. User approves the experience.</done>
</task>

</tasks>

<verification>
1. Feed pagination: story cards in batches of 10, "More" button loads next batch
2. Progressive loading: new photos show blurred placeholder → crossfade to full image
3. Dark loading state: tapping next photo shows dark bg + spinner immediately
4. Cube transition: 60fps rotation on both iOS and Android
5. Interactive swipe: finger-tracking cube with commit/cancel
6. Subscription: no reaction update flicker during transitions
7. Auto-skip: failed loads skip after 5 seconds
8. Prefetching: next friend's first photo prefetched proactively
9. All existing animations (expand, dismiss, suck-back) unchanged
10. Full test suite passes: `npm test -- --bail`
</verification>

<success_criteria>
- Progressive loading with thumbnail placeholder and 200ms crossfade works for new photos
- Dark background + spinner shows immediately on photo navigation
- Cube incoming face shows dark overlay until image loads
- Firestore subscription pauses during transitions, resumes after settling
- Auto-skip fires after 5s load failure in stories mode
- Next friend's first photo prefetched when near end of current friend's story
- All existing behavior (expand, dismiss, reactions, comments) preserved
- No regressions in full test suite
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-enhancements-to-story-viewing/07-03-SUMMARY.md`
</output>
