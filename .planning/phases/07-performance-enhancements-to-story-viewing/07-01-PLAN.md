---
phase: 07-performance-enhancements-to-story-viewing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/screens/FeedScreen.js
  - src/services/uploadQueueService.js
  - src/services/firebase/photoService.js
autonomous: true
requirements:
  - PERF-05
  - PERF-08
must_haves:
  truths:
    - "Feed story cards load in batches of 10, not all at once"
    - "A 'Load more' button appears below the last visible friend story card when more friends exist"
    - "Tapping 'Load more' reveals the next batch of 10 friend story cards"
    - "Stories mode only includes friends already loaded in the feed (locked sequence)"
    - "New photos generate a tiny thumbnail stored as base64 data URL in the Firestore photo document"
    - "Existing photos without thumbnails still display correctly (dark background fallback)"
  artifacts:
    - path: "src/screens/FeedScreen.js"
      provides: "Paginated story card rendering with Load more button"
      contains: "STORY_BATCH_SIZE"
    - path: "src/services/uploadQueueService.js"
      provides: "Thumbnail generation during upload pipeline"
      contains: "generateThumbnail"
    - path: "src/services/firebase/photoService.js"
      provides: "thumbnailDataURL field written to photo document"
      contains: "thumbnailDataURL"
  key_links:
    - from: "src/services/uploadQueueService.js"
      to: "src/services/firebase/photoService.js"
      via: "thumbnailDataURL passed through upload pipeline to createPhoto"
      pattern: "thumbnailDataURL"
    - from: "src/screens/FeedScreen.js"
      to: "storySequenceRef"
      via: "visibleCount state slices sortedFriends before locking sequence"
      pattern: "visibleCount|STORY_BATCH_SIZE"
---

<objective>
Add feed story card pagination with a "Load more" button and generate tiny thumbnails at photo upload time for progressive loading.

Purpose: Reduce initial feed render cost by loading story cards in batches, and lay the foundation for progressive image loading by generating thumbnails during the upload pipeline.
Output: FeedScreen renders story cards in batches with a Load more button; upload pipeline generates and stores a thumbnail data URL in each photo's Firestore document.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-CONTEXT.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-RESEARCH.md
@src/screens/FeedScreen.js
@src/services/uploadQueueService.js
@src/services/firebase/photoService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add feed story card pagination with "Load more" button</name>
  <files>src/screens/FeedScreen.js</files>
  <action>
Add batched story card rendering to FeedScreen's `renderStoriesRow()` function:

1. Add a constant `STORY_BATCH_SIZE = 10` near the top of FeedScreen (with the other layout constants).

2. Add a `visibleStoryCount` state initialized to `STORY_BATCH_SIZE`:
   ```javascript
   const [visibleStoryCount, setVisibleStoryCount] = useState(STORY_BATCH_SIZE);
   ```

3. In `renderStoriesRow()`, where `sortedFriends` is computed from `[...friendStories].sort(...)`, slice it:
   ```javascript
   const visibleFriends = sortedFriends.slice(0, visibleStoryCount);
   const hasMoreFriends = visibleStoryCount < sortedFriends.length;
   ```

4. Replace the `sortedFriends.map(...)` in the JSX with `visibleFriends.map(...)`.

5. After the `.map()` block (still inside the ScrollView), add a "Load more" button when `hasMoreFriends` is true:
   ```jsx
   {hasMoreFriends && (
     <TouchableOpacity
       style={styles.loadMoreStoriesButton}
       onPress={() => setVisibleStoryCount(prev => prev + STORY_BATCH_SIZE)}
       activeOpacity={0.7}
     >
       <PixelIcon name="chevron-forward" size={16} color={colors.text.secondary} />
       <Text style={styles.loadMoreStoriesText}>More</Text>
     </TouchableOpacity>
   )}
   ```

6. Add styles for the Load more button at the bottom of the StyleSheet:
   ```javascript
   loadMoreStoriesButton: {
     width: 56,
     height: 80,
     justifyContent: 'center',
     alignItems: 'center',
     backgroundColor: colors.background.tertiary,
     borderRadius: layout.borderRadius.sm,
     marginLeft: spacing.xs,
     gap: 4,
   },
   loadMoreStoriesText: {
     fontSize: 9,
     fontFamily: typography.fontFamily.bodyBold,
     color: colors.text.secondary,
   },
   ```

7. CRITICAL: In `handleOpenStories()` (the function that locks `storySequenceRef`), update it to use only the currently visible friends. The existing code already sorts `friendStories` and sets `storySequenceRef.current = sortedFriends` — change this to use the same visible slice:
   ```javascript
   // Only include friends currently visible in the feed
   storySequenceRef.current = sortedFriends.slice(0, visibleStoryCount);
   ```
   This ensures "In stories mode, only friends already loaded in the feed are available for swiping" per the user's locked decision.

8. Reset `visibleStoryCount` to `STORY_BATCH_SIZE` when the feed is refreshed (in the `refreshFeed` or `handleRefresh` function) so a pull-to-refresh starts from batch 1 again.

Do NOT change any other behavior in FeedScreen. The "Load more" button is purely additive.
  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npx eslint src/screens/FeedScreen.js --no-error-on-unmatched-pattern</automated>
    <manual>Open the app, verify story cards show in batches with a "More" button at the end. Tap "More" to load next batch.</manual>
  </verify>
  <done>Feed story cards render in batches of 10. A "More" button appears after the last visible card when more friends exist. Tapping it loads the next batch. Pull-to-refresh resets to the first batch. Stories mode sequence only includes visible friends.</done>
</task>

<task type="auto">
  <name>Task 2: Generate thumbnail at upload time and store in Firestore photo document</name>
  <files>src/services/uploadQueueService.js, src/services/firebase/photoService.js</files>
  <action>
Add thumbnail generation to the upload pipeline so new photos have a `thumbnailDataURL` field in their Firestore document:

1. In `uploadQueueService.js`, add a `generateThumbnail` helper function near the top (after imports):
   ```javascript
   import * as ImageManipulator from 'expo-image-manipulator';
   import * as FileSystem from 'expo-file-system';
   ```

   ```javascript
   /**
    * Generate a tiny thumbnail for progressive loading placeholder.
    * Creates a 20px wide JPEG, reads it as base64, returns a data URL.
    * Returns null on failure (non-critical — photo uploads without thumbnail).
    */
   const generateThumbnail = async (photoUri) => {
     try {
       const result = await ImageManipulator.manipulateAsync(
         photoUri,
         [{ resize: { width: 20 } }],
         { format: ImageManipulator.SaveFormat.JPEG, compress: 0.5 }
       );
       const base64 = await FileSystem.readAsStringAsync(result.uri, {
         encoding: FileSystem.EncodingType.Base64,
       });
       return `data:image/jpeg;base64,${base64}`;
     } catch (error) {
       logger.warn('uploadQueueService: Thumbnail generation failed', { error: error.message });
       return null;
     }
   };
   ```

2. In the `processQueueItem` function (or equivalent upload processing function), BEFORE calling `createPhoto`, generate the thumbnail from the local photo URI:
   ```javascript
   const thumbnailDataURL = await generateThumbnail(item.photoUri);
   ```
   Then pass it to `createPhoto`:
   ```javascript
   const result = await createPhoto(userId, item.photoUri, { thumbnailDataURL });
   ```

3. In `photoService.js`, update the `createPhoto` function signature to accept an options parameter:
   ```javascript
   export const createPhoto = async (userId, photoUri, options = {}) => {
   ```

   In the `addDoc` call where the photo document is created, include the thumbnail if provided:
   ```javascript
   const docData = {
     userId,
     imageURL: '',
     capturedAt: serverTimestamp(),
     status: 'developing',
     ...(options.thumbnailDataURL && { thumbnailDataURL: options.thumbnailDataURL }),
   };
   const photoRef = await addDoc(photosCollection, docData);
   ```

4. Verify that `expo-image-manipulator` is already in the project (it should be — RESEARCH.md mentions it's "existing"). If not, run `npx expo install expo-image-manipulator`.

5. Verify that `expo-file-system` is already in the project (standard Expo module). If not, run `npx expo install expo-file-system`.

IMPORTANT: This is a non-critical enhancement. If thumbnail generation fails, the photo still uploads normally without a thumbnail. The `generateThumbnail` function catches all errors and returns null.

Do NOT modify the upload queue retry logic, error handling, or any other upload behavior. This is purely additive.
  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npm test -- --testPathPattern="uploadQueue|photoService" --bail 2>/dev/null; npx eslint src/services/uploadQueueService.js src/services/firebase/photoService.js --no-error-on-unmatched-pattern</automated>
    <manual>Take a photo in the app, then check the Firestore photo document for a `thumbnailDataURL` field containing a base64 data URL.</manual>
  </verify>
  <done>New photos have a `thumbnailDataURL` field in their Firestore document containing a ~20px wide base64 JPEG. Thumbnail generation failures do not block photo uploads. Existing photos without thumbnails are unaffected.</done>
</task>

</tasks>

<verification>
1. Open FeedScreen — story cards appear in batches of 10 with "More" button
2. Tap "More" — next batch of friends appears
3. Open stories mode — only visible friends are in the swipe sequence
4. Pull-to-refresh — story count resets to first batch
5. Take a new photo — Firestore document contains `thumbnailDataURL` field
6. ESLint passes on all modified files
</verification>

<success_criteria>
- Feed story cards paginate in batches of STORY_BATCH_SIZE (10)
- "More" button loads additional batches
- Stories mode sequence respects pagination boundary
- New photos generate and store thumbnail data URLs
- Existing photos without thumbnails work unchanged
- No regressions in upload queue behavior or feed loading
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-enhancements-to-story-viewing/07-01-SUMMARY.md`
</output>
