---
phase: 07-performance-enhancements-to-story-viewing
plan: 00
type: execute
wave: 0
depends_on: []
files_modified:
  - __tests__/hooks/usePhotoDetailModal.test.js
  - __tests__/screens/PhotoDetailScreen.test.js
  - __tests__/screens/FeedScreen.test.js
autonomous: true
requirements:
  - PERF-01
  - PERF-02
  - PERF-04
  - PERF-05
  - PERF-06
  - PERF-07
must_haves:
  truths:
    - "Test scaffold files exist for all behaviors added in Plans 01-03"
    - "Tests are RED (failing or skipped) before implementation begins"
    - "Test patterns follow existing project conventions (jest.mock, renderHook, etc.)"
  artifacts:
    - path: "__tests__/hooks/usePhotoDetailModal.test.js"
      provides: "Test scaffold for prefetch, auto-skip, and photo navigation behaviors"
      contains: "usePhotoDetailModal"
    - path: "__tests__/screens/PhotoDetailScreen.test.js"
      provides: "New test cases for progressive loading, dark bg on tap, subscription pause/resume"
      contains: "progressive|darkLoadingOverlay|subscription"
    - path: "__tests__/screens/FeedScreen.test.js"
      provides: "Test scaffold for story card pagination with Load more button"
      contains: "STORY_BATCH_SIZE|Load more"
  key_links:
    - from: "__tests__/hooks/usePhotoDetailModal.test.js"
      to: "src/hooks/usePhotoDetailModal.js"
      via: "renderHook testing hook behavior"
      pattern: "renderHook.*usePhotoDetailModal"
    - from: "__tests__/screens/FeedScreen.test.js"
      to: "src/screens/FeedScreen.js"
      via: "render testing pagination UI"
      pattern: "render.*FeedScreen"
---

<objective>
Create test scaffold files with RED (failing/skipped) tests for all Phase 7 behaviors before implementation begins.

Purpose: Satisfy the Nyquist rule — every plan task's `<verify>` must have an automated test command that references an existing test file. This Wave 0 plan creates the test scaffolds so Plans 01-03 can run tests as part of their verify steps.
Output: Three test files with skipped/placeholder tests covering feed pagination, progressive loading, dark loading states, subscription management, auto-skip, and prefetch behaviors.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-CONTEXT.md
@.planning/phases/07-performance-enhancements-to-story-viewing/07-RESEARCH.md
@__tests__/screens/PhotoDetailScreen.test.js
@__tests__/hooks/useFeedPhotos.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test scaffold for usePhotoDetailModal and FeedScreen, extend PhotoDetailScreen tests</name>
  <files>__tests__/hooks/usePhotoDetailModal.test.js, __tests__/screens/FeedScreen.test.js, __tests__/screens/PhotoDetailScreen.test.js</files>
  <action>
Create two new test files and add new test cases to the existing PhotoDetailScreen test file. All new tests should be `test.skip(...)` or `it.todo(...)` so they show as skipped/pending (RED state) until implementation fills them in.

**1. Create `__tests__/hooks/usePhotoDetailModal.test.js`:**

Follow the same mock patterns as existing hook tests (e.g., `useComments.test.js`, `useFeedPhotos.test.js`). Include:

```javascript
/**
 * usePhotoDetailModal Unit Tests
 *
 * Test scaffold for Phase 7 performance behaviors:
 * - Within-friend photo prefetch (next 2-3 photos)
 * - Auto-skip on image load failure
 * - Next-friend photo prefetch
 */

// Mock navigation, logger, expo-image, contexts, and services
// following existing patterns from __tests__/hooks/ files

describe('usePhotoDetailModal', () => {
  describe('within-friend photo prefetch', () => {
    it.todo('prefetches next 2 photos when currentIndex changes');
    it.todo('does not prefetch when not in stories mode');
    it.todo('does not prefetch when at end of photos array');
  });

  describe('auto-skip on load failure', () => {
    it.todo('startLoadTimer triggers goNext after LOAD_FAILURE_TIMEOUT');
    it.todo('clearLoadTimer cancels pending auto-skip');
    it.todo('auto-skip only fires in stories mode');
    it.todo('successful load clears the timeout');
  });

  describe('next-friend prefetch', () => {
    it.todo('prefetches next friend first photo when near end of current friend story');
    it.todo('does not prefetch when not near end of story');
  });
});
```

Set up the standard mocks (navigation, logger, expo-image with `Image.prefetch` as jest.fn(), PhotoDetailContext, AuthContext) so the file is ready for implementation to fill in.

**2. Create `__tests__/screens/FeedScreen.test.js`:**

Follow mock patterns from existing screen tests (e.g., `SettingsScreen.test.js`, `PhotoDetailScreen.test.js`). Include:

```javascript
/**
 * FeedScreen Unit Tests
 *
 * Test scaffold for Phase 7 story card pagination.
 */

// Mock navigation, logger, contexts, hooks, services, and components

describe('FeedScreen', () => {
  describe('story card pagination', () => {
    it.todo('renders only STORY_BATCH_SIZE friends initially');
    it.todo('shows "More" button when more friends exist beyond batch');
    it.todo('does not show "More" button when all friends are visible');
    it.todo('tapping "More" reveals next batch of friend story cards');
    it.todo('stories mode sequence only includes visible friends');
  });
});
```

Set up mocks for AuthContext, useFeedPhotos, navigation, and any components used in FeedScreen's stories row.

**3. Extend `__tests__/screens/PhotoDetailScreen.test.js`:**

Append new `describe` blocks to the EXISTING test file (do NOT replace existing tests). Add:

```javascript
describe('progressive loading', () => {
  it.todo('renders placeholder prop with thumbnailDataURL when available');
  it.todo('sets transition={200} when thumbnailDataURL exists');
  it.todo('sets transition={0} when thumbnailDataURL is absent');
});

describe('dark loading overlay', () => {
  it.todo('shows dark overlay with spinner when imageLoading is true');
  it.todo('hides dark overlay when image finishes loading');
  it.todo('shows dark overlay immediately on photo change');
});

describe('subscription pause/resume', () => {
  it.todo('pauses subscription at start of cube transition');
  it.todo('resumes subscription when contextPhoto.id changes');
  it.todo('cleans up subscription on unmount');
});
```

IMPORTANT: Only append — do NOT modify or remove any existing tests in PhotoDetailScreen.test.js.
  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npm test -- --testPathPattern="usePhotoDetailModal|FeedScreen|PhotoDetailScreen" --bail</automated>
    <manual>Check that all new tests show as "skipped" or "todo" in test output, and existing PhotoDetailScreen tests still pass.</manual>
  </verify>
  <done>Three test files exist: usePhotoDetailModal.test.js (new), FeedScreen.test.js (new), PhotoDetailScreen.test.js (extended). All new tests are skipped/todo. Existing tests pass. Test commands in Plans 01-03 verify steps can now reference these files.</done>
</task>

</tasks>

<verification>
1. `npm test -- --testPathPattern="usePhotoDetailModal" --bail` — runs, shows skipped tests
2. `npm test -- --testPathPattern="FeedScreen" --bail` — runs, shows skipped tests
3. `npm test -- --testPathPattern="PhotoDetailScreen" --bail` — runs, existing tests pass, new tests show as skipped
4. No test failures in full suite: `npm test -- --bail`
</verification>

<success_criteria>
- __tests__/hooks/usePhotoDetailModal.test.js exists with skipped tests for prefetch, auto-skip
- __tests__/screens/FeedScreen.test.js exists with skipped tests for pagination
- __tests__/screens/PhotoDetailScreen.test.js has new skipped tests for progressive loading, dark overlay, subscription management
- All existing tests continue to pass
- Plans 01-03 verify commands can reference these test files
</success_criteria>

<output>
After completion, create `.planning/phases/07-performance-enhancements-to-story-viewing/07-00-SUMMARY.md`
</output>
