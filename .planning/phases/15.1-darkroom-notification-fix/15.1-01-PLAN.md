---
phase: 15.1-darkroom-notification-fix
plan: 01
type: execute
---

<objective>
Fix darkroom notification spam and implement reveal-all-on-tap behavior.

Purpose: Current notifications fire every darkroom trigger (~2 min) even with 0 photos, and multiple notifications send for the same batch. Users should only receive one notification per batch of photos that become ready, and tapping the notification should reveal all photos immediately.

Output: Updated Cloud Function with smarter notification logic, updated app to reveal all photos on notification tap.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-background-photo-upload/15-01-SUMMARY.md

**Key Files:**
@functions/index.js - Cloud Functions including sendPhotoRevealNotification
@src/services/firebase/notificationService.js - Client-side notification handling
@App.js - Notification tap handler and navigation
@src/components/DarkroomBottomSheet.js - Current reveal UI

**Current Issues:**
1. `sendPhotoRevealNotification` fires on every darkroom update (every 2 min schedule)
2. Notification checks `status: 'revealed'` but reveals happen continuously
3. No tracking of "already notified" state for photo batches
4. Notification tap opens darkroom but doesn't auto-reveal

**Tech Context:**
- Cloud Functions: Firebase v1 (not v2), Node.js 20 runtime
- Notification service: Expo Push API via fetch
- App: React Native + Expo managed workflow
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notification tracking to Cloud Function</name>
  <files>functions/index.js</files>
  <action>
Modify `sendPhotoRevealNotification` to only send notifications when photos actually transition from developing to revealed:

1. Before sending notification, check if there are photos with `status: 'revealed'` that were revealed in THIS batch (revealedAt matches lastRevealedAt within 5 second tolerance)

2. Add `lastNotifiedAt` field to darkroom document to track when we last sent a notification

3. Only send notification if:
   - `photosRevealed > 0` (there were actually photos revealed)
   - `lastNotifiedAt` is null OR `lastNotifiedAt < lastRevealedAt` (haven't notified for this batch yet)

4. After sending notification, update darkroom with `lastNotifiedAt: serverTimestamp()`

5. Query photos that were revealed in this specific batch (revealedAt close to lastRevealedAt) to get accurate count

Why this approach: The current trigger fires on every darkroom update. By tracking lastNotifiedAt we ensure one notification per reveal batch, not per schedule run.
  </action>
  <verify>
Deploy function and check logs:
- `firebase deploy --only functions:sendPhotoRevealNotification`
- Wait for scheduled reveal (2 min) with 0 photos - should log "No photos revealed, skipping notification"
- Wait for reveal with photos - should log "Notification sent" only once
- Next schedule run should log "Already notified for this batch"
  </verify>
  <done>
- Notification only fires once per batch of revealed photos
- No notification when 0 photos revealed
- lastNotifiedAt field tracks notification state
  </done>
</task>

<task type="auto">
  <name>Task 2: Pass revealedCount in notification data payload</name>
  <files>functions/index.js</files>
  <action>
Update the notification data payload to include the count of photos that were just revealed:

1. In `sendPhotoRevealNotification`, after counting revealed photos, include in data payload:
```javascript
{
  type: 'photo_reveal',
  revealedCount: photosRevealed,  // Count from this specific batch
  revealAll: true  // Signal to app to auto-reveal
}
```

2. This data will be used by the app to know how many photos to expect and trigger auto-reveal

Why: The app needs to know how many photos are in this batch and that it should auto-reveal them rather than show the normal press-and-hold UI.
  </action>
  <verify>
Check notification payload in logs:
- Deploy and trigger a reveal
- Verify log shows data payload with revealedCount and revealAll fields
  </verify>
  <done>
- Notification data includes revealedCount and revealAll fields
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement reveal-all-on-tap in app</name>
  <files>App.js, src/services/firebase/notificationService.js</files>
  <action>
Update notification tap handler to auto-reveal all photos when notification includes `revealAll: true`:

1. In `notificationService.js` - Update `handleNotificationTapped` to extract and return `revealAll` and `revealedCount` from data:
```javascript
case 'photo_reveal':
  return {
    success: true,
    data: {
      type: 'photo_reveal',
      screen: 'Camera',  // Navigate to camera (darkroom is accessed from there)
      params: {
        openDarkroom: true,
        revealAll: data.revealAll || false,
        revealedCount: data.revealedCount || 0
      },
    },
  };
```

2. In `App.js` - Update the notification response listener to pass params to navigation:
   - Extract `revealAll` and `revealedCount` from navigation data
   - Pass as route params when navigating to Camera screen

3. The CameraScreen can then check for these params on mount/focus and auto-open darkroom in "reveal all" mode

Why: Users expect tapping "Photos ready!" notification to immediately show them the photos, not require another press-and-hold interaction.
  </action>
  <verify>
- Build the app
- Trigger notification (may need to wait for scheduled reveal or manually trigger)
- Tap notification when received
- Verify navigation includes revealAll and revealedCount params
  </verify>
  <done>
- Notification tap extracts revealAll and revealedCount
- Navigation passes params to Camera screen
- Params ready to be consumed by camera/darkroom UI
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `firebase deploy --only functions` succeeds without errors
- [ ] Cloud Function logs show notification only sent once per reveal batch
- [ ] Cloud Function logs show "skipping notification" when 0 photos revealed
- [ ] Notification data payload includes revealedCount and revealAll fields
- [ ] App compiles without errors after notification handler changes
</verification>

<success_criteria>

- Notification spam eliminated (one notification per batch, none for 0 photos)
- Notification data includes reveal information
- App handles reveal-all flag in notification tap
- All changes deployed and working
</success_criteria>

<output>
After completion, create `.planning/phases/15.1-darkroom-notification-fix/15.1-01-SUMMARY.md`

Note: This plan covers notification fix and reveal-all-on-tap. iOS Live Activities (persistent lock screen widget) is deferred to 15.1-02 as it requires:
- Native Swift/SwiftUI code with ActivityKit
- expo-live-activity library (early stage)
- Development build (not Expo Go compatible)
- Separate discovery/research phase
</output>
