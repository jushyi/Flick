---
phase: 15.1-darkroom-notification-fix
plan: 01
subsystem: notifications
tags: [cloud-functions, push-notifications, darkroom, expo]

requires:
  - phase: 15-background-photo-upload
    provides: background upload infrastructure
provides:
  - one notification per reveal batch (no spam)
  - revealAll and revealedCount in notification payload
  - reveal-all-on-tap navigation params
affects: [notifications, darkroom, camera]

tech-stack:
  added: []
  patterns: [notification-deduplication, batch-tracking]

key-files:
  created: []
  modified: [functions/index.js, App.js, src/services/firebase/notificationService.js]

key-decisions:
  - "Use lastNotifiedAt field in darkroom document to track notification state"
  - "5-second tolerance window for matching photos to reveal batch"
  - "Convert string values from push data to proper boolean/number types"

patterns-established:
  - "Notification deduplication: lastNotifiedAt >= lastRevealedAt check"
  - "Batch photo matching: revealedAt timestamp within tolerance window"

issues-created: []

duration: 10min
completed: 2026-01-21
---

# Phase 15.1 Plan 01: Darkroom Notification Fix Summary

**Eliminated notification spam by tracking lastNotifiedAt and implemented reveal-all-on-tap behavior with revealedCount in payload.**

## Performance

- **Duration:** 10 minutes
- **Started:** 2026-01-21
- **Completed:** 2026-01-21
- **Tasks:** 3/3 (Task 2 merged into Task 1)
- **Files modified:** 3

## Accomplishments

- Added `lastNotifiedAt` field to darkroom documents for notification deduplication
- Only send notification when photosRevealed > 0 AND haven't notified for this batch
- Count photos by revealedAt timestamp within 5-second tolerance of batch time
- Include `revealedCount` and `revealAll` in notification data payload
- Updated notification tap handler to extract and pass reveal params
- App now navigates with openDarkroom, revealAll, revealedCount params

## Task Commits

1. **Task 1 & 2: Add notification tracking + pass revealedCount** - `86ee5d9` (fix)
2. **Task 3: Implement reveal-all-on-tap** - `ce2555d` (fix)

## Files Modified

### functions/index.js - +64/-22 lines
- Check if lastRevealedAt actually changed before sending
- Check lastNotifiedAt to prevent duplicate notifications for same batch
- Count photos revealed within 5-second tolerance of lastRevealedAt
- Skip notification if 0 photos revealed (but still update lastNotifiedAt)
- Include revealedCount (string) and revealAll ('true') in data payload
- Update lastNotifiedAt after sending notification

### src/services/firebase/notificationService.js - +12/-4 lines
- Extract revealAll and revealedCount from notification data
- Convert string values to proper types (boolean/number)
- Change screen target from 'Darkroom' to 'Camera'
- Include openDarkroom, revealAll, revealedCount in params

### App.js - +3/-4 lines
- Change screen check from 'Darkroom' to 'Camera'
- Pass all params object instead of just { openDarkroom: true }
- Replace console.log with logger.info

## Decisions Made

1. **lastNotifiedAt field**: Stored in darkroom document for easy comparison with lastRevealedAt
2. **5-second tolerance**: Accounts for batch commit timing differences when matching photos
3. **String conversion**: Push notification data comes as strings, must convert to boolean/number

## Deviations from Plan

- **Task 2 merged into Task 1**: Both required editing the same Cloud Function code section, so revealedCount and revealAll were added during Task 1 for efficiency

## Issues Encountered

None - all tasks completed successfully without blockers.

## How It Works

### Notification Deduplication Flow
1. `sendPhotoRevealNotification` triggers on darkroom update
2. Check if `lastRevealedAt` actually changed (a real reveal event)
3. Check if `lastNotifiedAt >= lastRevealedAt` (already notified)
4. Count photos where `revealedAt` is within 5 seconds of `lastRevealedAt`
5. If 0 photos, skip notification but update `lastNotifiedAt`
6. If photos > 0, send notification with count, then update `lastNotifiedAt`

### Notification Tap Flow
1. User taps "Photos Ready!" notification
2. `handleNotificationTapped` extracts revealAll='true', revealedCount='N'
3. Converts to `{ openDarkroom: true, revealAll: true, revealedCount: N }`
4. App.js navigates to Camera with these params
5. Camera/Darkroom UI can use params for auto-reveal behavior

## Next Steps

- CameraScreen can check for revealAll param on focus to auto-open darkroom
- DarkroomBottomSheet can skip hold-to-reveal if revealAll=true
- Deploy Cloud Function: `firebase deploy --only functions:sendPhotoRevealNotification`

---
*Phase: 15.1-darkroom-notification-fix*
*Completed: 2026-01-21*
