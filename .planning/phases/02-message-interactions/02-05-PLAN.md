---
phase: 02-message-interactions
plan: 05
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/components/ReactionPicker.js
  - src/components/ReplyPreview.js
  - src/components/PixelConfirmDialog.js
  - src/components/index.js
autonomous: true
requirements:
  - REACT-02
  - REPLY-02

must_haves:
  truths:
    - 'Long-press opens a floating overlay with emoji row above message and action menu below'
    - 'Overlay has dark semi-transparent backdrop, tap anywhere outside dismisses'
    - 'Reply preview shows mini message bubble above DMInput with cancel button'
    - 'Custom pixel-themed confirmation dialog replaces native Alert for delete'
  artifacts:
    - path: 'src/components/ReactionPicker.js'
      provides: 'Floating overlay with emoji picker row + text action menu (Reply, Unsend, Delete for me)'
      contains: 'ReactionPicker'
    - path: 'src/components/ReplyPreview.js'
      provides: 'Compact preview bar above DMInput showing message being replied to'
      contains: 'ReplyPreview'
    - path: 'src/components/PixelConfirmDialog.js'
      provides: 'Custom pixel-themed modal dialog for delete confirmation'
      contains: 'PixelConfirmDialog'
  key_links:
    - from: 'src/components/ReactionPicker.js'
      to: 'src/hooks/useMessageActions.js'
      via: 'receives onReaction, onReply, onUnsend, onDelete callbacks'
      pattern: 'onReaction|onReply|onUnsend'
    - from: 'src/components/ReplyPreview.js'
      to: 'src/components/DMInput.js'
      via: 'rendered above DMInput in ConversationScreen'
      pattern: 'ReplyPreview'
---

<objective>
Create the three overlay/floating UI components for message interactions: ReactionPicker (emoji row + action menu), ReplyPreview (compose bar), and PixelConfirmDialog (delete confirmation).

Purpose: These are the user-facing interaction surfaces. ReactionPicker is the primary interaction point for reactions, replies, and unsend. ReplyPreview shows context during reply composition. PixelConfirmDialog provides themed confirmation per user decision (no native alerts).
Output: Three new components ready for integration in Plan 06.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-message-interactions/02-CONTEXT.md
@.planning/phases/02-message-interactions/02-RESEARCH.md
@src/components/DMInput.js
@src/constants/colors.js
@src/constants/typography.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReactionPicker overlay component with emoji row and action menu</name>
  <files>src/components/ReactionPicker.js</files>
  <action>
Create the iMessage-style long-press overlay that shows emoji reactions above the message and text actions below.

**Imports:**

```javascript
import React, { useEffect } from 'react';
import { View, Text, Pressable, Modal, StyleSheet, useWindowDimensions } from 'react-native';
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  withSpring,
} from 'react-native-reanimated';
import { colors } from '../constants/colors';
import { typography } from '../constants/typography';
```

**Props:**

- `visible` ‚Äî boolean controlling modal visibility
- `message` ‚Äî the target message object (for determining available actions)
- `position` ‚Äî `{ x, y, width, height }` of the target message bubble
- `isCurrentUser` ‚Äî boolean (determines if Unsend/Delete actions show)
- `canUnsend` ‚Äî boolean (within 15-minute window for this message)
- `onReaction` ‚Äî callback `(emoji)` when emoji tapped
- `onReply` ‚Äî callback when Reply tapped
- `onUnsend` ‚Äî callback when Unsend tapped
- `onDeleteForMe` ‚Äî callback when Delete for me tapped
- `onClose` ‚Äî callback to dismiss overlay

**Layout (iMessage-style):**
The overlay is a full-screen Modal (transparent background) with:

1. **Dark backdrop:** `rgba(0, 0, 0, 0.5)` covering the entire screen. Tapping backdrop calls `onClose`.

2. **Scaled message preview:** A copy/representation of the long-pressed message, slightly scaled up (transform scale 1.05) at its original position. This provides the "lifted" feel.

3. **Emoji row (ABOVE the message):** A horizontal row of 6 emoji buttons positioned above the message position:

   ```
   ‚ù§Ô∏è  üòÇ  üòÆ  üò¢  üò°  üëç
   ```

   Each emoji in a circular pressable (40x40), with a slight bounce animation on appear (withSpring). The emoji row has a dark blurred background (rgba(30,30,40,0.9)), borderRadius 20, padding 8.

4. **Action menu (BELOW the message):** A vertical list of text-only action items positioned below the message position:
   - "Reply" ‚Äî always shown, calls onReply then onClose
   - "Unsend" ‚Äî shown only if `isCurrentUser && canUnsend`, calls onUnsend then onClose
   - "Delete for me" ‚Äî shown only if `isCurrentUser`, calls onDeleteForMe (which should trigger PixelConfirmDialog externally)

   Menu styling: dark background (rgba(30,30,40,0.95)), borderRadius 12, each item is a Pressable with padding 14, text in white Silkscreen (pixel font) 13px, separated by thin divider lines (rgba(255,255,255,0.1)).

**Positioning logic:**

- Use `position.y` to determine if the message is in the top or bottom half of the screen
- If top half: emoji row above message, action menu below message (default)
- If bottom half: action menu above message, emoji row below message (flip to avoid going off-screen)
- Use `useWindowDimensions()` for screen bounds checking
- Ensure the overlay never extends beyond screen edges (clamp positions)

**Animations:**

- Overlay fades in (backdrop opacity 0->0.5 in 200ms)
- Emoji row and action menu scale in from 0.8->1.0 with spring (stiffness 200, damping 20)
- On close: reverse fade (200ms)

**Emoji data:**

```javascript
const REACTION_EMOJIS = [
  { key: 'heart', char: '‚ù§Ô∏è' },
  { key: 'laugh', char: 'üòÇ' },
  { key: 'surprise', char: 'üòÆ' },
  { key: 'sad', char: 'üò¢' },
  { key: 'angry', char: 'üò°' },
  { key: 'thumbs_up', char: 'üëç' },
];
```

**Retro pixel aesthetic:**

- Menu background: dark navy matching the app theme (~rgba(20, 20, 40, 0.95))
- Text: white, Silkscreen font for action labels (matching retro style)
- Emoji container: slight border (rgba(255,255,255,0.15))
- No icons on menu items per user decision ("text-only context menu labels")
  </action>
  <verify>
  <automated>npx jest --testPathPattern="**tests**/components" --bail 2>&1 | tail -5</automated>
  <manual>Verify ReactionPicker renders emoji row + action menu with correct positioning logic</manual>
  </verify>
  <done>ReactionPicker overlay renders floating emoji row above message and text action menu below, with dark backdrop, spring animations, and retro pixel styling</done>
  </task>

<task type="auto">
  <name>Task 2: Create ReplyPreview and PixelConfirmDialog components</name>
  <files>src/components/ReplyPreview.js, src/components/PixelConfirmDialog.js, src/components/index.js</files>
  <action>
**1. Create src/components/ReplyPreview.js:**

A compact bar rendered above DMInput showing the message being replied to.

Props:

- `message` ‚Äî the message object being replied to
- `senderName` ‚Äî display name of the message sender (or "You" if current user)
- `onCancel` ‚Äî callback to clear reply mode

Rendering:

```jsx
<Animated.View style={[styles.container, animatedStyle]}>
  <View style={styles.content}>
    <View style={styles.accentBar} />
    <View style={styles.textContainer}>
      <Text style={styles.replyToLabel}>Replying to {senderName}</Text>
      <Text style={styles.previewText} numberOfLines={1}>
        {message.type === 'image'
          ? 'üì∑ Photo'
          : message.type === 'gif'
            ? 'GIF'
            : message.text || ''}
      </Text>
    </View>
    <Pressable onPress={onCancel} hitSlop={8} style={styles.cancelButton}>
      <Ionicons name="close" size={18} color={colors.textSecondary} />
    </Pressable>
  </View>
</Animated.View>
```

Styling:

- Container: borderTopWidth 1, borderColor rgba(255,255,255,0.1), backgroundColor matching input area (#0A0A1A or similar dark)
- Accent bar: 3px wide, cyan/accent color, full height, left side
- Reply label: Silkscreen font, 10px, cyan accent color
- Preview text: 12px, gray (#7B7B9E), numberOfLines 1 with ellipsis
- Cancel X: right-aligned, 18px icon
- Height: compact, ~44px total

Animation: slides up from bottom on appear (translateY 44->0, 200ms withTiming).

Swipe down gesture: if user swipes the preview downward (>30px), call onCancel. Use a simple Pan gesture with vertical detection.

**2. Create src/components/PixelConfirmDialog.js:**

A custom modal dialog styled in the retro 16-bit pixel aesthetic. Replaces native Alert.alert for the "Delete for me" confirmation.

Props:

- `visible` ‚Äî boolean
- `title` ‚Äî dialog title (e.g., "Delete Message")
- `message` ‚Äî dialog body text (e.g., "This will only remove it from your view")
- `confirmText` ‚Äî confirm button label (e.g., "Delete")
- `cancelText` ‚Äî cancel button label (default "Cancel")
- `onConfirm` ‚Äî callback when confirmed
- `onCancel` ‚Äî callback when cancelled
- `destructive` ‚Äî boolean, if true the confirm button is red/warning colored

Rendering:

```jsx
<Modal transparent visible={visible} animationType="fade">
  <View style={styles.overlay}>
    <View style={styles.dialog}>
      <Text style={styles.title}>{title}</Text>
      <Text style={styles.message}>{message}</Text>
      <View style={styles.buttonRow}>
        <Pressable onPress={onCancel} style={styles.button}>
          <Text style={styles.cancelText}>{cancelText}</Text>
        </Pressable>
        <Pressable onPress={onConfirm} style={[styles.button, styles.confirmButton]}>
          <Text style={[styles.confirmText, destructive && styles.destructiveText]}>
            {confirmText}
          </Text>
        </Pressable>
      </View>
    </View>
  </View>
</Modal>
```

Pixel aesthetic styling:

- Dialog: dark background (#1A1A2E), border 2px solid rgba(255,255,255,0.2), borderRadius 8
- Title: Silkscreen font, 16px, white, centered
- Message: Silkscreen font, 12px, gray (#7B7B9E), centered
- Buttons: horizontal row, separated by border. Cancel = gray text, Confirm = cyan text (or red if destructive)
- Button press state: backgroundColor rgba(255,255,255,0.05)
- Overlay: rgba(0,0,0,0.6)
- Width: 80% of screen, maxWidth 300

**3. Update barrel exports in src/components/index.js:**
Add exports for ReactionPicker, ReplyPreview, and PixelConfirmDialog:

```javascript
export { default as ReactionPicker } from './ReactionPicker';
export { default as ReplyPreview } from './ReplyPreview';
export { default as PixelConfirmDialog } from './PixelConfirmDialog';
```

  </action>
  <verify>
    <automated>npx jest --testPathPattern="__tests__/components" --bail 2>&1 | tail -5</automated>
    <manual>Verify ReplyPreview shows message preview with cancel button, PixelConfirmDialog renders modal with pixel styling</manual>
  </verify>
  <done>ReplyPreview renders compact bar with sender name, message preview, and cancel X. PixelConfirmDialog renders pixel-themed modal with confirm/cancel buttons. Both exported from barrel.</done>
</task>

</tasks>

<verification>
- ReactionPicker renders 6 emoji buttons in horizontal row
- ReactionPicker shows Reply (always), Unsend (conditional), Delete for me (conditional) as text actions
- ReactionPicker positions above/below message based on screen position
- ReplyPreview shows sender name and truncated message text
- ReplyPreview dismissable via X button or swipe down
- PixelConfirmDialog matches retro pixel aesthetic (Silkscreen font, dark theme)
- All three components exported from index.js barrel
</verification>

<success_criteria>

- Three new overlay/floating components created with full retro pixel styling
- ReactionPicker implements iMessage-style floating layout per user decision
- ReplyPreview shows message type labels for image/GIF (no thumbnails per user decision)
- PixelConfirmDialog replaces native Alert per user decision
- Components are self-contained and ready for integration in Plan 06
  </success_criteria>

<output>
After completion, create `.planning/phases/02-message-interactions/02-05-SUMMARY.md`
</output>
