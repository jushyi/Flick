---
phase: 02-message-interactions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/firebase/messageService.js
  - __tests__/services/messageService.test.js
autonomous: true
requirements:
  - REACT-04
  - REPLY-03

must_haves:
  truths:
    - "sendReaction creates a type:'reaction' message document with emoji and targetMessageId"
    - "removeReaction creates a type:'reaction' message with emoji:null as removal sentinel"
    - 'sendReply creates a message with denormalized replyTo object containing original message preview'
    - 'deleteMessageForMe adds message ID to conversation deletedMessages array for the user'
  artifacts:
    - path: 'src/services/firebase/messageService.js'
      provides: 'sendReaction, removeReaction, sendReply, deleteMessageForMe service functions'
      contains: 'sendReaction'
    - path: '__tests__/services/messageService.test.js'
      provides: 'Tests for all new message service functions'
      contains: 'sendReaction'
  key_links:
    - from: 'src/services/firebase/messageService.js'
      to: 'conversations/{id}/messages'
      via: 'addDoc for reactions and replies'
      pattern: 'addDoc.*messagesRef'
---

<objective>
Add reaction, reply, and delete-for-me service functions to messageService.js

Purpose: Establish the data layer for all Phase 2 message interactions. These service functions are consumed by hooks and UI components in later plans.
Output: Four new exported functions (sendReaction, removeReaction, sendReply, deleteMessageForMe) with comprehensive tests.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-message-interactions/02-CONTEXT.md
@.planning/phases/02-message-interactions/02-RESEARCH.md
@.planning/phases/01-message-infrastructure-read-receipts/01-01-SUMMARY.md
@src/services/firebase/messageService.js
@__tests__/services/messageService.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sendReaction, removeReaction, and sendReply to messageService</name>
  <files>src/services/firebase/messageService.js</files>
  <action>
Add three new exported functions to messageService.js following the existing `{ success, error }` return pattern:

**1. sendReaction(conversationId, senderId, targetMessageId, emoji)**

- Validate all params (return error if missing)
- Create a message document in `conversations/{conversationId}/messages/` with shape:
  ```
  { senderId, type: 'reaction', emoji, targetMessageId, text: null, gifUrl: null, imageUrl: null, createdAt: serverTimestamp() }
  ```
- `emoji` is one of: 'heart', 'laugh', 'surprise', 'sad', 'angry', 'thumbs_up'
- Return `{ success: true, messageId }` on success

**2. removeReaction(conversationId, senderId, targetMessageId)**

- Validate all params
- Create a message document with `emoji: null` as the removal sentinel:
  ```
  { senderId, type: 'reaction', emoji: null, targetMessageId, text: null, gifUrl: null, imageUrl: null, createdAt: serverTimestamp() }
  ```
- This sentinel approach avoids needing a Cloud Function to delete reaction docs (Firestore rules deny client delete)
- Return `{ success: true }` on success

**3. sendReply(conversationId, senderId, text, gifUrl, imageUrl, replyToMessage)**

- Validate conversationId, senderId, and replyToMessage (must have id, senderId, type)
- Determine type from content: imageUrl -> 'image', gifUrl -> 'gif', else 'text'
- Create message document with `replyTo` denormalized preview:
  ```
  {
    senderId,
    text: gifUrl || imageUrl ? null : text,
    gifUrl: gifUrl || null,
    imageUrl: imageUrl || null,
    type,
    replyTo: {
      messageId: replyToMessage.id,
      senderId: replyToMessage.senderId,
      type: replyToMessage.type,
      text: replyToMessage.type === 'text' ? (replyToMessage.text || '').substring(0, 100) : null,
      deleted: false,
    },
    createdAt: serverTimestamp(),
  }
  ```
- Do NOT store image URLs in replyTo (only type label) -- avoids signed URL expiry issues
- Return `{ success: true, messageId }` on success

Add these exports to the existing export list at the bottom of the file. Follow the exact code style of the existing `sendMessage` function for consistency.
</action>
<verify>
<automated>npx jest **tests**/services/messageService.test.js --bail 2>&1 | tail -5</automated>
<manual>Check that messageService.js exports sendReaction, removeReaction, sendReply</manual>
</verify>
<done>Three new functions exported from messageService.js, each following the { success, error } pattern with proper validation</done>
</task>

<task type="auto">
  <name>Task 2: Add deleteMessageForMe to messageService and write tests for all new functions</name>
  <files>src/services/firebase/messageService.js, __tests__/services/messageService.test.js</files>
  <action>
**1. Add deleteMessageForMe to messageService.js:**

**deleteMessageForMe(conversationId, userId, messageId)**

- Validate all params
- Uses `updateDoc` on the conversation document to add messageId to `deletedMessages.{userId}` array:
  ```
  updateDoc(conversationRef, {
    [`deletedMessages.${userId}`]: arrayUnion(messageId)
  })
  ```
- Import `arrayUnion` from `@react-native-firebase/firestore` (add to existing import block)
- Return `{ success: true }` on success, `{ success: false, error }` on failure

**2. Add comprehensive tests to **tests**/services/messageService.test.js:**

Add a new describe block after the existing tests. Mock `addDoc` and `updateDoc` at the module level (follow existing mock pattern in the file).

Test cases to add:

**sendReaction tests (4):**

- Returns success with messageId when called with valid params
- Returns error when conversationId is missing
- Creates doc with correct shape (type: 'reaction', emoji, targetMessageId, null text/gifUrl/imageUrl)
- Uses serverTimestamp() for createdAt

**removeReaction tests (2):**

- Returns success when called with valid params
- Creates doc with emoji: null (removal sentinel)

**sendReply tests (4):**

- Returns success with messageId for text reply
- Creates doc with correct replyTo shape (messageId, senderId, type, text truncated to 100 chars, deleted: false)
- For image reply: sets type to 'image', text to null
- Returns error when replyToMessage is missing

**deleteMessageForMe tests (3):**

- Returns success when called with valid params
- Calls updateDoc with arrayUnion on deletedMessages.{userId}
- Returns error when params are missing

Follow the existing test patterns in the file: mock functions defined outside jest.mock(), referenced inside mock returns.
</action>
<verify>
<automated>npx jest **tests**/services/messageService.test.js --bail --verbose 2>&1 | tail -30</automated>
</verify>
<done>All 13+ new tests pass. deleteMessageForMe exported. sendReaction, removeReaction, sendReply, deleteMessageForMe all tested with valid and invalid inputs.</done>
</task>

</tasks>

<verification>
- `npx jest __tests__/services/messageService.test.js --bail` passes all tests (existing + new)
- messageService.js exports: sendReaction, removeReaction, sendReply, deleteMessageForMe
- Reaction document shape matches research pattern: type:'reaction', emoji, targetMessageId
- Reply document shape includes denormalized replyTo with deleted:false flag
- deleteMessageForMe uses arrayUnion for atomic array updates
</verification>

<success_criteria>

- Four new service functions exported and tested
- All existing messageService tests continue to pass (no regressions)
- Service functions follow established { success, error } return pattern
- Tests cover happy path, validation failures, and document shape verification
  </success_criteria>

<output>
After completion, create `.planning/phases/02-message-interactions/02-01-SUMMARY.md`
</output>
