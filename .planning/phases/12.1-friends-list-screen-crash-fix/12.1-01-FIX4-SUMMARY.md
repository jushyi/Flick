---
phase: 12.1-friends-list-screen-crash-fix
plan: 01-FIX4
subsystem: auth
tags: [firestore, security-rules, friendships]

# Dependency graph
requires:
  - phase: 12.1-01-FIX3
    provides: Fixed getSentRequests query pattern
provides:
  - Firestore rules allow reading non-existent friendship documents
  - sendFriendRequest works for new friendships
  - checkFriendshipStatus works for users with no prior interaction
affects: [friendships, social-features]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "isFriendshipMemberById() - parse document ID for security rules"

key-files:
  created: []
  modified:
    - firestore.rules

key-decisions:
  - "Combined two rule approaches: isFriendshipMember for collection queries, isFriendshipMemberById for direct reads"

patterns-established:
  - "Parse deterministic document IDs in security rules to allow reads on non-existent documents"

issues-created: []

# Metrics
duration: 8min
completed: 2026-01-20
---

# Phase 12.1 Plan 01-FIX4: Fix Friend Request Permission Error Summary

**Added isFriendshipMemberById() helper to Firestore rules, enabling direct document reads on non-existent friendship documents for checkFriendshipStatus() and sendFriendRequest()**

## Performance

- **Duration:** 8 min
- **Started:** 2026-01-20T14:26:00Z
- **Completed:** 2026-01-20T14:34:00Z
- **Tasks:** 1 (+ 1 checkpoint)
- **Files modified:** 1

## Accomplishments

- Added `isFriendshipMemberById()` helper function that parses friendship document IDs
- Updated friendships read rule to support both collection queries and direct document reads
- Fixed UAT-004: Users can now send friend requests without permission errors

## Task Commits

1. **Task 1: Fix UAT-004 - Update Firestore rules** - `ff5baf9` (fix)

**Plan metadata:** (this commit)

## Files Created/Modified

- `firestore.rules` - Added isFriendshipMemberById() helper, updated friendships read rule

## Decisions Made

- Combined two security rule approaches:
  - `isFriendshipMember(resource.data)` - works for collection queries with `where` clauses
  - `isFriendshipMemberById(friendshipId)` - works for direct document reads on non-existent documents
- This allows the OR logic to handle both use cases

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

- Initial fix broke collection queries (getFriendships, getPendingRequests, etc.)
- Root cause: Collection queries need `isFriendshipMember(resource.data)` to evaluate query constraints
- Resolution: Combined both approaches with OR logic in the rule

## Next Phase Readiness

- UAT-004 resolved
- All friendship functionality working
- Ready to continue with Phase 12.2 (Feed Stories Feature)

---
*Phase: 12.1-friends-list-screen-crash-fix*
*Completed: 2026-01-20*
