---
phase: 12.1-friends-list-screen-crash-fix
plan: 01-FIX3
subsystem: social
tags: [firestore, friendship, or-query, security-rules]

# Dependency graph
requires:
  - phase: 12.1-FIX2
    provides: Single-field requestedBy query (still broken due to security rules)
provides:
  - getSentRequests using or() query pattern with client-side filtering
affects: [friend-requests, social-features]

# Tech tracking
tech-stack:
  added: []
  patterns: [or-query-with-client-filtering]

key-files:
  created: []
  modified: [src/services/firebase/friendshipService.js]

key-decisions:
  - "Use or(where('user1Id'), where('user2Id')) pattern for all friendship queries"
  - "Filter for requestedBy === userId client-side to satisfy security rules"

patterns-established:
  - "All friendship queries must use or() pattern for user1Id/user2Id to satisfy Firestore security rules"

issues-created: []

# Metrics
duration: 5min
completed: 2026-01-19
---

# Phase 12.1 Plan 01-FIX3: getSentRequests Security Rule Fix Summary

**Fixed getSentRequests permission error by using or(where('user1Id'), where('user2Id')) query pattern with client-side filtering for requestedBy**

## Performance

- **Duration:** 5 min
- **Started:** 2026-01-19
- **Completed:** 2026-01-19
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- Fixed UAT-003: getSentRequests permission error
- getSentRequests now uses consistent or() query pattern
- Client-side filtering for `requestedBy === userId && status === 'pending'`
- All three friendship UAT issues now resolved (UAT-001, UAT-002, UAT-003)

## Task Commits

1. **Task 1: Fix UAT-003 getSentRequests permission error** - `4d32e76` (fix)

**Plan metadata:** (pending)

## Files Created/Modified
- `src/services/firebase/friendshipService.js` - Changed getSentRequests query from `where('requestedBy')` to `or(where('user1Id'), where('user2Id'))` with client-side filtering

## Decisions Made
- Use the same or() query pattern as getFriendships and getPendingRequests
- Firestore security rules only allow queries where user is user1Id OR user2Id, not requestedBy alone

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - the fix was straightforward once the root cause was understood.

## Issue Fix Summary

**UAT-003 Root Cause:** The `getSentRequests` function was querying `where('requestedBy', '==', userId)`, but Firestore security rules only allow queries where the user is `user1Id` OR `user2Id`. The `requestedBy` field alone doesn't satisfy the security rules.

**Solution:** Changed query from:
```javascript
where('requestedBy', '==', userId)
```
To:
```javascript
or(
  where('user1Id', '==', userId),
  where('user2Id', '==', userId)
)
```
Plus client-side filtering: `if (data.status === 'pending' && data.requestedBy === userId)`

## Next Phase Readiness
- Phase 12.1 complete (all 3 UAT issues resolved)
- Ready for re-verification via /gsd:verify-work
- After verification, ready to proceed to Phase 13 (Production Build & Branding)

---
*Phase: 12.1-friends-list-screen-crash-fix*
*Plan: 01-FIX3*
*Completed: 2026-01-19*
