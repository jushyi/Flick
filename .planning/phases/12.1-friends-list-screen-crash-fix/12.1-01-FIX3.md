---
phase: 12.1-friends-list-screen-crash-fix
plan: 01-FIX3
type: fix
---

<objective>
Fix UAT-003: getSentRequests permission error breaking Friend Requests screen.

Source: 12.1-01-ISSUES.md
Priority: 0 critical, 1 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-ISSUES.md

**Source file:**
@src/services/firebase/friendshipService.js
</context>

<tasks>

<task type="auto">
  <name>Fix UAT-003: getSentRequests permission error</name>
  <files>src/services/firebase/friendshipService.js</files>
  <action>
The `getSentRequests` function currently queries by `requestedBy` field:
```javascript
const q = query(
  collection(db, 'friendships'),
  where('requestedBy', '==', userId)
);
```

This causes a permission error because Firestore security rules only allow queries where the user is `user1Id` or `user2Id`. The `requestedBy` field alone doesn't satisfy the security rules.

**Fix approach:** Use the same OR query pattern as `getPendingRequests` and `getFriendships`:
1. Query friendships where user is `user1Id` OR `user2Id` using modular `or()` function
2. Filter client-side for `requestedBy === userId` AND `status === 'pending'`

This is consistent with how other functions handle the same security constraint.

**Code change in getSentRequests function (lines 318-355):**

Change from:
```javascript
const q = query(
  collection(db, 'friendships'),
  where('requestedBy', '==', userId)
);
const querySnapshot = await getDocs(q);

// Filter for pending status client-side
const requests = [];
querySnapshot.forEach((doc) => {
  const data = doc.data();
  if (data.status === 'pending') {
    requests.push({
```

To:
```javascript
// Query friendships where user is either user1Id or user2Id using modular or() function
const q = query(
  collection(db, 'friendships'),
  or(
    where('user1Id', '==', userId),
    where('user2Id', '==', userId)
  )
);
const querySnapshot = await getDocs(q);

// Filter for pending requests WHERE USER IS THE SENDER (client-side)
const requests = [];
querySnapshot.forEach((doc) => {
  const data = doc.data();
  if (data.status === 'pending' && data.requestedBy === userId) {
    requests.push({
```

The key insight is that Firestore rules require the user to be part of the friendship (user1Id or user2Id), not just the requestedBy field.
  </action>
  <verify>
1. App builds without errors
2. FriendRequestsScreen loads without permission error
3. Both Received and Sent tabs work correctly
4. Sent tab shows requests where current user is the sender
  </verify>
  <done>
- getSentRequests uses or(where('user1Id'), where('user2Id')) pattern
- Client-side filtering for requestedBy === userId AND status === 'pending'
- FriendRequestsScreen loads both tabs without errors
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] getSentRequests function updated with or() query pattern
- [ ] Client-side filtering handles both status and requestedBy checks
- [ ] FriendRequestsScreen loads without permission errors
- [ ] Both tabs (Received and Sent) display correct data
</verification>

<success_criteria>
- UAT-003 from 12.1-01-ISSUES.md resolved
- Friend Requests screen loads without errors on initial mount
- Both Received and Sent tabs function correctly
- Ready for re-verification via /gsd:verify-work
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-FIX3-SUMMARY.md`
</output>
