# UAT Issues: Phase 12.1 Plan 01

**Tested:** 2026-01-20
**Source:** .planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-FIX3-SUMMARY.md
**Tester:** User via /gsd:verify-work

## Open Issues

None - all issues resolved.

## Resolved Issues

### UAT-004: Cannot send friend request - permission denied

**Discovered:** 2026-01-20
**Resolved:** 2026-01-20
**Phase/Plan:** 12.1-01-FIX4
**Severity:** Blocker
**Feature:** Send friend request
**Description:** When searching for a user and tapping Add Friend, multiple permission errors occur:
```
ERROR  ❌ [ERROR] Error checking friendship status {}
ERROR  ❌ [ERROR] Error sending friend request {}
ERROR  ❌ [ERROR] Failed to send friend request {"error": "[firestore/permission-denied] The caller does not have permission to execute the specified operation."}
```

**Expected:** Friend request should be sent successfully
**Actual:** Permission denied error, friend request not sent
**Repro:**
1. Navigate to Friends tab
2. Use search to find a user
3. Tap "Add Friend" button
4. Observe permission denied errors in console

**Root Cause:**
The Firestore security rule `allow read: if isFriendshipMember(resource.data)` fails when:
1. `checkFriendshipStatus()` uses `getDoc(friendshipRef)` to read a friendship document by ID
2. Document doesn't exist (users never interacted before)
3. `resource.data` is null for non-existent documents
4. `isFriendshipMember(null)` fails → permission denied

**Solution Applied:**
1. Added `isFriendshipMemberById()` helper function that parses document ID
2. Document ID format is deterministic: `[lowerUserId]_[higherUserId]`
3. Updated read rule to: `isFriendshipMember(resource.data) || isFriendshipMemberById(friendshipId)`
   - `isFriendshipMember(resource.data)` works for collection queries (getFriendships, etc.)
   - `isFriendshipMemberById(friendshipId)` works for direct reads on non-existent docs

**Fix Commit:** ff5baf9

### UAT-003: Friend Requests screen fails to load both tabs - permission error on getSentRequests

**Discovered:** 2026-01-19
**Resolved:** 2026-01-19
**Phase/Plan:** 12.1-01-FIX3
**Severity:** Major
**Feature:** Friend Requests - Both tabs
**Description:** When opening the Friend Requests screen, a permission error occurs immediately on initial load. The error appears in the console:
```
ERROR  ❌ [ERROR] Error getting sent requests {}
ERROR  ❌ [ERROR] Error fetching sent requests {"error": "[firestore/permission-denied] The caller does not have permission to execute the specified operation."}
```
Both Received and Sent tabs appear empty/broken. The FIX2 appears to not have fully resolved the issue.
**Expected:** Friend Requests screen loads with Received tab showing pending requests (or empty state), Sent tab accessible
**Actual:** Both tabs empty/broken, permission error on initial load
**Repro:**
1. Open app
2. Navigate to Friends tab (Friends List works)
3. Go to Friend Requests
4. Error appears immediately on load
5. Both tabs are empty/broken

**Root Cause:**
The `getSentRequests` function was querying `where('requestedBy', '==', userId)`, but Firestore security rules only allow queries where the user is `user1Id` OR `user2Id`. The `requestedBy` field alone doesn't satisfy the security rules.

**Solution Applied:**
1. Changed query pattern from `where('requestedBy', '==', userId)` to `or(where('user1Id', '==', userId), where('user2Id', '==', userId))`
2. Added client-side filtering: `if (data.status === 'pending' && data.requestedBy === userId)`
3. Consistent with getFriendships and getPendingRequests patterns

**Fix Commit:** 4d32e76

### UAT-002: Sent requests tab fails with permission error

**Discovered:** 2026-01-19
**Resolved:** 2026-01-19
**Phase/Plan:** 12.1-01-FIX2
**Severity:** Major
**Feature:** Friend Requests - Sent tab
**Description:** When navigating to the Friend Requests screen and viewing the "Sent" tab, an error occurs: "Error fetching sent requests (the caller does not have permission to execute the specified operation.)"
**Expected:** Sent friend requests should load and display
**Actual:** Permission error prevents loading sent requests
**Repro:**
1. Open app
2. Navigate to Friends tab
3. Go to Friend Requests
4. Switch to "Sent" tab
5. Error appears

**Root Cause:**
The `getSentRequests` function used a compound query with two `where` clauses:
```javascript
query(
  collection(db, 'friendships'),
  where('requestedBy', '==', userId),
  where('status', '==', 'pending')
);
```
This compound query requires a Firestore composite index.

**Solution Applied:**
1. Changed to single-field query: `where('requestedBy', '==', userId)`
2. Added client-side filtering: `if (data.status === 'pending')`
3. Pattern consistent with getFriendships and getPendingRequests

**Fix Commit:** 843951d

### UAT-001: Filter.where is not a function - FriendsListScreen still crashes

**Discovered:** 2026-01-19
**Resolved:** 2026-01-19
**Phase/Plan:** 12.1-01-FIX
**Severity:** Blocker
**Feature:** FriendsListScreen loading
**Description:** FriendsListScreen crashes on load with ErrorBoundary. The fix applied for Filter.or is not working correctly.
**Expected:** FriendsListScreen loads showing friends list or empty state
**Actual:** Screen crashes with error: `TypeError: firestore.default.Filter.where is not a function (it is undefined)`
**Repro:**
1. Launch app
2. Navigate to Friends tab
3. Screen immediately crashes to ErrorBoundary

**Root Cause:** Both the named Filter import and `firestore.Filter.or()` patterns don't work in React Native Firebase v22+. The modular API exports `or` and `where` as standalone functions that compose directly.

**Solution Applied:**
1. Added `or` to named imports: `import { ..., or, where } from '@react-native-firebase/firestore'`
2. Changed query pattern from `where(firestore.Filter.or(firestore.Filter.where(...)))` to `or(where(...), where(...))`
3. Fixed all 3 locations: getFriendships, getPendingRequests, subscribeFriendships

**Fix Commit:** d9e5f10

---

*Phase: 12.1-friends-list-screen-crash-fix*
*Plan: 01*
*Tested: 2026-01-19*
