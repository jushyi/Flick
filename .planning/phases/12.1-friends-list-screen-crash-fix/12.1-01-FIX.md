---
phase: 12.1-friends-list-screen-crash-fix
plan: 12.1-01-FIX
type: fix
---

<objective>
Fix 1 UAT issue from plan 12.1-01.

Source: 12.1-01-ISSUES.md
Priority: 1 blocker
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-PLAN.md

**Key files:**
@src/services/firebase/friendshipService.js

**Root Cause Discovery:**
The previous fix attempted `firestore.Filter.or()` pattern, but this results in:
`TypeError: firestore.default.Filter.where is not a function (it is undefined)`

**Correct Pattern (verified in node_modules):**
React Native Firebase v22+ exports `or` and `and` as standalone modular functions from `@react-native-firebase/firestore`:
- `node_modules/@react-native-firebase/firestore/lib/modular/query.js` exports: `or(...queries)`, `and(...queries)`
- These are re-exported via the main package index

**Correct Usage:**
```javascript
import { ..., or, where } from '@react-native-firebase/firestore';

// Instead of: where(firestore.Filter.or(firestore.Filter.where(...), ...))
// Use: or(where(...), where(...))
```

This follows the Firebase Web modular SDK pattern where `or()` and `and()` are standalone functions.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Filter.or to modular or() function in friendshipService.js</name>
  <files>src/services/firebase/friendshipService.js</files>
  <action>
1. Update imports - add `or` to the named imports:
   ```javascript
   import firestore, { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, where, or, onSnapshot, serverTimestamp } from '@react-native-firebase/firestore';
   ```

2. Replace all three occurrences of the Filter pattern with the modular `or()` function:

   **Location 1: getFriendships (around line 227-233)**
   Change from:
   ```javascript
   const q = query(
     collection(db, 'friendships'),
     where(firestore.Filter.or(
       firestore.Filter.where('user1Id', '==', userId),
       firestore.Filter.where('user2Id', '==', userId)
     ))
   );
   ```
   To:
   ```javascript
   const q = query(
     collection(db, 'friendships'),
     or(
       where('user1Id', '==', userId),
       where('user2Id', '==', userId)
     )
   );
   ```

   **Location 2: getPendingRequests (around line 276-282)**
   Same pattern change - use `or(where(...), where(...))` instead of `where(firestore.Filter.or(...))`

   **Location 3: subscribeFriendships (around line 415-420)**
   Same pattern change - use `or(where(...), where(...))` instead of `where(firestore.Filter.or(...))`

3. Keep the `firestore` default import (it's used for other purposes or can be removed if not needed elsewhere)

**What to avoid and WHY:**
- Do NOT wrap `or()` in another `where()` - `or()` is a query constraint itself, not a filter to pass to where
- Do NOT use `Filter` class at all - the modular API uses standalone functions
- Do NOT change any other query logic - only the OR query pattern
  </action>
  <verify>
1. Run `npx expo start` and navigate to Friends tab
2. FriendsListScreen should load without crashing
3. Check console for no errors related to Filter or or()
4. If user has friends, they should display
5. If user has no friends, empty state should display
  </verify>
  <done>
- `or` imported as named function from @react-native-firebase/firestore
- All 3 Filter.or patterns replaced with or(where(...), where(...))
- FriendsListScreen loads without ErrorBoundary catching crash
- Console shows no Filter-related errors
  </done>
</task>

</tasks>

<verification>
Before declaring fix complete:
- [ ] `or` added to named imports
- [ ] getFriendships uses `or(where(...), where(...))`
- [ ] getPendingRequests uses `or(where(...), where(...))`
- [ ] subscribeFriendships uses `or(where(...), where(...))`
- [ ] App starts without errors
- [ ] FriendsListScreen loads successfully
- [ ] No console errors related to Filter or queries
</verification>

<success_criteria>
- All UAT issues from 12.1-01-ISSUES.md addressed
- FriendsListScreen no longer crashes
- Friendship OR queries work correctly
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-FIX-SUMMARY.md`
</output>
