---
phase: 12.1-friends-list-screen-crash-fix
plan: 01-FIX2
type: fix
---

<objective>
Fix 1 UAT issue from plan 12.1-01-FIX.

Source: 12.1-01-ISSUES.md
Priority: 0 critical, 1 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-PLAN.md

**Key file:**
@src/services/firebase/friendshipService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-002 - getSentRequests compound query permission error</name>
  <files>src/services/firebase/friendshipService.js</files>
  <action>
The `getSentRequests` function uses a compound query that requires a Firestore composite index:
```javascript
query(
  collection(db, 'friendships'),
  where('requestedBy', '==', userId),
  where('status', '==', 'pending')
);
```

**Fix approach:** Follow the same pattern as `getPendingRequests` - query with a single condition and filter client-side.

1. Change the query to only filter by `requestedBy`:
   ```javascript
   const q = query(
     collection(db, 'friendships'),
     where('requestedBy', '==', userId)
   );
   ```

2. Add client-side filtering for status in the forEach loop:
   ```javascript
   querySnapshot.forEach((doc) => {
     const data = doc.data();
     if (data.status === 'pending') {  // Filter for pending status
       requests.push({
         id: doc.id,
         ...data,
       });
     }
   });
   ```

**What to avoid and WHY:**
- Do NOT create a Firestore composite index (adds maintenance overhead, client-side filtering is simpler for small datasets)
- Do NOT change the function signature or return type
- This pattern is consistent with how `getFriendships` and `getPendingRequests` already work
  </action>
  <verify>
1. Run `npx expo start` and navigate to Friends tab
2. Go to Friend Requests screen
3. Switch to "Sent" tab
4. No permission error should appear
5. If you have sent requests, they should display
6. If you have no sent requests, empty state should display
  </verify>
  <done>
- getSentRequests queries only by requestedBy field
- Client-side filtering for status === 'pending'
- No Firestore permission error on Sent tab
- UAT-002 resolved
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] getSentRequests uses single-field query (requestedBy only)
- [ ] Client-side filtering for pending status
- [ ] App starts without errors
- [ ] Friend Requests screen loads
- [ ] Sent tab shows sent requests (or empty state) without error
</verification>

<success_criteria>
- All UAT issues from 12.1-01-ISSUES.md addressed
- No Firestore permission errors
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-FIX2-SUMMARY.md`
</output>
