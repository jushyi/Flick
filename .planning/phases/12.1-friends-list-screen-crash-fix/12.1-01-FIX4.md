---
phase: 12.1-friends-list-screen-crash-fix
plan: 01-FIX4
type: fix
---

<objective>
Fix 1 UAT issue from plan 12.1-01.

Source: 12.1-01-ISSUES.md
Priority: 1 blocker, 0 major, 0 minor
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-PLAN.md

**Key file:**
@src/services/firebase/friendshipService.js
@firestore.rules
</context>

<root_cause_analysis>
## UAT-004: Cannot send friend request - permission denied

**Error chain:**
1. User searches for another user
2. Taps "Add Friend"
3. `checkFriendshipStatus()` is called first
4. `checkFriendshipStatus()` uses `getDoc(friendshipRef)` to read friendship document by ID
5. Document doesn't exist (users never interacted)
6. Firestore security rule: `allow read: if isFriendshipMember(resource.data);`
7. `resource.data` is null for non-existent documents
8. `isFriendshipMember(null)` fails â†’ permission denied

**Same issue in sendFriendRequest:**
- Lines 59-70 use `getDoc(friendshipRef)` to check if friendship exists before creating
- If document doesn't exist, rule fails with permission denied

**Root cause:** Firestore security rules can't handle `getDoc()` on non-existent documents because `resource.data` is null. The rule tries to access `friendshipData.user1Id` and `friendshipData.user2Id` on null.

**Solution:** Update Firestore security rules to allow reads on non-existent friendship documents when the user would be a member based on the document ID structure.

The friendship ID is deterministic: `[lowerUserId]_[higherUserId]`. We can parse the document ID to verify the requesting user is one of the two users.
</root_cause_analysis>

<tasks>

<task type="auto">
  <name>Fix UAT-004: Update Firestore rules to allow reading non-existent friendships</name>
  <files>firestore.rules</files>
  <action>
Update the friendships collection read rule to handle both existing and non-existent documents.

**Current rule (line 103):**
```
allow read: if isFriendshipMember(resource.data);
```

**Problem:** `resource.data` is null for non-existent documents.

**Solution:** Parse the friendshipId to extract user IDs and verify the requesting user is one of them.

The friendshipId format is: `[lowerUserId]_[higherUserId]`

Add a new helper function to check membership from document ID:
```javascript
// Check if user is part of friendship by parsing document ID
// Document ID format: [lowerUserId]_[higherUserId]
function isFriendshipMemberById(friendshipId) {
  let parts = friendshipId.split('_');
  return isAuthenticated() &&
         parts.size() == 2 &&
         (parts[0] == request.auth.uid || parts[1] == request.auth.uid);
}
```

Update the read rule to use both methods:
```javascript
// Read: Users can read friendships they're part of
// For existing docs: check resource.data
// For non-existent docs (checking if friendship exists): check document ID
allow read: if (resource != null && isFriendshipMember(resource.data)) ||
               (resource == null && isFriendshipMemberById(friendshipId));
```

Note: Actually, Firestore uses `resource.data` for the document data regardless of existence. When document doesn't exist, the read is denied at the rule level before checking data.

**Better approach:** Use the document ID check as the primary method since it works for both cases:
```javascript
allow read: if isFriendshipMemberById(friendshipId);
```

This is more permissive but still secure because:
1. User can only read friendship docs where they are one of the two users in the ID
2. The ID is deterministic and can't be forged to include arbitrary users
  </action>
  <verify>
1. Deploy rules: `firebase deploy --only firestore:rules`
2. Test in app: Search for a user and tap "Add Friend"
3. Verify friend request sends successfully without permission errors
  </verify>
  <done>
- Firestore rules updated to handle getDoc() on non-existent friendship documents
- Rules deployed to Firebase
- sendFriendRequest works without permission errors
- checkFriendshipStatus works for users with no prior friendship
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Updated Firestore rules to allow reading friendship documents by parsing document ID</what-built>
  <how-to-verify>
1. Launch the app with `npx expo start`
2. Log in as a user
3. Navigate to Friends tab
4. Search for another user (someone you're not friends with)
5. Tap "Add Friend" button
6. Verify: No permission errors in console
7. Verify: Friend request is sent successfully
8. Check receiving user: They should see the pending request
  </how-to-verify>
  <resume-signal>Type "approved" if friend requests work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Firestore rules deployed successfully
- [ ] sendFriendRequest works for new friendships
- [ ] checkFriendshipStatus works for users with no prior interaction
- [ ] Existing functionality still works (accept, decline, list friends)
</verification>

<success_criteria>
- UAT-004 resolved: Users can send friend requests without permission errors
- No regression in existing friendship functionality
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/12.1-friends-list-screen-crash-fix/12.1-01-FIX4-SUMMARY.md`
</output>
