---
phase: 10-storage-migration-cleanup
plan: 01
type: execute
domain: react-native-firebase
---

<objective>
Migrate storageService.js from Firebase JS SDK to React Native Firebase SDK.

Purpose: Storage operations need RN Firebase to share auth state with phone authentication, preventing permission-denied errors when users upload photos or profile images.
Output: Fully migrated storageService.js using @react-native-firebase/storage with working photo uploads.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-firestore-services-migration/09-01-SUMMARY.md
@.planning/phases/09-firestore-services-migration/09-02-SUMMARY.md

**Key files:**
@src/services/firebase/storageService.js
@src/services/firebase/firebaseConfig.js
@package.json

**Tech stack available:**
- @react-native-firebase/app: ^23.8.2
- @react-native-firebase/auth: ^23.8.2
- @react-native-firebase/firestore: ^23.8.2
- Method chaining pattern established in Phase 9

**Established patterns:**
- RN Firebase import: `import storage from '@react-native-firebase/storage'`
- Method chaining: `storage().ref(path).putFile(uri)`
- Consistent auth state between Auth and all Firebase operations

**Constraining decisions:**
- Phase 9: Method chaining pattern for RN Firebase SDK (not modular imports)
- Phase 9: Keep function signatures identical for zero-impact migration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @react-native-firebase/storage</name>
  <files>package.json</files>
  <action>
Install the RN Firebase Storage package:
```
npm install @react-native-firebase/storage
```

After installation, verify it appears in package.json dependencies alongside the other @react-native-firebase packages.

**Why this matters:** RN Firebase Storage shares the auth state established by @react-native-firebase/auth, eliminating the auth mismatch that causes permission-denied errors.

**Do NOT:** Modify any code files in this task - just install the dependency.
  </action>
  <verify>Run `npm ls @react-native-firebase/storage` shows installed version. Check package.json contains the dependency.</verify>
  <done>@react-native-firebase/storage appears in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Migrate storageService.js to RN Firebase SDK</name>
  <files>src/services/firebase/storageService.js</files>
  <action>
Rewrite storageService.js to use @react-native-firebase/storage instead of firebase/storage.

**Import change:**
```javascript
// REMOVE these JS SDK imports:
// import { ref, uploadBytes, getDownloadURL, deleteObject } from 'firebase/storage';
// import { storage } from './firebaseConfig';

// ADD RN Firebase import:
import storage from '@react-native-firebase/storage';
```

**Migration patterns for each function:**

1. **uploadProfilePhoto** and **uploadPhoto**:
   - JS SDK: `ref(storage, path)` → RN Firebase: `storage().ref(path)`
   - JS SDK: `uploadBytes(storageRef, blob)` → RN Firebase: `storageRef.putFile(localUri)`
   - JS SDK: `getDownloadURL(storageRef)` → RN Firebase: `storageRef.getDownloadURL()`
   - **IMPORTANT:** RN Firebase `putFile()` accepts local file URI directly (no blob conversion needed)
   - Remove the blob conversion code (fetch + response.blob())
   - Still compress image using ImageManipulator before upload

2. **deleteProfilePhoto** and **deletePhoto**:
   - JS SDK: `ref(storage, path)` → RN Firebase: `storage().ref(path)`
   - JS SDK: `deleteObject(storageRef)` → RN Firebase: `storageRef.delete()`

3. **getPhotoURL**:
   - JS SDK: `ref(storage, path)` → RN Firebase: `storage().ref(path)`
   - JS SDK: `getDownloadURL(storageRef)` → RN Firebase: `storageRef.getDownloadURL()`

**Example migration for uploadPhoto:**
```javascript
export const uploadPhoto = async (photoId, localUri) => {
  try {
    // Compress image first
    const compressedUri = await compressImage(localUri, 0.8);

    // Create storage reference (RN Firebase pattern)
    const storageRef = storage().ref(`photos/${photoId}.jpg`);

    // Upload file directly (no blob needed with RN Firebase)
    await storageRef.putFile(compressedUri);

    // Get download URL
    const downloadURL = await storageRef.getDownloadURL();

    return { success: true, url: downloadURL };
  } catch (error) {
    return { success: false, error: error.message };
  }
};
```

**Keep unchanged:**
- compressImage() helper function (uses expo-image-manipulator, not Firebase)
- Function signatures (return { success, url/error } objects)
- Logger usage

**Do NOT:**
- Remove compressImage function
- Change return value structure
- Add new dependencies
  </action>
  <verify>
Run `grep -n "from 'firebase/storage'" src/services/firebase/storageService.js` returns no matches.
Run `grep -n "@react-native-firebase/storage" src/services/firebase/storageService.js` returns the import line.
Run `grep -n "storage()" src/services/firebase/storageService.js` shows method chaining pattern.
  </verify>
  <done>storageService.js uses @react-native-firebase/storage with putFile() pattern, no firebase/storage imports remain</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Migrated storageService.js from Firebase JS SDK to React Native Firebase SDK</what-built>
  <how-to-verify>
1. Start the app: `npx expo start`
2. Open on iOS device/simulator
3. Login with phone authentication (to ensure auth state is established)
4. Navigate to Camera screen
5. Take a photo
6. Wait for darkroom reveal or check developing count increases
7. If photo shows in darkroom/feed, upload is working
8. Optionally: Try changing profile photo in Profile settings to test uploadProfilePhoto
9. Check Metro bundler logs for any storage-related errors
  </how-to-verify>
  <resume-signal>Type "approved" if photo upload works correctly, or describe any errors encountered</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] @react-native-firebase/storage installed in package.json
- [ ] No `firebase/storage` imports in storageService.js
- [ ] All 5 functions use storage().ref() pattern
- [ ] putFile() used instead of uploadBytes() (no blob conversion)
- [ ] Photo capture and upload works in app
</verification>

<success_criteria>

- @react-native-firebase/storage package installed
- storageService.js fully migrated to RN Firebase pattern
- Storage operations share auth state with phone authentication
- Photo upload functionality verified working
</success_criteria>

<output>
After completion, create `.planning/phases/10-storage-migration-cleanup/10-01-SUMMARY.md`:

# Phase 10 Plan 1: Storage Service Migration Summary

**[One-liner: what was accomplished]**

## Performance

- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 3
- **Files modified:** 2 (package.json, storageService.js)

## Accomplishments

- Installed @react-native-firebase/storage
- Migrated 5 functions from JS SDK to RN Firebase pattern
- Eliminated blob conversion (RN Firebase putFile accepts URI directly)

## Task Commits

1. **Task 1:** `deps(10-01): add @react-native-firebase/storage`
2. **Task 2:** `refactor(10-01): migrate storageService.js to RN Firebase`

## Files Created/Modified

- `package.json` - Added @react-native-firebase/storage dependency
- `src/services/firebase/storageService.js` - Migrated to RN Firebase SDK

## Decisions Made

[Any decisions from migration]

## Issues Encountered

[Any issues and resolutions]

## Next Phase Readiness

- Storage service uses shared RN Firebase auth state
- Ready for 10-02-PLAN.md: Remaining Services & Cleanup
</output>
