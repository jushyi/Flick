---
phase: 10-storage-migration-cleanup
plan: 02
type: execute
domain: react-native-firebase
---

<objective>
Migrate remaining Firestore services and screens, then remove Firebase JS SDK.

Purpose: Complete the Firebase SDK consolidation by migrating userService.js, screen-level Firestore calls, and removing the JS SDK dependency entirely.
Output: All Firebase operations use RN Firebase SDK, firebase package removed from dependencies.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary-frontmatter.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-firestore-services-migration/09-01-SUMMARY.md
@.planning/phases/09-firestore-services-migration/09-02-SUMMARY.md

**Key files to migrate:**
@src/services/firebase/userService.js
@src/services/firebase/firestoreService.js
@src/services/firebase/firebaseConfig.js
@src/components/FriendRequestCard.js
@src/screens/ProfileScreen.js
@src/screens/UserSearchScreen.js
@src/screens/FriendsListScreen.js
@package.json

**Tech stack available:**
- @react-native-firebase/firestore: ^23.8.2 (already installed)
- @react-native-firebase/storage (installed in 10-01)
- Method chaining pattern: firestore().collection().doc().get()

**Established patterns:**
- RN Firebase import: `import firestore from '@react-native-firebase/firestore'`
- Method chaining: `firestore().collection('users').doc(userId).get()`
- exists check: `typeof doc.exists === 'function' ? doc.exists() : doc.exists`
- serverTimestamp: `firestore.FieldValue.serverTimestamp()`

**Files with remaining JS SDK imports:**
- userService.js (3 functions)
- firestoreService.js (12+ functions, may be unused - verify)
- FriendRequestCard.js (direct Firestore query)
- ProfileScreen.js (direct Firestore query)
- UserSearchScreen.js (direct Firestore query)
- FriendsListScreen.js (direct Firestore query)
- firebaseConfig.js (JS SDK initialization)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate userService.js to RN Firebase SDK</name>
  <files>src/services/firebase/userService.js</files>
  <action>
Rewrite userService.js to use @react-native-firebase/firestore.

**Import change:**
```javascript
// REMOVE:
// import { doc, getDoc, updateDoc } from 'firebase/firestore';
// import { db } from './firebaseConfig';

// ADD:
import firestore from '@react-native-firebase/firestore';
```

**Migration for each function (3 total):**

1. **getDailyPhotoCount**:
```javascript
// JS SDK:
const userRef = doc(db, 'users', userId);
const userDoc = await getDoc(userRef);
if (!userDoc.exists()) { ... }
await updateDoc(userRef, { ... });

// RN Firebase:
const userRef = firestore().collection('users').doc(userId);
const userDoc = await userRef.get();
const docExists = typeof userDoc.exists === 'function' ? userDoc.exists() : userDoc.exists;
if (!docExists) { ... }
await userRef.update({ ... });
```

2. **incrementDailyPhotoCount** - Same pattern as getDailyPhotoCount

3. **checkDailyLimit** - Calls getDailyPhotoCount, no direct Firestore calls

**Keep unchanged:**
- getTodayDate() helper function
- Function signatures and return values
- Logger usage

**Do NOT:** Change the business logic (36-photo daily limit, date checking)
  </action>
  <verify>
Run `grep -n "from 'firebase/firestore'" src/services/firebase/userService.js` returns no matches.
Run `grep -n "@react-native-firebase/firestore" src/services/firebase/userService.js` returns the import.
Run `grep -n "firestore()" src/services/firebase/userService.js` shows method chaining.
  </verify>
  <done>userService.js uses RN Firebase method chaining, no JS SDK imports</done>
</task>

<task type="auto">
  <name>Task 2: Migrate screen components to RN Firebase SDK</name>
  <files>src/components/FriendRequestCard.js, src/screens/ProfileScreen.js, src/screens/UserSearchScreen.js, src/screens/FriendsListScreen.js</files>
  <action>
Migrate direct Firestore queries in 4 files from JS SDK to RN Firebase.

**For each file, apply the same pattern:**

Replace imports:
```javascript
// REMOVE:
// import { doc, getDoc } from 'firebase/firestore';  // or collection, query, where, getDocs, limit
// import { db } from '../services/firebase/firebaseConfig';  // or './firebaseConfig'

// ADD:
import firestore from '@react-native-firebase/firestore';
```

**FriendRequestCard.js migration:**
- Used for: Fetching other user's profile data
```javascript
// JS SDK:
const userRef = doc(db, 'users', userId);
const userDoc = await getDoc(userRef);

// RN Firebase:
const userDoc = await firestore().collection('users').doc(userId).get();
const docExists = typeof userDoc.exists === 'function' ? userDoc.exists() : userDoc.exists;
```

**ProfileScreen.js migration:**
- Used for: Counting user's triaged photos
```javascript
// JS SDK:
const photosQuery = query(
  collection(db, 'photos'),
  where('userId', '==', user.uid),
  where('status', '==', 'triaged')
);
const photosSnapshot = await getDocs(photosQuery);

// RN Firebase:
const photosSnapshot = await firestore()
  .collection('photos')
  .where('userId', '==', user.uid)
  .where('status', '==', 'triaged')
  .get();
```

**UserSearchScreen.js migration:**
- Used for: Searching users by username
```javascript
// JS SDK:
const usersRef = collection(db, 'users');
const q = query(
  usersRef,
  where('usernameLower', '>=', searchLower),
  where('usernameLower', '<=', searchLower + '\uf8ff'),
  limit(20)
);
const querySnapshot = await getDocs(q);

// RN Firebase:
const querySnapshot = await firestore()
  .collection('users')
  .where('usernameLower', '>=', searchLower)
  .where('usernameLower', '<=', searchLower + '\uf8ff')
  .limit(20)
  .get();
```

**FriendsListScreen.js migration:**
- Used for: Fetching user data for friend list
```javascript
// JS SDK:
const userRef = doc(db, 'users', friendId);
const userDoc = await getDoc(userRef);

// RN Firebase:
const userDoc = await firestore().collection('users').doc(friendId).get();
```

**Important for all:**
- Use exists check compatibility pattern: `typeof doc.exists === 'function' ? doc.exists() : doc.exists`
- Access data via `doc.data()` (same in both SDKs)
- Keep all other logic unchanged

**Do NOT:**
- Change UI components or styling
- Alter navigation behavior
- Modify error handling patterns
  </action>
  <verify>
Run `grep -rn "from 'firebase/firestore'" src/components/ src/screens/` returns no matches.
Run `grep -rn "import { db }" src/components/ src/screens/` returns no matches.
Run `grep -rn "@react-native-firebase/firestore" src/components/FriendRequestCard.js` returns the import.
  </verify>
  <done>All 4 files (FriendRequestCard.js, ProfileScreen.js, UserSearchScreen.js, FriendsListScreen.js) use RN Firebase</done>
</task>

<task type="auto">
  <name>Task 3: Remove Firebase JS SDK and clean up firebaseConfig.js</name>
  <files>src/services/firebase/firebaseConfig.js, src/services/firebase/firestoreService.js, package.json</files>
  <action>
Final cleanup: remove the Firebase JS SDK dependency and update/remove related files.

**Step 1: Assess firestoreService.js usage**
Check if firestoreService.js is imported anywhere in the codebase:
```bash
grep -rn "from.*firestoreService" src/
grep -rn "firestoreService" src/
```

If NOT used by any other file:
- DELETE firestoreService.js entirely

If still used:
- Migrate it to RN Firebase (same patterns as userService.js)
- Export functions that are actually used

**Step 2: Update firebaseConfig.js**
The file currently exports `db` and `storage` from JS SDK. After migration:
- These exports are no longer needed
- **Option A (Preferred):** Remove firebaseConfig.js entirely if nothing imports it
- **Option B:** Keep minimal config for env vars if still needed elsewhere

Check if firebaseConfig.js is imported:
```bash
grep -rn "from.*firebaseConfig" src/
```

If NO imports remain after cleaning up services:
- DELETE firebaseConfig.js

If still imported (e.g., for env config):
- Remove JS SDK imports and exports
- Keep only env variable setup if needed

**Step 3: Uninstall Firebase JS SDK**
```bash
npm uninstall firebase
```

Verify removal:
- package.json should NOT contain "firebase" (the JS SDK)
- Should still contain @react-native-firebase/* packages

**Step 4: Update services/firebase/index.js**
Check exports and remove any references to deleted services.

**IMPORTANT verification before uninstalling:**
Run these commands to ensure no JS SDK imports remain:
```bash
grep -rn "from 'firebase/" src/
grep -rn 'from "firebase/' src/
```
Should return NO results before proceeding with npm uninstall.

**Do NOT:**
- Remove @react-native-firebase packages
- Remove environment variable setup if still used
- Break any existing imports
  </action>
  <verify>
Run `npm ls firebase` should show "empty" or "not found".
Run `grep -rn "from 'firebase/" src/` returns no matches.
Run `cat package.json | grep '"firebase"'` returns no match (JS SDK removed).
Run `cat package.json | grep '@react-native-firebase'` shows the 4 RN Firebase packages remain.
  </verify>
  <done>Firebase JS SDK removed, firebaseConfig.js deleted or updated, firestoreService.js deleted if unused</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] userService.js migrated to RN Firebase
- [ ] FriendRequestCard.js, ProfileScreen.js, UserSearchScreen.js, FriendsListScreen.js migrated
- [ ] No `firebase/` imports remain in src/
- [ ] firebase JS SDK removed from package.json
- [ ] @react-native-firebase/* packages still present
- [ ] App runs without import errors
</verification>

<success_criteria>

- All Firebase operations use React Native Firebase SDK
- Firebase JS SDK completely removed from project
- Auth state shared across all Firebase operations (Auth, Firestore, Storage)
- App functions normally with unified SDK
- Phase 10 complete, v1.3 milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-storage-migration-cleanup/10-02-SUMMARY.md`:

# Phase 10 Plan 2: Remaining Services & Cleanup Summary

**[One-liner: what was accomplished]**

## Performance

- **Duration:** X min
- **Started:** [timestamp]
- **Completed:** [timestamp]
- **Tasks:** 3
- **Files modified:** [count]

## Accomplishments

- Migrated userService.js (3 functions) to RN Firebase
- Migrated 4 screen/component files to RN Firebase
- Removed Firebase JS SDK dependency
- [Deleted/updated] firestoreService.js and firebaseConfig.js

## Task Commits

1. **Task 1:** `refactor(10-02): migrate userService.js to RN Firebase`
2. **Task 2:** `refactor(10-02): migrate screen components to RN Firebase`
3. **Task 3:** `chore(10-02): remove Firebase JS SDK`

## Files Created/Modified

- `src/services/firebase/userService.js` - Migrated
- `src/components/FriendRequestCard.js` - Migrated
- `src/screens/ProfileScreen.js` - Migrated
- `src/screens/UserSearchScreen.js` - Migrated
- `src/screens/FriendsListScreen.js` - Migrated
- `package.json` - Removed firebase dependency
- [Other files affected]

## Decisions Made

[Decisions about firestoreService.js and firebaseConfig.js]

## Issues Encountered

[Any issues and resolutions]

## Milestone Complete: v1.3 Firebase SDK Consolidation

All Firebase services now use React Native Firebase SDK:
- @react-native-firebase/app
- @react-native-firebase/auth
- @react-native-firebase/firestore
- @react-native-firebase/storage

Auth state is shared across all operations, eliminating permission-denied errors caused by SDK auth mismatch.

## Next Steps

- Phase 10 complete
- v1.3 milestone complete
- Ready for next milestone planning
</output>
