---
phase: 13.1-darkroom-reveal-timing-fix
plan: 01
type: execute
---

<objective>
Fix darkroom reveal timing accuracy and reduce reveal interval from 0-2 hours to 0-15 minutes.

Purpose: User reported nextRevealAt timing in Firestore is inaccurate. The issue is that darkroom state isn't initialized/refreshed when photos are taken. Additionally, the 0-2 hour interval is too long.

Output: Updated darkroomService with 0-15 minute intervals and proper darkroom initialization on photo capture.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/services/firebase/darkroomService.js
@src/services/firebase/photoService.js
@src/screens/CameraScreen.js

**Issue Analysis:**

The timing inaccuracy occurs because:

1. **Darkroom not initialized on first photo:** When a user takes their first photo, the darkroom document may not exist or may have stale `nextRevealAt`. The `getDarkroom()` function creates the darkroom with a reveal time, but this only happens when explicitly called - not automatically when photos are captured.

2. **No refresh on photo capture:** When a photo is taken (`createPhoto`), the darkroom state isn't checked or updated. If `nextRevealAt` has already passed (user hasn't opened darkroom in a while), the next photo capture should trigger a new reveal schedule.

**Current flow:**
- User takes photo → `createPhoto()` saves photo with status='developing'
- Darkroom `nextRevealAt` may be stale or non-existent
- User opens darkroom → `isDarkroomReadyToReveal()` checks timing → reveals if ready
- But if darkroom was never initialized, timing is wrong

**Fix:**
1. Change interval from 0-2 hours to 0-15 minutes
2. Ensure darkroom is initialized/refreshed when photo is captured
3. If no developing photos exist and user takes a photo, set fresh `nextRevealAt`

**Root cause locations:**
- `darkroomService.js:104-109` - `calculateNextRevealTime()` uses `Math.random() * 2` (hours)
- `photoService.js:createPhoto()` - Doesn't ensure darkroom timing is set
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update reveal interval to 0-15 minutes</name>
  <files>src/services/firebase/darkroomService.js</files>
  <action>
Update calculateNextRevealTime() to generate random time between 0-15 minutes instead of 0-2 hours.

Change line 106 from:
```javascript
const randomHours = Math.random() * 2; // Random between 0-2 hours
const revealTime = new Date(now.getTime() + randomHours * 60 * 60 * 1000);
```

To:
```javascript
const randomMinutes = Math.random() * 15; // Random between 0-15 minutes
const revealTime = new Date(now.getTime() + randomMinutes * 60 * 1000);
```

Update the JSDoc comment from "0-2 hours" to "0-15 minutes".

Also update the comment in DarkroomScreen.js line 54 that says "0-2 hours" to "0-15 minutes".
  </action>
  <verify>
1. Check darkroomService.js has updated calculateNextRevealTime() with 15-minute interval
2. Verify JSDoc comment updated
3. Run app and capture a photo - check Firestore darkrooms/{userId} document has nextRevealAt within 15 minutes of now
  </verify>
  <done>
- calculateNextRevealTime() generates 0-15 minute intervals
- JSDoc comments updated to reflect new timing
- Comment in DarkroomScreen updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure darkroom timing is set on photo capture</name>
  <files>src/services/firebase/darkroomService.js, src/services/firebase/photoService.js</files>
  <action>
Add a new function to darkroomService.js called `ensureDarkroomInitialized(userId)`:

```javascript
/**
 * Ensure darkroom exists and has valid nextRevealAt for new photo capture
 * Called when user takes a photo to ensure timing is accurate
 * @param {string} userId - User ID
 * @returns {Promise}
 */
export const ensureDarkroomInitialized = async (userId) => {
  try {
    const darkroomRef = doc(db, 'darkrooms', userId);
    const darkroomDoc = await getDoc(darkroomRef);

    if (!darkroomDoc.exists()) {
      // Create new darkroom with initial reveal time
      const nextRevealAt = calculateNextRevealTime();
      await setDoc(darkroomRef, {
        userId,
        nextRevealAt,
        lastRevealedAt: null,
        createdAt: Timestamp.now(),
      });
      logger.info('DarkroomService: Created new darkroom for user', { userId });
      return { success: true, created: true };
    }

    // Darkroom exists - check if nextRevealAt is in the past (stale)
    const { nextRevealAt } = darkroomDoc.data();
    const now = Timestamp.now();

    if (!nextRevealAt || nextRevealAt.seconds < now.seconds) {
      // nextRevealAt is stale or missing - set a new one
      const newNextRevealAt = calculateNextRevealTime();
      await updateDoc(darkroomRef, {
        nextRevealAt: newNextRevealAt,
      });
      logger.info('DarkroomService: Refreshed stale nextRevealAt', { userId });
      return { success: true, refreshed: true };
    }

    // nextRevealAt is still in the future - no change needed
    return { success: true };
  } catch (error) {
    logger.error('DarkroomService: Failed to ensure darkroom initialized', { userId, error: error.message });
    return { success: false, error: error.message };
  }
};
```

Then update photoService.js `createPhoto()` to call this function after successfully creating a photo:

After line 73 (after the success log), add:
```javascript
// Ensure darkroom has valid timing for this new photo
import { ensureDarkroomInitialized } from './darkroomService';
// ... (add import at top of file)

// Inside createPhoto, after successful photo creation:
await ensureDarkroomInitialized(userId);
```

Move the import to the top of photoService.js with the other imports.
  </action>
  <verify>
1. Check ensureDarkroomInitialized() function exists in darkroomService.js
2. Check photoService.js imports and calls ensureDarkroomInitialized after createPhoto succeeds
3. Test: Delete darkroom document in Firebase console, take a photo, verify new darkroom document created with valid nextRevealAt
4. Test: Set nextRevealAt to past timestamp in Firebase console, take a photo, verify nextRevealAt is refreshed to future
  </verify>
  <done>
- ensureDarkroomInitialized() function added to darkroomService
- photoService.createPhoto() calls ensureDarkroomInitialized() after photo creation
- Darkroom timing is always accurate when photos are captured
- Handles both new darkrooms and stale nextRevealAt timestamps
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Photos captured now have nextRevealAt within 0-15 minutes (not 0-2 hours)
- [ ] New users taking first photo get proper darkroom initialization
- [ ] Users with stale nextRevealAt get it refreshed on photo capture
- [ ] Firestore darkrooms/{userId} document shows accurate nextRevealAt
- [ ] No console errors or warnings
- [ ] Existing reveal flow still works (press-and-hold to reveal)
</verification>

<success_criteria>

- Reveal interval changed from 0-2 hours to 0-15 minutes
- nextRevealAt in Firestore is accurate (refreshed on photo capture if stale)
- All existing darkroom functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/13.1-darkroom-reveal-timing-fix/13.1-01-SUMMARY.md`:

# Phase 13.1 Plan 01: Darkroom Reveal Timing Fix Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase 13.1 complete, ready for Phase 14.
</output>
