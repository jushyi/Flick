---
phase: 18-reaction-notification-debouncing
plan: 01
type: execute
---

<objective>
Implement 10-second debouncing for reaction notifications in the Cloud Function and store aggregated notifications in Firestore.

Purpose: Eliminate notification spam when users rapidly tap multiple reactions. One notification per user per reaction session, with emoji√ócount format.
Output: Updated Cloud Function with debouncing logic, notifications collection with aggregated reaction data.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-reaction-notification-debouncing/18-CONTEXT.md
@.planning/phases/14-remote-notification-testing/14-01-SUMMARY.md
@functions/index.js

**Current behavior:** sendReactionNotification triggers on every photo update with new reactions, sending one notification per tap.

**Target behavior:**
- First reaction from user X starts a 10-second pending window
- Subsequent reactions from user X within window aggregate (don't trigger notification)
- After 10 seconds of inactivity, send ONE notification with aggregated emoji√ócount format
- Store notification in `notifications` collection for later display

**Emoji√ócount format:** "Sarah reacted üòÇ√ó2 ‚ù§Ô∏è√ó1 üî•√ó3 to your photo"

**Key constraint:** Only reaction notifications get debounced. Friend request and photo reveal notifications stay as-is.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add debouncing state to sendReactionNotification Cloud Function</name>
  <files>functions/index.js</files>
  <action>
Modify the existing `sendReactionNotification` function to implement debouncing:

1. Add a `pendingReactions` in-memory object at module level to track pending reaction batches:
   ```javascript
   // Track pending reactions: { "photoId_reactorId": { timeout, reactions, photoOwnerId, fcmToken, reactorName } }
   const pendingReactions = {};
   ```

2. Modify `sendReactionNotification` to:
   - Calculate a unique key: `${photoId}_${reactorId}`
   - If key exists in pendingReactions:
     - Clear existing timeout
     - Merge new reactions into existing batch
     - Set new 10-second timeout
   - If key doesn't exist:
     - Create new pending entry with reactor info
     - Set 10-second timeout
   - When timeout fires:
     - Format message as "Name reacted üòÇ√ó2 ‚ù§Ô∏è√ó1 to your photo"
     - Send notification via existing sendPushNotification
     - Write to `notifications` collection
     - Delete pending entry

3. Helper function to format emoji√ócount:
   ```javascript
   function formatReactionSummary(reactions) {
     // reactions = { 'üòÇ': 2, '‚ù§Ô∏è': 1 }
     return Object.entries(reactions)
       .map(([emoji, count]) => `${emoji}√ó${count}`)
       .join(' ');
   }
   ```

IMPORTANT: Use `setTimeout` for the 10-second window. Cloud Functions can run for up to 540 seconds (9 min) which accommodates the 10-second debounce.

IMPORTANT: The reactions passed to format should be the DIFF (what changed in this session), not total reactions on photo.
  </action>
  <verify>
Deploy function with `firebase deploy --only functions`. Check Firebase Functions logs show debounce behavior: "Starting reaction batch for..." and "Sending batched notification..."
  </verify>
  <done>
- sendReactionNotification includes 10-second debounce logic
- pendingReactions object tracks in-flight batches
- formatReactionSummary helper produces "üòÇ√ó2 ‚ù§Ô∏è√ó1" format
- Function deployed to Firebase
  </done>
</task>

<task type="auto">
  <name>Task 2: Create notifications collection and write aggregated notifications</name>
  <files>functions/index.js</files>
  <action>
Extend the debounce timeout handler in sendReactionNotification to write to Firestore `notifications` collection:

1. When sending the batched notification, also write to Firestore:
   ```javascript
   await admin.firestore().collection('notifications').add({
     recipientId: photoOwnerId,       // User who receives notification
     type: 'reaction',                // Notification type
     senderId: reactorId,             // User who reacted
     senderName: reactorName,         // Cached for display
     senderProfilePhotoURL: senderProfilePhotoURL, // Cached for display
     photoId: photoId,                // Reference to photo
     reactions: reactions,            // { 'üòÇ': 2, '‚ù§Ô∏è': 1 } - the batch
     message: `${reactorName} reacted ${formatReactionSummary(reactions)} to your photo`,
     createdAt: admin.firestore.FieldValue.serverTimestamp(),
     read: false,                     // For future read/unread tracking (out of scope but cheap to add)
   });
   ```

2. Fetch sender's profilePhotoURL when creating the pending entry (needed for notification display).

3. Ensure the notification message follows the format: "Name reacted üòÇ√ó2 ‚ù§Ô∏è√ó1 to your photo"

IMPORTANT: The `notifications` collection stores ALL notification types eventually, but for this phase we only write reaction notifications. Friend requests and photo reveals continue using push-only (no Firestore storage).
  </action>
  <verify>
Trigger a reaction via the app. Wait 10+ seconds. Check Firestore Console ‚Üí notifications collection for new document with correct structure.
  </verify>
  <done>
- notifications collection created in Firestore
- Reaction notifications written with recipientId, type, senderId, senderName, senderProfilePhotoURL, photoId, reactions, message, createdAt, read fields
- Message format matches "Name reacted üòÇ√ó2 ‚ù§Ô∏è√ó1 to your photo"
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `firebase deploy --only functions` succeeds
- [ ] Rapid tapping (5+ reactions in 5 seconds) produces only ONE push notification after 10 seconds
- [ ] Notification message shows emoji√ócount format
- [ ] Firestore `notifications` collection contains aggregated notification document
- [ ] Existing friend request and photo reveal notifications still work (not affected)
</verification>

<success_criteria>
- Cloud Function deployed with debouncing
- 10-second batching window works correctly
- Emoji√ócount format renders correctly
- Notifications stored in Firestore for frontend display
</success_criteria>

<output>
After completion, create `.planning/phases/18-reaction-notification-debouncing/18-01-SUMMARY.md`:

# Phase 18 Plan 01: Backend - Cloud Function Debouncing Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `functions/index.js` - Added debouncing logic and notifications collection write

## Decisions Made

[Any implementation choices]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 18-02-PLAN.md (Notifications Feed UI)
</output>
