---
phase: 36-comments-feature
plan: 36-03-FIX-3
type: fix
---

<objective>
Fix 8 UAT issues from plan 36-03 Round 4.

Source: 36-03-ISSUES.md
Priority: 0 critical, 2 major, 2 minor, 4 cosmetic
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/36-comments-feature/36-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/36-comments-feature/36-03-PLAN.md

**Key source files:**
@src/components/PhotoDetailModal.js
@src/components/comments/CommentsBottomSheet.js
@src/components/comments/CommentRow.js
@src/components/comments/CommentInput.js
@src/hooks/usePhotoDetailModal.js
@src/styles/PhotoDetailModal.styles.js
@src/styles/CommentsBottomSheet.styles.js
@src/styles/CommentRow.styles.js
@src/styles/CommentInput.styles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-026 PhotoDetailModal swipe-to-close (feed mode) [MAJOR]</name>
  <files>src/hooks/usePhotoDetailModal.js</files>
  <action>
The PanResponder conditions may be preventing swipe gesture capture in feed mode:
- In stories mode, TouchableWithoutFeedback wraps the photo
- In feed mode, no TouchableWithoutFeedback, but panResponder should still work

Debug the PanResponder by checking:

1. onStartShouldSetPanResponder returns false (correct - don't capture taps)
2. onMoveShouldSetPanResponder checks gestureState.dy > 10

The issue: onMoveShouldSetPanResponderCapture returns false unless gestureState.dy > 10, but this might not be reached if the gesture isn't being captured at all.

Fix by adjusting panResponder to be more permissive:

- Change onMoveShouldSetPanResponder to capture on ANY downward movement (dy > 0)
- The threshold of 10px is too high for some swipes
- Alternative: lower threshold to dy > 5 for initial capture

Also ensure the panHandlers are properly attached to a View that spans the full modal area.
</action>
<verify>
Test in Expo Go:

1. Open photo from feed
2. Swipe down on the photo
3. Modal should follow finger and close when threshold reached
   </verify>
   <done>Swipe-to-close works in feed mode PhotoDetailModal</done>
   </task>

<task type="auto">
  <name>Task 2: Fix UAT-021 keyboard covers comments (sheet moves up) [MAJOR]</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/styles/CommentsBottomSheet.styles.js</files>
  <action>
Current implementation expands sheet height when keyboard visible, but user wants sheet to MOVE UP above keyboard.

Solution: Use Animated.Value to translate sheet up when keyboard shows.

1. Add keyboard height state tracking using Keyboard.addListener
2. Create animated translateY value for sheet position
3. When keyboard shows: animate sheet up by keyboard height
4. When keyboard hides: animate sheet back to original position

Implementation:

```javascript
const sheetTranslateY = useRef(new Animated.Value(0)).current;

// In keyboard listeners:
const handleKeyboardShow = event => {
  const keyboardHeight = event.endCoordinates.height;
  setKeyboardVisible(true);
  Animated.timing(sheetTranslateY, {
    toValue: -keyboardHeight,
    duration: 250,
    useNativeDriver: true,
  }).start();
};

const handleKeyboardHide = () => {
  setKeyboardVisible(false);
  Animated.timing(sheetTranslateY, {
    toValue: 0,
    duration: 200,
    useNativeDriver: true,
  }).start();
};
```

Apply sheetTranslateY to the outer Animated.View style in addition to existing translateY.

Remove the previous fix that expanded maxHeight - the sheet should stay at 60% but move up.
</action>
<verify>
Test in Expo Go:

1. Open CommentsBottomSheet
2. Tap input to open keyboard
3. Entire sheet should move UP above keyboard
4. Comments content should remain visible
5. Tap outside input or dismiss keyboard - sheet returns to original position
   </verify>
   <done>Keyboard appears, sheet moves up, comments content visible</done>
   </task>

<task type="auto">
  <name>Task 3: Fix UAT-020 CommentsBottomSheet swipe-to-close [MINOR]</name>
  <files>src/components/comments/CommentsBottomSheet.js</files>
  <action>
Add PanResponder to CommentsBottomSheet for swipe-to-close gesture, similar to PhotoDetailModal.

1. Create PanResponder for handle bar area (or full sheet):

```javascript
const panResponder = useRef(
  PanResponder.create({
    onStartShouldSetPanResponder: () => false,
    onMoveShouldSetPanResponder: (_, gestureState) => {
      // Respond to downward swipes
      return gestureState.dy > 5;
    },
    onPanResponderMove: (_, gestureState) => {
      if (gestureState.dy > 0) {
        // Update translateY to follow finger
        translateY.setValue(gestureState.dy);
      }
    },
    onPanResponderRelease: (_, gestureState) => {
      // Close if dragged down >1/4 of sheet or fast swipe
      if (gestureState.dy > SHEET_HEIGHT * 0.25 || gestureState.vy > 0.5) {
        // Animate out and close
        Animated.timing(translateY, {
          toValue: SHEET_HEIGHT,
          duration: 200,
          useNativeDriver: true,
        }).start(() => onClose());
      } else {
        // Spring back
        Animated.spring(translateY, {
          toValue: 0,
          useNativeDriver: true,
        }).start();
      }
    },
  })
).current;
```

2. Attach panResponder.panHandlers to the sheet's handle bar View or outer container.

Note: Be careful not to interfere with FlatList scrolling - only capture gestures on the handle bar area, not the content area.
</action>
<verify>
Test in Expo Go:

1. Open CommentsBottomSheet
2. Swipe down on handle bar
3. Sheet should follow finger
4. Release past threshold - sheet closes
5. Release before threshold - sheet springs back
6. FlatList scrolling still works in comments area
   </verify>
   <done>Swipe-to-close works on CommentsBottomSheet handle bar</done>
   </task>

<task type="auto">
  <name>Task 4: Fix UAT-027 user info and preview 6px rightward shift [COSMETIC]</name>
  <files>src/styles/PhotoDetailModal.styles.js</files>
  <action>
User wants all overlay elements shifted 6px to the right.

Current values (all left: 16):

- profilePicContainer
- userInfoOverlay
- commentPreviewContainer

Change all to left: 22 (16 + 6):

- profilePicContainer: left: 22
- userInfoOverlay: left: 22
- commentPreviewContainer: left: 22
  </action>
  <verify>Visual inspection in Expo Go - elements are 6px further right</verify>
  <done>User info and preview elements shifted 6px right (left: 22)</done>
  </task>

<task type="auto">
  <name>Task 5: Fix UAT-022 and UAT-023 spacing issues [COSMETIC]</name>
  <files>src/components/PhotoDetailModal.js, src/styles/PhotoDetailModal.styles.js</files>
  <action>
Two spacing issues to fix:

**UAT-022: Username too close to photo bottom when no comments**
Current: bottom: 100 when no comments (overcorrected)
Fix: Change to bottom: 102 for ~2px more space

**UAT-023: Spacing between user info and comment preview too large**
Current: userInfoOverlay bottom: 140, commentPreviewContainer bottom: 100
Gap is 40px which is excessive.

Fix by adjusting positions:

- userInfoOverlay with comments: bottom: 130 (was 140)
- commentPreviewContainer: bottom: 100 (keep same)
- Gap reduced to 30px

Update PhotoDetailModal.js inline style:

```javascript
style={[styles.userInfoOverlay, { bottom: previewComments?.length > 0 ? 130 : 102 }]}
```

  </action>
  <verify>
Visual inspection in Expo Go:
1. Photo with 0 comments - username has comfortable spacing from bottom
2. Photo with comments - user info closer to comment preview (30px gap vs 40px)
  </verify>
  <done>Spacing adjusted: 102 bottom for no comments, 130 for with comments</done>
</task>

<task type="auto">
  <name>Task 6: Fix UAT-024 timestamp too far from Reply button [COSMETIC]</name>
  <files>src/styles/CommentRow.styles.js</files>
  <action>
Current dot style has marginHorizontal: 6, creating 12px total gap.

Reduce spacing by changing:

- dot marginHorizontal: 4 (from 6)

This tightens the "Reply Â· 2h ago" spacing.
</action>
<verify>Visual inspection - Reply button and timestamp appear closer together</verify>
<done>Timestamp spacing reduced (dot marginHorizontal: 4)</done>
</task>

<task type="auto">
  <name>Task 7: Fix UAT-025 send button height mismatch [COSMETIC]</name>
  <files>src/styles/CommentInput.styles.js</files>
  <action>
Current:
- sendButton: 36x36 (height: 36)
- inputWrapper: minHeight: 40

Send button is 4px shorter than input field.

Fix by changing sendButton dimensions to match inputWrapper minHeight:

- width: 40 (from 36)
- height: 40 (from 36)
- borderRadius: 20 (from 18, to maintain circle)
  </action>
  <verify>Visual inspection - Send button same height as input field</verify>
  <done>Send button height matches input field (40x40)</done>
  </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UAT-026: PhotoDetailModal swipe-to-close works in feed mode
- [ ] UAT-021: Keyboard opens, sheet moves up, comments visible
- [ ] UAT-020: CommentsBottomSheet swipe-to-close on handle bar works
- [ ] UAT-027: Overlay elements shifted 6px right
- [ ] UAT-022: Username spacing comfortable with 0 comments
- [ ] UAT-023: User info closer to comment preview
- [ ] UAT-024: Reply/timestamp spacing tighter
- [ ] UAT-025: Send button same height as input
- [ ] No regressions in existing functionality
- [ ] App builds and runs without errors
</verification>

<success_criteria>

- All 8 UAT issues from 36-03-ISSUES.md Round 4 addressed
- No TypeScript/ESLint errors
- Ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/36-comments-feature/36-03-FIX-3-SUMMARY.md`
</output>
