---
phase: 36-comments-feature
plan: 03-FIX
type: fix
---

<objective>
Fix 8 UAT issues from plan 36-03.

Source: 36-03-ISSUES.md
Priority: 3 Major, 5 Minor

**Major Issues:**

- UAT-002: Comment doesn't appear in list after submitting
- UAT-005: Comment button on feed cards doesn't open CommentsBottomSheet
- UAT-006: Client-side filtering bandaid for Firestore composite index

**Minor Issues:**

- UAT-001: Footer layout ~1/3 not 50/50
- UAT-003: CommentsBottomSheet closes on send
- UAT-004: Preview comments overlap with user's name
- UAT-007: Keyboard doesn't auto-open
- UAT-008: Poor empty state for CommentsBottomSheet
  </objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/36-comments-feature/36-03-ISSUES.md

**Original plan for reference:**
@.planning/phases/36-comments-feature/36-03-PLAN.md

**Key source files:**
@src/components/PhotoDetailModal.js
@src/hooks/usePhotoDetailModal.js
@src/styles/PhotoDetailModal.styles.js
@src/components/comments/CommentsBottomSheet.js
@src/components/comments/CommentInput.js
@src/components/comments/CommentPreview.js
@src/components/FeedPhotoCard.js
@src/hooks/useComments.js
@src/services/firebase/commentService.js
@firestore.indexes.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix UAT-002 - Comment not appearing in list after submitting</name>
  <files>src/hooks/useComments.js, src/components/comments/CommentsBottomSheet.js, src/services/firebase/commentService.js</files>
  <action>
**Investigate and fix why new comments don't appear in the list:**

Likely causes:

1. Real-time subscription not set up correctly
2. Optimistic UI update missing
3. Comment being added to different collection/path than subscription is watching

**Debug steps:**

1. Check commentService.subscribeToComments - verify it's watching the correct path: `photos/{photoId}/comments`
2. Check useComments hook - verify subscription is active and updating state
3. Check addComment - verify it writes to the same path the subscription watches

**Implementation:**

1. In useComments.js, ensure subscribeToComments is called on mount and cleans up on unmount
2. Verify the onSnapshot callback properly updates the comments array state
3. Add optimistic update: append new comment to state immediately after addComment succeeds
4. Ensure Firestore subcollection path matches between write and read

**If subscription works but needs refresh:**

- After addComment completes, manually trigger a refresh of the comments list
- Or ensure the subscription is receiving the update (check Firestore rules allow reading)

**Note:** Do NOT rely solely on optimistic updates - the subscription should work. But optimistic update improves UX.
</action>
<verify>
Open CommentsBottomSheet, type a comment, submit. Comment should appear in the list immediately (or within 1-2 seconds via subscription).
</verify>
<done>

- Comments appear in list after submitting
- Real-time subscription working correctly
- Optimistic UI update for instant feedback
  </done>
  </task>

<task type="auto">
  <name>Task 2: Fix UAT-003 + UAT-007 + UAT-008 - Bottom sheet UX improvements</name>
  <files>src/components/comments/CommentsBottomSheet.js, src/components/comments/CommentInput.js</files>
  <action>
**Fix three related bottom sheet UX issues:**

**UAT-003: Sheet closes on comment send**

- Find where the sheet closes after sending
- Remove or disable the onClose call in the send handler
- Sheet should stay open to allow viewing/adding more comments

**UAT-007: Keyboard doesn't auto-open**

- Add autoFocus={true} to the TextInput in CommentInput.js
- Or use useRef + useEffect to focus the input when sheet becomes visible
- May need to delay focus slightly: `setTimeout(() => inputRef.current?.focus(), 300)`

**UAT-008: Poor empty state**

- Add consistent height to CommentsBottomSheet when empty
- Add empty state view: "No comments yet" centered text
- Set minHeight to ~50% of screen height (use Dimensions.get('window').height \* 0.5)

**Implementation details:**

In CommentsBottomSheet.js:

```javascript
// Set consistent height
const { height: screenHeight } = Dimensions.get('window');
const MIN_SHEET_HEIGHT = screenHeight * 0.5;

// Empty state
{
  comments.length === 0 && (
    <View style={styles.emptyState}>
      <Text style={styles.emptyStateText}>No comments yet</Text>
      <Text style={styles.emptyStateSubtext}>Be the first to comment</Text>
    </View>
  );
}
```

In CommentInput.js:

```javascript
const inputRef = useRef(null);

useEffect(() => {
  // Auto-focus when component mounts (sheet opened)
  const timer = setTimeout(() => {
    inputRef.current?.focus();
  }, 300); // Delay for sheet animation
  return () => clearTimeout(timer);
}, []);
```

For staying open after send - find the onSubmit/handleSend and remove any setShowComments(false) call.
</action>
<verify>

1. Open CommentsBottomSheet - keyboard should appear automatically
2. On empty photo - sheet should be ~50% height with "No comments yet" message
3. Submit a comment - sheet should stay open, not close
   </verify>
   <done>

- Sheet stays open after sending comment (UAT-003)
- Keyboard auto-opens when sheet appears (UAT-007)
- Empty state shows ~50% height with message (UAT-008)
  </done>
  </task>

<task type="auto">
  <name>Task 3: Fix UAT-005 - Feed card comment button doesn't open CommentsBottomSheet</name>
  <files>src/components/FeedPhotoCard.js, src/screens/FeedScreen.js</files>
  <action>
**Wire up comment button on feed cards to open PhotoDetailModal with comments visible:**

The feed card should have a comment button/icon that:

1. Opens the PhotoDetailModal
2. Automatically opens the CommentsBottomSheet

**Implementation:**

In FeedPhotoCard.js:

- Add onCommentsPress prop
- Render a comment icon/button (speech bubble)
- onPress calls onCommentsPress(photo)

In FeedScreen.js:

- Add handler: handleCommentsPress = (photo) => { ... }
- This handler should:
  1. Open PhotoDetailModal with the selected photo
  2. Signal that comments should auto-open

**Option A: Use navigation params**

```javascript
// FeedScreen
const handleCommentsPress = photo => {
  setSelectedPhoto(photo);
  setShowModal(true);
  setAutoOpenComments(true); // New state
};
```

Then pass autoOpenComments to PhotoDetailModal which triggers setShowComments(true) on mount.

**Option B: Direct callback**

```javascript
// Pass showComments setter to PhotoDetailModal
<PhotoDetailModal
  ...
  initialShowComments={autoOpenComments}
  onOpened={() => setAutoOpenComments(false)} // Reset
/>
```

In PhotoDetailModal, check initialShowComments prop in useEffect and open sheet if true.

**Also check:**

- Does CommentPreview's "View all X comments" link work?
- Does the preview in feed card respond to taps?
  </action>
  <verify>
  On Feed screen, tap the comment button on a feed card. PhotoDetailModal should open with CommentsBottomSheet already visible.
  </verify>
  <done>
- Comment button on feed cards triggers modal + comments sheet
- Tapping comment preview also opens comments
- "View all X comments" link works
  </done>
  </task>

<task type="auto">
  <name>Task 4: Fix UAT-001 + UAT-004 - Footer layout and preview overlap</name>
  <files>src/styles/PhotoDetailModal.styles.js, src/components/PhotoDetailModal.js, src/components/comments/CommentPreview.js</files>
  <action>
**Fix two layout issues:**

**UAT-001: Footer layout ~1/3 not 50/50**

In PhotoDetailModal.styles.js, ensure footer children have equal flex:

```javascript
footer: {
  flexDirection: 'row',
  alignItems: 'center',
  paddingHorizontal: 16,
  paddingVertical: 8,
},
commentInputTrigger: {
  flex: 1, // Equal flex
  // ... other styles
},
emojiPickerContainer: {
  flex: 1, // Equal flex (was probably missing or different)
  // ... other styles
},
```

Check if there's padding/margin causing the imbalance.

**UAT-004: Preview comments overlap with user's name**

In PhotoDetailModal.js, ensure CommentPreview is positioned correctly:

- Should be BELOW the userInfoOverlay
- Add proper marginTop to create spacing
- Check z-index if needed

Layout order should be:

1. Photo
2. User info (name + timestamp)
3. CommentPreview (with margin from user info)
4. Progress bar (stories mode)
5. Footer (comment input + emojis)

**In styles:**

```javascript
commentPreviewContainer: {
  marginTop: 8, // Space from user info
  marginBottom: 8, // Space before progress/footer
  paddingHorizontal: 16,
},
```

Ensure there's no absolute positioning causing overlap.
</action>
<verify>

1. Footer should be visually 50/50 split between comment trigger and emoji pills
2. Preview comments should appear below username with clear spacing, no overlap
   </verify>
   <done>

- Footer is 50/50 split (UAT-001)
- Preview comments properly positioned below user info (UAT-004)
- No layout overlaps
  </done>
  </task>

<task type="auto">
  <name>Task 5: Fix UAT-006 - Deploy Firestore composite index for comments</name>
  <files>firestore.indexes.json, src/services/firebase/commentService.js</files>
  <action>
**Deploy proper Firestore composite index instead of client-side filtering:**

**Step 1: Create/update firestore.indexes.json**

Add the composite index for the comments subcollection query:

```json
{
  "indexes": [
    {
      "collectionGroup": "comments",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "parentId", "order": "ASCENDING" },
        { "fieldPath": "createdAt", "order": "DESCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

**Note:** The collectionGroup "comments" will apply to all photos/{photoId}/comments subcollections.

**Step 2: Deploy the index**

```bash
firebase deploy --only firestore:indexes
```

**Step 3: Revert client-side filtering in commentService.js**

In getPreviewComments, restore the proper query:

```javascript
const q = query(
  collection(db, 'photos', photoId, 'comments'),
  where('parentId', '==', null),
  orderBy('createdAt', 'desc'),
  limit(3)
);
```

Remove the client-side filter that was added as workaround.

**Step 4: Handle index building delay**

Composite indexes take time to build (minutes to hours for large collections).

- Keep a fallback to client-side filtering if query fails with "index not ready"
- Log a warning instead of error during transition period
- Once index is ready, the query will work server-side

**Alternative if index deployment is blocked:**
Document this as a production deployment task and keep client-side filtering for now, but clean up the error logging so it doesn't spam the console.
</action>
<verify>

1. Run firebase deploy --only firestore:indexes
2. Wait for index to build (check Firebase console)
3. Open a photo modal - no more ERROR in console for getPreviewComments
4. Preview comments load without errors
   </verify>
   <done>

- Firestore composite index deployed
- Query uses server-side filtering
- No more error logs for preview comments
- Client-side fallback for transition period (if needed)
  </done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Fixes for all 8 UAT issues from plan 36-03</what-built>
  <how-to-verify>
1. Run: npx expo start
2. Open the app on a test device

**Test UAT-001 (Footer layout):** 3. Open PhotoDetailModal on any photo 4. Verify: Footer is 50/50 split - comment area and emoji pills equal width

**Test UAT-002 (Comment appears in list):** 5. Open CommentsBottomSheet 6. Type and submit a comment 7. Verify: Comment appears in list immediately

**Test UAT-003 (Sheet stays open):** 8. After submitting comment, verify sheet stays open (doesn't close)

**Test UAT-004 (No overlap):** 9. Check preview comments in modal - should be below username, no overlap

**Test UAT-005 (Feed card comment button):** 10. Close modal, return to feed 11. Tap comment icon/button on a feed card 12. Verify: Modal opens with CommentsBottomSheet already visible

**Test UAT-006 (No console errors):** 13. Check console - should not see ERROR for getPreviewComments

**Test UAT-007 (Keyboard auto-open):** 14. Open CommentsBottomSheet 15. Verify: Keyboard appears automatically without extra tap

**Test UAT-008 (Empty state):** 16. Find a photo with no comments, open CommentsBottomSheet 17. Verify: Sheet is ~50% height with "No comments yet" message
</how-to-verify>
<resume-signal>Type "approved" if all issues fixed, or describe remaining issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All 3 Major issues fixed (UAT-002, UAT-005, UAT-006)
- [ ] All 5 Minor issues fixed (UAT-001, UAT-003, UAT-004, UAT-007, UAT-008)
- [ ] Original acceptance criteria from issues met
- [ ] No console errors related to comments
</verification>

<success_criteria>

- All UAT issues from 36-03-ISSUES.md addressed
- Comments functionality works end-to-end
- UX is smooth and Instagram-like
- Ready for re-verification
  </success_criteria>

<output>
After completion, create `.planning/phases/36-comments-feature/36-03-FIX-SUMMARY.md`
</output>
