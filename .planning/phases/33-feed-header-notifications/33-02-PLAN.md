---
phase: 33-feed-header-notifications
plan: 02
type: execute
---

<objective>
Implement Notifications tab with pinned friend requests and Friends tab consolidating existing friend management screens.

Purpose: Create the actual content for both Activity page tabs, making it a functional social hub.
Output: NotificationsTab with pinned requests + reactions, FriendsTab with full friend management.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/33-feed-header-notifications/33-CONTEXT.md

@src/screens/ActivityScreen.js
@src/screens/NotificationsScreen.js
@src/screens/FriendsListScreen.js
@src/screens/UserSearchScreen.js
@src/screens/FriendRequestsScreen.js
@src/services/firebase/friendshipService.js

**Tech stack available:**

- Firestore queries for notifications and friendships
- Existing friendship service functions (getPendingRequests, getFriendships, etc.)

**Established patterns:**

- FlatList with RefreshControl for data lists
- Profile photo + message + timestamp layout (NotificationsScreen)
- Tabbed interface pattern (FriendRequestsScreen has Received/Sent tabs)

**From 33-CONTEXT.md:**

- Friend requests pinned at top of Notifications tab (not inline chronologically)
- Instagram Activity style: clean rows with profile photos, names, action text, timestamps
- Friends tab consolidates all friend-related actions
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Create NotificationsTab with pinned friend requests</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Replace the NotificationsTab placeholder with full implementation:

1. **State management:**
   - friendRequests[] for pinned section (pending requests where user is recipient)
   - notifications[] for reaction notifications
   - loading, refreshing states
   - Use user.uid from useAuth()

2. **Data fetching (useCallback + useEffect):**
   - Fetch pending friend requests: query friendships where status='pending' AND user is NOT requestedBy
   - Fetch notifications: existing query from NotificationsScreen (recipientId, orderBy createdAt desc)
   - Mark notifications as read when tab is viewed (update read=true in Firestore)

3. **Render structure:**
   - **Pinned Friend Requests Section** (if any exist):
     - Section header: "Friend Requests" with count badge
     - Horizontal-ish list or vertical cards showing:
       - Profile photo, username, "wants to be friends" text
       - Accept (checkmark) and Decline (X) buttons
     - Tapping request navigates to full FriendRequests screen for more options
   - **Reactions List** (below pinned section):
     - Section header: "Reactions" (or no header, just list)
     - Vertical FlatList with existing notification item pattern
     - Profile photo, "[Name] reacted [emoji] to your photo", timestamp
     - Tapping opens photo in PhotoDetailModal (same as current behavior)

4. **Pull-to-refresh:** Refresh both friend requests and notifications

5. **Empty state:** Different messages for no requests vs no reactions

Style with dark theme (black background, white text) matching the Activity page.
</action>
<verify>
Open Activity screen, Notifications tab should show:

- Pinned friend requests at top (if any pending)
- Reaction notifications below
- Pull to refresh works
  </verify>
  <done>NotificationsTab displays pinned friend requests, reaction notifications, and handles empty states</done>
  </task>

<task type="auto">
  <name>Task 2: Create FriendsTab with consolidated friend management</name>
  <files>src/screens/ActivityScreen.js</files>
  <action>
Replace the FriendsTab placeholder with consolidated friend management:

1. **Layout structure (single scrollable view with sections):**
   - **Search bar** at top (text input with search icon)
   - **Search results section** (shows when search query entered)
   - **Pending Requests section** (collapsible or always visible)
     - Shows incoming + outgoing request counts
     - Tapping opens FriendRequestsScreen (existing screen)
   - **Friends list section** (main content)
     - Vertical list of accepted friends
     - Each row: profile photo, displayName, username
     - Swipe to remove friend OR tap for options

2. **State management:**
   - searchQuery string
   - searchResults[] (users matching query)
   - friends[] (accepted friendships)
   - pendingCount (incoming + outgoing)
   - loading, refreshing states

3. **Data fetching:**
   - Use existing friendshipService functions:
     - getFriendships(userId) for friends list
     - searchUsers pattern from UserSearchScreen (query by username)
   - Count pending requests for badge

4. **Actions:**
   - Search: debounced search (500ms) querying users collection
   - Send request: call sendFriendRequest()
   - View requests: navigate to FriendRequests screen
   - Remove friend: call removeFriend() with confirmation

5. **Integration:**
   - The Friends tab is the primary interface
   - FriendRequestsScreen remains accessible for detailed request management
   - UserSearchScreen functionality is inlined here

Style consistently with NotificationsTab (dark theme).
</action>
<verify>
Open Activity screen, Friends tab should show:

- Search bar functional
- Friends list displays
- Pending requests section with counts
- Can search for users and send requests
  </verify>
  <done>FriendsTab displays search, friends list, pending requests section with full functionality</done>
  </task>

<task type="auto">
  <name>Task 3: Add mark-as-read behavior for notifications</name>
  <files>src/screens/ActivityScreen.js, src/services/firebase/notificationService.js</files>
  <action>
1. **In notificationService.js**, add function:
   ```javascript
   export const markNotificationsAsRead = async (userId) => {
     // Query all unread notifications for user
     // Batch update read=true
     // Return success/error
   }
   ```

2. **In ActivityScreen.js NotificationsTab:**
   - When tab becomes active (useEffect with isFocused or useFocusEffect), call markNotificationsAsRead
   - This clears the red dot in FeedScreen (since dot checks for read=false)
   - Only mark as read AFTER data loads successfully

3. **Verify red dot behavior:**
   - Red dot should appear when new unread notifications exist
   - Red dot should disappear when Activity page is opened
   - New notifications after viewing should re-trigger red dot
     </action>
     <verify>
4. Create a reaction on a photo (triggers notification)
5. Verify red dot appears on feed heart icon
6. Open Activity screen
7. Return to Feed - red dot should be gone
   </verify>
   <done>Notifications marked as read when viewing Activity, red dot indicator clears correctly</done>
   </task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] NotificationsTab shows pinned friend requests at top
- [ ] NotificationsTab shows reactions list below requests
- [ ] FriendsTab has search, friends list, pending section
- [ ] Search in FriendsTab returns results and allows sending requests
- [ ] Mark-as-read works - red dot clears when opening Activity
- [ ] Pull-to-refresh works on both tabs
- [ ] No console errors or warnings
</verification>

<success_criteria>

- NotificationsTab fully functional with pinned requests
- FriendsTab consolidates friend management
- Mark-as-read clears notification indicator
- Both tabs styled consistently with dark theme
- Empty states handled gracefully
  </success_criteria>

<output>
After completion, create `.planning/phases/33-feed-header-notifications/33-02-SUMMARY.md`
</output>
