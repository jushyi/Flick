---
phase: 50.1-fix-failing-test-suites
plan: 01
subsystem: testing
tags: [jest, jest-expo, firestore-mock, test-infrastructure, cloud-functions]

# Dependency graph
requires:
  - phase: 49-automated-test-suite
    provides: Jest test infrastructure, test files, jest.setup.js
  - phase: 50-cicd-pipeline
    provides: PR checks workflow requiring npm test to pass
provides:
  - Cloud function test isolation from root jest config
  - Complete Firestore modular API mock (23 named exports)
  - performanceService global mock (withTrace pass-through)
  - Service-level mocks for blockService and albumService in dependent tests
affects: [50.1-02, testing, ci-cd]

# Tech tracking
tech-stack:
  added: []
  patterns: [sequential-test-runner, local-mock-override-pattern]

key-files:
  created: []
  modified:
    [
      jest.config.js,
      package.json,
      __tests__/setup/jest.setup.js,
      __tests__/services/friendshipService.test.js,
      __tests__/services/feedService.test.js,
      __tests__/services/photoService.test.js,
      __tests__/integration/friendshipFlow.test.js,
      __tests__/integration/photoLifecycle.test.js,
    ]

key-decisions:
  - 'Sequential test runner (&&) instead of Jest projects — two test suites have incompatible presets'
  - "Local service mocks instead of global for blockService/albumService — global mocks break those services' own test suites"
  - "performanceService mocked globally since it's infrastructure used by all services"

patterns-established:
  - 'Local mock override: test files that test a service import it directly; dependent test files mock it locally'
  - 'Firestore mock must include all modular API named exports matching source file imports'

issues-created: []

# Metrics
duration: 11min
completed: 2026-02-12
---

# Phase 50.1 Plan 01: Test Infrastructure & Mock Fixes Summary

**Cloud function test isolation via sequential runner, complete Firestore modular API mock with 23 named exports, and service-level mocks for performanceService/blockService/albumService**

## Performance

- **Duration:** 11 min
- **Started:** 2026-02-12T16:46:25Z
- **Completed:** 2026-02-12T16:57:31Z
- **Tasks:** 2/2
- **Files modified:** 8

## Accomplishments

- Cloud function tests isolated from root jest config — no longer fail under jest-expo preset
- Firestore mock in jest.setup.js now exports all 23 modular API functions used across source files
- friendshipService.test.js: 12 failures → 0 (all 63 tests pass)
- Service mocks added for performanceService (global), blockService (local), albumService (local)
- Test file local mocks fixed in 5 files (added missing limit, startAfter, writeBatch, Timestamp, FieldValue, getCountFromServer, documentId exports)
- Total app test failures reduced from 76 to 50 (remaining 50 are assertion-level diverged expectations for Plan 02)

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix Cloud Functions test isolation** - `4670fb9` (fix)
2. **Task 2: Fix Firestore mock and add missing service mocks** - `449f142` (fix)

## Files Created/Modified

- `jest.config.js` - Added functions/ to testPathIgnorePatterns
- `package.json` - Updated test script to run app then cloud function tests sequentially
- `__tests__/setup/jest.setup.js` - Complete Firestore modular API mock, performanceService global mock
- `__tests__/services/friendshipService.test.js` - Added limit, orderBy, documentId to local Firestore mock
- `__tests__/services/feedService.test.js` - Added limit, startAfter, Timestamp, getCountFromServer to local mock; added blockService mock
- `__tests__/services/photoService.test.js` - Added limit, writeBatch, Timestamp, FieldValue, getCountFromServer to local mock; added albumService mock
- `__tests__/integration/friendshipFlow.test.js` - Added limit, documentId to local mock; added blockService mock
- `__tests__/integration/photoLifecycle.test.js` - Added limit, writeBatch, FieldValue, getCountFromServer to local mock; added albumService mock

## Decisions Made

- Used sequential `&&` runner instead of Jest projects feature — the two test suites have completely different presets (jest-expo vs node) making projects configuration complex for no benefit
- Mocked blockService and albumService locally in dependent test files rather than globally — global mocks broke those services' own test suites by replacing real implementations
- Kept performanceService as global mock since it's infrastructure (withTrace) used by all services and has no dedicated test suite

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed local Firestore mocks in 5 test files**

- **Found during:** Task 2 (Firestore mock and service mocks)
- **Issue:** Test files define their own local `jest.mock('@react-native-firebase/firestore')` that overrides the global jest.setup.js mock. These local mocks were also missing limit, startAfter, writeBatch, etc. Fixing only jest.setup.js wouldn't help since local mocks take priority.
- **Fix:** Added missing Firestore exports to local mocks in friendshipService, feedService, photoService, friendshipFlow, and photoLifecycle test files
- **Files modified:** 5 test files (see Files Created/Modified above)
- **Verification:** friendshipService 63/63 pass, no "X is not a function" errors in any suite
- **Committed in:** 449f142

**2. [Rule 1 - Bug] Used local mocks instead of global for blockService/albumService**

- **Found during:** Task 2 (service mocks)
- **Issue:** Plan specified global mocks in jest.setup.js for blockService and albumService. But global mocks broke those services' own test suites (blockService.test.js, albumService.test.js) by replacing real implementations with stubs.
- **Fix:** Removed global mocks for blockService/albumService from jest.setup.js; added local mocks in feedService.test.js, photoService.test.js, friendshipFlow.test.js, and photoLifecycle.test.js instead.
- **Files modified:** jest.setup.js (removed), 4 test files (added local mocks)
- **Verification:** blockService.test.js and albumService.test.js pass again
- **Committed in:** 449f142

---

**Total deviations:** 2 auto-fixed (1 blocking, 1 bug)
**Impact on plan:** Both fixes necessary for correct mock isolation. No scope creep.

## Issues Encountered

- Plan target of ≤29 remaining failures not fully met (50 remain vs ≤29 target). The remaining 50 failures are all assertion-level mismatches (diverged test expectations) in feedService, photoService, friendshipFlow, and photoLifecycle — these are Plan 02 scope, not infrastructure issues.

## Next Phase Readiness

- All mock infrastructure issues resolved — no more "X is not a function" or module resolution errors
- Cloud function tests pass independently (88/88) and are excluded from root config
- friendshipService fully passes (63/63)
- Ready for 50.1-02: Fix Diverged Test Expectations in 4 remaining suites

---

_Phase: 50.1-fix-failing-test-suites_
_Completed: 2026-02-12_
