---
phase: 52.2-photo-tagging-lag
plan: 01
type: execute
---

<objective>
Fix photo tagging lag where tags don't appear immediately without manual refresh. When a user tags someone in a photo, the checkmark should appear instantly when reopening the tag sheet, and the tag badge should update in real-time across all views (feed, story, photo detail).

Purpose: Make tagging feel instant and reliable by syncing UI state with Firestore changes in real-time
Output: Tags update instantly - checkmarks appear when reopening tag sheet, badges update across all views
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/52.2-photo-tagging-lag/52.2-CONTEXT.md
@.planning/phases/52.2-photo-tagging-lag/52.2-RESEARCH.md

**Issue:** ISS-016 found during Plan 52-02 (Multi-Device Tests) UAT testing
**Root cause:** UI state not updating when Firestore data changes - missing real-time subscriptions and FlatList extraData

**Research findings:**

- Standard approach: Firestore `onSnapshot()` in `useEffect` with cleanup
- FlatList needs `extraData` prop when renderItem depends on external state
- Always create new object references when updating state (no in-place mutations)
- Common pitfalls: missing cleanup, stale closures, missing extraData, cache vs server confusion

**Current implementation gaps:**

1. `TagFriendsModal.js` - Missing FlatList `extraData` prop (line 215-225)
2. `PhotoDetailScreen.js` - No subscription to `currentPhoto` updates
3. `photoService.js` - No `subscribePhoto` function (needs to be added)

**Existing patterns:**

- `feedService.js` `subscribeFeedPhotos` (line 230-321) - Follow this pattern
- Uses `onSnapshot` with callback, returns unsubscribe function
- Hydrates photos with user data via `batchFetchUserData`

**Tech available:**

- @react-native-firebase/firestore - Already imported, onSnapshot available
- React hooks (useEffect, useState) - Standard in codebase
- FlatList - React Native core component

**Established patterns:**

- Service layer exports subscribe functions that take callbacks
- Components use subscriptions in useEffect with cleanup
- Logger utility for debug/info/error logging
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add photo subscription service function</name>
  <files>src/services/firebase/photoService.js</files>
  <action>
Create `subscribePhoto(photoId, callback)` function following the pattern from `feedService.js` `subscribeFeedPhotos`.

Implementation details:

- Add function after `updatePhotoTags` (around line 1120)
- Use `onSnapshot(doc(db, 'photos', photoId), ...)` to listen to single photo document
- Call callback with `{ success: true, photo: photoData }` on updates
- Call callback with `{ success: false, error: message }` on errors
- Return unsubscribe function
- Add logger.info for subscription start and logger.error for errors
- Export the function

Pattern to follow:

```javascript
export const subscribePhoto = (photoId, callback) => {
  try {
    const photoRef = doc(db, 'photos', photoId);

    const unsubscribe = onSnapshot(
      photoRef,
      snapshot => {
        if (snapshot.exists()) {
          callback({ success: true, photo: { id: snapshot.id, ...snapshot.data() } });
        } else {
          callback({ success: false, error: 'Photo not found' });
        }
      },
      error => {
        logger.error('subscribePhoto: Error', { photoId, error: error.message });
        callback({ success: false, error: error.message });
      }
    );

    return unsubscribe;
  } catch (error) {
    logger.error('subscribePhoto: Setup failed', { photoId, error: error.message });
    return () => {}; // Return no-op cleanup
  }
};
```

Don't add user data hydration - keep it simple, just return photo document data. Parent components can hydrate user data if needed.
</action>
<verify>
Search for "export const subscribePhoto" in photoService.js - function should exist with onSnapshot pattern and return unsubscribe function
</verify>
<done>
subscribePhoto function exists in photoService.js, exports function that takes photoId and callback, uses onSnapshot, returns unsubscribe function, follows established service patterns
</done>
</task>

<task type="auto">
  <name>Task 2: Add FlatList extraData to TagFriendsModal</name>
  <files>src/components/TagFriendsModal.js</files>
  <action>
Add `extraData` prop to the FlatList component in TagFriendsModal to force re-renders when `selectedIds` state changes.

Location: Line 215-225 in TagFriendsModal.js

Current code:

```javascript
<FlatList
  data={friends}
  renderItem={renderFriendItem}
  keyExtractor={keyExtractor}
  contentContainerStyle={styles.listContent}
  showsVerticalScrollIndicator={false}
  initialNumToRender={10}
  maxToRenderPerBatch={8}
  windowSize={5}
  removeClippedSubviews={true}
/>
```

Change to:

```javascript
<FlatList
  data={friends}
  extraData={selectedIds} // ADD THIS LINE - forces re-render when selection changes
  renderItem={renderFriendItem}
  keyExtractor={keyExtractor}
  contentContainerStyle={styles.listContent}
  showsVerticalScrollIndicator={false}
  initialNumToRender={10}
  maxToRenderPerBatch={8}
  windowSize={5}
  removeClippedSubviews={true}
/>
```

Why: FlatList is a PureComponent that uses shallow equality checks on props. When renderItem (line 127-174) depends on external state like `selectedIds` (line 129), FlatList won't detect the change unless we pass that state via `extraData`. Without this, checkmarks don't appear/disappear when toggling selections.

This is Research Pitfall #3 - "FlatList Not Re-rendering with External State".
</action>
<verify>
Read TagFriendsModal.js line 215-225, confirm FlatList has `extraData={selectedIds}` prop between `data` and `renderItem` props
</verify>
<done>
FlatList in TagFriendsModal has extraData prop set to selectedIds, positioned after data prop, properly formatted
</done>
</task>

<task type="auto">
  <name>Task 3: Subscribe to photo in PhotoDetailScreen</name>
  <files>src/screens/PhotoDetailScreen.js</files>
  <action>
Add real-time subscription to the current photo document so `currentPhoto` state updates when Firestore changes (like when tags are added).

Steps:

1. Import subscribePhoto at top of file (around line 44-48 with other photoService imports):

```javascript
import {
  deletePhotoCompletely,
  archivePhoto,
  updatePhotoTags,
  subscribePhoto, // ADD THIS
} from '../services/firebase/photoService';
```

2. Add useEffect hook to subscribe to currentPhoto updates. Insert after the existing useEffect that sets up keyboard listeners (find a good spot around line 150-200 based on existing useEffect hooks).

```javascript
// Subscribe to current photo for real-time updates (tags, reactions, etc.)
useEffect(() => {
  if (!currentPhoto?.id) return;

  logger.debug('PhotoDetailScreen: Setting up photo subscription', { photoId: currentPhoto.id });

  const unsubscribe = subscribePhoto(currentPhoto.id, result => {
    if (result.success && result.photo) {
      logger.debug('PhotoDetailScreen: Photo updated from subscription', {
        photoId: result.photo.id,
        tagCount: result.photo.taggedUserIds?.length || 0,
      });

      // Update current photo state with latest data from Firestore
      setCurrentPhoto(prev => ({
        ...prev,
        ...result.photo,
      }));
    } else {
      logger.warn('PhotoDetailScreen: Photo subscription error', { error: result.error });
    }
  });

  return () => {
    logger.debug('PhotoDetailScreen: Cleaning up photo subscription', { photoId: currentPhoto.id });
    unsubscribe();
  };
}, [currentPhoto?.id]);
```

Why: currentPhoto is initialized from navigation params but never updates when Firestore changes. When a user tags someone, updatePhotoTags updates Firestore, but currentPhoto stays stale. Next time TagFriendsModal opens, it gets stale initialSelectedIds from currentPhoto.taggedUserIds.

With this subscription:

- Photo tags update → Firestore updates → onSnapshot fires → setCurrentPhoto updates → tag badge shows new count
- Next modal open → initialSelectedIds is fresh → checkmarks appear correctly

3. Make sure the dependency array only includes `currentPhoto?.id` to avoid re-subscribing unnecessarily.
   </action>
   <verify>
   Read PhotoDetailScreen.js:
1. Check imports include subscribePhoto from photoService
1. Search for "subscribePhoto(currentPhoto.id" - useEffect with photo subscription should exist
1. Verify cleanup function returns unsubscribe()
1. Verify dependency array is [currentPhoto?.id]
   </verify>
   <done>
   PhotoDetailScreen imports subscribePhoto, has useEffect subscribing to currentPhoto.id, updates state on changes, cleanup function returns unsubscribe, dependency array correct
   </done>
   </task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] subscribePhoto function exists in photoService.js and follows established patterns
- [ ] TagFriendsModal FlatList has extraData={selectedIds} prop
- [ ] PhotoDetailScreen imports and uses subscribePhoto
- [ ] No console.log usage (logger only)
- [ ] All logger calls use appropriate levels (debug/info/warn/error)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/ESLint errors introduced
- Photo tags update instantly when reopening tag sheet (checkmarks appear)
- Tag badges update in real-time in PhotoDetailScreen
- Code follows established service patterns from feedService
- Proper cleanup functions prevent memory leaks
  </success_criteria>

<output>
After completion, create `.planning/phases/52.2-photo-tagging-lag/52.2-01-SUMMARY.md`:

# Phase 52.2 Plan 01: Fix Photo Tagging Lag Summary

**Fixed photo tag state sync - tags now update instantly across all views**

## Accomplishments

- Added subscribePhoto service function for real-time photo updates
- Fixed FlatList re-rendering in TagFriendsModal with extraData prop
- Added photo subscription to PhotoDetailScreen for live tag updates

## Files Created/Modified

- `src/services/firebase/photoService.js` - Added subscribePhoto function
- `src/components/TagFriendsModal.js` - Added extraData prop to FlatList
- `src/screens/PhotoDetailScreen.js` - Added photo subscription useEffect

## Decisions Made

- Followed feedService subscription pattern for consistency
- PhotoDetailScreen subscribes to current photo (not TagFriendsModal) - keeps modal simple, parent owns data
- DarkroomScreen deferred - needs testing to confirm if subscription needed for photo stack

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready to test ISS-016 fix - tag someone, close sheet, reopen → checkmark should appear instantly
</output>
