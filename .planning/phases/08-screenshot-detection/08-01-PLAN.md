---
phase: 08-screenshot-detection
plan: 01
type: execute
wave: 1
depends_on:
  - 08-00
files_modified:
  - package.json
  - app.json
  - firestore.rules
  - src/services/firebase/screenshotService.js
  - src/services/screenshotQueueService.js
  - functions/index.js
  - src/services/firebase/notificationService.js
autonomous: true
requirements:
  - SCRN-01
  - SCRN-03

must_haves:
  truths:
    - "Screenshot event writes screenshottedAt timestamp on the snap message document"
    - "Screenshot event creates a system_screenshot message in the conversation messages subcollection"
    - "Only the first screenshot of a given snap triggers writes (idempotent)"
    - "Failed screenshot writes are queued locally and retried when connectivity returns"
    - "Cloud Function sends push notification to snap sender (not screenshotter) for system_screenshot messages"
    - "The conversation preview in the messages list shows the screenshot event as the most recent message"
    - "Firestore security rules allow the non-sender participant to write screenshottedAt on snap message documents"
  artifacts:
    - path: "src/services/firebase/screenshotService.js"
      provides: "Firestore writes for screenshot events (screenshottedAt + system message)"
      exports: ["recordScreenshot"]
    - path: "src/services/screenshotQueueService.js"
      provides: "Offline queue for screenshot events using AsyncStorage"
      exports: ["queueScreenshotEvent", "processScreenshotQueue"]
    - path: "functions/index.js"
      provides: "onNewMessage handling for system_screenshot message type"
      contains: "system_screenshot"
    - path: "src/services/firebase/notificationService.js"
      provides: "Screenshot notification deep-link handler"
      contains: "screenshot"
    - path: "firestore.rules"
      provides: "Updated message update rules allowing screenshottedAt field"
      contains: "screenshottedAt"
  key_links:
    - from: "src/services/firebase/screenshotService.js"
      to: "conversations/{id}/messages/{id}"
      via: "updateDoc + addDoc"
      pattern: "updateDoc.*screenshottedAt"
    - from: "src/services/screenshotQueueService.js"
      to: "src/services/firebase/screenshotService.js"
      via: "processScreenshotQueue calls recordScreenshot"
      pattern: "recordScreenshot"
    - from: "functions/index.js"
      to: "notifications/sender.js"
      via: "sendPushNotification for system_screenshot type"
      pattern: "system_screenshot.*sendPushNotification"
---

<objective>
Install expo-screen-capture, update Firestore security rules, create the screenshot service layer (Firestore writes + offline queue), and extend the Cloud Function to handle screenshot system messages with push notifications.

Purpose: Establishes the complete data pipeline for screenshot detection — from client-side recording to server-side notification delivery — before the UI integration layer connects it.
Output: screenshotService.js, screenshotQueueService.js, updated firestore.rules, extended onNewMessage Cloud Function, notification deep-link handler for screenshot type.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-screenshot-detection/08-CONTEXT.md
@.planning/phases/08-screenshot-detection/08-RESEARCH.md
@.planning/phases/08-screenshot-detection/08-00-SUMMARY.md
@src/services/firebase/messageService.js
@src/services/firebase/snapService.js
@src/services/uploadQueueService.js
@src/services/firebase/notificationService.js
@functions/index.js
@firestore.rules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install expo-screen-capture, update Firestore rules, and create screenshotQueueService</name>
  <files>
    package.json
    app.json
    firestore.rules
    src/services/screenshotQueueService.js
  </files>
  <action>
**Step 1: Install expo-screen-capture**
Run `npx expo install expo-screen-capture`. This is a native module — remind user a new EAS build is required before deployment.

**Step 2: Add expo-screen-capture to app.json plugins**
Verify whether expo-screen-capture requires a plugin entry in app.json. The expo-screen-capture docs indicate it does not require a config plugin for basic usage (addScreenshotListener). However, to be safe and follow the project pattern of declaring all Expo modules in plugins, add `"expo-screen-capture"` to the `plugins` array in app.json — place it after `"expo-asset"` and before `"expo-updates"`.

**Step 3: Update Firestore security rules to allow screenshottedAt**
The current Firestore rules for `conversations/{conversationId}/messages/{messageId}` allow non-sender updates to `viewedAt` and `screenshotted` fields (line ~435-436 in firestore.rules):

```
allow update: if isConversationMemberById(conversationId) &&
                 resource.data.senderId != request.auth.uid &&
                 request.resource.data.diff(resource.data).affectedKeys()
                   .hasOnly(['viewedAt', 'screenshotted']);
```

Update the `hasOnly` list to also include `'screenshottedAt'`:
```
.hasOnly(['viewedAt', 'screenshotted', 'screenshottedAt']);
```

Also update the comment above this rule to mention screenshot detection:
```
// Update: Only conversation participants who are NOT the message sender
// can update viewedAt, screenshotted, and screenshottedAt fields
// Covers: snap viewedAt (triggers onSnapViewed cleanup), screenshot detection
```

**Step 4: Create `src/services/screenshotQueueService.js`**

Mirror the `uploadQueueService.js` pattern. This service handles offline screenshot event persistence.

Constants:
- `QUEUE_STORAGE_KEY = '@screenshotQueue'`
- `MAX_RETRIES = 3`

Export three functions:

1. `queueScreenshotEvent(event)` — Takes `{ conversationId, snapMessageId, screenshotterId, screenshotterName }`, appends to AsyncStorage array, returns `{ success: true }`

2. `processScreenshotQueue()` — Reads queue from AsyncStorage, iterates through events, calls `recordScreenshot` from screenshotService for each. On success, removes the event from the queue. On failure, increments a `retryCount` on the event. If `retryCount >= MAX_RETRIES`, remove the event and log a warning. Write updated queue back to AsyncStorage after processing.

3. `getQueueLength()` — Returns the current queue length (for debugging/logging).

Use `AsyncStorage` from `@react-native-async-storage/async-storage`. Use logger, not console.log.
  </action>
  <verify>
    <automated>npx jest __tests__/services/smoke.test.js --verbose 2>&1 | tail -10</automated>
    <manual>Verify expo-screen-capture appears in package.json dependencies, app.json plugins, and firestore.rules has screenshottedAt in the messages update rule. Verify screenshotQueueService.js exists with correct exports.</manual>
  </verify>
  <done>expo-screen-capture installed in package.json and registered in app.json plugins. Firestore rules allow non-sender to write screenshottedAt on message documents. screenshotQueueService.js exports queueScreenshotEvent, processScreenshotQueue, getQueueLength with AsyncStorage persistence.</done>
</task>

<task type="auto">
  <name>Task 2: Create screenshotService with idempotent check-then-write logic</name>
  <files>
    src/services/firebase/screenshotService.js
  </files>
  <action>
Create `src/services/firebase/screenshotService.js`.

Export a single function `recordScreenshot({ conversationId, snapMessageId, screenshotterId, screenshotterName })` that:

1. Gets a reference to the snap message document: `conversations/{conversationId}/messages/{snapMessageId}`
2. Reads the snap document via `getDoc`
3. **Idempotency check**: If `snapData.screenshottedAt` already exists, return `{ success: true, alreadyScreenshotted: true }` — do NOT create duplicate system messages
4. **Active snap check**: If `snapData.type !== 'snap'` or snap is expired/deleted, return early with `{ success: true, skipped: true }`
5. Writes `screenshottedAt: serverTimestamp()` via `updateDoc` on the snap message document
6. Creates a system message document in `conversations/{conversationId}/messages/` via `addDoc` with this structure:
   ```js
   {
     senderId: screenshotterId,  // Use screenshotter's ID (NOT null) so onNewMessage can derive recipientId correctly
     type: 'system_screenshot',
     text: `${screenshotterName} screenshotted a snap`,
     screenshotterId: screenshotterId,
     snapMessageId: snapMessageId,
     gifUrl: null,
     imageUrl: null,
     createdAt: serverTimestamp(),
   }
   ```
   **IMPORTANT**: Set `senderId` to the screenshotter's ID. The `onNewMessage` Cloud Function uses `senderId` to derive `recipientId` (the snap sender who should receive the notification). If `senderId` were null, the function would crash. The `type: 'system_screenshot'` field signals this is a system message for rendering purposes.
7. Return `{ success: true, systemMessageId: <new doc id> }`
8. Wrap in try/catch, return `{ success: false, error: error.message }` on failure

Follow project service patterns: import from `@react-native-firebase/firestore`, use logger for all log statements, use `{ success, error }` return pattern.
  </action>
  <verify>
    <automated>npx jest __tests__/services/screenshotService.test.js --verbose 2>&1 | tail -20</automated>
    <manual>Verify screenshotService.js exports recordScreenshot with idempotent check-then-write pattern</manual>
  </verify>
  <done>screenshotService.js exports recordScreenshot with idempotent check-then-write pattern. screenshotService.test.js tests pass GREEN (screenshottedAt write, system message creation, idempotency, non-snap skip, error handling).</done>
</task>

<task type="auto">
  <name>Task 3: Extend onNewMessage Cloud Function for system_screenshot + add notification deep-link</name>
  <files>
    functions/index.js
    src/services/firebase/notificationService.js
  </files>
  <action>
**Step 1: Extend `onNewMessage` in `functions/index.js`**

The `onNewMessage` Cloud Function handles conversation metadata updates and push notifications for all message types. Add handling for `system_screenshot` type:

1. **After the reaction handling block** (around line 2976), add a new block for `system_screenshot`:

```js
if (messageType === 'system_screenshot') {
  // System messages: update lastMessage but do NOT increment unread count
  // (system events are informational, not actionable unread messages)
  shouldIncrementUnread = false;
}
```

2. **In the lastMessage preview builder** (around line 2980), add a case for `system_screenshot`:
   - `lastMessagePreview` should be the message text (e.g., "Alex screenshotted a snap") — just use `message.text`
   - Add this as a case before the fallback: `messageType === 'system_screenshot' ? message.text : ...`

3. **In the push notification section** (around line 3068), add handling for `system_screenshot`:
   - Build notification body: `"${senderName} screenshotted your snap"` — the neutral/factual tone per user decision
   - **CRITICAL RECIPIENT LOGIC**: For system_screenshot, the `senderId` on the document is the screenshotter. The `recipientId` (derived from conversation ID) is the snap sender who should receive the notification. This is correct — the existing `recipientId` derivation already gives us the right person.
   - Set notification data type to `'screenshot'` (for client-side deep-link routing)
   - Include `conversationId` and `senderId` (screenshotter) in notification data

4. **Notification preference check**: The existing `dmEnabled` check already covers screenshot notifications per user decision ("Respects existing notification mute settings"). No additional preference needed.

5. **Do NOT add streak updates** for system_screenshot messages — only snap messages trigger streaks.

**Step 2: Add screenshot notification deep-link in `notificationService.js`**

In the `handleNotificationTapped` function's switch statement, add a `case 'screenshot':` block (before `default`) that navigates to the Conversation screen:

```js
case 'screenshot':
  return {
    success: true,
    data: {
      type: 'screenshot',
      screen: 'Conversation',
      params: {
        conversationId: conversationId,
        friendId: senderId,
        friendProfile: {
          uid: senderId,
          displayName: senderName || 'Unknown',
          photoURL: senderProfilePhotoURL || null,
        },
      },
    },
  };
```

This matches the existing `direct_message` case pattern. The `senderId` in the notification data is the screenshotter — when the snap sender taps the notification, they navigate to the conversation with the screenshotter (their friend).
  </action>
  <verify>
    <automated>cd functions && npx jest __tests__/triggers/screenshotNotification.test.js --verbose 2>&1 | tail -20</automated>
    <manual>Verify onNewMessage handles system_screenshot type: updates lastMessage, sends push to recipient, does not increment unread</manual>
  </verify>
  <done>onNewMessage Cloud Function handles system_screenshot messages: updates conversation metadata (lastMessage with message text, updatedAt), sends push notification with "screenshotted your snap" body to snap sender only, does NOT increment unread count. notificationService.js handles screenshot notification taps with deep-link to Conversation screen. screenshotNotification.test.js tests pass GREEN.</done>
</task>

</tasks>

<verification>
1. `src/services/firebase/screenshotService.js` exists with `recordScreenshot` export that writes `screenshottedAt` + system message
2. `src/services/screenshotQueueService.js` exists with `queueScreenshotEvent`, `processScreenshotQueue`, `getQueueLength` exports
3. `expo-screen-capture` appears in package.json dependencies and app.json plugins
4. `firestore.rules` allows non-sender participants to write `screenshottedAt` on message documents
5. `functions/index.js` handles `system_screenshot` message type in `onNewMessage`
6. `src/services/firebase/notificationService.js` has `screenshot` case in `handleNotificationTapped`
7. Service tests pass: `npx jest __tests__/services/screenshotService.test.js --verbose`
8. Cloud Function tests pass: `cd functions && npx jest __tests__/triggers/screenshotNotification.test.js --verbose`
9. No lint errors: `npm run lint -- --quiet`
</verification>

<success_criteria>
- Screenshot events can be recorded to Firestore (screenshottedAt + system message) via screenshotService
- Failed screenshot writes are queued and retried via screenshotQueueService
- Cloud Function delivers push notification to snap sender when system_screenshot message is created
- Conversation preview in messages list shows the screenshot event text as the most recent message
- Screenshot notification tap deep-links to conversation
- Idempotency: only first screenshot of a snap triggers the full flow
- Firestore rules permit screenshottedAt writes by non-sender conversation participants
- All Wave 0 tests pass GREEN after implementation
</success_criteria>

<output>
After completion, create `.planning/phases/08-screenshot-detection/08-01-SUMMARY.md`
</output>
