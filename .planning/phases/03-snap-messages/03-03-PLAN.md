---
phase: 03-snap-messages
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/components/SnapViewer.js
  - src/components/SnapBubble.js
  - src/components/SnapProgressRing.js
  - __tests__/components/SnapBubble.test.js
autonomous: true
requirements:
  - SNAP-04
  - SNAP-05

must_haves:
  truths:
    - "Unopened snap shows warm yellow/amber bubble with pixel art camera icon and 'Snap' label"
    - "Opened snap shows dimmed/faded bubble with 'Opened' label"
    - "Sending snap shows optimistic bubble with amber progress ring and 'Sending...' text"
    - 'Failed snap (retries exhausted) shows error state with tap-to-retry'
    - 'Tapping an unopened snap opens SnapViewer full-screen'
    - 'SnapViewer shows snap in Polaroid frame with black background'
    - 'Dismissing SnapViewer (swipe-down or X) marks snap as viewed'
    - 'Viewed snap cannot be reopened'
  artifacts:
    - path: 'src/components/SnapBubble.js'
      provides: 'Snap message bubble with unopened/opened/sending/error states'
      min_lines: 80
    - path: 'src/components/SnapViewer.js'
      provides: 'Full-screen view-once snap display with Polaroid frame'
      min_lines: 100
    - path: 'src/components/SnapProgressRing.js'
      provides: 'Amber circular progress ring for snap upload state'
      min_lines: 30
    - path: '__tests__/components/SnapBubble.test.js'
      provides: 'Unit tests for SnapBubble rendering states'
  key_links:
    - from: 'src/components/SnapBubble.js'
      to: 'src/components/SnapViewer.js'
      via: 'onPress callback triggers SnapViewer navigation'
      pattern: 'onPress'
    - from: 'src/components/SnapViewer.js'
      to: 'src/services/firebase/snapService.js'
      via: 'getSignedSnapUrl for image load, markSnapViewed on dismiss'
      pattern: '(getSignedSnapUrl|markSnapViewed)'
    - from: 'src/components/SnapViewer.js'
      to: 'expo-image'
      via: "Image with cachePolicy='none'"
      pattern: 'cachePolicy.*none'
---

<objective>
Build the snap viewing experience: SnapBubble component for the conversation thread and SnapViewer for full-screen view-once display. This is the "receiving" half of the snap experience.

Purpose: Recipients need to see snap messages in conversation and view them full-screen with the Polaroid aesthetic. The view-once mechanic is the core of snap ephemerality.
Output: SnapBubble.js, SnapViewer.js, SnapProgressRing.js, SnapBubble tests.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-snap-messages/03-CONTEXT.md
@.planning/phases/03-snap-messages/03-RESEARCH.md
@.planning/phases/03-snap-messages/03-01-SUMMARY.md

@src/components/MessageBubble.js
@src/components/PixelIcon.js
@src/services/firebase/snapService.js
@src/constants/colors.js
@src/constants/typography.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SnapBubble and SnapProgressRing components + tests</name>
  <files>
    src/components/SnapBubble.js
    src/components/SnapProgressRing.js
    __tests__/components/SnapBubble.test.js
  </files>
  <action>
**SnapBubble.js:**
Create a message bubble variant specifically for snap messages. This is rendered in the conversation thread instead of the regular MessageBubble for `type: 'snap'` messages.

Props: `message`, `isCurrentUser`, `showTimestamp`, `onPress` (opens SnapViewer for unviewed snaps), `isPending` (for optimistic local snaps), `hasError` (retries exhausted), `onRetry` (callback for tap-to-retry)

**Four visual states (per locked user decisions):**

1. **Sending** (`isPending === true && !hasError`):
   - Amber/yellow accent bubble (`colors.status.developing` or warm amber ~#F5A623)
   - SnapProgressRing component wrapping the camera icon (indeterminate or circular progress)
   - "Sending..." status text below
   - Non-interactive (no onPress)

2. **Error / Retry** (`hasError === true`):
   - Red-tinted or dimmed amber bubble indicating failure
   - PixelIcon for error indicator (e.g., exclamation mark or warning icon)
   - "Failed" label with "Tap to retry" hint text
   - Interactive: `onPress` calls `onRetry()` to re-attempt upload
   - Per locked user decision: "error state with tap-to-retry button on the bubble"

3. **Unopened** (`message.viewedAt === null && !isPending && !hasError`):
   - Warm yellow/amber accent bubble background
   - Custom pixel art camera icon via `<PixelIcon name="camera" />` (NOT an emoji per user decision)
   - "Snap" label text next to icon
   - Interactive: `onPress` triggers SnapViewer
   - For sender: shows "Delivered" status text
   - For recipient: shows "Snap" label, tappable

4. **Opened** (`message.viewedAt !== null`):
   - Dimmed/faded version of the bubble (reduced opacity ~0.5 or muted colors)
   - Same camera icon but dimmed
   - "Opened" label replacing "Snap"
   - Non-interactive (cannot reopen -- per user decision: view once)
   - Show timestamp of when it was opened

Layout structure:

- Align left (friend) or right (current user) per `isCurrentUser` -- same as MessageBubble
- Same timestamp formatting as regular messages (consistent with existing MessageBubble patterns)
- Bubble shape: rounded corners, similar padding to text message bubbles

**SnapProgressRing.js:**
SVG-based circular progress ring using `react-native-svg`:

- Circle with `strokeDasharray` pattern for indeterminate animation
- Amber color (`#F5A623` or `colors.status.developing`)
- Wraps around the camera icon (size ~40px diameter)
- Use RN core Animated for rotation animation (simple spin, per project convention for simple animations)
- Props: `size` (default 40), `color` (default amber)

**SnapBubble.test.js:**

- Test unopened state renders "Snap" label and camera icon
- Test opened state renders "Opened" label and reduced opacity
- Test sending state renders "Sending..." and progress ring
- Test error state renders "Failed" and "Tap to retry" text
- Test onPress is called for unopened snaps only
- Test onPress is NOT called for opened snaps
- Test onRetry is called when error state bubble is pressed
- Test isCurrentUser alignment (right for sender, left for recipient)
- Mock PixelIcon and SnapProgressRing
  </action>
  <verify>
  <automated>cd "C:/Users/maser/Lapse Clone" && npx jest **tests**/components/SnapBubble.test.js --no-coverage 2>&1 | tail -20</automated>
  </verify>
  <done>SnapBubble renders four distinct states (sending/error/unopened/opened) with correct visual treatment. Error state shows tap-to-retry per user decision. SnapProgressRing provides amber circular animation. All SnapBubble tests pass.</done>
  </task>

<task type="auto">
  <name>Task 2: Create SnapViewer full-screen view-once component</name>
  <files>
    src/components/SnapViewer.js
  </files>
  <action>
Create `src/components/SnapViewer.js` -- a full-screen overlay/modal for viewing snaps once.

**Props:** `visible`, `snapMessage` (the message object with snapStoragePath, caption, senderId), `conversationId`, `onClose` (callback after marking viewed)

**Layout (per locked user decisions):**

- Full black background, immersive full-screen (Modal or absolute positioned overlay)
- Centered Polaroid frame:
  - Thin white border (8px) on top and sides
  - Photo displayed with `contentFit="contain"` and 4:3 aspect ratio
  - Thick white strip at bottom (64px) containing caption text in Silkscreen pixel art font
  - Polaroid strip always visible even without caption (per user decision)
  - Polaroid sits perfectly straight -- no tilt or rotation
- X close button in top-right corner (white PixelIcon `close` on semi-transparent background)
- Sender name displayed above the Polaroid (optional, for context)

**Image Loading:**

- On mount (when `visible` becomes true): call `getSignedSnapUrl(snapMessage.snapStoragePath)` from snapService
- Show PixelSpinner while URL is loading
- Display image using `expo-image` with `cachePolicy="none"` (CRITICAL: prevents device caching per SNAP-07)
- Set `transition={0}` on Image (instant display, no fade-in)
- Handle load error: show error state with close button

**View-Once Mechanic:**

- On dismiss (X button press OR swipe-down gesture):
  1. Call `markSnapViewed(conversationId, snapMessage.id)` from snapService
  2. Call `onClose()` callback to hide the viewer
  3. The message's `viewedAt` will be updated in Firestore, causing SnapBubble to show "Opened" state via real-time subscription
- Prevent re-opening: the parent component (ConversationScreen) should not pass `onPress` to SnapBubble for viewed snaps. The SnapViewer itself does not need to guard -- it just marks viewed on dismiss.

**Swipe-down dismiss gesture:**

- Use `react-native-gesture-handler` Pan gesture
- Track vertical translation with `react-native-reanimated` shared value
- On swipe down past threshold (100px), trigger dismiss
- Animate Polaroid frame down with opacity fade during gesture
- Trigger haptic feedback on dismiss

**No timer** -- user views at own pace until dismissed (per user decision).

**Import organization:** Follow project conventions -- React/RN first, then third-party, then internal services, then components, then context/hooks, then utils.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest **tests**/services/snapService.test.js **tests**/components/SnapBubble.test.js --no-coverage 2>&1 | tail -10</automated>
<manual>Verify SnapViewer.js exists with Polaroid frame, cachePolicy="none", markSnapViewed on dismiss, swipe gesture</manual>
</verify>
<done>SnapViewer displays snap in Polaroid frame with black background. Image loads via short-lived signed URL with cachePolicy="none". Dismiss via X button or swipe-down marks snap as viewed. Caption displays in Polaroid bottom strip.</done>
</task>

</tasks>

<verification>
- SnapBubble renders correctly for all four states (sending, error, unopened, opened)
- SnapViewer loads snap image via getSignedSnapUrl with cachePolicy="none"
- SnapViewer marks snap as viewed on dismiss
- SnapProgressRing shows amber animation during upload
- `npx jest __tests__/components/SnapBubble.test.js` passes
- Full test suite still passes: `npm test`
</verification>

<success_criteria>

- Unopened snap bubble: amber background, camera icon, "Snap" label, tappable
- Opened snap bubble: dimmed, "Opened" label, non-interactive
- Sending snap bubble: progress ring, "Sending..." text
- Error snap bubble: tap-to-retry on retries exhausted
- SnapViewer: full-screen Polaroid frame, black background, caption in bottom strip
- View-once: snap marked viewed on close, cannot be reopened
- Images use cachePolicy="none" to prevent device persistence
  </success_criteria>

<output>
After completion, create `.planning/phases/03-snap-messages/03-03-SUMMARY.md`
</output>
