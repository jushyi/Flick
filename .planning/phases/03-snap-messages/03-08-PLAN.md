---
phase: 03-snap-messages
plan: 08
type: execute
wave: 2
depends_on: ['07']
files_modified:
  - src/components/SnapViewer.js
  - src/screens/SnapPreviewScreen.js
  - src/services/firebase/snapService.js
  - src/screens/ConversationScreen.js
autonomous: true
requirements: [SNAP-05, SNAP-07]
gap_closure: true

must_haves:
  truths:
    - 'SnapViewer overlay is semi-transparent so conversation is visible behind the Polaroid'
    - 'Recipient can tap a reaction emoji below the Polaroid to react to a snap'
    - 'Snap photo appears identical between sender preview and recipient viewer (no black bars)'
    - 'Back camera snaps have EXIF orientation normalized before upload'
  artifacts:
    - path: 'src/components/SnapViewer.js'
      provides: 'Semi-transparent overlay, reaction bar, unified contentFit'
      contains: 'rgba(0'
    - path: 'src/services/firebase/snapService.js'
      provides: 'EXIF normalization in compressSnapImage'
      contains: 'manipulateAsync'
  key_links:
    - from: 'src/components/SnapViewer.js'
      to: 'src/services/firebase/messageService.js'
      via: 'sendReaction for snap reactions'
      pattern: 'sendReaction'
    - from: 'src/services/firebase/snapService.js'
      to: 'expo-image-manipulator'
      via: 'EXIF normalization with empty actions array'
      pattern: "manipulateAsync.*\\[\\]"
---

<objective>
Overhaul SnapViewer with semi-transparent overlay, snap reaction bar, and fix cross-platform photo aspect ratio/orientation issues.

Purpose: Address UAT Tests 4 and 7 (major severity) — the SnapViewer looks bare and photos display differently between sender and recipient due to contentFit mismatch and missing EXIF normalization.
Output: SnapViewer with transparent backdrop, reaction bar, and consistent photo display cross-platform.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-snap-messages/03-UAT.md
@.planning/debug/snapviewer-bare-orientation.md
@src/components/SnapViewer.js
@src/screens/SnapPreviewScreen.js
@src/services/firebase/snapService.js
@src/components/ReactionPicker.js
@src/services/firebase/messageService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: EXIF normalization and contentFit unification</name>
  <files>src/services/firebase/snapService.js, src/screens/SnapPreviewScreen.js, src/components/SnapViewer.js</files>
  <action>
**snapService.js — EXIF normalization in compressSnapImage (lines 66-79)**:

Before the resize operation, add an EXIF normalization step. This follows the same pattern used in `ProfilePhotoCropScreen.android.js` (line 115): call `ImageManipulator.manipulateAsync(uri, [], { format: SaveFormat.JPEG })` with an empty actions array to bake EXIF orientation into pixel data without any visual transformation. Then pass the normalized URI to the resize step.

Updated `compressSnapImage`:

```javascript
const compressSnapImage = async uri => {
  try {
    // Step 1: Normalize EXIF orientation (bake rotation into pixels).
    // Back camera photos retain raw EXIF from sensor; this ensures
    // orientation is consistent across platforms before upload.
    const normalized = await ImageManipulator.manipulateAsync(uri, [], {
      format: ImageManipulator.SaveFormat.JPEG,
    });

    // Step 2: Resize and compress
    const manipResult = await ImageManipulator.manipulateAsync(
      normalized.uri,
      [{ resize: { width: 1080 } }],
      { compress: 0.7, format: ImageManipulator.SaveFormat.JPEG }
    );
    return manipResult.uri;
  } catch (error) {
    logger.error('snapService.compressSnapImage: Compression failed, using original', {
      error: error.message,
    });
    return uri;
  }
};
```

**SnapPreviewScreen.js — contentFit (line 204)**:

Change `contentFit="cover"` to `contentFit="contain"`. The sender should see the SAME rendering as the recipient. Using `contain` preserves the full photo without cropping. The `photoContainer` background is already white (part of Polaroid frame), so any letterbox bars will be white, not black, which blends naturally with the Polaroid aesthetic.

Also change the photo background container. Currently the photo sits directly inside the Polaroid. Add a `backgroundColor: '#1A1A1A'` (very dark, near-black) to the photo area style (`screenStyles.photo`) so any letterboxing inside the Polaroid has a subtle dark background that contrasts with the white frame. This matches the look of a real Polaroid where the photo area is dark.

**SnapViewer.js — contentFit (line 242)**:

Already `contentFit="contain"` — no change needed. This now matches the sender preview. Both views show the full photo with the same framing.

The `photoContainer` in SnapViewer already has `backgroundColor: '#000000'` which is fine for the dark-themed viewer.

Note: Loading speed was explicitly deferred by the user ("can defer to future milestone"). Do NOT attempt any loading optimizations.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx eslint src/services/firebase/snapService.js src/screens/SnapPreviewScreen.js src/components/SnapViewer.js --no-error-on-unmatched-pattern && npm test -- **tests**/services/snapService.test.js --silent 2>&1 | tail -5</automated>
<manual>Take a snap with the back camera on iOS, send to Android recipient. Both sender preview and recipient viewer should show the same photo framing with no black bars or rotation differences.</manual>
</verify>
<done>compressSnapImage normalizes EXIF with empty-action manipulateAsync before resize. Both SnapPreviewScreen and SnapViewer use contentFit="contain" for identical photo display. No black bars or rotation mismatches between platforms.</done>
</task>

<task type="auto">
  <name>Task 2: Semi-transparent overlay and snap reaction bar</name>
  <files>src/components/SnapViewer.js, src/screens/ConversationScreen.js</files>
  <action>
**Semi-transparent overlay**:

Change the overlay `backgroundColor` from `'#000000'` (solid black, line 272) to `'rgba(0, 0, 0, 0.85)'`. This makes the conversation partially visible behind the snap, giving spatial context. The value 0.85 keeps the snap photo as the clear focus while hinting at the conversation below. The Modal is already set to `transparent: true` so this will work immediately.

**Snap reaction bar**:

Add a horizontal row of 6 reaction emojis below the Polaroid frame inside the `polaroidContainer`. Use the same 6 emojis as the existing `ReactionPicker` component: heart, laugh, surprise, sad, angry, thumbs_up.

Implementation:

1. Accept two new props: `onReaction` (callback with emoji key) and `currentUserId` (to determine if user is sender — senders don't see the reaction bar).

2. Define the same `REACTION_EMOJIS` array as ReactionPicker:

```javascript
const REACTION_EMOJIS = [
  { key: 'heart', char: '\u2764\uFE0F' },
  { key: 'laugh', char: '\uD83D\uDE02' },
  { key: 'surprise', char: '\uD83D\uDE2E' },
  { key: 'sad', char: '\uD83D\uDE22' },
  { key: 'angry', char: '\uD83D\uDE21' },
  { key: 'thumbs_up', char: '\uD83D\uDC4D' },
];
```

3. Render the reaction bar ONLY when the user is NOT the sender (i.e., `snapMessage.senderId !== currentUserId`). The sender has no reason to react to their own snap.

4. Place the reaction bar below the Polaroid frame but still inside the animated `polaroidContainer` so it moves with the swipe-down gesture. Style:

```javascript
reactionBar: {
  flexDirection: 'row',
  justifyContent: 'center',
  alignItems: 'center',
  marginTop: 20,
  gap: 16,
},
reactionButton: {
  width: 44,
  height: 44,
  borderRadius: 22,
  backgroundColor: 'rgba(255, 255, 255, 0.15)',
  justifyContent: 'center',
  alignItems: 'center',
},
reactionEmoji: {
  fontSize: 22,
},
```

5. When a reaction emoji is tapped:
   - Trigger haptic feedback: `Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Medium)`
   - Call `onReaction(emojiKey)` prop callback
   - The callback (provided by ConversationScreen) will call `sendReaction(conversationId, currentUserId, snapMessage.id, emojiKey)` from messageService — this reuses the existing reaction system so snap reactions appear in the conversation thread just like regular message reactions.
   - After reacting, do NOT auto-dismiss the viewer. User can keep viewing or dismiss manually.

6. Update the SnapViewer component's prop types to include the new props. The caller (ConversationScreen) already has access to `conversationId`, `currentUserId`, and `sendReaction` — it just needs to wire `onReaction` as a callback.

**Update ConversationScreen wiring**:

The SnapViewer is rendered inside ConversationScreen. Read `src/screens/ConversationScreen.js` to find the SnapViewer JSX usage (around line 641-647). Add the new props:

- `currentUserId={user.uid}`
- `onReaction={(emojiKey) => { sendReaction(conversationId, user.uid, snapViewerMessage.id, emojiKey); }}`

Import `sendReaction` from `messageService` if not already imported (check existing imports first — it may already be imported for regular message reactions).
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx eslint src/components/SnapViewer.js src/screens/ConversationScreen.js --no-error-on-unmatched-pattern</automated>
<manual>Open a received snap. Overlay should be semi-transparent (conversation faintly visible behind). Six reaction emoji buttons should appear below the Polaroid. Tapping one should send a reaction (visible in conversation thread after dismissing viewer). Sender viewing their own snap should NOT see the reaction bar.</manual>
</verify>
<done>SnapViewer overlay is semi-transparent (rgba 0,0,0,0.85). Reaction bar with 6 emojis appears for recipients below the Polaroid frame. Tapping a reaction sends it via the existing sendReaction system. Senders do not see the reaction bar on their own snaps.</done>
</task>

</tasks>

<verification>
- `npx eslint src/components/SnapViewer.js src/screens/SnapPreviewScreen.js src/services/firebase/snapService.js src/screens/ConversationScreen.js --no-error-on-unmatched-pattern` passes
- `npm test -- __tests__/services/snapService.test.js --silent` passes
- No `console.log` statements introduced
- Both UAT gaps (Tests 4, 7) addressed
</verification>

<success_criteria>

- SnapViewer overlay shows conversation faintly through semi-transparent background
- Recipient can react to a snap via emoji bar below the Polaroid frame
- Sender does NOT see reaction bar when viewing their own snap
- Photo framing is identical between sender preview and recipient viewer
- Back camera snaps have EXIF normalized before upload
- Cross-platform orientation is consistent (no black bars, no rotation mismatch)
  </success_criteria>

<output>
After completion, create `.planning/phases/03-snap-messages/03-08-SUMMARY.md`
</output>
