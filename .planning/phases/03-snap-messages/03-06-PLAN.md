---
phase: 03-snap-messages
plan: 06
type: execute
wave: 5
depends_on:
  - 03-05
files_modified:
  - src/screens/ConversationScreen.js
  - src/components/DMInput.js
  - src/components/SnapBubble.js
  - src/components/SnapViewer.js
  - src/components/ConversationRow.js
autonomous: false
requirements:
  - SNAP-01
  - SNAP-02
  - SNAP-03
  - SNAP-04
  - SNAP-05
  - SNAP-06

must_haves:
  truths:
    - 'User can capture and send snap from within a conversation'
    - "Recipient sees generic 'Snap' icon, taps to view full-screen in Polaroid frame"
    - 'Snap disappears after closing viewer (cannot reopen)'
    - "Sender sees 'Opened' after recipient views the snap"
    - 'Camera button appears when DM input is empty, morphs to send arrow when typing'
    - 'Conversation list shows snap camera shortcut and correct snap preview text'
  artifacts:
    - path: 'src/screens/ConversationScreen.js'
      provides: 'Full snap integration with SnapViewer overlay'
    - path: 'src/components/DMInput.js'
      provides: 'Camera/send button morph'
    - path: 'src/components/SnapBubble.js'
      provides: 'Snap bubble with all three states'
    - path: 'src/components/SnapViewer.js'
      provides: 'Full-screen Polaroid viewer'
  key_links:
    - from: 'src/components/DMInput.js'
      to: 'src/screens/SnapCameraModal.js'
      via: 'onOpenSnapCamera navigation callback'
      pattern: 'onOpenSnapCamera'
    - from: 'src/screens/ConversationScreen.js'
      to: 'src/components/SnapViewer.js'
      via: 'SnapViewer overlay with snapViewerMessage state'
      pattern: 'SnapViewer'
---

<objective>
Visual verification and polish of the complete snap flow. Fix any integration issues between the snap components, ensure smooth transitions, and verify the end-to-end experience matches user decisions.

Purpose: After all snap components are built and wired, this plan runs the full flow on a real device to catch visual, layout, and interaction issues that unit tests cannot detect.
Output: Polished, verified snap experience matching all locked user decisions.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-snap-messages/03-CONTEXT.md
@.planning/phases/03-snap-messages/03-04-SUMMARY.md
@.planning/phases/03-snap-messages/03-05-SUMMARY.md

@src/screens/ConversationScreen.js
@src/components/DMInput.js
@src/components/SnapBubble.js
@src/components/SnapViewer.js
@src/components/ConversationRow.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite and fix any failures</name>
  <files>
    src/screens/ConversationScreen.js
    src/components/DMInput.js
    src/components/SnapBubble.js
    src/components/SnapViewer.js
    src/components/ConversationRow.js
  </files>
  <action>
Run the complete test suite to catch any integration issues:

1. Run `npm test` and identify any failing tests
2. Fix any import errors, missing mocks, or type mismatches
3. Verify all snap-specific tests pass:
   - `npx jest __tests__/services/snapService.test.js`
   - `npx jest __tests__/components/SnapBubble.test.js`
4. Verify no regressions in existing tests:
   - `npx jest __tests__/services/messageService.test.js`
   - `npx jest __tests__/hooks/useConversation.test.js`
5. Run lint check: `npm run lint` and fix any issues

Also verify:

- All imports are properly organized per project conventions (React/RN -> third-party -> services -> components -> context -> utils)
- No `console.log` statements (use `logger` throughout)
- All new files use proper file naming (PascalCase for components/screens, camelCase for services/hooks)
- expo-image usage in SnapViewer has `cachePolicy="none"` (CRITICAL for ephemerality)

Fix any issues found. This task ensures the codebase is clean before visual verification.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npm test --no-coverage 2>&1 | tail -20</automated>
</verify>
<done>Full test suite passes with no failures. Lint is clean. All snap components properly integrated with correct imports and no console.log statements.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete snap flow on device</name>
  <files>
    src/screens/ConversationScreen.js
    src/components/DMInput.js
    src/components/SnapBubble.js
    src/components/SnapViewer.js
    src/components/ConversationRow.js
  </files>
  <action>
Human verification of the complete snap messaging flow on a real device. All automated work is complete -- this checkpoint confirms the visual and interactive experience matches the locked user decisions from CONTEXT.md.

Deploy the latest code via `eas update` (user runs this manually), then test the complete snap flow on device.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npm test --no-coverage 2>&1 | tail -5</automated>
<manual> 1. Open the app on a test device 2. Navigate to a DM conversation with a friend 3. Verify the camera icon appears in the input bar when text field is empty 4. Type some text -- verify camera icon morphs to send arrow 5. Clear text -- verify send arrow morphs back to camera icon 6. Tap the camera icon -- verify full-screen camera opens (slides up from bottom) 7. Verify flash toggle, camera flip, and close button are visible 8. Take a photo -- verify it shows in a Polaroid frame on the preview screen 9. Verify "To: [FriendName]" appears at the top 10. Type a caption in the Polaroid bottom strip (verify max 150 chars) 11. Tap send -- verify you return to conversation immediately 12. Verify the snap appears as an amber bubble with camera icon and "Sending..." then "Delivered" 13. On the recipient device: verify snap notification arrives 14. Tap the snap notification -- verify conversation opens and snap viewer auto-opens 15. Alternatively, open conversation manually -- verify amber "Snap" bubble is visible 16. Tap the snap bubble -- verify full-screen Polaroid viewer opens with black background 17. Verify caption is visible in the Polaroid bottom strip 18. Dismiss via swipe-down or X button 19. Verify snap bubble now shows "Opened" in dimmed state 20. Verify you cannot tap to reopen the snap 21. On sender device: verify the snap bubble changed from "Delivered" to "Opened" 22. Check ConversationRow on messages list: verify snap camera shortcut button is visible 23. Verify ConversationRow shows correct last message preview for snaps
</manual>
</verify>
<done>User approves the complete snap flow on device. All SNAP requirements verified visually: capture, preview, send, bubble states, view-once viewer, status transitions, ConversationRow updates.</done>
</task>

</tasks>

<verification>
- Full test suite passes: `npm test`
- Lint passes: `npm run lint`
- End-to-end snap flow verified on device
- All six SNAP requirements verified
- Camera button morph, Polaroid viewer, view-once mechanic all working
</verification>

<success_criteria>

- Complete snap flow works end-to-end on real device
- Polaroid aesthetic matches user vision (white frame, pixel art font, black background)
- View-once mechanic works (snap gone after dismiss, cannot reopen)
- Sender sees status transitions (Sending -> Delivered -> Opened)
- No regressions in existing text/gif/image/reaction messaging
- User approves the experience
  </success_criteria>

<output>
After completion, create `.planning/phases/03-snap-messages/03-06-SUMMARY.md`
</output>
