---
phase: 03-snap-messages
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - src/screens/SnapCameraModal.js
  - src/screens/SnapPreviewScreen.js
  - src/hooks/useSnapCamera.js
autonomous: true
requirements:
  - SNAP-01
  - SNAP-02

must_haves:
  truths:
    - 'User can open a full-screen camera from within a conversation to capture a snap'
    - 'Camera supports flash toggle, camera flip, and both front/rear cameras'
    - 'After capture, user sees a Polaroid-framed preview with the recipient name'
    - 'User can type an optional caption (max 150 chars) in the Polaroid bottom strip'
    - 'User can retake via X button or swipe-down to return to camera'
    - 'Pressing send uploads the snap and returns to conversation immediately'
  artifacts:
    - path: 'src/screens/SnapCameraModal.js'
      provides: 'Full-screen camera screen in snap mode with flash, flip, capture'
      min_lines: 80
    - path: 'src/screens/SnapPreviewScreen.js'
      provides: 'Polaroid-framed preview with caption input, send button, retake/discard'
      min_lines: 120
    - path: 'src/hooks/useSnapCamera.js'
      provides: 'Camera logic wrapper for snap mode (flash, facing, capture, permissions)'
      min_lines: 40
  key_links:
    - from: 'src/screens/SnapCameraModal.js'
      to: 'src/screens/SnapPreviewScreen.js'
      via: 'navigation.navigate with captured photoUri'
      pattern: 'navigate.*SnapPreview'
    - from: 'src/screens/SnapPreviewScreen.js'
      to: 'src/services/firebase/snapService.js'
      via: 'uploadAndSendSnap call on send press'
      pattern: 'uploadAndSendSnap'
    - from: 'src/hooks/useSnapCamera.js'
      to: 'expo-camera CameraView'
      via: 'camera ref and takePictureAsync'
      pattern: 'takePictureAsync'
---

<objective>
Build the snap capture flow: a full-screen camera modal and Polaroid-framed preview screen with caption input. This is the "sending" half of the snap experience.

Purpose: Users need to capture and send snaps from within DM conversations. The camera reuses existing expo-camera infrastructure but in a dedicated snap mode with Polaroid preview.
Output: SnapCameraModal.js, SnapPreviewScreen.js, useSnapCamera.js hook.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-snap-messages/03-CONTEXT.md
@.planning/phases/03-snap-messages/03-RESEARCH.md
@.planning/phases/03-snap-messages/03-01-SUMMARY.md

@src/screens/CameraScreen.js
@src/hooks/useCameraBase.js
@src/services/firebase/snapService.js
@src/constants/colors.js
@src/constants/typography.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useSnapCamera hook and SnapCameraModal screen</name>
  <files>
    src/hooks/useSnapCamera.js
    src/screens/SnapCameraModal.js
  </files>
  <action>
**useSnapCamera.js:**
Create a hook that wraps `useCameraBase` (or directly uses expo-camera) for snap-specific camera logic. It should provide:
- `cameraRef` -- ref for the CameraView component
- `facing` state (front/back) with `toggleFacing()` function
- `flash` state (off/on) with `toggleFlash()` function
- `hasPermission` and `requestPermission` from expo-camera
- `captureSnap()` function: calls `cameraRef.current.takePictureAsync({ quality: 0.8 })`, returns the photo URI
- No zoom levels needed (keep it simple for snaps)
- No darkroom/upload queue logic (snaps bypass darkroom entirely)
- Handle camera permission check on mount

Reference `useCameraBase.js` for patterns but keep this hook simpler -- snaps have a narrower feature set.

**SnapCameraModal.js:**
Create a full-screen camera screen presented as a modal (slide_from_bottom animation configured in navigator). Per user decisions:

Layout:

- Full black background
- CameraView fills most of screen (use flex: 1)
- Top bar: X close button (top-left) to dismiss modal and return to conversation
- Bottom bar: flash toggle (left), large capture button (center), camera flip (right)
- No darkroom button, no zoom controls (per user decision: snap mode hides these)
- Use PixelIcon for flash (`flash` / `flash-off`), flip (`flip-camera`), and close (`close`) icons

Behavior:

- Receives `conversationId`, `friendId`, `friendDisplayName` from route params
- On capture: trigger haptic feedback (Haptics.impactAsync), navigate to `SnapPreviewScreen` passing `{ photoUri, conversationId, friendId, friendDisplayName }`
- Handle permissions: if no camera permission, show request prompt
- Camera should be ready immediately (no loading delay beyond permission)

Style: Black background, white icons, consistent with CameraScreen patterns but simplified.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --passWithNoTests --no-coverage 2>&1 | tail -5</automated>
<manual>Verify SnapCameraModal.js and useSnapCamera.js exist with correct exports and structure</manual>
</verify>
<done>SnapCameraModal renders a full-screen camera with flash toggle, camera flip, capture button, and close button. useSnapCamera hook manages camera state. On capture, navigates to SnapPreviewScreen with photoUri.</done>
</task>

<task type="auto">
  <name>Task 2: Create SnapPreviewScreen with Polaroid frame and caption</name>
  <files>
    src/screens/SnapPreviewScreen.js
  </files>
  <action>
Create `src/screens/SnapPreviewScreen.js` -- the Polaroid-framed preview shown after capturing a snap photo.

**Layout (per locked user decisions):**

- Full black background, immersive
- "To: [RecipientName]" label at top of screen (using friendDisplayName from route params) in pixel art font
- Centered Polaroid frame containing:
  - Thin white border (8px) on top and sides
  - Captured photo displayed inside the frame with `contentFit="cover"` and 4:3 aspect ratio
  - Thick white strip at bottom (64px height) -- this is where the caption goes
  - Caption is typed directly into the thick bottom strip (WYSIWYG)
  - Use TextInput with pixel art font (Silkscreen_400Regular), placeholder "Write something!" in light gray
  - Max 150 character limit with `maxLength={150}`
  - Polaroid strip always visible even without caption
- X button (top-left) to retake: navigates back to SnapCameraModal
- Send button (bottom-right, prominent): large PixelIcon arrow-up on amber/yellow background circle

**Swipe-down gesture to discard:**

- Use `react-native-gesture-handler` PanGesture
- On swipe down past threshold, navigate back to camera (same as X button)
- Use `react-native-reanimated` for translateY animation during gesture

**Send behavior:**

- On press: call `uploadAndSendSnap(conversationId, senderId, photoUri, caption)` from snapService
- While uploading: disable send button, show loading state
- On success: navigate back to conversation screen (pop to ConversationScreen or goBack twice)
- On error: show Alert with retry option
- After send: return to conversation immediately (no confirmation overlay per user decision)

**Keyboard handling:**

- Use `KeyboardAvoidingView` with `behavior={Platform.select({ ios: 'padding', android: 'height' })}` to prevent keyboard from covering caption input
- Adjust `keyboardVerticalOffset` per platform for proper positioning

**Imports:**

- `useAuth` for senderId (user.uid)
- `uploadAndSendSnap` from snapService
- `expo-image` for photo display with default cachePolicy (this is a preview, not a viewed snap)
- `react-native-reanimated` + `react-native-gesture-handler` for swipe gesture
- `Haptics.notificationAsync` on send
  </action>
  <verify>
  <automated>cd "C:/Users/maser/Lapse Clone" && npx jest --passWithNoTests --no-coverage 2>&1 | tail -5</automated>
  <manual>Verify SnapPreviewScreen.js exists with Polaroid layout, caption TextInput, send button, swipe-down dismiss</manual>
  </verify>
  <done>SnapPreviewScreen shows Polaroid-framed photo with WYSIWYG caption input in the bottom strip, "To: RecipientName" header, retake X button, swipe-down dismiss, and send button that calls snapService.uploadAndSendSnap. Returns to conversation after send.</done>
  </task>

</tasks>

<verification>
- SnapCameraModal.js renders camera with flash/flip/capture/close
- SnapPreviewScreen.js shows Polaroid frame with caption input
- useSnapCamera.js provides camera state management
- Both screens handle route params correctly (conversationId, friendId, friendDisplayName)
- Send flow calls uploadAndSendSnap and navigates back to conversation
- Full test suite still passes: `npm test`
</verification>

<success_criteria>

- Camera opens in snap mode with only flash, flip, and capture buttons
- Captured photo appears in Polaroid frame with white border and thick bottom strip
- Caption input works in the Polaroid strip with 150 char limit
- Send uploads snap via snapService and returns to conversation
- Retake and swipe-down discard work correctly
- "To: RecipientName" shows correct recipient
  </success_criteria>

<output>
After completion, create `.planning/phases/03-snap-messages/03-02-SUMMARY.md`
</output>
