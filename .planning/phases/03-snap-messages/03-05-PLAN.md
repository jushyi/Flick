---
phase: 03-snap-messages
plan: 05
type: execute
wave: 4
depends_on:
  - 03-04
files_modified:
  - storage.rules
  - firestore.rules
  - functions/index.js
autonomous: true
requirements:
  - INFRA-03
  - INFRA-04
  - SNAP-07
  - SNAP-08

must_haves:
  truths:
    - 'Firebase Storage rules allow owner-only reads for snap-photos/ path'
    - 'Firestore security rules permit expiresAt field on snap message documents'
    - 'Storage lifecycle rule configured for snap-photos/ path with 7-day auto-delete'
    - 'Firestore TTL policy targets expiresAt field on messages collection group'
  artifacts:
    - path: 'storage.rules'
      provides: 'snap-photos/{userId}/{allPaths=**} rule matching photos/ pattern'
      contains: 'snap-photos'
    - path: 'firestore.rules'
      provides: 'Updated rules permitting expiresAt and snapStoragePath fields on message documents'
      contains: 'expiresAt'
  key_links:
    - from: 'storage.rules'
      to: 'src/services/firebase/snapService.js'
      via: 'snap-photos/ path authorized for owner write'
      pattern: 'snap-photos'
    - from: 'firestore.rules'
      to: 'functions/index.js (cleanupExpiredSnaps)'
      via: 'expiresAt field used by TTL and cleanup function'
      pattern: 'expiresAt'
---

<objective>
Configure infrastructure for snap lifecycle: Firebase Storage rules for snap-photos/ path, Firestore security rules for snap message fields, and document the TTL/lifecycle configurations needed.

Purpose: Without correct security rules, snap uploads and viewedAt updates will fail. Storage lifecycle and Firestore TTL provide automatic cleanup of orphaned snaps as safety nets behind the Cloud Functions.
Output: Updated storage.rules, firestore.rules, infrastructure documentation.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-snap-messages/03-RESEARCH.md
@.planning/phases/03-snap-messages/03-01-SUMMARY.md

@storage.rules
@firestore.rules
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Storage and Firestore security rules for snaps</name>
  <files>
    storage.rules
    firestore.rules
  </files>
  <action>
**storage.rules:**

Add a new rule block for `snap-photos/` following the same pattern as the existing `photos/` rule. Read the current storage.rules file first.

Add under the existing rules:

```
match /snap-photos/{userId}/{allPaths=**} {
  // Owner can upload snap photos
  allow write: if request.auth != null && request.auth.uid == userId;
  // Direct reads restricted to owner only; others access via Admin SDK signed URLs
  allow read: if request.auth != null && request.auth.uid == userId;
}
```

This matches the `photos/{userId}/{allPaths=**}` pattern already in the file. Non-owners access snap photos exclusively via the `getSignedSnapUrl` Cloud Function (which uses Admin SDK and bypasses security rules).

Add `cacheControl` metadata validation if the existing rules check metadata on uploads:

- Snap uploads should have `contentType` matching `image/jpeg` or `image/png`

**firestore.rules:**

Read the current firestore.rules file first. The research confirmed that `viewedAt` and `screenshotted` update permissions already exist (lines 428-432). Verify this is still the case.

Add/verify the following fields are allowed in message document writes:

- `snapStoragePath` (string) -- allowed in message creation (same participant rules as other message fields)
- `caption` (string or null) -- allowed in message creation
- `expiresAt` (timestamp) -- allowed in message creation
- `viewedAt` (timestamp) -- UPDATE permission for non-sender already exists, verify it covers snap messages specifically

The key rule to verify/add: the existing message creation rule must allow the new fields (`snapStoragePath`, `caption`, `expiresAt`, `viewedAt`). If the rules use a whitelist of allowed fields, add these. If they use `request.resource.data` validation, ensure snap fields pass validation.

Also verify that the `cleanupExpiredSnaps` Cloud Function can delete message documents -- this uses Admin SDK so it bypasses rules, but document it.

Do NOT modify any existing rules that work for text/gif/image/reaction messages. Only add snap-specific allowances.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --passWithNoTests --no-coverage 2>&1 | tail -5</automated>
<manual>Review storage.rules has snap-photos/ rule and firestore.rules allows snap message fields</manual>
</verify>
<done>Storage rules allow owner-only read/write for snap-photos/ path. Firestore rules allow snapStoragePath, caption, expiresAt fields on message documents. viewedAt update permission verified for snap messages.</done>
</task>

<task type="auto">
  <name>Task 2: Document TTL and lifecycle infrastructure configuration</name>
  <files>
    functions/index.js
  </files>
  <action>
**INFRA-03: Firestore TTL policy documentation**

Add a comment block at the top of the snap-related Cloud Functions section in functions/index.js documenting the required Firestore TTL configuration:

```javascript
/**
 * INFRASTRUCTURE REQUIREMENT (INFRA-03):
 * Firestore TTL policy must be configured on the messages collection group:
 *   Collection group: messages
 *   TTL field: expiresAt
 *
 * Configure via Firebase Console:
 *   Firestore -> Indexes -> TTL Policies -> Create policy
 *   Collection group ID: messages
 *   Timestamp field: expiresAt
 *
 * Or via gcloud CLI:
 *   gcloud firestore fields ttls update expiresAt \
 *     --collection-group=messages \
 *     --enable-ttl \
 *     --project=flick-prod-49615
 *
 * NOTE: TTL deletion is NOT instant (can take up to 24h after expiry).
 * Primary cleanup path is onSnapViewed. TTL is a safety net only.
 */
```

**INFRA-04: Storage lifecycle rule documentation**

Add a comment block documenting the required GCS lifecycle rule:

```javascript
/**
 * INFRASTRUCTURE REQUIREMENT (INFRA-04):
 * Firebase Storage lifecycle rule on snap-photos/ path:
 *   Condition: matchesPrefix ["snap-photos/"]
 *   Action: Delete
 *   Age: 7 days
 *
 * Configure via GCS Console:
 *   Cloud Storage -> [bucket] -> Lifecycle -> Add rule
 *   Or via gsutil:
 *     gsutil lifecycle set lifecycle.json gs://[bucket-name]
 *
 * lifecycle.json example:
 *   {
 *     "rule": [{
 *       "action": { "type": "Delete" },
 *       "condition": { "age": 7, "matchesPrefix": ["snap-photos/"] }
 *     }]
 *   }
 *
 * This is a safety net for orphaned snap photos. Primary cleanup is onSnapViewed.
 */
```

Also verify the `cleanupExpiredSnaps` scheduled function has a sensible schedule. Per the research, it should run every 2 hours. Ensure the schedule expression in the function definition is `every 2 hours`.

These infrastructure configurations must be done manually via Firebase Console or gcloud CLI -- they cannot be deployed via `firebase deploy`. The documentation in the code ensures the next developer (or the user) knows what to configure.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --passWithNoTests --no-coverage 2>&1 | tail -5</automated>
<manual>Verify functions/index.js has INFRA-03 and INFRA-04 documentation comments with exact configuration steps</manual>
</verify>
<done>Infrastructure requirements documented in code: Firestore TTL policy for expiresAt field on messages collection group (INFRA-03), GCS lifecycle rule for snap-photos/ path with 7-day auto-delete (INFRA-04). Both include console and CLI configuration instructions.</done>
</task>

</tasks>

<verification>
- storage.rules has `snap-photos/{userId}/{allPaths=**}` rule
- firestore.rules allows snap message fields (snapStoragePath, caption, expiresAt)
- functions/index.js documents INFRA-03 (Firestore TTL) and INFRA-04 (Storage lifecycle) with exact configuration steps
- No existing rules broken for text/gif/image/reaction messages
- Full test suite still passes: `npm test`
</verification>

<success_criteria>

- Snap photo uploads succeed against storage rules (owner can write to snap-photos/)
- Signed URL access works via Admin SDK (bypasses rules)
- Snap message creation succeeds with all required fields
- viewedAt update by non-sender succeeds
- INFRA-03 and INFRA-04 configuration instructions are clear and actionable
  </success_criteria>

<output>
After completion, create `.planning/phases/03-snap-messages/03-05-SUMMARY.md`
</output>
