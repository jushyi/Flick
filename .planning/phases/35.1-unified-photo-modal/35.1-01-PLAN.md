---
phase: 35.1-unified-photo-modal
plan: 01
type: execute
---

<objective>
Unify PhotoDetailModal and StoriesViewerModal into a single component with conditional features based on viewing mode.

Purpose: Eliminate duplicate code, ensure identical visual appearance for photos viewed from feed or stories, and properly separate concerns (story segments and view tracking only in stories mode).
Output: Single PhotoDetailModal component that handles both feed and stories viewing with mode-based conditional rendering.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-stories-redesign/35-03-SUMMARY.md

**Key files:**
@src/components/PhotoDetailModal.js
@src/components/StoriesViewerModal.js
@src/hooks/usePhotoDetailModal.js
@src/styles/PhotoDetailModal.styles.js
@src/screens/FeedScreen.js

**Phase goal from ROADMAP:**

> Merge PhotoDetailModal and stories viewer with conditional story segments (feed vs stories mode)
>
> - Story segments only appear when viewing stories
> - Feed photos do NOT trigger viewed state

**Current implementation:**

- PhotoDetailModal: Single photo view with swipe-to-close, profile overlay, emoji reactions footer
- StoriesViewerModal: Multi-photo navigation with progress bar, tap left/right, no reactions

**Target behavior:**

- mode='feed': Single photo, emoji reactions, NO progress bar, NO navigation
- mode='stories': Multi-photo, emoji reactions, progress bar, tap navigation
- Identical visual appearance (same profile position, same photo styling)
- View tracking only triggered in stories mode

**Key decisions from prior phases:**

- Stories open to first unviewed photo (35-03)
- Mark all photos viewed on close (35-03)
- Photo-level view tracking with 24-hour expiry (35-02)
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Extend PhotoDetailModal with stories mode</name>
  <files>src/hooks/usePhotoDetailModal.js, src/components/PhotoDetailModal.js, src/styles/PhotoDetailModal.styles.js</files>
  <action>
Extend the PhotoDetailModal to support both feed and stories modes:

**Hook changes (usePhotoDetailModal.js):**

1. Add new params: mode ('feed' | 'stories'), photos array, initialIndex, onPhotoChange
2. Add currentIndex state and navigation functions (goNext, goPrev)
3. Add currentPhoto derived from photos[currentIndex] in stories mode, or photo prop in feed mode
4. Add tap navigation handler that:
   - Left 30%: go previous or close if first photo
   - Right 30%: go next or close if last photo
   - Center 40%: no action (future: pause)
5. Add haptics for navigation (Light) and close (Medium)
6. Export renderProgressBar flag based on mode

**Component changes (PhotoDetailModal.js):**

1. Add new props: mode (default 'feed'), photos, initialIndex, onPhotoChange
2. Add progress bar section between header and photo (conditionally rendered in stories mode):
   - Horizontal row of segments
   - Active segments filled white, inactive gray
   - Gap of 4px between segments
3. Wrap photo in TouchableWithoutFeedback for tap navigation (stories mode only)
4. Keep emoji reactions footer in both modes
5. Pass mode to hook, derive photo from currentPhoto

**Style changes (PhotoDetailModal.styles.js):**
Add progress bar styles matching StoriesViewerModal:

- progressBarContainer: paddingTop for status bar, horizontal flex, gap 4
- progressSegment: flex 1, height 3, borderRadius 1.5
- progressSegmentActive: white background
- progressSegmentInactive: rgba(255,255,255,0.3) background

Avoid breaking changes - existing feed usage (mode prop omitted) should work unchanged.
</action>
<verify>npm run lint passes, TypeScript/type errors none (JavaScript project)</verify>
<done>PhotoDetailModal accepts mode prop, shows progress bar + tap navigation in stories mode, emoji reactions in both modes</done>
</task>

<task type="auto">
  <name>Task 2: Update FeedScreen to use unified modal</name>
  <files>src/screens/FeedScreen.js, src/components/index.js</files>
  <action>
Update FeedScreen to use the unified PhotoDetailModal for both feed and stories:

**FeedScreen.js changes:**

1. Remove StoriesViewerModal import
2. Keep PhotoDetailModal import
3. Replace stories modal usage:
   - Current: `<StoriesViewerModal visible={storiesModalVisible} friend={selectedFriend} ... />`
   - New: Use PhotoDetailModal with:
     - mode="stories"
     - photos={selectedFriend?.topPhotos || []}
     - initialIndex={storiesInitialIndex}
     - visible={storiesModalVisible}
     - onClose={handleCloseStories}
     - onReactionToggle={handleStoriesReactionToggle} (need to add)
     - currentUserId={user?.uid}
4. Update handleCloseStories to NOT mark as viewed when viewing from feed (mode='feed')
   - View tracking already happens correctly since stories uses mode='stories'
5. Add handleStoriesReactionToggle function similar to handleReactionToggle but for story photos
   - Need to update the photo in selectedFriend.topPhotos and call toggleReaction

**index.js changes:**

1. Remove StoriesViewerModal export

Do NOT delete StoriesViewerModal.js yet - mark for deletion in summary (cleanup in future phase if needed).
</action>
<verify>App launches, feed photos open in modal with reactions, stories open with progress bar and navigation</verify>
<done>FeedScreen uses unified PhotoDetailModal for both feed (mode='feed') and stories (mode='stories')</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Unified PhotoDetailModal handling both feed and stories viewing modes</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device
    3. Navigate to Feed tab

    **Test feed mode:**
    4. Tap a photo in the feed
    5. Verify: Modal opens with photo, NO progress bar at top
    6. Verify: Emoji reactions footer visible at bottom
    7. Tap an emoji - verify reaction count increases
    8. Swipe down to close

    **Test stories mode:**
    9. Tap a friend's story card at top of feed
    10. Verify: Modal opens with photo AND progress bar segments at top
    11. Verify: Emoji reactions footer visible at bottom
    12. Tap right side of screen - verify navigates to next photo
    13. Tap left side - verify navigates to previous photo
    14. Verify progress bar updates as you navigate
    15. Navigate to last photo, tap right - verify modal closes
    16. Re-open stories, verify starts at first unviewed (or beginning if all viewed)

    **Test visual consistency:**
    17. Compare feed photo modal to stories modal - verify identical appearance
    18. Profile photo position, photo styling, close button all match

  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] PhotoDetailModal accepts mode prop with 'feed' (default) and 'stories'
- [ ] Progress bar only renders in stories mode
- [ ] Tap navigation only works in stories mode
- [ ] Emoji reactions work in both modes
- [ ] Feed photos do NOT trigger viewed state
- [ ] Stories photos work with existing view tracking
- [ ] No console errors or warnings
- [ ] Lint passes
</verification>

<success_criteria>

- Single PhotoDetailModal component handles both viewing modes
- Identical visual appearance in both modes (except progress bar)
- Stories mode has progress bar and tap navigation
- Feed mode has emoji reactions only
- View tracking unchanged (stories only)
- StoriesViewerModal deprecated (export removed)
- No regressions in existing functionality
  </success_criteria>

<output>
After completion, create `.planning/phases/35.1-unified-photo-modal/35.1-01-SUMMARY.md`:

# Phase 35.1 Plan 01: Unified Photo Modal Summary

**[One-liner describing what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Phase 35.1 complete
- Ready for Phase 36 (Comments Feature)
  </output>
