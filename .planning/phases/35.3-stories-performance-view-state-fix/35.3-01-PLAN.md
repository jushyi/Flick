---
phase: 35.3-stories-performance-view-state-fix
plan: 01
type: execute
---

<objective>
Fix clunky story navigation (slow photo loading) and incorrect view state tracking (ring turns gray before all stories viewed).

Purpose: Stories should feel responsive and the gradient ring should accurately reflect viewing status.
Output: Smooth photo transitions in stories, accurate view state tracking based on photo-level completion.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context

@.planning/phases/35-stories-redesign/35-03-SUMMARY.md
@.planning/phases/35.1-unified-photo-modal/35.1-01-SUMMARY.md
@.planning/phases/35.2-feed-header-bottom-padding/35.2-01-SUMMARY.md

# Key source files

@src/hooks/useViewedStories.js
@src/hooks/usePhotoDetailModal.js
@src/components/PhotoDetailModal.js
@src/components/FriendStoryCard.js
@src/screens/FeedScreen.js

**Tech stack available:**

- expo-image (already in codebase, used in 18.1-FIX-3 for image caching)
- AsyncStorage for view state persistence

**Established patterns:**

- expo-image with transition prop for smooth loading (eliminates black flash)
- Photo-level view tracking already exists in useViewedStories.js

**Constraining decisions:**

- Phase 35-03: "Mark all photos viewed on close (next open starts fresh)"
- Phase 35.1-01: "Single modal component with mode prop"

**Root cause analysis:**

Issue 1 - Slow photo loading:

- PhotoDetailModal.js uses RN Image component (line 125)
- RN Image lacks native caching that expo-image provides
- No transition effect when image source changes

Issue 2 - Incorrect view state:

- FriendStoryCard receives `isViewed` prop from `isViewed(friend.userId)` (FeedScreen line 459)
- This checks friend-level view state (viewedFriends Set)
- `markAsViewed(friendId)` is called when modal closes regardless of photos viewed
- User could view 1 of 5 photos, close, and ring turns gray
- Should only turn gray when ALL photos have been viewed
  </context>

<tasks>

<task type="auto">
  <name>Task 1: Add hasViewedAllPhotos function and fix ring color logic</name>
  <files>src/hooks/useViewedStories.js, src/screens/FeedScreen.js</files>
  <action>
  1. In useViewedStories.js, add new function `hasViewedAllPhotos`:
     ```javascript
     /**
      * Check if all photos in an array have been viewed
      * @param {Array<object>} photos - Array of photo objects with id property
      * @returns {boolean} True if ALL photos have been viewed
      */
     const hasViewedAllPhotos = useCallback(
       photos => {
         if (!photos || photos.length === 0) return false;
         return photos.every(photo => viewedPhotos.has(photo.id));
       },
       [viewedPhotos]
     );
     ```
  2. Add `hasViewedAllPhotos` to the return object

3. In FeedScreen.js:
   - Update destructuring to include `hasViewedAllPhotos`:
     `const { isViewed, markAsViewed, markPhotosAsViewed, getFirstUnviewedIndex, hasViewedAllPhotos } = useViewedStories();`
   - Update FriendStoryCard's isViewed prop (line ~459):
     From: `isViewed={isViewed(friend.userId)}`
     To: `isViewed={hasViewedAllPhotos(friend.topPhotos)}`

4. Keep the existing `markAsViewed` call in `handleCloseStories` - this still marks friend as viewed at the friend level, but the ring color now depends on photo-level completion

This ensures the gradient ring only turns gray when user has actually seen ALL photos.
</action>
<verify>

1. Open stories for a friend with multiple photos
2. View only the first photo, then close modal
3. Verify ring is still gradient (not gray) because not all photos viewed
4. Reopen stories, view all photos, close modal
5. Verify ring is now gray (all photos viewed)
   </verify>
   <done>Gradient ring accurately reflects whether ALL photos have been viewed, not just whether modal was opened</done>
   </task>

<task type="auto">
  <name>Task 2: Replace RN Image with expo-image for smooth photo loading</name>
  <files>src/components/PhotoDetailModal.js</files>
  <action>
  1. Import Image from expo-image:
     ```javascript
     import { Image } from 'expo-image';
     ```
  2. Remove Image from react-native imports (keep View, Text, Modal, TouchableOpacity, etc.)

3. Update the Image component (around line 123-127):
   From:
   ```javascript
   <Image source={{ uri: imageURL }} style={styles.photo} resizeMode="cover" />
   ```
   To:
   ```javascript
   <Image source={{ uri: imageURL }} style={styles.photo} contentFit="cover" transition={200} />
   ```

Note: expo-image uses `contentFit` instead of `resizeMode`, and `transition` prop enables smooth fade between images.

expo-image provides:

- Native memory and disk caching (images load instantly on revisit)
- 200ms crossfade transition (eliminates jarring image swap)
- Better performance than RN Image
  </action>
  <verify>

1. Open stories modal for a friend with multiple photos
2. Tap right side to navigate to next photo
3. Observe smooth 200ms fade transition (not abrupt swap)
4. Navigate back and forth - images should load near-instantly from cache
5. Close modal, reopen - first image should load from cache immediately
   </verify>
   <done>Photo transitions are smooth with expo-image caching and 200ms fade effect</done>
   </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>View state tracking fix and expo-image performance improvement for stories modal</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on device/simulator
    3. Navigate to Feed tab

    **Test view state tracking:**
    4. Find a friend's story with gradient ring (unviewed)
    5. Tap to open stories - note which photo index it starts on
    6. View only 1-2 photos, then close (swipe down or X)
    7. Verify: Ring should STILL be gradient (not all photos viewed)
    8. Reopen same friend's stories
    9. View ALL photos (tap through to the end)
    10. Close modal
    11. Verify: Ring is now gray (all photos viewed)

    **Test photo loading performance:**
    12. Open a different friend's stories
    13. Tap rapidly through photos (left/right areas)
    14. Verify: Photos transition smoothly (200ms fade, no jarring swap)
    15. Go back to first photo - should load instantly from cache
    16. Close and reopen - first photo loads immediately

  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run lint` passes without errors
- [ ] App runs without crashes in stories modal
- [ ] View state tracking accurate (ring matches photo-level completion)
- [ ] Photo transitions smooth (200ms fade effect visible)
- [ ] Images cache properly (instant load on revisit)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript/ESLint errors introduced
- Stories navigation feels responsive (not clunky)
- Gradient ring accurately reflects viewing status
  </success_criteria>

<output>
After completion, create `.planning/phases/35.3-stories-performance-view-state-fix/35.3-01-SUMMARY.md`:

# Phase 35.3 Plan 01: Stories Performance & View State Fix Summary

**[Substantive one-liner - what shipped]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 36 (Comments Feature)
</output>
