---
phase: 18.6-triage-animation-timing
plan: 01
type: execute
---

<objective>
Eliminate the perceptible delay between card exit and cascade animation for fluid, continuous triage flow.

Purpose: Make photo triage feel like flipping through a deck of cards in one continuous motion - no dead time between animations.
Output: Smoother triage experience where cascade starts as soon as exiting card clears visual overlap.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18.6-triage-animation-timing/18.6-CONTEXT.md
@.planning/phases/18.4-triage-animation-arc-adjustment/18.4-01-SUMMARY.md
@.planning/phases/18.1-batched-darkroom-triage-with-undo/18.1-FIX-5-SUMMARY.md
@src/components/SwipeablePhotoCard.js
@src/screens/DarkroomScreen.js

**Tech stack available:** React Native Reanimated (withTiming, withDelay, runOnJS, useSharedValue)
**Established patterns:** stackIndex useEffect drives cascade animation, CASCADE_DELAY_MS constant controls timing

**Current animation flow:**
1. User swipes/taps → exit animation starts (EXIT_DURATION = 800ms for swipe, BUTTON_EXIT_DURATION = 800ms for buttons)
2. Exit animation completes (callback) → handleArchive/Journal/Delete runs
3. State update (hiddenPhotoIds) → visiblePhotos changes → cards get new stackIndex
4. stackIndex useEffect detects change → CASCADE_DELAY_MS (100ms) delay → cascade animation (350ms)

**The problem:**
Cascade doesn't START until AFTER exit completes + state updates + 100ms delay = visible gap.
The exiting card is fully off-screen before cascade begins.

**The fix:**
Trigger cascade earlier - when exiting card clears visual overlap (~50-60% exit), not at 100%.
This requires notifying parent DURING the exit animation (via runOnJS callback at percentage point).

**Key insight from CONTEXT.md:**
"Cascade should trigger when exiting card clears visual overlap with the stack (not at 80% exit or arbitrary percentage)"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add early cascade trigger callback in SwipeablePhotoCard</name>
  <files>src/components/SwipeablePhotoCard.js</files>
  <action>
Add a new callback prop `onExitClearance` that fires when the exiting card clears visual overlap with the stack.

**Implementation:**
1. Add `onExitClearance` prop to the component
2. Calculate the "clearance point" - when card's left/right edge clears the stack area:
   - Card width is SCREEN_WIDTH * 0.92
   - Clearance occurs when |translateX| > cardWidth (card has moved its full width)
   - This is approximately when translateX reaches ±(SCREEN_WIDTH * 0.46) given half-width overlap
3. In the exit animation, add an intermediate callback that fires at the clearance point:
   - For swipe: Use `withTiming` but check progress in a `withSequence` or use `withCallback` pattern
   - Better approach: Calculate the TIME at which clearance occurs and use `withDelay` to fire callback

**Timing calculation:**
- Total exit: 800ms to reach SCREEN_WIDTH * 1.5
- Clearance at SCREEN_WIDTH * 0.92 (one card width) = 0.92/1.5 = ~61% of exit
- Fire callback at ~490ms (61% of 800ms)

**Add to both gesture swipe (`onEnd`) and imperative methods (`triggerArchive`, `triggerJournal`):**
```javascript
// Fire clearance callback partway through exit animation
const CLEARANCE_DELAY = Math.round(EXIT_DURATION * 0.6); // ~480ms for swipe
const BUTTON_CLEARANCE_DELAY = Math.round(BUTTON_EXIT_DURATION * 0.6);

// In onEnd and imperative methods, use setTimeout to fire callback:
if (onExitClearance) {
  setTimeout(() => {
    runOnJS(onExitClearance)();
  }, CLEARANCE_DELAY);
}
```

**Do NOT change:** Exit animation duration, arc path, rotation, overlays, or any visual characteristics.
  </action>
  <verify>Component accepts onExitClearance prop. Verify by reading the component and confirming the prop is destructured and called during exit animations.</verify>
  <done>SwipeablePhotoCard has onExitClearance callback that fires at ~60% exit progress for both swipe and button triage.</done>
</task>

<task type="auto">
  <name>Task 2: Connect early trigger to cascade in DarkroomScreen</name>
  <files>src/screens/DarkroomScreen.js</files>
  <action>
Connect the `onExitClearance` callback to trigger the cascade animation early by hiding the photo (which updates stackIndex).

**Implementation:**
1. Add `handleExitClearance` callback:
```javascript
// Called when exiting card clears visual overlap - trigger cascade early
const handleExitClearance = useCallback((photoId) => {
  logger.debug('DarkroomScreen: Exit clearance reached, triggering cascade', { photoId });

  // Hide the photo to update stackIndex and trigger cascade animation
  setHiddenPhotoIds(prev => {
    const newHidden = new Set(prev);
    newHidden.add(photoId);
    return newHidden;
  });
}, []);
```

2. Pass to SwipeablePhotoCard:
```javascript
onExitClearance={isActive ? () => handleExitClearance(photo.id) : undefined}
```

3. Remove or reduce CASCADE_DELAY_MS in SwipeablePhotoCard since we're now triggering earlier.
   The 100ms delay was to "let exiting card clear" - but now we're explicitly waiting for clearance.
   Set CASCADE_DELAY_MS = 0 since timing is already handled by onExitClearance.

**Key change:** Photo is hidden DURING exit animation (at clearance point), not AFTER exit completes.
The action handlers (handleArchive/etc) still fire at exit completion for haptics and undo stack, but the cascade is already in motion.

**IMPORTANT:** The handleTriage function still needs to handle the undo stack push and success state check.
Split the concerns:
- onExitClearance: Just hides photo to trigger cascade (visual)
- onSwipeLeft/Right/Down callbacks: Handle undo stack, success state, logging (logic)

Update handleTriage to NOT hide the photo if it's already hidden (prevent double-hide):
```javascript
// Only hide if not already hidden (may have been hidden early by onExitClearance)
if (!hiddenPhotoIds.has(photoId)) {
  setHiddenPhotoIds(prev => {
    const newHidden = new Set(prev);
    newHidden.add(photoId);
    return newHidden;
  });
}
```

**Do NOT change:** Undo stack logic, success state logic, haptic feedback timing.
  </action>
  <verify>Run app on device, swipe or tap to triage a photo. Observe that the cascade animation starts while the exiting card is still visible (before it fully exits screen).</verify>
  <done>Cascade animation starts when exiting card clears visual overlap. No perceptible gap between exit and cascade.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Early cascade trigger for fluid triage animation flow</what-built>
  <how-to-verify>
    1. Run: npx expo start
    2. Open app on physical iOS device
    3. Navigate to Camera, take 4+ photos, wait for reveal, open darkroom
    4. Swipe a photo left (Archive) and observe:
       - Cascade animation should START while exiting card is still partially visible
       - No pause/gap between exit and cascade
       - Cards flow continuously like flipping through a deck
    5. Swipe a photo right (Journal) and verify same fluid behavior
    6. Tap Archive button and verify same fluid behavior
    7. Tap Journal button and verify same fluid behavior
    8. Tap Delete button - this has different animation (suction) so verify it still works correctly
    9. Verify undo still works: tap Undo and card should animate back correctly
    10. Complete triage and verify success screen appears correctly
  </how-to-verify>
  <resume-signal>Type "approved" if triage feels fluid with no perceptible gaps, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] Swipe triage (left/right) has no perceptible gap between exit and cascade
- [ ] Button triage (Archive/Journal/Delete) has no perceptible gap
- [ ] Delete suction animation still works correctly
- [ ] Undo functionality still works correctly
- [ ] Success screen appears correctly when all photos triaged
- [ ] App builds without errors
</verification>

<success_criteria>

- Cascade animation starts when exiting card clears visual overlap
- No perceptible pause between exit and cascade for any triage action
- Existing functionality (undo, success state, haptics) unchanged
- Motion feels like flipping through a deck of cards in one continuous flow
</success_criteria>

<output>
After completion, create `.planning/phases/18.6-triage-animation-timing/18.6-01-SUMMARY.md`:

# Phase 18.6 Plan 01: Triage Animation Timing Optimization Summary

**[Substantive one-liner - what shipped]**

## Performance

- **Duration:** X min
- **Tasks:** 2 auto + 1 checkpoint
- **Files modified:** 2

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Task Commits

1. **Task 1: [name]** - `hash` (type)
2. **Task 2: [name]** - `hash` (type)

## Files Created/Modified

- `src/components/SwipeablePhotoCard.js` - Added onExitClearance callback
- `src/screens/DarkroomScreen.js` - Connected early cascade trigger

## Decisions Made

[Key decisions and rationale, or "None"]

## Deviations from Plan

[Deviations, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

- Phase 18.6 complete
- v1.5 milestone complete (Phase 18.6 is the final phase)
</output>
