---
phase: 10-pinned-snaps-android
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - src/services/firebase/snapService.js
  - src/screens/SnapPreviewScreen.js
  - src/services/firebase/notificationService.js
  - src/screens/ConversationScreen.js
  - functions/index.js
  - __tests__/services/snapService.test.js
  - __tests__/services/notificationService.test.js
autonomous: false
requirements:
  - PINA-01
  - PINA-03

must_haves:
  truths:
    - "Sender can toggle 'pin to screen' on SnapPreviewScreen before sending a snap"
    - "The isPinned boolean is written to the snap message document in Firestore"
    - "When recipient views a pinned snap, the notification is automatically dismissed from the notification shade"
    - "Pinned snap notifications auto-expire after 48 hours via cloud function"
  artifacts:
    - path: "src/services/firebase/snapService.js"
      provides: "uploadAndSendSnap with isPinned parameter"
      contains: "isPinned"
    - path: "src/screens/SnapPreviewScreen.js"
      provides: "Pin toggle UI and isPinned state passed to uploadAndSendSnap"
      contains: "isPinned"
    - path: "src/services/firebase/notificationService.js"
      provides: "storePinnedNotifId and dismissPinnedNotif helpers using AsyncStorage"
      contains: "dismissPinnedNotif"
    - path: "src/screens/ConversationScreen.js"
      provides: "Pinned notification dismissal wired to snap view flow"
      contains: "dismissPinnedNotif"
    - path: "functions/index.js"
      provides: "expirePinnedSnapNotifications scheduled cloud function"
      contains: "expirePinnedSnapNotifications"
    - path: "__tests__/services/snapService.test.js"
      provides: "Tests for isPinned field in uploadAndSendSnap"
      contains: "isPinned"
    - path: "__tests__/services/notificationService.test.js"
      provides: "Tests for dismissPinnedNotif and storePinnedNotifId helpers"
      contains: "dismissPinnedNotif"
  key_links:
    - from: "src/screens/SnapPreviewScreen.js"
      to: "src/services/firebase/snapService.js"
      via: "uploadAndSendSnap call with isPinned param"
      pattern: "uploadAndSendSnap.*isPinned"
    - from: "src/screens/ConversationScreen.js"
      to: "src/services/firebase/notificationService.js"
      via: "dismissPinnedNotif called when SnapViewer closes after viewing"
      pattern: "dismissPinnedNotif"
    - from: "functions/index.js"
      to: "Expo Push API"
      via: "expirePinnedSnapNotifications sends cancel_pinned_snap data-only push"
      pattern: "cancel_pinned_snap"
---

<objective>
Add the sender-side pin toggle, snap message isPinned field, notification dismissal on snap view, and 48-hour auto-expiry cloud function.

Purpose: Complete the pinned snap feature end-to-end: sender toggles pin, message stores isPinned flag (triggering Plan 01's cloud function to send BigPictureStyle push), recipient views snap and notification auto-dismisses, and stale pinned notifications expire after 48 hours via cloud function.

Output: Complete pinned snap Android feature with toggle, dismissal, and expiry
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-pinned-snaps-android/10-CONTEXT.md
@.planning/phases/10-pinned-snaps-android/10-RESEARCH.md
@.planning/phases/10-pinned-snaps-android/10-01-SUMMARY.md

@src/services/firebase/snapService.js
@src/screens/SnapPreviewScreen.js
@src/services/firebase/notificationService.js
@src/screens/ConversationScreen.js
@functions/index.js
@__tests__/services/snapService.test.js
@__tests__/services/notificationService.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isPinned field to snapService and pin toggle to SnapPreviewScreen</name>
  <files>
    src/services/firebase/snapService.js
    src/screens/SnapPreviewScreen.js
    __tests__/services/snapService.test.js
  </files>
  <action>
1. **src/services/firebase/snapService.js** — Extend `uploadAndSendSnap` to accept an optional `isPinned` parameter:
   - Change signature from `(conversationId, senderId, localUri, caption = null)` to `(conversationId, senderId, localUri, caption = null, isPinned = false)`
   - In the `messageData` object, add `isPinned: isPinned || false` field after the `caption` field
   - Update the JSDoc to document the new param: `@param {boolean} isPinned - Whether to pin this snap to recipient's notification shade`
   - This is backward-compatible: existing callers pass no 5th argument, defaulting to false

2. **src/screens/SnapPreviewScreen.js** — Add a pin toggle in the send area:
   - Add state: `const [isPinned, setIsPinned] = useState(false);`
   - In the `handleSend` callback, pass `isPinned` to `uploadAndSendSnap`:
     Change: `await uploadAndSendSnap(conversationId, user.uid, photoUri, caption || null)`
     To: `await uploadAndSendSnap(conversationId, user.uid, photoUri, caption || null, isPinned)`
   - Add a pin toggle button in the footer area (near the send button). The toggle should be a `TouchableOpacity` that toggles `isPinned` state:
     - Position: To the left of the send button, in the same row
     - Icon: Use `PixelIcon` with name `'pin'` (or `'pin-outline'` if available — check PixelIcon constants; if neither exists, use `'notifications'` icon). The icon should be filled/highlighted when isPinned is true.
     - Style: When isPinned is true, the icon should be colored amber (`colors.accent.amber` or `'#F5A623'`). When false, use `colors.text.tertiary` (muted).
     - Size: Same as other footer icons (24)
     - Add a small label below or beside the icon: "Pin" in retro pixel font, matching the muted/amber color toggle
   - Add haptic feedback on toggle: `Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light)` when toggling
   - The toggle mirrors the iOS experience per user decision (same position, same visual treatment). Since Phase 9 (iOS) is not yet implemented, this establishes the cross-platform toggle that Phase 9 will reuse.

3. **__tests__/services/snapService.test.js** — Add test cases for the isPinned parameter:
   - In the existing `uploadAndSendSnap` describe block, add:
     a) Test: `'sends snap with isPinned: true when pin flag is set'` — call uploadAndSendSnap with isPinned=true, verify the addDoc call includes `isPinned: true` in the message data
     b) Test: `'defaults isPinned to false when not provided'` — call uploadAndSendSnap without 5th param, verify addDoc includes `isPinned: false`
  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npx jest __tests__/services/snapService.test.js --no-coverage 2>&1 | tail -20</automated>
    <manual>Verify SnapPreviewScreen renders a pin toggle button near the send button</manual>
  </verify>
  <done>
    - uploadAndSendSnap accepts isPinned param and writes it to the message document
    - SnapPreviewScreen has a pin toggle button that toggles amber/muted styling
    - Pin toggle state is passed to uploadAndSendSnap on send
    - Tests verify isPinned field is written correctly to Firestore
  </done>
</task>

<task type="auto">
  <name>Task 2: Add notification dismissal on snap view and 48h expiry cloud function</name>
  <files>
    src/services/firebase/notificationService.js
    src/screens/ConversationScreen.js
    functions/index.js
    __tests__/services/notificationService.test.js
  </files>
  <action>
1. **src/services/firebase/notificationService.js** — Add pinned notification tracking and dismissal helpers:
   a) Add `import AsyncStorage from '@react-native-async-storage/async-storage';` at the top (with third-party imports). If AsyncStorage is not already imported, add it. Note: The project may use `@react-native-async-storage/async-storage` — check package.json. If not available, use `expo-secure-store` or a simple module-level Map as fallback (module-level Map is fine since notifications are device-local and ephemeral).

   b) Add a constant near the top: `const PINNED_NOTIF_KEY = '@pinned_snap_notifications';`

   c) Add two new exported functions:

   ```javascript
   /**
    * Store a pinned snap notification identifier for later dismissal.
    * Called when a pinned_snap notification is received.
    * @param {string} senderId - The sender's user ID (key for lookup)
    * @param {string} notificationId - The system notification identifier
    */
   export const storePinnedNotifId = async (senderId, notificationId) => {
     try {
       const existing = JSON.parse(await AsyncStorage.getItem(PINNED_NOTIF_KEY) || '{}');
       existing[senderId] = notificationId;
       await AsyncStorage.setItem(PINNED_NOTIF_KEY, JSON.stringify(existing));
       logger.debug('Stored pinned notification ID', { senderId, notificationId });
     } catch (error) {
       logger.error('Failed to store pinned notification ID', { error: error.message });
     }
   };

   /**
    * Dismiss a pinned snap notification when the snap is viewed.
    * Reads the stored notification identifier for the sender and dismisses it.
    * @param {string} senderId - The sender's user ID
    */
   export const dismissPinnedNotif = async (senderId) => {
     try {
       const existing = JSON.parse(await AsyncStorage.getItem(PINNED_NOTIF_KEY) || '{}');
       const notifId = existing[senderId];
       if (notifId) {
         await Notifications.dismissNotificationAsync(notifId);
         delete existing[senderId];
         await AsyncStorage.setItem(PINNED_NOTIF_KEY, JSON.stringify(existing));
         logger.info('Dismissed pinned notification', { senderId, notifId });
       }
     } catch (error) {
       // Best-effort: notification may already be dismissed by user swipe
       logger.warn('Failed to dismiss pinned notification', { senderId, error: error.message });
     }
   };
   ```

   d) In the `setNotificationHandler` callback (the `handleNotification` function that returns shouldShowAlert etc.), add logic to capture pinned snap notification identifiers. When a notification arrives in the foreground with `data.type === 'pinned_snap'`, call `storePinnedNotifId(data.senderId, notification.request.identifier)`. Also return `shouldShowAlert: true` for pinned_snap type so the system notification persists in the shade even when the app is in the foreground. For background/killed state, add a `addNotificationReceivedListener` call in `initializeNotifications` that stores the identifier for pinned_snap notifications.

   e) Add a new exported function to handle the cancel_pinned_snap data push from the 48h expiry cloud function:
   ```javascript
   /**
    * Handle cancel_pinned_snap push from 48h expiry cloud function.
    * Called from notification received listener when type is cancel_pinned_snap.
    * @param {string} senderId - Sender whose pinned notification to cancel
    */
   export const handleCancelPinnedSnap = async (senderId) => {
     await dismissPinnedNotif(senderId);
   };
   ```

2. **src/screens/ConversationScreen.js** — Wire dismissal when snap is viewed:
   - Import `dismissPinnedNotif` from notificationService
   - In the SnapViewer `onClose` callback (around line 700), after the existing `setSnapViewerMessage(null)`, add a call to dismiss the pinned notification if the snap was viewed (not just closed). The SnapViewer's markSnapViewed is called internally before onClose. To determine if the snap was from a friend (not self), check if `snapViewerMessage.senderId !== user.uid`. If it was a friend's snap, call `dismissPinnedNotif(snapViewerMessage.senderId)`.
   - This is best-effort: if the notification was already dismissed by the user swiping, dismissPinnedNotif will silently handle the error.

3. **functions/index.js** — Add the 48-hour expiry cloud function:
   - Add a new scheduled function `expirePinnedSnapNotifications` that runs every 2 hours (matching the existing `cleanupExpiredSnaps` cadence):
   ```javascript
   exports.expirePinnedSnapNotifications = functions
     .runWith({ memory: '256MB', timeoutSeconds: 120 })
     .pubsub.schedule('every 2 hours')
     .onRun(async () => {
       // Find pinned snap messages older than 48 hours that haven't been viewed
       const cutoff = new Date(Date.now() - 48 * 60 * 60 * 1000);
       const snapshot = await db.collectionGroup('messages')
         .where('type', '==', 'snap')
         .where('isPinned', '==', true)
         .where('viewedAt', '==', null)
         .where('createdAt', '<=', admin.firestore.Timestamp.fromDate(cutoff))
         .get();

       if (snapshot.empty) {
         logger.info('expirePinnedSnapNotifications: No expired pinned snaps');
         return null;
       }

       logger.info('expirePinnedSnapNotifications: Found expired pinned snaps', {
         count: snapshot.size,
       });

       const { sendPushNotification } = require('./notifications/sender');

       for (const doc of snapshot.docs) {
         try {
           const message = doc.data();
           const conversationId = doc.ref.parent.parent.id;
           const parts = conversationId.split('_');
           if (parts.length !== 2) continue;

           const [uid1, uid2] = parts;
           const recipientId = uid1 === message.senderId ? uid2 : uid1;

           // Get recipient's FCM token
           const recipientDoc = await db.collection('users').doc(recipientId).get();
           if (!recipientDoc.exists) continue;
           const fcmToken = recipientDoc.data().fcmToken;
           if (!fcmToken) continue;

           // Send silent data-only push to cancel the notification on device
           await sendPushNotification(
             fcmToken,
             '', // empty title (data-only)
             '', // empty body (data-only)
             {
               type: 'cancel_pinned_snap',
               senderId: message.senderId,
               conversationId,
             },
             recipientId
           );

           // Mark as no longer pinned to avoid re-processing
           await doc.ref.update({ isPinned: false });

           logger.info('expirePinnedSnapNotifications: Expired pinned snap', {
             conversationId,
             messageId: doc.id,
           });
         } catch (error) {
           logger.error('expirePinnedSnapNotifications: Error expiring snap', {
             messageId: doc.id,
             error: error.message,
           });
           // Continue with other snaps
         }
       }

       return null;
     });
   ```

   NOTE: The `cancel_pinned_snap` data push is handled client-side by the notification received listener added in step 1d. When the client receives a notification with `type: 'cancel_pinned_snap'`, it calls `handleCancelPinnedSnap(senderId)` which dismisses the notification.

   IMPORTANT: This collectionGroup query on 'messages' requires a Firestore composite index on `type`, `isPinned`, `viewedAt`, `createdAt`. Add a comment in the code noting this requirement. The index will be created automatically when the function first runs and Firestore returns an error with a direct link to create it, or it can be added to `firestore.indexes.json`.

4. **__tests__/services/notificationService.test.js** — Add tests for dismissal helpers:
   - Mock AsyncStorage (or the storage mechanism used)
   - Test `storePinnedNotifId`: stores senderId -> notificationId mapping
   - Test `dismissPinnedNotif`: reads stored ID, calls `dismissNotificationAsync`, removes from storage
   - Test `dismissPinnedNotif` with no stored ID: does not call `dismissNotificationAsync`, does not throw
  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npx jest __tests__/services/notificationService.test.js __tests__/services/snapService.test.js --no-coverage 2>&1 | tail -20</automated>
    <manual>Review ConversationScreen snap view flow — verify dismissPinnedNotif is called after viewing friend's snap</manual>
  </verify>
  <done>
    - storePinnedNotifId and dismissPinnedNotif helpers manage notification ID tracking via AsyncStorage
    - ConversationScreen calls dismissPinnedNotif when a friend's snap is viewed in SnapViewer
    - Notification received listener captures pinned_snap notification identifiers for background/killed state
    - cancel_pinned_snap data push handled client-side for 48h expiry
    - expirePinnedSnapNotifications cloud function finds and expires unviewed pinned snaps older than 48h
    - All tests pass for dismissal helpers
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify pinned snap end-to-end flow</name>
  <what-built>Complete pinned snap Android feature: sender pin toggle on SnapPreviewScreen, BigPictureStyle notification with thumbnail, deep link to conversation with auto-open snap, notification dismissal on snap view, 48-hour cloud function expiry</what-built>
  <how-to-verify>
    1. Open the app on an Android device (or emulator with push notification support)
    2. Navigate to a conversation and tap the camera button to take a snap
    3. On SnapPreviewScreen, verify there is a pin toggle button near the send button
    4. Toggle the pin button ON (should turn amber), send the snap
    5. On the recipient's Android device, verify:
       a. A notification appears with "Pinned snap from [Name]" title
       b. The notification shows the snap photo thumbnail (BigPictureStyle)
       c. The notification has sound + vibration
       d. The notification persists in the notification shade
    6. Tap the notification — verify it opens the conversation and auto-opens the snap viewer
    7. After viewing the snap, pull down the notification shade — verify the pinned snap notification is gone
    8. Send another pinned snap but do NOT view it — verify it persists in the notification shade
    9. Verify the pin toggle defaults to OFF when entering SnapPreviewScreen fresh
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx jest __tests__/services/notificationService.test.js __tests__/services/snapService.test.js --no-coverage` — all tests pass
2. `cd functions && npx jest --no-coverage` — all cloud function tests pass
3. `npm run lint` — no linting errors
4. Manual: Pin toggle visible and functional on SnapPreviewScreen
5. Manual: Pinned snap notification arrives with thumbnail on Android
6. Manual: Notification dismissed after viewing snap
</verification>

<success_criteria>
- SnapPreviewScreen has a pin toggle that sets isPinned on the snap message document
- Pinned snap notifications include BigPictureStyle thumbnail via richContent.image
- Tapping notification navigates to conversation with auto-open snap
- Viewing a pinned snap auto-dismisses the notification from the shade
- 48-hour expiry cloud function sends cancel push for stale pinned snaps
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-pinned-snaps-android/10-02-SUMMARY.md`
</output>
