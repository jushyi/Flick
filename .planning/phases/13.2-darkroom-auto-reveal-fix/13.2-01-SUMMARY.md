---
phase: 13.2-darkroom-auto-reveal-fix
plan: 01
subsystem: darkroom
tags: [firebase, firestore, appstate, reveal, timing]

# Dependency graph
requires:
  - phase: 13.1-darkroom-reveal-timing-fix
    provides: ensureDarkroomInitialized on photo capture, 0-15 min interval
provides:
  - Auto-reveal of overdue photos before resetting stale darkroom timing
  - Foreground reveal check via AppState listener
  - Two-point reveal trigger (photo capture + app foreground)
affects: [14-remote-notification-testing]

# Tech tracking
tech-stack:
  added: []
  patterns: [inline reveal logic to avoid circular imports, AppState foreground listener]

key-files:
  created: []
  modified: [src/services/firebase/darkroomService.js, App.js]

key-decisions:
  - "Inlined reveal logic in darkroomService to avoid circular import with photoService"
  - "Added two reveal trigger points: ensureDarkroomInitialized (on capture) and App foreground listener"

patterns-established:
  - "AppState foreground listener pattern for proactive background sync"

issues-created: []

# Metrics
duration: 2min
completed: 2026-01-20
---

# Phase 13.2 Plan 01: Darkroom Auto-Reveal Fix Summary

**Fixed auto-reveal: photos now reveal when stale darkroom timing detected (on capture or app foreground), not just when user opens DarkroomScreen**

## Performance

- **Duration:** 2 min
- **Started:** 2026-01-20T19:26:15Z
- **Completed:** 2026-01-20T19:28:30Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- ensureDarkroomInitialized() now reveals overdue photos BEFORE resetting stale nextRevealAt
- App-level AppState listener checks for pending reveals when app comes to foreground
- Photos no longer stuck in 'developing' state indefinitely
- Used inline reveal logic to avoid circular import between darkroomService and photoService

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix ensureDarkroomInitialized to reveal photos before resetting stale timing** - `8510772` (fix)
2. **Task 2: Add app-level reveal check on foreground** - `2ac7b99` (feat)

**Plan metadata:** (pending - this commit)

## Files Created/Modified

- `src/services/firebase/darkroomService.js` - Added inline reveal logic in ensureDarkroomInitialized() to reveal overdue photos before resetting stale nextRevealAt
- `App.js` - Added AppState foreground listener that checks isDarkroomReadyToReveal and triggers revealPhotos + scheduleNextReveal

## Decisions Made

- **Inline reveal logic vs import**: Used inline reveal logic (query developing photos, update to revealed) to avoid circular import. photoService imports from darkroomService, so importing revealPhotos from photoService into darkroomService would create circular dependency.
- **Two trigger points**: Photos can now be revealed via two mechanisms: (1) when capturing a new photo if darkroom is stale, (2) when app comes to foreground if darkroom is ready

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None

## Next Step

Phase 13.2 complete, ready for Phase 14: Remote Notification Testing & Polish.

---
*Phase: 13.2-darkroom-auto-reveal-fix*
*Completed: 2026-01-20*
