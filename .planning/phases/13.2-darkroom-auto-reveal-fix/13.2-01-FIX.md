---
phase: 13.2-darkroom-auto-reveal-fix
plan: 01-FIX
type: fix
---

<objective>
Fix UAT-001: Add server-side darkroom reveal via scheduled Firebase Cloud Function.

Source: 13.2-01-ISSUES.md
Priority: 1 major issue

Purpose: Enable photos to reveal at exactly the scheduled time regardless of app state (open, closed, backgrounded), with push notification firing at actual reveal time.
Output: Working server-side reveal system where Cloud Function checks all darkrooms periodically and reveals overdue photos.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

**Issues being fixed:**
@.planning/phases/13.2-darkroom-auto-reveal-fix/13.2-01-ISSUES.md

**Original plan for reference:**
@.planning/phases/13.2-darkroom-auto-reveal-fix/13.2-01-PLAN.md

**Existing Cloud Functions:**
@functions/index.js

**Darkroom Service (for reveal logic reference):**
@src/services/firebase/darkroomService.js

**Photo Service (for reveal logic reference):**
@src/services/firebase/photoService.js

**Architecture Decision:**
The client-side reveal logic (Task 1 & 2 from original plan) is insufficient because:
- Photos only reveal when user interacts with app (capture or foreground)
- If user never opens app, photos stay in 'developing' forever
- Push notification for "photos ready" can only fire after client reveals

Server-side reveal solves this:
- Cloud Function runs on schedule (every 1-2 minutes)
- Checks ALL users' darkrooms for overdue `nextRevealAt`
- Server reveals photos directly in Firestore
- This triggers `sendPhotoRevealNotification` (existing function) via darkroom onUpdate
- User receives notification at actual reveal time, even if app is closed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scheduled Cloud Function for server-side darkroom reveal</name>
  <files>functions/index.js</files>
  <action>
Add a new scheduled Cloud Function `processDarkroomReveals` that runs every 2 minutes to check all darkrooms and reveal overdue photos.

1. Add the scheduled function using firebase-functions v2 pubsub scheduler:

```javascript
/**
 * Cloud Function: Process darkroom reveals on schedule
 * Runs every 2 minutes to check all darkrooms and reveal overdue photos
 * This ensures photos reveal at scheduled time even when app is closed
 */
exports.processDarkroomReveals = functions.pubsub
  .schedule('every 2 minutes')
  .onRun(async (context) => {
    try {
      const now = admin.firestore.Timestamp.now();
      console.log('processDarkroomReveals: Starting scheduled reveal check at', now.toDate());

      // Query all darkrooms where nextRevealAt has passed
      const darkroomsSnapshot = await admin.firestore()
        .collection('darkrooms')
        .where('nextRevealAt', '<=', now)
        .get();

      if (darkroomsSnapshot.empty) {
        console.log('processDarkroomReveals: No darkrooms ready to reveal');
        return null;
      }

      console.log(`processDarkroomReveals: Found ${darkroomsSnapshot.size} darkrooms ready to reveal`);

      // Process each darkroom
      const results = await Promise.all(
        darkroomsSnapshot.docs.map(async (darkroomDoc) => {
          const userId = darkroomDoc.id;
          try {
            return await revealUserPhotos(userId, now);
          } catch (error) {
            console.error(`processDarkroomReveals: Error for user ${userId}:`, error);
            return { userId, success: false, error: error.message };
          }
        })
      );

      const successCount = results.filter(r => r.success).length;
      const revealedCount = results.reduce((sum, r) => sum + (r.photosRevealed || 0), 0);
      console.log(`processDarkroomReveals: Completed. ${successCount}/${darkroomsSnapshot.size} users processed, ${revealedCount} photos revealed`);

      return { processed: darkroomsSnapshot.size, successful: successCount, photosRevealed: revealedCount };
    } catch (error) {
      console.error('processDarkroomReveals: Fatal error:', error);
      return null;
    }
  });
```

2. Add the helper function `revealUserPhotos` before the scheduled function:

```javascript
/**
 * Reveal all developing photos for a user and schedule next reveal
 * @param {string} userId - User ID
 * @param {Timestamp} now - Current timestamp
 * @returns {Promise<object>} - Result of reveal operation
 */
async function revealUserPhotos(userId, now) {
  console.log(`revealUserPhotos: Processing user ${userId}`);

  // Query developing photos for this user
  const photosSnapshot = await admin.firestore()
    .collection('photos')
    .where('userId', '==', userId)
    .where('status', '==', 'developing')
    .get();

  if (photosSnapshot.empty) {
    console.log(`revealUserPhotos: No developing photos for user ${userId}`);
  } else {
    console.log(`revealUserPhotos: Revealing ${photosSnapshot.size} photos for user ${userId}`);

    // Update all photos to revealed
    const batch = admin.firestore().batch();
    photosSnapshot.docs.forEach((doc) => {
      batch.update(doc.ref, {
        status: 'revealed',
        revealedAt: admin.firestore.FieldValue.serverTimestamp(),
      });
    });
    await batch.commit();
  }

  // Calculate next reveal time (0-15 minutes from now)
  const randomMinutes = Math.floor(Math.random() * 16); // 0-15 minutes
  const nextRevealMs = now.toMillis() + (randomMinutes * 60 * 1000);
  const nextRevealAt = admin.firestore.Timestamp.fromMillis(nextRevealMs);

  // Update darkroom with new reveal time
  // This update triggers sendPhotoRevealNotification via onUpdate
  await admin.firestore().collection('darkrooms').doc(userId).update({
    nextRevealAt: nextRevealAt,
    lastRevealedAt: admin.firestore.FieldValue.serverTimestamp(),
  });

  console.log(`revealUserPhotos: User ${userId} - ${photosSnapshot.size} photos revealed, next reveal at ${nextRevealAt.toDate()}`);

  return {
    userId,
    success: true,
    photosRevealed: photosSnapshot.size,
    nextRevealAt: nextRevealAt.toDate(),
  };
}
```

3. Place the helper function after sendPushNotification and before the existing Cloud Functions.

IMPORTANT: The darkroom update at the end triggers the existing `sendPhotoRevealNotification` function, so users will receive the push notification automatically.
  </action>
  <verify>
cd functions && npm run lint (if lint script exists, otherwise skip)
Review functions/index.js to confirm:
- revealUserPhotos helper function exists
- processDarkroomReveals scheduled function exists
- Schedule is 'every 2 minutes'
- Function queries darkrooms where nextRevealAt <= now
- Function updates photos to 'revealed' status
- Function updates darkroom with new nextRevealAt
  </verify>
  <done>
- processDarkroomReveals scheduled Cloud Function created
- Runs every 2 minutes
- Queries all darkrooms with overdue nextRevealAt
- Reveals photos server-side
- Schedules next reveal
- Existing notification function will trigger on darkroom update
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy updated Cloud Functions</name>
  <files>functions/index.js</files>
  <action>
Deploy the updated Cloud Functions to Firebase.

1. Navigate to functions directory:
   cd functions

2. Install any missing dependencies (if needed):
   npm install

3. Deploy all functions:
   firebase deploy --only functions

4. Verify deployment in Firebase Console:
   - Check that processDarkroomReveals appears in Functions list
   - Check that it shows scheduled trigger 'every 2 minutes'

NOTES:
- The scheduled function requires the Blaze (pay-as-you-go) plan for Firebase
- If not on Blaze plan, deployment will fail with an error about scheduled functions
- User should upgrade to Blaze if needed (Firebase Console > Project Settings > Usage and billing)

AUTHENTICATION GATE: If firebase CLI is not authenticated, the user will need to run `firebase login` first.
  </action>
  <verify>
After deployment completes:
1. Check Firebase Console > Functions to see processDarkroomReveals listed
2. Check function logs (Firebase Console > Functions > processDarkroomReveals > Logs)
3. Wait 2-3 minutes to see first scheduled execution in logs
  </verify>
  <done>
- Cloud Functions deployed successfully
- processDarkroomReveals visible in Firebase Console
- Scheduled trigger configured for every 2 minutes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Server-side darkroom reveal system - photos now reveal automatically every 2 minutes via Cloud Function, even when app is closed</what-built>
  <how-to-verify>
1. Capture a photo in the app (it goes to darkroom as 'developing')
2. COMPLETELY CLOSE the app (not just background - force close)
3. Wait 2-15 minutes (depending on when nextRevealAt was scheduled)
4. You should receive a push notification "Photos Ready!" even though app is closed
5. Open app and check DarkroomScreen - photo should already be revealed
6. Check Firebase Console > Functions > processDarkroomReveals > Logs to see execution
  </how-to-verify>
  <resume-signal>Type "approved" if notifications arrive with app closed, or describe what went wrong</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] processDarkroomReveals function deployed to Firebase
- [ ] Function runs on 2-minute schedule
- [ ] Function correctly queries overdue darkrooms
- [ ] Function reveals photos server-side
- [ ] Function triggers existing notification via darkroom update
- [ ] User tested with app closed and received notification at reveal time
</verification>

<success_criteria>
- All UAT issues from 13.2-01-ISSUES.md addressed
- Photos reveal at scheduled time regardless of app state
- Push notification fires at actual reveal time
- Tests pass (verified by user acceptance testing)
- Ready for re-verification
</success_criteria>

<output>
After completion, create `.planning/phases/13.2-darkroom-auto-reveal-fix/13.2-01-FIX-SUMMARY.md`
</output>
