---
phase: 04-snap-streaks
plan: 04
type: execute
wave: 3
depends_on:
  - 04-02
  - 04-03
files_modified:
  - src/components/ConversationRow.js
  - src/components/ConversationHeader.js
  - src/components/DMInput.js
  - src/hooks/useMessages.js
  - src/screens/ConversationScreen.js
  - src/screens/MessagesScreen.js
autonomous: false
requirements:
  - STRK-03
  - STRK-04

must_haves:
  truths:
    - 'ConversationRow shows StreakIndicator with correct state instead of plain snap icon'
    - "ConversationHeader shows StreakIndicator matching the conversation's streak state"
    - 'DMInput snap button shows StreakIndicator with correct state instead of plain snap icon'
    - 'All three locations show identical icon treatment for the same conversation'
    - "Warning state displays red icon with '!' in all three locations"
    - 'Messages list uses single Firestore listener for all streak data (no N+1)'
  artifacts:
    - path: 'src/components/ConversationRow.js'
      provides: 'StreakIndicator replacing PixelIcon snap-polaroid'
      contains: 'StreakIndicator'
    - path: 'src/components/ConversationHeader.js'
      provides: 'StreakIndicator in conversation header'
      contains: 'StreakIndicator'
    - path: 'src/components/DMInput.js'
      provides: 'StreakIndicator replacing PixelIcon snap-polaroid in camera button'
      contains: 'StreakIndicator'
    - path: 'src/hooks/useMessages.js'
      provides: 'useStreakMap integration for batch streak data'
      contains: 'useStreakMap'
  key_links:
    - from: 'src/hooks/useMessages.js'
      to: 'src/hooks/useStreaks.js'
      via: 'useStreakMap provides streakMap to ConversationRow'
      pattern: 'useStreakMap'
    - from: 'src/components/ConversationRow.js'
      to: 'src/components/StreakIndicator.js'
      via: 'StreakIndicator replaces PixelIcon'
      pattern: 'StreakIndicator'
    - from: 'src/components/DMInput.js'
      to: 'src/components/StreakIndicator.js'
      via: 'StreakIndicator replaces PixelIcon in camera button'
      pattern: 'StreakIndicator'
    - from: 'src/screens/ConversationScreen.js'
      to: 'src/hooks/useStreaks.js'
      via: 'useStreak provides streak data for header and DMInput'
      pattern: 'useStreak'
---

<objective>
Wire StreakIndicator into all three UI locations (ConversationRow, ConversationHeader, DMInput) and integrate useStreakMap into useMessages for efficient batch streak data. This is the final integration that makes streaks visible to users.

Purpose: Connects the client-side streak building blocks (service, component, hooks) to the live UI. After this plan, users will see streak states on snap icons across the entire messaging experience: conversation list, conversation header, and message input.

Output: Updated ConversationRow, ConversationHeader, DMInput, useMessages, ConversationScreen, MessagesScreen with streak awareness.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-snap-streaks/04-CONTEXT.md
@.planning/phases/04-snap-streaks/04-RESEARCH.md
@.planning/phases/04-snap-streaks/04-02-SUMMARY.md
@.planning/phases/04-snap-streaks/04-03-SUMMARY.md
@src/components/ConversationRow.js
@src/components/ConversationHeader.js
@src/components/DMInput.js
@src/hooks/useMessages.js
@src/screens/ConversationScreen.js
@src/screens/MessagesScreen.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate useStreakMap into useMessages and wire StreakIndicator into ConversationRow, ConversationHeader, and DMInput</name>
  <files>src/hooks/useMessages.js, src/components/ConversationRow.js, src/components/ConversationHeader.js, src/components/DMInput.js, src/screens/ConversationScreen.js, src/screens/MessagesScreen.js</files>
  <action>
**1. Integrate useStreakMap into useMessages hook:**

In `src/hooks/useMessages.js`:

- Import `useStreakMap` from `'../hooks/useStreaks'`
- Import `generateStreakId` from `'../services/firebase/streakService'`
- Call `const { streakMap } = useStreakMap(userId)` inside the hook
- Add `streakMap` to the hook's return value
- Each conversation item returned from useMessages should be enriched with streak data. In the conversation mapping logic (where friendProfile is attached), also attach streak data:

```javascript
const streakId = friendId ? generateStreakId(userId, friendId) : null;
const streakInfo = streakId ? streakMap[streakId] : null;

return {
  ...conversation,
  friendProfile: friendProfile || { ... },
  streakState: streakInfo?.streakState || 'default',
  streakDayCount: streakInfo?.dayCount || 0,
  streakColor: streakInfo?.streakColor || null,
};
```

This means ConversationRow receives streak data as part of its conversation prop, no additional hooks needed in each row.

**2. Update ConversationRow to use StreakIndicator:**

In `src/components/ConversationRow.js`:

- Import `StreakIndicator` from `'./StreakIndicator'`
- Remove the direct `<PixelIcon name="snap-polaroid" size={18} color={SNAP_AMBER} />` in the snap camera button
- Replace with `<StreakIndicator streakState={conversation.streakState} dayCount={conversation.streakDayCount} size={18} />`
- The `conversation` object now includes `streakState` and `streakDayCount` from useMessages enrichment
- Keep the existing `onSnapCamera` press handler unchanged
- Keep the existing TouchableOpacity wrapper and hitSlop unchanged
- If `conversation.streakState` is not present (shouldn't happen after enrichment, but defensive), default to `'default'`

**3. Add StreakIndicator to ConversationHeader:**

In `src/components/ConversationHeader.js`:

- Import `StreakIndicator` from `'./StreakIndicator'`
- Accept new props: `streakState` and `streakDayCount` (passed from ConversationScreen)
- Add the StreakIndicator next to the user's display name or in the header right area. Place it to the right of the display name text, in a row layout. Use the same `size={18}` as ConversationRow for consistency.
- **Always render StreakIndicator regardless of streak state** (including default/muted gray). Per locked decision: "Identical icon treatment across all 3 locations." ConversationRow and DMInput both show the icon at default state, so ConversationHeader must too. The default muted gray icon is unobtrusive enough that it does not clutter the header.

**4. Update DMInput snap button to use StreakIndicator:**

In `src/components/DMInput.js`:

- Import `StreakIndicator` from `'./StreakIndicator'`
- Accept new props: `streakState` and `streakDayCount` (passed from ConversationScreen)
- Replace `<PixelIcon name="snap-polaroid" size={22} color={colors.status.developing} />` in the camera button with `<StreakIndicator streakState={streakState} dayCount={streakDayCount} size={22} />`
- The camera button is inside an `Animated.View` for the morph animation — keep that wrapper unchanged. Only swap the inner PixelIcon for StreakIndicator.
- Default props: `streakState = 'default'`, `streakDayCount = 0` for backward compatibility.

**5. Wire streak data from ConversationScreen to ConversationHeader and DMInput:**

In `src/screens/ConversationScreen.js`:

- Import `useStreak` from `'../hooks/useStreaks'`
- Get `currentUserId` from `useAuth()` (already available in ConversationScreen)
- Get `friendId` from the conversation data (already extracted in ConversationScreen)
- Call `const { streakState, dayCount: streakDayCount, streakColor } = useStreak(currentUserId, friendId)`
- Pass `streakState` and `streakDayCount` to `<ConversationHeader>` and `<DMInput>` as props

**6. Wire streak data from MessagesScreen to ConversationRow:**

In `src/screens/MessagesScreen.js`:

- The useMessages hook now returns `streakMap` but more importantly, conversation objects are enriched with `streakState` and `streakDayCount`. No changes needed in MessagesScreen — the data flows through conversation objects to ConversationRow automatically.
- Verify MessagesScreen passes the full conversation object to ConversationRow (it already does).

**Key constraints from user decisions:**

- State transitions are INSTANT (no animation between states)
- Identical icon treatment across all 3 locations (same StreakIndicator component)
- Display-only (not tappable for details) — no tooltip or popover
- Day count is embedded inside the icon (handled by StreakIndicator)
- Last message preview text in ConversationRow is UNCHANGED by streak status
  </action>
  <verify>
  <automated>cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern="(useMessages|DMInput|ConversationRow)" --forceExit 2>&1 | tail -20</automated>
  <manual>Open the app, navigate to Messages tab. Verify snap icons in conversation rows. Open a conversation, verify header and input bar snap button. If a streak exists, verify color changes. If no streak, verify default muted gray icon.</manual>
  </verify>
  <done>useMessages hook returns enriched conversations with streakState and streakDayCount via useStreakMap. ConversationRow renders StreakIndicator instead of plain PixelIcon for snap camera button. ConversationHeader always renders StreakIndicator (including default state) for identical treatment across all 3 locations. DMInput camera button uses StreakIndicator. All three locations show identical streak state for the same conversation.</done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of streak UI across all locations</name>
  <action>
Verify streak UI integration across all three locations:
1. ConversationRow snap camera icon now shows streak-aware colors (muted gray default, warm tint building, amber/orange/deep orange active with day count, red warning with "!")
2. ConversationHeader shows streak indicator next to display name for non-default streaks
3. DMInput snap button reflects streak state matching the conversation
4. Messages list uses single Firestore listener for all streak data (efficient)
5. NotificationSettingsScreen has "Streak Warnings" toggle
  </action>
  <verify>
1. Open the app on device/simulator
2. Navigate to Messages tab — verify snap camera icons in conversation list
3. If no streaks exist yet: all icons should be muted gray (default state)
4. Open a conversation — verify ConversationHeader and DMInput snap button match the conversation list icon
5. Go to Settings > Notifications — verify "Streak Warnings" toggle is present and toggleable
6. If you can test with two accounts exchanging snaps: send snaps between them and verify icon changes from gray to warm tint (building)
7. Verify no visual regressions in existing conversation UI (message bubbles, input bar layout, etc.)
  </verify>
  <done>User confirms streak icons render correctly across all three locations (ConversationRow, ConversationHeader, DMInput) with correct state-based coloring and day count display. No visual regressions in existing UI.</done>
</task>

</tasks>

<verification>
- Existing tests pass: `npx jest --forceExit` (full suite green)
- ConversationRow renders StreakIndicator component
- ConversationHeader always renders StreakIndicator (identical treatment to ConversationRow and DMInput)
- DMInput camera button uses StreakIndicator
- useMessages hook returns conversations enriched with streakState and streakDayCount
- NotificationSettingsScreen includes streakWarnings toggle
- Visual checkpoint confirms correct rendering on device
</verification>

<success_criteria>

- Streak icons visible in all 3 locations with correct state-based rendering
- Single Firestore listener per user for all streak data (no N+1)
- Warning state (red + "!") displays correctly when streak is about to expire
- Active state (color + day count) displays correctly for streaks >= 3 days
- No visual regressions in existing messaging UI
- User can toggle streak warning notifications on/off
  </success_criteria>

<output>
After completion, create `.planning/phases/04-snap-streaks/04-04-SUMMARY.md`
</output>
