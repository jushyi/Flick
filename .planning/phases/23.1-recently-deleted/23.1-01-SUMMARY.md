# Plan 23.1-01: Soft Delete Infrastructure - Summary

**Status:** Complete
**Completed:** 2026-02-05

## Objective

Implement soft delete infrastructure for photos with 30-day grace period and scheduled cleanup.

## Tasks Completed

### Task 1: Add soft delete methods to photoService

**Commit:** `7bc1adc` - `feat(23.1-01): add soft delete methods to photoService`

Modified and added methods for soft delete infrastructure:

1. **Modified `triagePhoto` delete action** - Instead of immediately deleting:
   - Sets `photoState: 'deleted'`
   - Sets `status: 'triaged'`
   - Sets `scheduledForPermanentDeletionAt` (30 days from now)
   - Sets `deletionScheduledAt` (serverTimestamp)

2. **Added `softDeletePhoto(photoId, userId)`** - For PhotoDetailScreen/Album menu context:
   - Verifies ownership
   - Sets same soft delete fields as triagePhoto
   - Returns `{ success: true/false, error }`

3. **Added `restoreDeletedPhoto(photoId, userId)`** - For recovering deleted photos:
   - Verifies ownership
   - Verifies `photoState === 'deleted'`
   - Updates `photoState: 'journal'`
   - Clears deletion fields with `FieldValue.delete()`
   - Resets `triagedAt` to restart visibility window

4. **Added `getDeletedPhotos(userId)`** - For Recently Deleted screen:
   - Queries photos where `userId` matches AND `photoState === 'deleted'`
   - Orders by `deletionScheduledAt desc`
   - Returns array of photo objects

5. **Added `permanentlyDeletePhoto(photoId, userId)`** - For bypassing grace period:
   - Verifies ownership
   - Uses internal `cascadeDeletePhoto` for full cleanup
   - Can delete photos in ANY photoState

6. **Refactored `deletePhotoCompletely`** into `cascadeDeletePhoto`:
   - Internal cascade function
   - Called by `permanentlyDeletePhoto` and Cloud Function
   - Handles: albums, comments/likes, storage, document deletion

### Task 2: Add scheduled photo deletion Cloud Function

**Commit:** `8686cee` - `feat(23.1-01): add scheduled photo deletion Cloud Function`

1. **Added `processScheduledPhotoDeletions` Cloud Function**:
   - Schedule: `15 3 * * *` (3:15 AM UTC daily)
   - Offset from account deletion (3 AM) to avoid resource contention
   - Queries photos where `photoState === 'deleted'` AND `scheduledForPermanentDeletionAt <= now`
   - Cascade deletes each photo: albums, comments/likes, storage, document
   - Comprehensive logging for monitoring

2. **Added composite index** to `firestore.indexes.json`:
   - Collection: `photos`
   - Fields: `photoState` (ASC), `scheduledForPermanentDeletionAt` (ASC)
   - Required for the Cloud Function query

## Files Modified

- `src/services/firebase/photoService.js` - Added soft delete methods and refactored cascade delete
- `functions/index.js` - Added processScheduledPhotoDeletions Cloud Function
- `firestore.indexes.json` - Added composite index for photo deletion query

## Verification

- [x] npm run lint passes (only pre-existing warnings)
- [x] triagePhoto 'delete' action sets soft delete fields, not immediate delete
- [x] All new photoService exports: softDeletePhoto, restoreDeletedPhoto, getDeletedPhotos, permanentlyDeletePhoto
- [x] Cloud Function processScheduledPhotoDeletions exists in functions/index.js
- [x] Composite index added to firestore.indexes.json

## Deviations

None. Plan executed as specified.

## Notes

- Added `FieldValue` import to photoService for clearing fields during restore
- The `deletePhotoCompletely` function is now deprecated in favor of `permanentlyDeletePhoto` (which calls internal `cascadeDeletePhoto`)
- Cloud Function uses same cascade delete pattern as client-side for consistency
- Index needs to be deployed to Firebase before the Cloud Function can be tested

---

_Phase: 23.1-recently-deleted_
_Completed: 2026-02-05_
