---
phase: 01-message-infrastructure-read-receipts
plan: 02
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/components/ReadReceiptIndicator.js
  - src/components/index.js
  - src/screens/ConversationScreen.js
  - src/components/ConversationRow.js
  - src/screens/SettingsScreen.js
  - src/context/AuthContext.js
autonomous: true
requirements:
  - READ-01
  - READ-03

must_haves:
  truths:
    - "Sender sees 'Delivered' below their last sent message when recipient has not opened the conversation"
    - "Sender sees 'Read [time]' below their last sent message when recipient has opened the conversation"
    - 'Read indicator updates in real-time without page refresh (recipient opens conversation -> sender sees Read appear)'
    - "Conversation list shows 'Sent' for own unread text messages, 'Seen' for own read text messages"
    - 'Conversation list shows unread count badge (cyan circle with white number) instead of plain dot'
    - 'Privacy toggle in Settings hides read status for both parties when either user has receipts off'
    - 'Delivered fades in after message bubble lands; Delivered->Read transition uses subtle crossfade'
  artifacts:
    - path: 'src/components/ReadReceiptIndicator.js'
      provides: 'Delivered / Read [time] text component with fade animations'
      contains: 'ReadReceiptIndicator'
    - path: 'src/screens/ConversationScreen.js'
      provides: "ReadReceiptIndicator rendered below sender's last message"
      contains: 'ReadReceiptIndicator'
    - path: 'src/components/ConversationRow.js'
      provides: 'Status preview text (Sent/Seen) + unread count badge'
      contains: 'UnreadBadge'
    - path: 'src/screens/SettingsScreen.js'
      provides: 'Read Receipts privacy toggle'
      contains: 'readReceiptsEnabled'
  key_links:
    - from: 'src/screens/ConversationScreen.js'
      to: 'src/hooks/useConversation.js'
      via: 'Reads conversationDoc.readReceipts from hook return value'
      pattern: 'conversationDoc.*readReceipts'
    - from: 'src/components/ConversationRow.js'
      to: 'conversation.readReceipts'
      via: 'Derives Sent/Seen status from readReceipts timestamp comparison'
      pattern: 'readReceipts.*toMillis'
    - from: 'src/screens/ConversationScreen.js'
      to: 'src/components/ReadReceiptIndicator.js'
      via: 'Passes isRead, readAt, visible props'
      pattern: 'ReadReceiptIndicator'
    - from: 'src/screens/SettingsScreen.js'
      to: 'Firestore users collection'
      via: 'Writes readReceiptsEnabled field to user profile'
      pattern: 'readReceiptsEnabled'
---

<objective>
Build the read receipt UI: create the ReadReceiptIndicator component with fade animations, integrate it into ConversationScreen below the sender's last message, update ConversationRow with status preview text (Sent/Seen) and unread count badge, and add the read receipts privacy toggle to Settings. This delivers the user-visible read receipt experience.

Purpose: This plan delivers the user-facing features. Sender sees "Delivered" then "Read [time]" below their last message. Conversation list shows contextual status words. Privacy toggle gives users control. These are the touchpoints users interact with.

Output: ReadReceiptIndicator component, updated ConversationScreen, updated ConversationRow, updated SettingsScreen with privacy toggle.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-message-infrastructure-read-receipts/01-CONTEXT.md
@.planning/phases/01-message-infrastructure-read-receipts/01-RESEARCH.md
@.planning/phases/01-message-infrastructure-read-receipts/01-01-SUMMARY.md
@src/screens/ConversationScreen.js
@src/components/ConversationRow.js
@src/components/MessageBubble.js
@src/screens/SettingsScreen.js
@src/components/index.js
@src/context/AuthContext.js
@src/constants/colors.js
@src/constants/typography.js
@src/constants/spacing.js
@src/constants/animations.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReadReceiptIndicator component and integrate into ConversationScreen</name>
  <files>
    src/components/ReadReceiptIndicator.js
    src/components/index.js
    src/screens/ConversationScreen.js
  </files>
  <action>
**ReadReceiptIndicator component (READ-01):**

1. Create `src/components/ReadReceiptIndicator.js`. This component renders "Delivered" or "Read [time]" below the sender's last sent message.
2. Props: `isRead` (boolean), `readAt` (Firestore Timestamp or null), `visible` (boolean - controls entrance animation).
3. Display logic:
   - When `isRead === true` and `readAt` exists: show `"Read {format(readAt.toDate(), 'h:mm a')}"` using `date-fns` `format` function.
   - When `isRead === false`: show `"Delivered"`.
   - When `visible === false`: render nothing (or keep opacity at 0).
4. Styling per CONTEXT.md decisions:
   - Color: `#7B7B9E` (muted secondary color). Use `colors.text.secondary` if it matches, otherwise hardcode this exact value.
   - Font: Readable sans-serif body font (NOT pixel/retro font). Use the project's `typography.fontFamily.readable` or `SpaceMono_400Regular`.
   - Font size: ~10px (match existing timestamp styling in MessageBubble).
   - Alignment: `alignItems: 'flex-end'` (right-aligned, matching sent message alignment).
   - Spacing: `paddingHorizontal: 16`, `marginTop: 2`, `marginBottom: 4`.
5. Animations per CONTEXT.md decisions:
   - "Delivered" fades in when `visible` becomes true: `Animated.timing` with `duration: 250` (animations.duration.slow), `useNativeDriver: true`.
   - Crossfade when `isRead` changes from false to true: sequence of fade out (100ms) then fade in (150ms). Use `Animated.sequence` with two `Animated.timing` calls.
   - Use `useRef(new Animated.Value(0))` for opacity.
6. Use React Native core `Animated` API (NOT reanimated -- per research, RN core is sufficient for simple fades).
7. Import `format` from `date-fns`.

**Barrel export:**

8. Add `ReadReceiptIndicator` to `src/components/index.js` barrel export.

**ConversationScreen integration (READ-01 + READ-03):**

9. Open `src/screens/ConversationScreen.js`.
10. The hook `useConversation` now returns `conversationDoc` (from Plan 01). Destructure it from the hook return.
11. Derive read state:
    - Get the friend's userId (the other participant in the conversation).
    - `const friendReadAt = conversationDoc?.readReceipts?.[friendId]`
    - Find the current user's last sent message in the messages array: `const lastSentMessage = messages.find(m => m.senderId === currentUserId)`
    - Determine if read: `const isRead = friendReadAt && lastSentMessage?.createdAt && friendReadAt.toMillis() >= lastSentMessage.createdAt.toMillis()`
12. **Privacy check:** Both users must have `readReceiptsEnabled !== false` for read status to show.
    - Current user's setting: `currentUserProfile?.readReceiptsEnabled !== false` (default ON).
    - Friend's setting: Get from friend profile data (passed via route params or available from useMessages hook). Check: `friendProfile?.readReceiptsEnabled !== false`.
    - `const showReadStatus = senderEnabled && recipientEnabled`.
    - When `showReadStatus` is false, the indicator should show "Delivered" permanently (never "Read").
13. Render `<ReadReceiptIndicator>` below the last sent message in the message list.
    - The indicator appears ONLY below the current user's most recent sent message (not every message).
    - Position it after the last sent message bubble in the FlatList renderItem or as a separate element.
    - `visible` prop: true once the message is confirmed sent (appears in messages list).
    - `isRead` prop: `showReadStatus && isRead`.
    - `readAt` prop: `friendReadAt`.
14. Handle the case where the user hasn't sent any messages yet: don't render the indicator.
    </action>
    <verify>
    <automated>npm run lint -- --max-warnings 0 src/components/ReadReceiptIndicator.js src/screens/ConversationScreen.js 2>&1 | tail -5</automated>
    <manual>Visually verify in the app: send a message, see "Delivered" fade in. Have friend open conversation, see "Delivered" transition to "Read [time]" with crossfade animation.</manual>
    </verify>
    <done> - ReadReceiptIndicator component renders "Delivered" or "Read [time]" with correct styling (#7B7B9E, ~10px, sans-serif, right-aligned) - Fade-in animation on "Delivered" appearance (250ms) - Crossfade animation on Delivered -> Read transition (100ms out + 150ms in) - ConversationScreen derives read state from conversationDoc.readReceipts - Indicator appears only below sender's most recent sent message - Privacy check: both users must have readReceiptsEnabled for "Read" to show - Exported from components/index.js barrel
    </done>
    </task>

<task type="auto">
  <name>Task 2: Update ConversationRow with status preview text and unread count badge</name>
  <files>
    src/components/ConversationRow.js
  </files>
  <action>
**Status preview text (READ-01 conversation list view):**

1. Open `src/components/ConversationRow.js`.
2. Find where the last message preview text is rendered (the subtitle/secondary text below the friend's name).
3. Replace the current logic with a new `getPreviewText()` function that implements the Snapchat-style status words per CONTEXT.md:
   - **When current user sent the last message** (`lastMessage.senderId === currentUserId`):
     - Determine if friend has read it: compare `conversation.readReceipts?.[friendId]` timestamp against `lastMessage.timestamp`. If `readReceipts[friendId].toMillis() >= lastMessage.timestamp.toMillis()`, it's read.
     - Text messages (`type === 'text'` or missing type): "Seen" if read, "Sent" if unread.
     - GIF messages (`type === 'gif'`): "Seen" if read, "Sent" if unread.
     - Future types (snap, reaction, reply, tagged_photo): add placeholders now for forward compatibility:
       - `type === 'snap'`: "Opened" if read, "Delivered" if unread.
       - `type === 'reaction'`: "Seen" if read, "Sent" if unread.
       - `type === 'tagged_photo'`: "Seen" if read, "Sent" if unread.
       - Default fallback: "Sent".
     - **Privacy:** If either user has `readReceiptsEnabled === false`, always show "Sent" (never "Seen"). Use: `const showReadStatus = currentUserProfile?.readReceiptsEnabled !== false && friendProfile?.readReceiptsEnabled !== false`.
   - **When friend sent the last message** (`lastMessage.senderId !== currentUserId`):
     - `type === 'text'` or missing: show `lastMessage.text` (existing behavior).
     - `type === 'gif'`: show "Sent a GIF" (existing behavior, keep it).
     - `type === 'snap'`: show "Sent you a snap" (placeholder for Phase 3).
     - `type === 'reaction'`: show `"Reacted ${lastMessage.emoji} to your message"` (placeholder for Phase 2).
     - `type === 'tagged_photo'`: show "Tagged you in a photo" (placeholder for Phase 5).
     - Default: show `lastMessage.text || 'No messages yet'`.
4. Handle the `lastMessage?.type` field gracefully: default to `'text'` when missing (`const msgType = lastMessage?.type || 'text'`).
5. The `readReceipts` data comes from the conversation object already passed to ConversationRow. The conversation data from `useMessages` includes the full conversation document.
6. The friend profile data (for privacy check) should be available from the cached friend profiles in `useMessages`. If not directly available in ConversationRow props, check what data is passed and use `readReceiptsEnabled` from the friend data prop.
7. Conversation list status transitions should be instant (no animation per CONTEXT.md).

**Unread count badge (READ-01 conversation list view):**

8. Find the existing unread indicator in ConversationRow. Per research, there's a simple 8x8 cyan dot (`unreadDot` style).
9. Replace the simple dot with an `UnreadBadge` sub-component:
   - Shows when `unreadCount > 0` (where `unreadCount` comes from `conversation.unreadCount?.[currentUserId]` or is passed as a prop).
   - Displays the count number: "1", "2", "3", etc.
   - Cap at "99+" for counts above 99.
   - Styling per CONTEXT.md + research:
     - `minWidth: 18`, `height: 18`, `borderRadius: 9` (circle).
     - `backgroundColor: '#00D4FF'` (cyan, `colors.interactive.primary`).
     - Text: `fontSize: 10`, `color: '#0A0A1A'` (dark on cyan, `colors.text.inverse` or `colors.background.primary`), bold font.
     - `paddingHorizontal: 4` (allows pill shape for 2+ digit numbers).
     - Position: same location as current `unreadDot` (in the right column of the row).
10. Remove or replace the old `unreadDot` style/component.
    </action>
    <verify>
    <automated>npm run lint -- --max-warnings 0 src/components/ConversationRow.js 2>&1 | tail -5</automated>
    <manual>In the Messages tab: verify "Sent"/"Seen" status for own messages, actual text for friend's messages. Verify cyan count badge shows number instead of plain dot. Check "99+" cap.</manual>
    </verify>
    <done> - ConversationRow shows "Sent"/"Seen" for own text/gif messages based on readReceipts - ConversationRow shows actual text for friend's text messages, "Sent a GIF" for friend's gifs - Forward-compatible preview text for snap, reaction, tagged_photo types - Privacy: "Sent" shown permanently when either user has receipts off - Unread count badge replaces plain dot: cyan circle, white number, "99+" cap - Type field defaults to 'text' when missing (backward compatibility)
    </done>
    </task>

<task type="auto">
  <name>Task 3: Add read receipts privacy toggle to Settings and user profile</name>
  <files>
    src/screens/SettingsScreen.js
    src/context/AuthContext.js
  </files>
  <action>
**Privacy toggle in Settings (READ-01 privacy):**

1. Open `src/screens/SettingsScreen.js`.
2. Find the "Privacy" section in the settings list (look for items like "Sync Contacts", "Blocked Users").
3. Add a new toggle item for "Read Receipts" in the Privacy section, positioned after "Sync Contacts" and before "Blocked Users" (or at a natural position in the Privacy section):
   ```
   {
     id: 'readReceipts',
     label: 'Read Receipts',
     icon: 'eye-outline',  // or appropriate icon from the icon set used in Settings
     isToggle: true,
     value: userProfile?.readReceiptsEnabled !== false,  // Default ON for existing users
     onToggle: handleReadReceiptsToggle,
     subtitle: "When off, you won't send or receive read receipts",
   }
   ```
4. Implement `handleReadReceiptsToggle`:
   - When user toggles OFF: show an Alert with explanation: "When you turn off read receipts, you also won't see when others read your messages." with "Turn Off" and "Cancel" buttons.
   - On confirm: write `readReceiptsEnabled: false` to the user's Firestore profile document.
   - When user toggles ON: write `readReceiptsEnabled: true` directly (no confirmation needed).
   - Use `updateDoc(doc(db, 'users', user.uid), { readReceiptsEnabled: newValue })`.
   - Also update the local profile state via `updateUserProfile` or `updateProfile` from AuthContext so the UI reflects the change immediately without waiting for Firestore sync.
5. Import `Alert` from 'react-native' if not already imported.
6. Import Firestore operations (`doc`, `updateDoc`, `getFirestore`) if not already imported.

**AuthContext update (if needed):**

7. Open `src/context/AuthContext.js`. Check if `updateProfile` or `updateUserProfile` already handles arbitrary profile field updates.
8. If `updateProfile` only updates specific fields (like displayName, photoURL), extend it to handle the `readReceiptsEnabled` field. Or if there's a generic `updateProfile` that writes to Firestore and updates local state, it should work as-is.
9. Ensure the local `userProfile` state in AuthContext includes `readReceiptsEnabled` when it's loaded from Firestore (it should come automatically since the profile document is loaded in full).
10. The `readReceiptsEnabled` field defaults to `undefined` for existing users (which is treated as `true` via `!== false` checks throughout the codebase). No migration needed.

**IMPORTANT:** The toggle uses the PixelToggle component (existing retro-styled toggle). Do NOT build a custom toggle. Use whatever toggle pattern the Settings screen already uses for existing toggles (like notification settings).
</action>
<verify>
<automated>npm run lint -- --max-warnings 0 src/screens/SettingsScreen.js 2>&1 | tail -5</automated>
<manual>In Settings > Privacy section: verify "Read Receipts" toggle is visible, defaults to ON. Toggle OFF, see confirmation Alert with explanation. Toggle back ON. Verify the change persists across app restarts.</manual>
</verify>
<done> - "Read Receipts" toggle appears in Privacy section of Settings - Toggle defaults to ON for existing users (readReceiptsEnabled undefined treated as true) - Toggling OFF shows Alert with explanation text - Toggle writes readReceiptsEnabled to user's Firestore profile - Local profile state updates immediately on toggle - Uses existing PixelToggle component (not custom) - Subtitle text: "When off, you won't send or receive read receipts"
</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run lint` -- no linting errors
2. `npx jest --no-coverage` -- full test suite passes
3. Visual verification in app:
   a. Send a message in conversation -- "Delivered" fades in below last sent message
   b. Recipient opens conversation -- sender sees "Read [time]" appear with crossfade
   c. Conversation list shows "Sent" for unread own messages, "Seen" for read own messages
   d. Conversation list shows cyan count badge with number instead of plain dot
   e. Settings > Privacy shows "Read Receipts" toggle, defaults to ON
   f. Toggle OFF shows confirmation Alert, hides read indicators for both parties
   g. "99+" shown for large unread counts
</verification>

<success_criteria>

- Sender sees "Delivered" then "Read [time]" below their most recent sent message (READ-01)
- Read indicator updates in real-time when recipient opens conversation (READ-03)
- Conversation list shows Sent/Seen status words for own messages
- Unread count badge (cyan circle, white number) replaces plain dot
- Privacy toggle in Settings controls read receipt visibility for both parties
- Animations: fade-in for Delivered, crossfade for Delivered->Read
- All styling matches CONTEXT.md specs (#7B7B9E, ~10px, sans-serif, right-aligned)
- Backward compatible: existing conversations without readReceipts show "Delivered"
  </success_criteria>

<output>
After completion, create `.planning/phases/01-message-infrastructure-read-receipts/01-02-SUMMARY.md`
</output>
