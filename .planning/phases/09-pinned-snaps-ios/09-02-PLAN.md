---
phase: 09-pinned-snaps-ios
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/usePinPreference.js
  - src/components/PinToggle.js
  - src/components/PinTooltip.js
  - __tests__/hooks/usePinPreference.test.js
autonomous: true
requirements:
  - PINI-01

must_haves:
  truths:
    - "Pin toggle preference persists per friend across app restarts"
    - "Pin toggle appears on the snap preview screen with pixel-art styling"
    - "First-time tooltip explains the pin feature and never shows again"
  artifacts:
    - path: "src/hooks/usePinPreference.js"
      provides: "Per-friend sticky pin preference via AsyncStorage"
      exports: ["usePinPreference"]
    - path: "src/components/PinToggle.js"
      provides: "Pixel-art pin icon with toggle switch component"
      exports: ["default"]
    - path: "src/components/PinTooltip.js"
      provides: "One-time tooltip overlay for pin feature explanation"
      exports: ["default"]
    - path: "__tests__/hooks/usePinPreference.test.js"
      provides: "Unit tests for pin preference hook"
  key_links:
    - from: "src/hooks/usePinPreference.js"
      to: "AsyncStorage"
      via: "getItem/setItem with pin_pref_ prefix"
      pattern: "AsyncStorage\\.(getItem|setItem)"
    - from: "src/components/PinToggle.js"
      to: "src/hooks/usePinPreference.js"
      via: "enabled prop and onToggle callback"
      pattern: "onToggle"
---

<objective>
Create the pin toggle UI components and per-friend sticky preference hook for the snap send screen.

Purpose: PINI-01 requires senders to toggle "pin to screen" when sending a snap. The toggle must remember its state per friend (sticky preference) and include a one-time explanatory tooltip for first-time users.

Output: A reusable `PinToggle` component, a `PinTooltip` overlay, a `usePinPreference` hook with AsyncStorage persistence, and unit tests for the hook.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pinned-snaps-ios/09-CONTEXT.md
@src/screens/SnapPreviewScreen.js
@src/constants/colors.js
@src/constants/typography.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePinPreference hook with AsyncStorage persistence and unit tests</name>
  <files>
    src/hooks/usePinPreference.js
    __tests__/hooks/usePinPreference.test.js
  </files>
  <action>
    1. Create `src/hooks/usePinPreference.js`:
       - Import `useState`, `useEffect`, `useCallback` from React
       - Import `AsyncStorage` from `@react-native-async-storage/async-storage`
       - Import `Platform` from `react-native` (pin preference is iOS-only but hook should work cross-platform gracefully)
       - Import `logger` from `../utils/logger`
       - Constants: `PIN_KEY_PREFIX = 'pin_pref_'`, `TOOLTIP_SHOWN_KEY = 'pin_tooltip_shown'`
       - Export `usePinPreference(friendId)` hook returning `{ pinEnabled, togglePin, loaded, showTooltip, dismissTooltip }`:
         - `pinEnabled` (boolean): Current toggle state, default false
         - `togglePin(value)` (function): Sets pin state and persists to AsyncStorage at key `pin_pref_{friendId}`
         - `loaded` (boolean): True once AsyncStorage read completes (prevents flicker)
         - `showTooltip` (boolean): True if user has never seen the tooltip (check `pin_tooltip_shown` key)
         - `dismissTooltip()` (function): Sets `pin_tooltip_shown` to 'true' in AsyncStorage, sets showTooltip to false
       - On mount (useEffect with [friendId]):
         - Read `pin_pref_{friendId}` from AsyncStorage. Set pinEnabled to `val === 'true'`.
         - Read `pin_tooltip_shown` from AsyncStorage. Set showTooltip to `val !== 'true'`.
         - Set loaded to true after both reads complete.
       - `togglePin` callback: Update state immediately (optimistic), then `AsyncStorage.setItem`. Log via logger.

    2. Create `__tests__/hooks/usePinPreference.test.js`:
       - Mock `@react-native-async-storage/async-storage` (standard Jest mock pattern)
       - Mock `../src/utils/logger`
       - Use `@testing-library/react-hooks` or `renderHook` from `@testing-library/react-native`
       - Test cases:
         a. Returns `pinEnabled: false` and `loaded: true` when no stored preference exists
         b. Returns `pinEnabled: true` when AsyncStorage has `'true'` for the friend
         c. `togglePin(true)` updates state and calls `AsyncStorage.setItem`
         d. `togglePin(false)` updates state and persists false
         e. Uses correct key format: `pin_pref_{friendId}`
         f. `showTooltip` is true when `pin_tooltip_shown` has no value
         g. `showTooltip` is false when `pin_tooltip_shown` is 'true'
         h. `dismissTooltip()` sets `showTooltip` to false and persists to AsyncStorage
         i. Changing `friendId` reloads the preference for the new friend

    Follow project test patterns: mock functions defined at module scope, jest.mock with delegation, require after mocks.
  </action>
  <verify>
    <automated>npx jest __tests__/hooks/usePinPreference.test.js --no-coverage -x</automated>
    <manual>Check that hook exports match expected API shape</manual>
  </verify>
  <done>usePinPreference hook reads/writes per-friend pin preference from AsyncStorage. Tooltip shown state tracked. All test cases pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create PinToggle and PinTooltip UI components</name>
  <files>
    src/components/PinToggle.js
    src/components/PinTooltip.js
  </files>
  <action>
    1. Create `src/components/PinToggle.js`:
       - Import React, `View`, `Text`, `TouchableOpacity`, `StyleSheet`, `Platform` from react-native
       - Import `PixelIcon` from `./PixelIcon`
       - Import `colors` from `../constants/colors`
       - Import `typography` from `../constants/typography`
       - Import `Haptics` from `expo-haptics`
       - Props: `enabled` (boolean), `onToggle` (function), `disabled` (boolean, optional)
       - Layout: Horizontal row with:
         - Left: PixelIcon "pin" (or closest available icon — check PixelIcon set, fallback to "location" or "bookmark"). Size 18. Color: amber when enabled, muted gray when disabled.
         - Center: "Pin to screen" text label in pixel font
         - Right: Toggle indicator — small circle that slides left/right or changes color. When enabled: amber background. When disabled: muted dark background.
       - On press: Call `onToggle(!enabled)` and trigger light haptic feedback (`Haptics.impactAsync(Haptics.ImpactFeedbackStyle.Light)`)
       - Style: Dark pill/chip shape matching the app's retro aesthetic. Height ~40px. Rounded corners.
       - **Platform guard:** Only render on iOS (`Platform.OS === 'ios'`). Return null on Android.
       - If `disabled` prop is true, reduce opacity and ignore presses.

    2. Create `src/components/PinTooltip.js`:
       - Import React, `View`, `Text`, `TouchableOpacity`, `StyleSheet`, `Animated` from react-native
       - Import `colors` from `../constants/colors`
       - Import `typography` from `../constants/typography`
       - Props: `visible` (boolean), `onDismiss` (function)
       - Layout: Absolute-positioned tooltip bubble that appears above or below the PinToggle:
         - Dark semi-transparent background overlay (just behind the tooltip, not full-screen)
         - Tooltip bubble with text: "Pin this snap to their lock screen"
         - Small "Got it" dismiss button or tap-anywhere-to-dismiss
         - Subtle pointer/arrow pointing toward the PinToggle
       - Animation: Fade in on mount when visible, fade out on dismiss using RN core Animated (not reanimated, per project convention for simple fades)
       - On dismiss: Call `onDismiss()` callback
       - Style: Dark bubble with light text, matching app's CRT/retro aesthetic. Border or subtle glow.

    IMPORTANT: Check which icons are available in PixelIcon by reviewing the component. If "pin" doesn't exist, use "bookmark" or another appropriate icon. Do not add new icons without verifying the PixelIcon set.
  </action>
  <verify>
    <automated>node -e "const fs = require('fs'); const pin = fs.existsSync('src/components/PinToggle.js'); const tip = fs.existsSync('src/components/PinTooltip.js'); console.log({pin, tip}); if (!pin || !tip) process.exit(1);"</automated>
    <manual>Review PinToggle and PinTooltip components for correct import paths, Platform guard on PinToggle, and styling consistency with app theme</manual>
  </verify>
  <done>PinToggle renders a pixel-art styled toggle with haptic feedback, returns null on Android. PinTooltip shows a one-time explanation bubble with fade animation and dismiss callback.</done>
</task>

</tasks>

<verification>
1. `npx jest __tests__/hooks/usePinPreference.test.js --no-coverage` passes all test cases
2. `PinToggle` returns null on Android (Platform guard)
3. `PinToggle` accepts `enabled`, `onToggle`, `disabled` props
4. `PinTooltip` fades in/out and calls `onDismiss` on dismiss
5. `usePinPreference` correctly uses `pin_pref_{friendId}` key pattern
6. Tooltip shown state uses separate `pin_tooltip_shown` AsyncStorage key
7. `npm run lint` passes on all new files
</verification>

<success_criteria>
- usePinPreference hook persists per-friend toggle state in AsyncStorage
- PinToggle renders pixel-art styled toggle with iOS-only Platform guard
- PinTooltip shows one-time explanatory tooltip with dismissal
- All unit tests for the hook pass
- Components follow project import organization and naming conventions
</success_criteria>

<output>
After completion, create `.planning/phases/09-pinned-snaps-ios/09-02-SUMMARY.md`
</output>
