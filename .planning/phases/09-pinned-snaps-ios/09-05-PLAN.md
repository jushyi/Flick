---
phase: 09-pinned-snaps-ios
plan: 05
type: execute
wave: 4
depends_on:
  - 09-04
files_modified: []
autonomous: false
requirements:
  - PINI-01
  - PINI-02
  - PINI-03
  - PINI-04
  - PINI-05

must_haves:
  truths:
    - "All pinned snap features work end-to-end on a physical iOS device"
    - "Pin toggle appears on snap preview screen with correct styling"
    - "Live Activity appears on recipient's lock screen with photo thumbnail and sender info"
    - "Tapping Live Activity opens the conversation"
    - "Live Activity disappears after viewing the snap"
  artifacts: []
  key_links: []
---

<objective>
Verify the complete pinned snaps feature end-to-end on a physical iOS device.

Purpose: Live Activities cannot be tested in simulators or via Jest. A physical iOS device (iOS 16.2+) is required to verify the full flow: pin toggle, Live Activity appearance, thumbnail display, tap-to-open, and view-to-dismiss.

Output: Confirmed working feature or list of issues to fix.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-pinned-snaps-ios/09-CONTEXT.md
@.planning/phases/09-pinned-snaps-ios/09-04-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Build and verify pinned snaps on physical iOS device</name>
  <files>None (verification only)</files>
  <action>
    Build a new native dev client with `eas build --platform ios --profile development` and verify the complete pinned snaps feature on a physical iOS device (iOS 16.2+). Two devices needed (sender and recipient). Test all 5 PINI requirements plus cap enforcement and Android safety.

    What was built:
    - Pin toggle on SnapPreviewScreen (between Polaroid and send button)
    - Per-friend sticky preference via AsyncStorage
    - One-time tooltip explaining the feature
    - Native Expo module bridging to ActivityKit
    - SwiftUI widget extension with dark-themed Live Activity layout
    - Thumbnail sharing via App Groups
    - Cloud Function sending pinned data in notification payload
    - Live Activity creation on notification receipt
    - Live Activity dismissal on snap view
    - 5-activity cap enforcement
    - 48-hour auto-expiry
  </action>
  <verify>
    **Test the pin toggle (PINI-01):**
    1. Open a conversation, tap the snap camera button
    2. Take a snap photo
    3. On SnapPreviewScreen, verify the pin toggle appears between the Polaroid frame and the Send button
    4. First time: verify the tooltip "Pin this snap to their lock screen" appears
    5. Tap "Got it" to dismiss the tooltip
    6. Toggle pin ON (should show amber/active state)
    7. Go back without sending, retake snap — verify pin toggle remembers ON state for this friend
    8. Switch to a different friend — verify pin toggle is OFF (per-friend preference)

    **Test Live Activity appearance (PINI-02):**
    1. From Device A, send a pinned snap to Device B
    2. On Device B, verify a Live Activity appears on the lock screen showing:
       - Small square photo thumbnail (the snap photo, compressed)
       - Sender's display name
       - Caption text (if one was entered), truncated with ellipsis if long
    3. If no caption was entered, verify only photo + sender name appear (no empty caption area)

    **Test tap-to-open (PINI-03):**
    1. With the Live Activity visible on Device B's lock screen
    2. Tap the Live Activity
    3. Verify the app opens directly to the conversation with the sender

    **Test view-to-dismiss (PINI-04):**
    1. Send another pinned snap from Device A to Device B
    2. Verify Live Activity appears on Device B
    3. Open the conversation on Device B and tap the snap to view it
    4. After viewing (and the SnapViewer closes), verify the Live Activity disappears from the lock screen

    **Test auto-expiry (PINI-05):**
    - This cannot be fully tested in real time (48 hours). Verify:
    1. In the native module code, confirm staleDate is set to 48 hours in the future
    2. Optionally: temporarily change staleDate to 2 minutes for testing, verify the Live Activity goes stale/disappears, then revert

    **Test cap enforcement:**
    1. Send 6 pinned snaps from different accounts to Device B
    2. Verify only 5 Live Activities are visible — the oldest should have been dismissed

    **Test Android safety:**
    1. On an Android device, open the snap preview screen
    2. Verify the pin toggle does NOT appear (iOS-only feature)
    3. Send a normal snap — verify no crashes
  </verify>
  <done>Human confirms all 5 PINI requirements work on a physical iOS device. No crashes on Android. Live Activity styling matches app dark/retro theme. Pin toggle state persists per friend. Type "approved" if all tests pass, or describe specific issues that need fixing.</done>
</task>

</tasks>

<verification>
All 5 PINI requirements verified on physical iOS device:
1. PINI-01: Pin toggle visible, sticky per friend, tooltip works
2. PINI-02: Live Activity shows thumbnail, sender name, caption
3. PINI-03: Tapping opens conversation
4. PINI-04: Viewing snap dismisses Live Activity
5. PINI-05: staleDate configured for 48h auto-expiry
</verification>

<success_criteria>
- Human confirms all 5 PINI requirements work on a physical iOS device
- No crashes on Android
- Live Activity styling matches app's dark/retro theme
- Pin toggle state persists per friend
</success_criteria>

<output>
After completion, create `.planning/phases/09-pinned-snaps-ios/09-05-SUMMARY.md`
</output>
