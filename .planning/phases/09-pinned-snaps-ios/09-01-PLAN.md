---
phase: 09-pinned-snaps-ios
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app.json
  - app.config.js
  - modules/live-activity-manager/index.ts
  - modules/live-activity-manager/expo-module.config.json
  - modules/live-activity-manager/src/LiveActivityManagerModule.swift
  - modules/live-activity-manager/src/PinnedSnapAttributes.swift
  - targets/FlickLiveActivity/expo-target.config.js
  - targets/FlickLiveActivity/index.swift
  - targets/FlickLiveActivity/FlickLiveActivityWidget.swift
  - targets/FlickLiveActivity/PinnedSnapAttributes.swift
  - targets/FlickLiveActivity/Info.plist
autonomous: true
requirements:
  - PINI-02
  - PINI-05

must_haves:
  truths:
    - "A local Expo native module exists that can start, end, and count Live Activities via ActivityKit"
    - "A widget extension target exists with SwiftUI layout rendering photo thumbnail, sender name, and caption"
    - "App Groups configuration enables shared file access between main app and widget extension"
    - "Live Activities auto-expire after 48 hours via staleDate configuration"
  artifacts:
    - path: "modules/live-activity-manager/index.ts"
      provides: "TypeScript exports for startActivity, endActivity, endAllActivities, getActiveCount"
    - path: "modules/live-activity-manager/src/LiveActivityManagerModule.swift"
      provides: "Swift ActivityKit bridge with start/end/count functions and App Groups file I/O"
    - path: "modules/live-activity-manager/src/PinnedSnapAttributes.swift"
      provides: "ActivityAttributes struct shared with widget extension"
    - path: "targets/FlickLiveActivity/FlickLiveActivityWidget.swift"
      provides: "SwiftUI Live Activity layout with pixel-art branding"
    - path: "targets/FlickLiveActivity/PinnedSnapAttributes.swift"
      provides: "Identical copy of ActivityAttributes for widget target"
    - path: "targets/FlickLiveActivity/expo-target.config.js"
      provides: "Widget extension target configuration for @bacons/apple-targets"
  key_links:
    - from: "modules/live-activity-manager/src/LiveActivityManagerModule.swift"
      to: "ActivityKit framework"
      via: "Activity.request() and Activity.end()"
      pattern: "Activity<PinnedSnapAttributes>"
    - from: "targets/FlickLiveActivity/FlickLiveActivityWidget.swift"
      to: "modules/live-activity-manager/src/PinnedSnapAttributes.swift"
      via: "Identical ActivityAttributes struct definition"
      pattern: "PinnedSnapAttributes"
    - from: "modules/live-activity-manager/src/LiveActivityManagerModule.swift"
      to: "App Groups shared container"
      via: "FileManager.containerURL(forSecurityApplicationGroupIdentifier:)"
      pattern: "group.com.spoodsjs.flick"
---

<objective>
Create the native iOS infrastructure for Live Activities: a local Expo native module bridging JS to ActivityKit, and a SwiftUI widget extension target rendering the branded Live Activity layout.

Purpose: This is the foundational native plumbing required before any JS integration. Live Activities require Swift/SwiftUI code that cannot be written in JS — the native module bridges the gap, and the widget extension renders on the lock screen.

Output: A working local Expo module (`live-activity-manager`) with `startActivity`, `endActivity`, `endAllActivities`, and `getActiveCount` functions, plus a `FlickLiveActivity` widget extension target with pixel-art branded SwiftUI layout.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pinned-snaps-ios/09-CONTEXT.md
@.planning/phases/09-pinned-snaps-ios/09-RESEARCH.md
@app.json
@app.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @bacons/apple-targets, create local Expo module, configure App Groups and Info.plist</name>
  <files>
    package.json
    app.json
    app.config.js
    modules/live-activity-manager/index.ts
    modules/live-activity-manager/expo-module.config.json
  </files>
  <action>
    1. Install @bacons/apple-targets:
       ```
       npm install @bacons/apple-targets
       ```

    2. Create local Expo module using the Expo CLI:
       ```
       npx create-expo-module@latest --local --name live-activity-manager
       ```
       This scaffolds `modules/live-activity-manager/` with the correct structure. After scaffolding:
       - Edit `modules/live-activity-manager/index.ts` to export: `startActivity(activityId: string, senderName: string, caption: string | null, deepLinkUrl: string, thumbnailUri: string): Promise<string | null>`, `endActivity(activityId: string): Promise<void>`, `endAllActivities(): Promise<void>`, `getActiveCount(): Promise<number>`.
       - Edit `modules/live-activity-manager/expo-module.config.json` to include the correct module name and platforms (ios only).
       - Remove any Android-specific generated files (android/ directory) since this is iOS-only.

    3. Update `app.json`:
       - Add `"NSSupportsLiveActivities": true` to `ios.infoPlist`
       - Add `@bacons/apple-targets` to the plugins array
       - Add the local module to plugins if needed

    4. Update `app.config.js`:
       - Add App Groups entitlement `"com.apple.security.application-groups": ["group.com.spoodsjs.flick"]` to `ios.entitlements`
       - Ensure the App Group ID is `group.com.spoodsjs.flick`

    IMPORTANT: Do NOT remove existing plugins or entitlements. Spread/merge with existing values.
  </action>
  <verify>
    <automated>node -e "const pkg = require('./package.json'); const hasAppleTargets = !!pkg.dependencies['@bacons/apple-targets']; const fs = require('fs'); const hasModule = fs.existsSync('modules/live-activity-manager/index.ts'); const appJson = require('./app.json'); const hasLiveActivities = appJson.expo.ios.infoPlist?.NSSupportsLiveActivities === true; console.log({hasAppleTargets, hasModule, hasLiveActivities}); if (!hasAppleTargets || !hasModule || !hasLiveActivities) process.exit(1);"</automated>
    <manual>Verify package.json has @bacons/apple-targets, modules/live-activity-manager/ exists with index.ts, app.json has NSSupportsLiveActivities</manual>
  </verify>
  <done>@bacons/apple-targets installed, local Expo module scaffolded with correct TS exports, App Groups entitlement and NSSupportsLiveActivities configured in app config</done>
</task>

<task type="auto">
  <name>Task 2: Create Swift native module (ActivityKit bridge) and SwiftUI widget extension</name>
  <files>
    modules/live-activity-manager/src/LiveActivityManagerModule.swift
    modules/live-activity-manager/src/PinnedSnapAttributes.swift
    targets/FlickLiveActivity/expo-target.config.js
    targets/FlickLiveActivity/index.swift
    targets/FlickLiveActivity/FlickLiveActivityWidget.swift
    targets/FlickLiveActivity/PinnedSnapAttributes.swift
    targets/FlickLiveActivity/Info.plist
  </files>
  <action>
    1. Create `modules/live-activity-manager/src/PinnedSnapAttributes.swift`:
       - Define `PinnedSnapAttributes: ActivityAttributes` struct with:
         - `activityId: String`
         - `senderName: String`
         - `caption: String?`
         - `deepLinkUrl: String`
       - `ContentState` can be empty (compact-only, no dynamic updates needed)
       - Add `import ActivityKit` at top

    2. Create `modules/live-activity-manager/src/LiveActivityManagerModule.swift`:
       - Import `ExpoModulesCore` and `ActivityKit`
       - Class `LiveActivityManagerModule: Module` with `definition() -> ModuleDefinition`
       - `Name("LiveActivityManager")`
       - `AsyncFunction("startActivity")` accepting (activityId, senderName, caption?, deepLinkUrl, thumbnailUri):
         - Guard `#available(iOS 16.2, *)` else return nil
         - Guard `ActivityAuthorizationInfo().areActivitiesEnabled` else return nil
         - **Cap enforcement:** Check `Activity<PinnedSnapAttributes>.activities.count`. If >= 5, end the oldest activity (sort by creation date or just pick first) before starting new one.
         - Accept `thumbnailUri` parameter — copy the file from this local URI to the App Groups shared container at `{containerURL}/{activityId}.jpg` using `FileManager`
         - Create `PinnedSnapAttributes` with the parameters
         - Set `staleDate` to 48 hours from now
         - Set `dismissalPolicy` to `.after(Date().addingTimeInterval(48 * 60 * 60))` in the ActivityContent
         - Call `Activity.request(attributes:content:pushType:nil)`
         - Return the native activity ID string
       - `AsyncFunction("endActivity")` accepting activityId:
         - Guard iOS 16.2+
         - Loop through `Activity<PinnedSnapAttributes>.activities`, find matching `activityId` in attributes, call `activity.end(nil, dismissalPolicy: .immediate)`
       - `AsyncFunction("endAllActivities")`:
         - Guard iOS 16.2+
         - End all `Activity<PinnedSnapAttributes>.activities` with `.immediate`
       - `AsyncFunction("getActiveCount")` returning Int:
         - Guard iOS 16.2+, return count of activities

    3. Create `targets/FlickLiveActivity/expo-target.config.js`:
       ```javascript
       module.exports = {
         type: 'widget',
         name: 'FlickLiveActivity',
         bundleIdentifier: '.FlickLiveActivity',
         deploymentTarget: '16.2',
         frameworks: ['SwiftUI', 'ActivityKit', 'WidgetKit'],
         entitlements: {
           'com.apple.security.application-groups': ['group.com.spoodsjs.flick'],
         },
       };
       ```

    4. Create `targets/FlickLiveActivity/PinnedSnapAttributes.swift`:
       - **CRITICAL:** This must be an IDENTICAL copy of the struct from step 1. Add a comment: `// IMPORTANT: This file must stay in sync with modules/live-activity-manager/src/PinnedSnapAttributes.swift`

    5. Create `targets/FlickLiveActivity/index.swift`:
       - Import WidgetKit, SwiftUI, ActivityKit
       - `@main struct FlickLiveActivityBundle: WidgetBundle` containing the Live Activity widget

    6. Create `targets/FlickLiveActivity/FlickLiveActivityWidget.swift`:
       - SwiftUI `Widget` conforming to `ActivityConfiguration(for: PinnedSnapAttributes.self)`
       - **Compact layout only** (lock screen presentation):
         - Left: 48x48 square photo thumbnail loaded from App Groups container (`{containerURL}/{activityId}.jpg`). Fallback to app icon if image not found. Use `RoundedRectangle(cornerRadius: 4)` clip shape.
         - Right: Sender name (bold, ~14pt) on top line, caption text (regular, ~12pt, truncated to 1 line with ellipsis) on second line. If no caption, only show sender name.
         - Background: dark color `#0A0A1A` (matches app background)
         - Text color: white/light gray
         - The widget `widgetURL` should be set to `URL(string: context.attributes.deepLinkUrl)` for tap-to-open
       - No expanded/Dynamic Island states needed (compact only per user decision)

    7. Create `targets/FlickLiveActivity/Info.plist`:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
       <plist version="1.0">
       <dict>
           <key>NSSupportsLiveActivities</key>
           <true/>
           <key>NSExtension</key>
           <dict>
               <key>NSExtensionPointIdentifier</key>
               <string>com.apple.widgetkit-extension</string>
           </dict>
       </dict>
       </plist>
       ```

    IMPORTANT: Per locked decision, the Live Activity MUST use the app's pixel font for branded styling. Attempt embedding the project's pixel font in the widget extension:
       a. Copy the font file (check `assets/fonts/` for the pixel .ttf) into `targets/FlickLiveActivity/`
       b. Add the font file to the widget target's resource bundle via `expo-target.config.js` resources array
       c. Reference the font in SwiftUI using `.font(.custom("FontName", size: 14))` — check the exact PostScript name of the font via `fc-scan` or the project's typography constants
       d. If the widget extension cannot embed the font (iOS widget extensions have a known limitation where custom fonts must be added to both the host app AND the extension target, and @bacons/apple-targets may not support font resource bundling for widget targets), document this constraint explicitly in a code comment and fall back to `.font(.system(size: 14, design: .monospaced))` which approximates pixel-art styling. Log the constraint finding so it can be revisited in a future native build iteration.
       e. Regardless of font outcome, the dark background (#0A0A1A), light text, and overall retro aesthetic MUST be implemented — these are not optional.
  </action>
  <verify>
    <automated>node -e "const fs = require('fs'); const files = ['modules/live-activity-manager/src/LiveActivityManagerModule.swift', 'modules/live-activity-manager/src/PinnedSnapAttributes.swift', 'targets/FlickLiveActivity/expo-target.config.js', 'targets/FlickLiveActivity/index.swift', 'targets/FlickLiveActivity/FlickLiveActivityWidget.swift', 'targets/FlickLiveActivity/PinnedSnapAttributes.swift', 'targets/FlickLiveActivity/Info.plist']; const missing = files.filter(f => !fs.existsSync(f)); console.log({allExist: missing.length === 0, missing}); if (missing.length > 0) process.exit(1);"</automated>
    <manual>Verify Swift files compile conceptually (actual build verification requires EAS build). Check that PinnedSnapAttributes.swift is identical in both locations.</manual>
  </verify>
  <done>Native module has startActivity/endActivity/endAllActivities/getActiveCount Swift implementations with cap enforcement and App Groups file I/O. Widget extension has SwiftUI layout with dark-themed compact view showing thumbnail, sender name, and caption. PinnedSnapAttributes is identical in both targets.</done>
</task>

</tasks>

<verification>
1. `modules/live-activity-manager/` directory exists with index.ts, expo-module.config.json, and Swift source files
2. `targets/FlickLiveActivity/` directory exists with widget configuration, SwiftUI layout, and Info.plist
3. `PinnedSnapAttributes.swift` is identical in both `modules/` and `targets/` locations
4. `app.json` has `NSSupportsLiveActivities: true` and `@bacons/apple-targets` plugin
5. `app.config.js` has App Groups entitlement
6. `package.json` has `@bacons/apple-targets` dependency
7. Native module exports match TypeScript declarations in index.ts
</verification>

<success_criteria>
- @bacons/apple-targets installed and configured as Expo plugin
- Local Expo module created with ActivityKit bridge (4 async functions)
- Widget extension target created with branded SwiftUI layout
- App Groups configured for thumbnail sharing
- NSSupportsLiveActivities enabled
- Cap enforcement (5 max) implemented in native module
- 48-hour auto-expiry configured via staleDate
</success_criteria>

<output>
After completion, create `.planning/phases/09-pinned-snaps-ios/09-01-SUMMARY.md`
</output>
