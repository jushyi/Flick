---
phase: 09-pinned-snaps-ios
plan: 03
type: execute
wave: 2
depends_on:
  - 09-01
  - 09-02
files_modified:
  - src/services/liveActivityService.js
  - src/services/firebase/snapService.js
  - src/screens/SnapPreviewScreen.js
  - __tests__/services/liveActivityService.test.js
autonomous: true
requirements:
  - PINI-01
  - PINI-02
  - PINI-03

must_haves:
  truths:
    - "JS service layer can start and end Live Activities via the native module"
    - "Snap message documents include pinned flag and pinnedActivityId when pin is toggled on"
    - "SnapPreviewScreen shows pin toggle between Polaroid and send button"
    - "Sending a pinned snap uploads a thumbnail to Firebase Storage for recipient retrieval"
    - "Deep link URL in Live Activity matches existing conversation routing pattern"
  artifacts:
    - path: "src/services/liveActivityService.js"
      provides: "JS bridge to native module with Platform guard, thumbnail handling, deep link URL construction"
      exports: ["startPinnedSnapActivity", "endPinnedSnapActivity", "endAllPinnedActivities"]
    - path: "src/services/firebase/snapService.js"
      provides: "uploadAndSendSnap with pinned flag and pinnedActivityId in message document"
    - path: "src/screens/SnapPreviewScreen.js"
      provides: "Pin toggle integrated between Polaroid frame and send button"
    - path: "__tests__/services/liveActivityService.test.js"
      provides: "Unit tests for liveActivityService covering start, end, platform guards, deep link URL"
  key_links:
    - from: "src/services/liveActivityService.js"
      to: "modules/live-activity-manager"
      via: "require() with Platform.OS guard"
      pattern: "Platform\\.OS === 'ios'"
    - from: "src/screens/SnapPreviewScreen.js"
      to: "src/hooks/usePinPreference.js"
      via: "usePinPreference(friendId) hook"
      pattern: "usePinPreference"
    - from: "src/screens/SnapPreviewScreen.js"
      to: "src/services/firebase/snapService.js"
      via: "uploadAndSendSnap with pinToScreen parameter"
      pattern: "uploadAndSendSnap"
    - from: "src/services/firebase/snapService.js"
      to: "Firebase Storage snap-thumbnails/ path"
      via: "Thumbnail upload for recipient Live Activity"
      pattern: "snap-thumbnails/"
---

<objective>
Create the JS service layer for Live Activities and wire the pin toggle into the snap send flow on SnapPreviewScreen.

Purpose: This connects the native module (Plan 01) and UI components (Plan 02) into a working send flow. When a sender enables the pin toggle and sends a snap, the snap message includes a `pinned` flag and a small thumbnail is uploaded to Firebase Storage for the recipient to use when creating the Live Activity.

Output: A working `liveActivityService.js`, modified `snapService.js` with pinned snap support, `SnapPreviewScreen.js` with integrated pin toggle, and unit tests.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-pinned-snaps-ios/09-CONTEXT.md
@.planning/phases/09-pinned-snaps-ios/09-RESEARCH.md
@.planning/phases/09-pinned-snaps-ios/09-01-SUMMARY.md
@.planning/phases/09-pinned-snaps-ios/09-02-SUMMARY.md
@src/screens/SnapPreviewScreen.js
@src/services/firebase/snapService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create liveActivityService.js and its unit tests</name>
  <files>
    src/services/liveActivityService.js
    __tests__/services/liveActivityService.test.js
  </files>
  <action>
    1. Create `src/services/liveActivityService.js`:
       - Follow project import organization (React Native core, then third-party, then internal)
       - Import `Platform` from `react-native`
       - Import `logger` from `../utils/logger`
       - Lazy-load the native module to avoid crash on Android:
         ```javascript
         let LiveActivityManager = null;
         if (Platform.OS === 'ios') {
           try {
             LiveActivityManager = require('../../modules/live-activity-manager').default;
           } catch (e) {
             logger.warn('liveActivityService: Native module not available', { error: e.message });
           }
         }
         ```
       - Export `startPinnedSnapActivity({ activityId, senderName, caption, conversationId, friendId, thumbnailUri })`:
         - Guard: `Platform.OS !== 'ios' || !LiveActivityManager` → return `{ success: false, error: 'Not supported' }`
         - Construct deep link URL: `lapse://messages/${conversationId}` (matches existing notification routing in App.js)
         - Call `LiveActivityManager.startActivity(activityId, senderName, caption || null, deepLinkUrl, thumbnailUri)`
         - Return `{ success: true, nativeActivityId }` or `{ success: false, error }` on catch
         - Log via logger
       - Export `endPinnedSnapActivity(activityId)`:
         - Guard iOS + native module
         - Call `LiveActivityManager.endActivity(activityId)`
         - Log via logger
       - Export `endAllPinnedActivities()`:
         - Guard iOS + native module
         - Call `LiveActivityManager.endAllActivities()`
         - Log via logger
       - Follow project service pattern: return `{ success, error }` objects

    2. Create `__tests__/services/liveActivityService.test.js`:
       - Mock `react-native` Platform (set to 'ios' by default, test 'android' case too)
       - Mock the native module `../../modules/live-activity-manager`
       - Mock `../src/utils/logger`
       - Test cases:
         a. `startPinnedSnapActivity` calls native module with correct params including deep link URL
         b. `startPinnedSnapActivity` constructs deep link as `lapse://messages/{conversationId}`
         c. `startPinnedSnapActivity` returns `{ success: false }` on Android
         d. `startPinnedSnapActivity` returns `{ success: false }` when native module throws
         e. `endPinnedSnapActivity` calls native endActivity with activityId
         f. `endPinnedSnapActivity` does nothing on Android (no crash)
         g. `endAllPinnedActivities` calls native endAllActivities
       - Follow project test patterns (mock functions at module scope, jest.mock with delegation)
  </action>
  <verify>
    <automated>npx jest __tests__/services/liveActivityService.test.js --no-coverage -x</automated>
    <manual>Verify deep link URL pattern matches existing App.js navigateToNotification routing</manual>
  </verify>
  <done>liveActivityService.js bridges to native module with Platform guards. Deep link URL uses lapse://messages/{conversationId}. Unit tests pass for all start/end/guard scenarios.</done>
</task>

<task type="auto">
  <name>Task 2: Modify snapService for pinned flag and integrate pin toggle into SnapPreviewScreen</name>
  <files>
    src/services/firebase/snapService.js
    src/screens/SnapPreviewScreen.js
  </files>
  <action>
    1. Modify `src/services/firebase/snapService.js` — `uploadAndSendSnap`:
       - Add new parameter: `options = {}` as 5th argument (after caption). Options object: `{ pinToScreen: false }`
       - When `options.pinToScreen` is true:
         a. Generate a `pinnedActivityId` (use the same `snapId` already generated)
         b. Create a tiny thumbnail (100x100, compress 0.5) using `ImageManipulator.manipulateAsync` from the compressed snap URI
         c. Upload the thumbnail to `snap-thumbnails/{snapId}.jpg` in Firebase Storage (separate from the main snap photo)
         d. Get the download URL of the thumbnail using `storageRef.getDownloadURL()`
         e. Add these fields to `messageData`:
            - `pinned: true`
            - `pinnedActivityId: snapId` (same as snap ID for simplicity)
            - `pinnedThumbnailUrl: thumbnailDownloadUrl` (for recipient to download for App Groups)
       - When `options.pinToScreen` is false or undefined:
         - Add `pinned: false` to messageData (explicit false for Firestore queries)
         - Do NOT upload a thumbnail or add pinnedActivityId/pinnedThumbnailUrl
       - Return the `pinnedActivityId` in the success result if pinned: `{ success: true, messageId, pinnedActivityId }`

    2. Modify `src/screens/SnapPreviewScreen.js`:
       - Add imports:
         - `import PinToggle from '../components/PinToggle';`
         - `import PinTooltip from '../components/PinTooltip';`
         - `import { usePinPreference } from '../hooks/usePinPreference';`
       - Inside the component, after existing state hooks:
         - `const { pinEnabled, togglePin, loaded: pinLoaded, showTooltip, dismissTooltip } = usePinPreference(friendId);`
       - Modify `handleSend`:
         - Pass `{ pinToScreen: pinEnabled }` as options to `uploadAndSendSnap`:
           ```javascript
           const result = await uploadAndSendSnap(conversationId, user.uid, photoUri, caption || null, { pinToScreen: pinEnabled });
           ```
       - In JSX, between the Polaroid frame `</Animated.View>` and the footer `<View style={screenStyles.footer}`:
         - Add the PinToggle component (only when `pinLoaded` is true):
           ```jsx
           {pinLoaded && (
             <View style={screenStyles.pinToggleContainer}>
               <PinToggle
                 enabled={pinEnabled}
                 onToggle={togglePin}
                 disabled={isSending}
               />
               <PinTooltip
                 visible={showTooltip && pinLoaded}
                 onDismiss={dismissTooltip}
               />
             </View>
           )}
           ```
         - Add `pinToggleContainer` style: centered, with some vertical padding (8-12px top/bottom)
       - Add `pinEnabled` to the `handleSend` dependency array

    IMPORTANT: Do NOT restructure the existing SnapPreviewScreen layout. Only add the pin toggle section between the Polaroid and footer. Keep all existing functionality intact.
  </action>
  <verify>
    <automated>npx jest __tests__/services/snapService.test.js --no-coverage -x</automated>
    <manual>Verify SnapPreviewScreen renders pin toggle between Polaroid and send button. Verify snapService adds pinned fields to message document when pinToScreen is true.</manual>
  </verify>
  <done>snapService.uploadAndSendSnap accepts pinToScreen option, adds pinned/pinnedActivityId/pinnedThumbnailUrl to message data, uploads tiny thumbnail. SnapPreviewScreen shows PinToggle between Polaroid and send button with tooltip support.</done>
</task>

</tasks>

<verification>
1. `npx jest __tests__/services/liveActivityService.test.js --no-coverage` passes
2. `npx jest __tests__/services/snapService.test.js --no-coverage` passes
3. liveActivityService returns `{ success: false }` on Android (no crash)
4. Deep link URL uses `lapse://messages/{conversationId}` pattern
5. snapService adds `pinned: true`, `pinnedActivityId`, `pinnedThumbnailUrl` when pinToScreen option is true
6. snapService adds `pinned: false` when pinToScreen is false (explicit for queries)
7. SnapPreviewScreen imports and renders PinToggle and PinTooltip
8. SnapPreviewScreen passes pinToScreen to uploadAndSendSnap
9. `npm run lint` passes on all modified files
</verification>

<success_criteria>
- liveActivityService.js provides JS bridge with Platform guards and { success, error } return pattern
- snapService supports pinned snap message creation with thumbnail upload
- SnapPreviewScreen integrates pin toggle between Polaroid and send button
- All existing tests pass, new tests pass
- No Android crashes from iOS-only code
</success_criteria>

<output>
After completion, create `.planning/phases/09-pinned-snaps-ios/09-03-SUMMARY.md`
</output>
