---
phase: 05-photo-tag-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/index.js
  - functions/__tests__/triggers/notifications.test.js
  - functions/__tests__/callable/addTaggedPhotoToFeed.test.js
autonomous: true
requirements: [TAG-01, TAG-03]

must_haves:
  truths:
    - 'When a user tags a friend in a photo, a type:tagged_photo message is created in their DM conversation'
    - 'If no conversation exists between tagger and tagged user, one is auto-created'
    - 'Tagged user receives exactly one push notification per tag (not two)'
    - 'Tagged photo appears on recipient feed immediately after tapping Add to feed (no darkroom delay)'
    - 'onNewMessage correctly handles tagged_photo type for lastMessage preview and push notification'
    - 'addTaggedPhotoToFeed is idempotent -- calling twice does not create duplicate photos'
    - 'Photographer receives push notification when their photo is reshared'
  artifacts:
    - path: 'functions/index.js'
      provides: 'Modified sendTaggedPhotoNotification, extended onNewMessage, new addTaggedPhotoToFeed callable'
      contains: 'addTaggedPhotoToFeed'
    - path: 'functions/__tests__/triggers/notifications.test.js'
      provides: 'Tests for sendTaggedPhotoNotification DM message creation and onNewMessage tagged_photo handling'
    - path: 'functions/__tests__/callable/addTaggedPhotoToFeed.test.js'
      provides: 'Tests for addTaggedPhotoToFeed callable including idempotency'
  key_links:
    - from: 'sendTaggedPhotoNotification'
      to: 'conversations/{id}/messages/'
      via: 'Firestore message document creation'
      pattern: "db\\.collection.*conversations.*messages.*add"
    - from: 'onNewMessage'
      to: 'tagged_photo type handling'
      via: 'lastMessagePreview and notification body builder'
      pattern: 'tagged_photo.*Tagged you in a photo'
    - from: 'addTaggedPhotoToFeed'
      to: 'photos collection'
      via: 'new photo document with attribution'
      pattern: 'attribution.*photographerId'
---

<objective>
Build the complete server-side pipeline for photo tag integration: (1) modify sendTaggedPhotoNotification to create DM messages instead of activity feed notifications, (2) extend onNewMessage to handle tagged_photo type for conversation metadata and push notifications, and (3) create addTaggedPhotoToFeed callable Cloud Function for the reshare flow with attribution and photographer notification.

Purpose: Establish the server-side foundation so tagged photos flow through DMs and can be reshared to feeds with attribution. All three Cloud Function changes must land together because sendTaggedPhotoNotification creates messages that onNewMessage must handle.

Output: Modified functions/index.js with three changes, plus tests covering the new behavior.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-tag-integration/05-CONTEXT.md
@.planning/phases/05-photo-tag-integration/05-RESEARCH.md
@functions/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Modify sendTaggedPhotoNotification to create DM messages + extend onNewMessage for tagged_photo</name>
  <files>functions/index.js</files>
  <action>
**Part A: Modify sendTaggedPhotoNotification (lines ~958-1113)**

Replace the push notification + notifications collection write with DM message creation. For each newly tagged user:

1. Call a server-side `getOrCreateConversation(taggerId, taggedUserId)` helper (implement inline or as a helper function in the same file). Pattern: deterministic ID `[lower]_[higher]`, create conversation doc if not exists with `participants`, `lastMessage: null`, `createdAt`, `updatedAt`, `deletedAt: { [uid1]: null, [uid2]: null }`, `unreadCount: { [uid1]: 0, [uid2]: 0 }`.

2. Create a message document in `conversations/{conversationId}/messages/` with:

   ```javascript
   {
     senderId: taggerId,
     type: 'tagged_photo',
     text: null,
     gifUrl: null,
     imageUrl: null,
     photoId: photoId,
     photoURL: after.imageURL || null,  // Denormalized for fast rendering
     photoOwnerId: taggerId,
     createdAt: admin.firestore.FieldValue.serverTimestamp(),
   }
   ```

3. REMOVE the `sendPushNotification` call from this function (onNewMessage will handle it).
4. REMOVE the `db.collection('notifications').add(...)` call (migration: new tags go to DMs only).
5. Check block status before creating conversation: query `blocks` collection where `(blockerId == taggedUserId AND blockedId == taggerId)`. If blocked, skip that user silently.
6. Use `Promise.allSettled` for processing all tagged users concurrently instead of sequential `for` loop. Log settled rejections but do not fail the function.

**Part B: Extend onNewMessage (lines ~2970-3097)**

1. Add `tagged_photo` to the `lastMessagePreview` builder (after the snap case):

   ```javascript
   messageType === 'tagged_photo'
     ? 'Tagged you in a photo'
   ```

2. Add `tagged_photo` to the notification body builder (after the snap case):

   ```javascript
   } else if (messageType === 'tagged_photo') {
     body = 'Tagged you in a photo';
   }
   ```

3. Add `tagged_photo` to the notification data type mapping:
   ```javascript
   type: messageType === 'snap' ? 'snap' : messageType === 'tagged_photo' ? 'tagged_photo' : 'direct_message',
   ```
   Include `conversationId` in notification data for navigation.

**Part C: Create addTaggedPhotoToFeed callable**

Add a new callable Cloud Function `addTaggedPhotoToFeed` at the end of the DM section (before the snap infrastructure section). Structure:

```javascript
exports.addTaggedPhotoToFeed = functions
  .runWith({ memory: '256MB', timeoutSeconds: 60 })
  .https.onCall(async (data, context) => {
    // 1. Auth check
    if (!context.auth) throw HttpsError('unauthenticated', 'Must be authenticated');
    const recipientId = context.auth.uid;
    const { photoId, messageId, conversationId } = data;

    // 2. Validate inputs (strings, non-empty)
    // 3. Verify recipient is a participant in the conversation
    // 4. Read the message doc, verify type === 'tagged_photo'
    // 5. Idempotency: check message.addedToFeedBy?.[recipientId] -- if exists, return existing newPhotoId
    // 6. Read original photo doc (photoId from message)
    // 7. Verify original photo exists and is not deleted
    // 8. Create new photo document for recipient:
    //    - userId: recipientId
    //    - imageURL: originalPhoto.imageURL
    //    - storagePath: originalPhoto.storagePath (same file, no copy)
    //    - capturedAt: originalPhoto.capturedAt
    //    - status: 'triaged' (skip darkroom)
    //    - photoState: 'journal' (on feed immediately)
    //    - visibility: 'friends-only'
    //    - month: format(new Date(), 'yyyy-MM') or derive from capturedAt
    //    - reactions: {}, reactionCount: 0
    //    - triagedAt: serverTimestamp()
    //    - attribution: {
    //        originalPhotoId: photoId,
    //        photographerId: originalPhoto.userId,
    //        photographerUsername: photographer.username,
    //        photographerDisplayName: photographer.displayName,
    //      }
    //    - caption: originalPhoto.caption || null
    //    - taggedUserIds: [] (empty -- reshared photo does not inherit tags)
    // 9. Update message doc: addedToFeedBy.{recipientId} = { newPhotoId, addedAt: serverTimestamp() }
    // 10. Send push notification to photographer: "[recipientName] added your photo to their feed"
    //     (specific text, not randomized templates per user decision)
    //     Only notify if photographer !== recipientId
    // 11. Return { success: true, newPhotoId }
  });
```

Use Zod for input validation following the existing pattern in validation.js. For the photographer notification, look up the photographer's FCM token and check notification preferences before sending.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone/functions" && node -e "const f = require('./index.js'); console.log('sendTaggedPhotoNotification:', typeof f.sendTaggedPhotoNotification); console.log('onNewMessage:', typeof f.onNewMessage); console.log('addTaggedPhotoToFeed:', typeof f.addTaggedPhotoToFeed);"</automated>
<manual>All three functions should log their type as 'object' (Cloud Function objects). No require/syntax errors.</manual>
</verify>
<done> - sendTaggedPhotoNotification creates DM messages (not activity notifications) for each tagged user - Block check prevents message creation for blocked taggers - onNewMessage handles tagged_photo type correctly in lastMessage preview and notification body - addTaggedPhotoToFeed callable exists with auth, validation, idempotency, attribution, and photographer notification - Old push + notifications collection write removed from sendTaggedPhotoNotification
</done>
</task>

<task type="auto">
  <name>Task 2: Tests for Cloud Function changes</name>
  <files>functions/__tests__/triggers/notifications.test.js, functions/__tests__/callable/addTaggedPhotoToFeed.test.js</files>
  <action>
**Part A: Extend existing notifications.test.js**

Add test cases to the existing `sendTaggedPhotoNotification` describe block:

1. "creates DM message for each newly tagged user" -- Mock Firestore to verify message doc creation with correct schema (type: 'tagged_photo', photoId, photoURL, photoOwnerId, senderId)
2. "auto-creates conversation if none exists" -- Mock convRef.get() returning `exists: false`, verify conversation doc is created with correct structure
3. "skips blocked users" -- Mock blocks collection query returning a match, verify no message created for that user
4. "does NOT write to notifications collection" -- Verify `db.collection('notifications').add` is NOT called
5. "does NOT call sendPushNotification directly" -- Verify sendPushNotification is NOT called (onNewMessage handles it)
6. "processes tagged users concurrently with Promise.allSettled" -- Verify one user failure does not prevent others

Add test cases for `onNewMessage` tagged_photo handling:

7. "sets lastMessage text to 'Tagged you in a photo' for tagged_photo type"
8. "sends push notification with 'Tagged you in a photo' body for tagged_photo type"
9. "sets notification data type to 'tagged_photo'"

Follow the existing test patterns in this file: mock functions defined at module scope outside jest.mock, Firebase Admin mocked via the existing test setup.

**Part B: Create new addTaggedPhotoToFeed.test.js**

Create `functions/__tests__/callable/addTaggedPhotoToFeed.test.js` (create the `callable/` directory if it does not exist):

1. "throws unauthenticated if no auth context"
2. "throws invalid-argument for missing photoId, messageId, or conversationId"
3. "creates new photo document with attribution fields" -- Verify the created doc has `attribution.photographerId`, `attribution.photographerUsername`, `attribution.photographerDisplayName`, `attribution.originalPhotoId`, `status: 'triaged'`, `photoState: 'journal'`
4. "returns existing newPhotoId if already added (idempotency)" -- Mock message doc with addedToFeedBy already set, verify no new photo created
5. "updates message doc with addedToFeedBy map" -- Verify `messageRef.update` called with correct path
6. "sends push notification to photographer with exact text" -- Verify notification body is "[Name] added your photo to their feed" (not randomized)
7. "does not notify if photographer is the recipient" -- Verify no push when photographer === recipientId
8. "throws not-found if original photo is deleted" -- Mock photo with `photoState: 'deleted'`, verify HttpsError thrown

Follow the existing Cloud Function test patterns: mock admin, mock db, mock context with auth.uid.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone/functions" && npx jest **tests**/triggers/notifications.test.js **tests**/callable/addTaggedPhotoToFeed.test.js --bail --no-coverage 2>&1 | tail -20</automated>
<manual>All new tests pass. No existing tests broken.</manual>
</verify>
<done> - 6+ tests for sendTaggedPhotoNotification DM message creation (including block check, no activity notification, concurrent processing) - 3 tests for onNewMessage tagged_photo handling (lastMessage, notification body, notification data type) - 8 tests for addTaggedPhotoToFeed callable (auth, validation, attribution, idempotency, photographer notification) - All tests pass
</done>
</task>

</tasks>

<verification>
```bash
# Verify all functions export correctly
cd "C:/Users/maser/Lapse Clone/functions" && node -e "const f = require('./index.js'); console.log('exports:', Object.keys(f).filter(k => ['sendTaggedPhotoNotification','onNewMessage','addTaggedPhotoToFeed'].includes(k)))"

# Run all affected tests

cd "C:/Users/maser/Lapse Clone/functions" && npx jest **tests**/triggers/notifications.test.js **tests**/callable/addTaggedPhotoToFeed.test.js --bail --no-coverage

```
</verification>

<success_criteria>
- sendTaggedPhotoNotification creates type:tagged_photo messages in DM conversations (not activity notifications)
- onNewMessage handles tagged_photo for conversation metadata and push notifications
- addTaggedPhotoToFeed callable creates reshared photos with attribution, is idempotent, notifies photographer
- All new tests pass, no existing tests broken
</success_criteria>

<output>
After completion, create `.planning/phases/05-photo-tag-integration/05-01-SUMMARY.md`
</output>
```
