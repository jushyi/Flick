---
phase: 05-photo-tag-integration
plan: 04
type: execute
wave: 1
depends_on: ['05-02', '05-03']
files_modified:
  - src/components/TaggedPhotoBubble.js
  - src/styles/TaggedPhotoBubble.styles.js
  - src/screens/ConversationScreen.js
  - src/screens/PhotoDetailScreen.js
autonomous: true
requirements: [TAG-02, TAG-03, TAG-04]
gap_closure: true
must_haves:
  truths:
    - 'Tagged photo DM card uses reply-like transparent styling, shows full photo, and has Add to feed button overlaid inside the photo at bottom center'
    - 'Loading spinner on Add to feed matches app-wide PixelSpinner'
    - 'Tapping tagged photo card in DM opens PhotoDetail with full photo, attribution, and Add to feed button'
    - 'Tapping Photo by @username attribution in PhotoDetail navigates to photographer profile above the transparent modal'
  artifacts:
    - path: 'src/styles/TaggedPhotoBubble.styles.js'
      provides: 'Reply-like transparent card styling without teal accent'
      contains: 'transparent'
    - path: 'src/components/TaggedPhotoBubble.js'
      provides: 'Add to feed button positioned inside photo container with absolute positioning; uses PixelSpinner'
      contains: 'position.*absolute'
    - path: 'src/screens/ConversationScreen.js'
      provides: 'Tagged photo press calls openPhotoDetail before navigating to PhotoDetail'
      contains: 'openPhotoDetail'
    - path: 'src/screens/PhotoDetailScreen.js'
      provides: 'handlePhotographerPress uses contextAvatarPress for fullScreenModal navigation'
      contains: 'contextAvatarPress'
  key_links:
    - from: 'src/screens/ConversationScreen.js'
      to: 'PhotoDetailContext'
      via: 'usePhotoDetailActions().openPhotoDetail()'
      pattern: 'openPhotoDetail'
    - from: 'src/screens/PhotoDetailScreen.js'
      to: 'ProfileFromPhotoDetail'
      via: 'contextAvatarPress(photographerId, name)'
      pattern: 'contextAvatarPress.*photographer'
---

<objective>
Fix 4 UAT gaps from Phase 05 photo tag integration:

1. (Major) Restyle TaggedPhotoBubble card: remove teal accent, match reply/media bubble transparent style, show full photo without 4:3 constraint, move Add to feed button inside the photo at bottom center with absolute positioning.
2. (Cosmetic) Replace any remaining ActivityIndicator with PixelSpinner (already using PixelSpinner from initial fix, but confirm consistency).
3. (Major) Fix tagged photo tap opening PhotoDetail: ConversationScreen must call openPhotoDetail() on PhotoDetailContext before navigating, so PhotoDetailScreen has photo data.
4. (Major) Fix attribution navigation: handlePhotographerPress must use contextAvatarPress (ProfileFromPhotoDetail fullScreenModal) instead of navigation.navigate('OtherUserProfile') which renders behind the transparent PhotoDetail modal.

Purpose: Close all 4 UAT failures so tagged photo DM cards are visually correct and fully interactive.
Output: Updated TaggedPhotoBubble, ConversationScreen, and PhotoDetailScreen files.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-tag-integration/05-02-SUMMARY.md
@.planning/phases/05-photo-tag-integration/05-03-SUMMARY.md
@.planning/phases/05-photo-tag-integration/05-UAT.md
@src/components/TaggedPhotoBubble.js
@src/styles/TaggedPhotoBubble.styles.js
@src/screens/ConversationScreen.js
@src/screens/PhotoDetailScreen.js
@src/context/PhotoDetailContext.js
@src/components/MessageBubble.js (reference bubbleMedia style at line 434)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restyle TaggedPhotoBubble card and move Add to feed button inside photo</name>
  <files>src/styles/TaggedPhotoBubble.styles.js, src/components/TaggedPhotoBubble.js</files>
  <action>
**TaggedPhotoBubble.styles.js — Full restyling:**

1. Remove the teal accent constants (TAG_ACCENT, TAG_BG, TAG_BORDER). The TAG_ACCENT export is used in one place (PixelSpinner color prop in TaggedPhotoBubble.js) — that will be updated in TaggedPhotoBubble.js.

2. Restyle the `card` to match the MessageBubble `bubbleMedia` style pattern: transparent background, no colored border, no teal shadow. Specifically:
   - `backgroundColor: 'transparent'`
   - `borderWidth: 0`
   - `borderColor: 'transparent'`
   - Remove the Platform.select shadow/elevation block entirely
   - Keep `overflow: 'hidden'` and `borderRadius: 6`
   - Keep `width: 240`

3. Update `photoContainer`:
   - Remove `aspectRatio: 4 / 3`
   - Set `width: '100%'` (already there)
   - Set `position: 'relative'` (needed for absolute child positioning)
   - The photo height will be determined by the Image component naturally

4. Update `photo` style:
   - Keep `width: '100%'`
   - Change `height: '100%'` to `aspectRatio: 3 / 4` (portrait aspect — this gives a natural photo height since the container no longer constrains)
   - Add `borderRadius: 6`

5. Update `photoPlaceholder`:
   - Change `height: '100%'` to `aspectRatio: 3 / 4`

6. Remove the existing `buttonContainer` style entirely.

7. Add a new `buttonOverlay` style for the button positioned inside the photo:

   ```js
   buttonOverlay: {
     position: 'absolute',
     bottom: 10,
     left: 0,
     right: 0,
     alignItems: 'center',
   }
   ```

8. Update `addButton`:
   - Remove `backgroundColor: TAG_ACCENT` — replace with `backgroundColor: 'rgba(0, 0, 0, 0.6)'`
   - Add `borderRadius: 16` (pill shape)
   - Keep `flexDirection: 'row'`, `alignItems: 'center'`, `justifyContent: 'center'`
   - Keep `paddingHorizontal: 12`, `height: 32`, `gap: 4`

9. Update `addButtonDisabled`:
   - `backgroundColor: 'rgba(0, 0, 0, 0.4)'`

10. Remove `TAG_ACCENT` from the named export line. If other files import it, those references will be updated in this task.

**TaggedPhotoBubble.js — Move button inside photo + update spinner:**

1. Remove the `TAG_ACCENT` import from the styles import line. Change:
   `import { styles, TAG_ACCENT } from '../styles/TaggedPhotoBubble.styles';`
   to:
   `import { styles } from '../styles/TaggedPhotoBubble.styles';`

2. Move the "Add to feed" button JSX from OUTSIDE the `photoContainer` (where it sits in a separate `buttonContainer` View) to INSIDE the `photoContainer`, using the new `buttonOverlay` style. The button should overlay the bottom center of the photo image.

   Current structure (WRONG):

   ```
   <View style={styles.photoContainer}>
     <Image ... />
   </View>
   {!isCurrentUser && (
     <View style={styles.buttonContainer}>
       <TouchableOpacity ...> ... </TouchableOpacity>
     </View>
   )}
   ```

   New structure (CORRECT):

   ```
   <View style={styles.photoContainer}>
     {imageError || !message.photoURL ? (
       <View style={styles.photoPlaceholder}> ... </View>
     ) : (
       <Image ... />
     )}
     {!isCurrentUser && (
       <View style={styles.buttonOverlay}>
         <TouchableOpacity ...> ... </TouchableOpacity>
       </View>
     )}
   </View>
   ```

3. Update the PixelSpinner color prop: replace `color={TAG_ACCENT}` with `color={colors.text.primary}` (since teal accent is removed).

4. Verify the PixelSpinner import is already present (it was fixed during initial plan execution — the component already imports PixelSpinner, NOT ActivityIndicator). No change needed if already correct.
   </action>
   <verify>
   <automated>cd "c:/Users/maser/Lapse Clone" && npx jest **tests**/components/TaggedPhotoBubble.test.js --no-coverage 2>&1 | tail -20</automated>
   <manual>Open a DM conversation with a tagged photo. Card should have no teal border/background, photo should display full (not 4:3 cropped), and Add to feed button should be centered at the bottom of the photo image with a dark semi-transparent pill background.</manual>
   </verify>
   <done>TaggedPhotoBubble renders with transparent card styling matching media bubbles, full photo without aspect ratio constraint, and Add to feed button overlaid inside the photo at bottom center. No teal accent colors remain.</done>
   </task>

<task type="auto">
  <name>Task 2: Fix tagged photo PhotoDetail navigation and attribution profile navigation</name>
  <files>src/screens/ConversationScreen.js, src/screens/PhotoDetailScreen.js</files>
  <action>
**ConversationScreen.js — Fix tagged photo tap to populate PhotoDetailContext:**

The root cause: the `pressHandler` for tagged photos navigates to PhotoDetail by passing photo data as route params, but PhotoDetailScreen reads photo data from PhotoDetailContext (not route params). Since `openPhotoDetail()` is never called, context is empty, and PhotoDetailScreen hits its guard (`if !currentPhoto return null`) rendering nothing behind the transparent modal.

1. Import `usePhotoDetailActions` from `'../context/PhotoDetailContext'`:

   ```js
   import { usePhotoDetailActions } from '../context/PhotoDetailContext';
   ```

2. Inside the `ConversationScreen` component (near the other hooks), call `usePhotoDetailActions()`:

   ```js
   const { openPhotoDetail } = usePhotoDetailActions();
   ```

3. Update the `pressHandler` for tagged photo messages in the `renderItem` function. Replace the direct `navigation.navigate('PhotoDetail', ...)` with a two-step approach:
   - First, call `openPhotoDetail()` to populate the context
   - Then, navigate to PhotoDetail with taggedPhotoContext as route params

   Replace this block:

   ```js
   const pressHandler = isTaggedPhotoMessage
     ? msg => {
         navigation.navigate('PhotoDetail', {
           photo: {
             id: msg.photoId,
             imageURL: msg.photoURL,
             userId: msg.photoOwnerId,
           },
           taggedPhotoContext: {
             messageId: msg.id,
             conversationId: conversationId,
             photoId: msg.photoId,
             addedToFeedBy: msg.addedToFeedBy || {},
           },
         });
       }
   ```

   With:

   ```js
   const pressHandler = isTaggedPhotoMessage
     ? msg => {
         openPhotoDetail({
           photo: {
             id: msg.photoId,
             imageURL: msg.photoURL,
             photoURL: msg.photoURL,
             userId: msg.photoOwnerId,
           },
           photos: [
             {
               id: msg.photoId,
               imageURL: msg.photoURL,
               photoURL: msg.photoURL,
               userId: msg.photoOwnerId,
             },
           ],
           initialIndex: 0,
           mode: 'feed',
           currentUserId: user.uid,
         });
         navigation.navigate('PhotoDetail', {
           taggedPhotoContext: {
             messageId: msg.id,
             conversationId: conversationId,
             photoId: msg.photoId,
             addedToFeedBy: msg.addedToFeedBy || {},
           },
         });
       }
   ```

4. Add `openPhotoDetail` to the `renderItem` useCallback dependency array.

**PhotoDetailScreen.js — Fix attribution navigation to use contextAvatarPress:**

The root cause: `handlePhotographerPress` uses `navigation.navigate('OtherUserProfile')` which has card presentation. PhotoDetail is a transparentModal. Cards render behind transparentModals in React Navigation. The fix is to use `contextAvatarPress()` which navigates to `ProfileFromPhotoDetail` (fullScreenModal, renders above transparentModal) — the same pattern used by `handleAvatarPress` and `handleCommentAvatarPress`.

1. Find `handlePhotographerPress` (around line 547). Replace its implementation:

   Current (WRONG):

   ```js
   const handlePhotographerPress = useCallback(
     (photographerId, photographerDisplayName) => {
       navigation.navigate('OtherUserProfile', {
         userId: photographerId,
         username: photographerDisplayName,
       });
     },
     [navigation]
   );
   ```

   New (CORRECT):

   ```js
   const handlePhotographerPress = useCallback(
     (photographerId, photographerDisplayName) => {
       if (contextAvatarPress) {
         contextAvatarPress(photographerId, photographerDisplayName);
       }
     },
     [contextAvatarPress]
   );
   ```

   This matches the pattern in `handleCommentAvatarPress` (line ~594) and `handleAvatarPress` (line ~537). The `contextAvatarPress` function navigates to `ProfileFromPhotoDetail` which is a fullScreenModal and renders above the transparent PhotoDetail modal.

2. The `navigation` dependency can be removed from `handlePhotographerPress`'s dependency array since it no longer uses `navigation` directly. Replace with `[contextAvatarPress]`.
   </action>
   <verify>
   <automated>cd "c:/Users/maser/Lapse Clone" && npx jest **tests**/screens/PhotoDetailScreen.test.js --no-coverage 2>&1 | tail -20</automated>
   <manual>In a DM conversation, tap a tagged photo card. PhotoDetail should open showing the full photo with attribution. Then tap "Photo by @username" — photographer profile should appear on top of (not behind) the PhotoDetail modal.</manual>
   </verify>
   <done>Tapping tagged photo card in DM opens PhotoDetail with photo data populated via PhotoDetailContext. Tapping attribution text navigates to photographer profile via ProfileFromPhotoDetail (fullScreenModal) which renders above the transparent PhotoDetail modal.</done>
   </task>

</tasks>

<verification>
1. `npm test -- --no-coverage` passes with no new failures
2. Tagged photo card in DM has transparent background (no teal), full photo, button overlaid inside photo
3. Tapping card opens PhotoDetail with visible photo and attribution
4. Tapping attribution text navigates to profile above PhotoDetail (not behind it)
5. Add to feed button uses PixelSpinner (not ActivityIndicator) during loading
6. Add to feed works from both the DM card and PhotoDetail view
</verification>

<success_criteria>

- All 4 UAT gaps closed: card styling, spinner, PhotoDetail navigation, attribution navigation
- No regressions in existing test suites
- Tagged photo flow is fully functional end-to-end: see card -> tap -> PhotoDetail -> tap attribution -> profile
  </success_criteria>

<output>
After completion, create `.planning/phases/05-photo-tag-integration/05-04-SUMMARY.md`
</output>
