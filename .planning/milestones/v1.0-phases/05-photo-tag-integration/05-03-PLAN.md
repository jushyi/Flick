---
phase: 05-photo-tag-integration
plan: 03
type: execute
wave: 2
depends_on: [05-01]
files_modified:
  - src/components/FeedPhotoCard.js
  - src/styles/FeedPhotoCard.styles.js
  - src/screens/PhotoDetailScreen.js
  - src/styles/PhotoDetailScreen.styles.js
  - src/services/firebase/notificationService.js
  - __tests__/components/FeedPhotoCard.test.js
  - __tests__/screens/PhotoDetailScreen.test.js
autonomous: true
requirements: [TAG-04, TAG-01]

must_haves:
  truths:
    - "'Photo by @username' attribution text appears on reshared photos in the feed"
    - 'Attribution text is positioned below display name/timestamp and above caption'
    - "Tapping attribution navigates to photographer's profile"
    - 'Attribution appears in both FeedPhotoCard and PhotoDetailScreen'
    - 'Attribution is permanent and cannot be removed by recipient'
    - 'Tagged photo push notification navigates to DM conversation (not Activity screen)'
    - "PhotoDetailScreen shows 'Add to feed' button for tagged photo context"
  artifacts:
    - path: 'src/components/FeedPhotoCard.js'
      provides: 'Attribution display on feed cards'
      contains: 'attribution'
    - path: 'src/screens/PhotoDetailScreen.js'
      provides: 'Attribution display in photo detail + Add to feed button when opened from tagged photo message'
      contains: 'attribution'
    - path: 'src/services/firebase/notificationService.js'
      provides: 'Updated notification tap handler for tagged_photo type'
      contains: 'tagged_photo'
    - path: '__tests__/components/FeedPhotoCard.test.js'
      provides: 'Tests for attribution rendering'
    - path: '__tests__/screens/PhotoDetailScreen.test.js'
      provides: 'Tests for attribution rendering and Add to feed button in PhotoDetailScreen'
  key_links:
    - from: 'src/components/FeedPhotoCard.js'
      to: 'onAvatarPress(photographerId)'
      via: 'attribution TouchableOpacity'
      pattern: 'attribution.*photographerId'
    - from: 'src/screens/PhotoDetailScreen.js'
      to: 'addTaggedPhotoToFeed'
      via: 'Add to feed button onPress'
      pattern: 'addTaggedPhotoToFeed.*taggedPhotoContext'
    - from: 'src/services/firebase/notificationService.js'
      to: 'Conversation screen navigation'
      via: 'handleNotificationTapped tagged_photo case'
      pattern: 'tagged_photo.*Conversation'
---

<objective>
Add attribution display to FeedPhotoCard and PhotoDetailScreen for reshared photos, update notification navigation to route tagged_photo push notifications to DM conversations, add "Add to feed" functionality within PhotoDetailScreen when viewing a tagged photo, and create tests covering both PhotoDetailScreen and FeedPhotoCard changes.

Purpose: Complete the reshare experience -- users see "Photo by @username" on reshared photos, tapping it navigates to the photographer's profile, and push notifications for tags navigate correctly.

Output: Modified FeedPhotoCard with attribution, PhotoDetailScreen with attribution + "Add to feed", updated notification handler, tests for both screens.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-photo-tag-integration/05-CONTEXT.md
@.planning/phases/05-photo-tag-integration/05-RESEARCH.md
@.planning/phases/05-photo-tag-integration/05-01-SUMMARY.md
@src/components/FeedPhotoCard.js
@src/styles/FeedPhotoCard.styles.js
@src/screens/PhotoDetailScreen.js
@src/services/firebase/notificationService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Attribution display in FeedPhotoCard + PhotoDetailScreen + Add to feed button</name>
  <files>src/components/FeedPhotoCard.js, src/styles/FeedPhotoCard.styles.js, src/screens/PhotoDetailScreen.js, src/styles/PhotoDetailScreen.styles.js</files>
  <action>
**Part A: FeedPhotoCard attribution**

In `src/components/FeedPhotoCard.js`, add attribution display between the user info row and the caption:

1. After the `</View>` closing the `infoRow` (around line 169), and BEFORE the caption section (line 172), insert:

```jsx
{
  /* Attribution line (for reshared photos) */
}
{
  photo.attribution && (
    <TouchableOpacity
      onPress={() =>
        onAvatarPress(photo.attribution.photographerId, photo.attribution.photographerDisplayName)
      }
      activeOpacity={0.7}
      style={styles.attributionRow}
    >
      <PixelIcon name="camera" size={14} color={colors.text.muted} />
      <Text style={styles.attributionText}>Photo by @{photo.attribution.photographerUsername}</Text>
    </TouchableOpacity>
  );
}
```

2. In `src/styles/FeedPhotoCard.styles.js`, add styles:
   - `attributionRow`: `flexDirection: 'row'`, `alignItems: 'center'`, `paddingHorizontal: 12`, `paddingTop: 4`, `gap: 6`
   - `attributionText`: Silkscreen font, `fontSize: 11`, `color: colors.text.muted` (a dimmer color than secondary to differentiate from display name), no uppercase

3. The `onAvatarPress` callback is already a prop of FeedPhotoCard. When attribution is tapped, it navigates to the photographer's profile using the same callback but with the photographer's userId and displayName.

**Part B: PhotoDetailScreen attribution**

In `src/screens/PhotoDetailScreen.js`:

1. Find the user info section (display name, timestamp). Below that section and above any caption display, add:

```jsx
{
  photo?.attribution && (
    <TouchableOpacity
      onPress={() =>
        handlePhotographerPress(
          photo.attribution.photographerId,
          photo.attribution.photographerDisplayName
        )
      }
      activeOpacity={0.7}
      style={styles.attributionRow}
    >
      <PixelIcon name="camera" size={14} color={colors.text.muted} />
      <Text style={styles.attributionText}>Photo by @{photo.attribution.photographerUsername}</Text>
    </TouchableOpacity>
  );
}
```

2. Add `handlePhotographerPress` function that navigates to the photographer's profile. Use the existing navigation pattern for profile navigation (check how `OtherUserProfile` screen is navigated to in this file and replicate).

3. In `src/styles/PhotoDetailScreen.styles.js`, add matching attribution styles (same as FeedPhotoCard for visual consistency).

**Part C: "Add to feed" button in PhotoDetailScreen**

When PhotoDetailScreen is opened from a tagged photo message context (the photo was opened via TaggedPhotoBubble's onPress), show an "Add to feed" / "Added to feed" button.

This uses `taggedPhotoContext` passed as navigation params by ConversationScreen (Plan 05-02 wires this):

1. In PhotoDetailScreen, read `taggedPhotoContext` from route params: `const { taggedPhotoContext } = route.params || {}`.
2. If `taggedPhotoContext` exists and current user is NOT the photo owner (tagger):
   - Show "Add to feed" button (same pill style as TaggedPhotoBubble button for consistency)
   - Track `hasAdded` from `taggedPhotoContext.addedToFeedBy?.[currentUserId]`
   - Track `isAdding` local state (loading)
   - On press: set `isAdding = true`, call `addTaggedPhotoToFeed(taggedPhotoContext.photoId, taggedPhotoContext.conversationId, taggedPhotoContext.messageId)` from photoTagService
   - After success: set local `hasAdded = true`, button becomes "Added to feed" (disabled)
   - On error: set `isAdding = false`, button remains tappable for retry
3. Position the button in the action bar area of PhotoDetailScreen (near reactions/comments section).

Note: This button placement is secondary to the inline button on TaggedPhotoBubble. Both should work, but the card button is the primary interaction per user decision.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern="FeedPhotoCard|PhotoDetailScreen" --bail --no-coverage 2>&1 | tail -15</automated>
<manual>FeedPhotoCard renders attribution text for photos with attribution field. PhotoDetailScreen shows attribution and Add to feed button when appropriate.</manual>
</verify>
<done> - "Photo by @username" text appears below name/timestamp and above caption in FeedPhotoCard - Tapping attribution calls onAvatarPress with photographer's userId and displayName - PhotoDetailScreen shows same attribution when photo has attribution field - "Add to feed" button visible in PhotoDetailScreen when opened from tagged photo message - Attribution styled consistently between FeedPhotoCard and PhotoDetailScreen
</done>
</task>

<task type="auto">
  <name>Task 2: Notification navigation update + FeedPhotoCard attribution tests + PhotoDetailScreen tests</name>
  <files>src/services/firebase/notificationService.js, __tests__/components/FeedPhotoCard.test.js, __tests__/screens/PhotoDetailScreen.test.js</files>
  <action>
**Part A: Update notification handler for tagged_photo**

In `src/services/firebase/notificationService.js`, update the `handleNotificationTapped` function:

1. Change the existing `case 'tagged':` (around line 390) to route to Conversation screen instead of Activity screen:

```javascript
case 'tagged':
case 'tagged_photo':
  // Navigate to DM conversation (per Phase 5 migration decision)
  return {
    success: true,
    data: {
      type: 'tagged_photo',
      screen: 'Conversation',
      params: {
        conversationId: conversationId,
        friendId: senderId,
        friendProfile: {
          uid: senderId,
          displayName: senderName || 'Unknown',
          photoURL: senderProfilePhotoURL || null,
        },
      },
    },
  };
```

The `conversationId`, `senderId`, `senderName`, and `senderProfilePhotoURL` come from the notification data payload sent by onNewMessage (which includes these fields for tagged_photo notifications per Plan 01). Extract them from the notification data the same way the `direct_message` case does.

2. Ensure the notification data destructuring at the top of `handleNotificationTapped` includes `conversationId` and sender fields that onNewMessage sends.

**Part B: Create FeedPhotoCard attribution tests**

Create `__tests__/components/FeedPhotoCard.test.js`:

1. "renders attribution text when photo has attribution field" -- Pass photo with `attribution: { photographerUsername: 'alice', photographerId: 'uid1', photographerDisplayName: 'Alice' }`, verify "Photo by @alice" text rendered
2. "does NOT render attribution when photo has no attribution field" -- Pass photo without attribution, verify no attribution text
3. "calls onAvatarPress with photographer ID when attribution tapped" -- Simulate press on attribution, verify `onAvatarPress(photographerId, photographerDisplayName)` called
4. "renders attribution between info row and caption" -- Verify DOM order: info row, then attribution, then caption
5. "renders camera icon next to attribution text" -- Verify PixelIcon name="camera" rendered within attribution row

Mock `expo-image`, `PixelIcon`, `CommentPreview`, and other dependencies following the project's test patterns. Mock `getPreviewComments` to return empty array.

**Part C: Create PhotoDetailScreen tests for attribution and Add to feed**

Create `__tests__/screens/PhotoDetailScreen.test.js`:

1. "renders attribution text when photo has attribution field" -- Pass photo with `attribution` object, verify "Photo by @username" text rendered
2. "does NOT render attribution when photo has no attribution" -- Pass photo without attribution, verify no attribution text
3. "navigates to photographer profile when attribution tapped" -- Simulate press on attribution, verify navigation called with photographer userId
4. "shows 'Add to feed' button when taggedPhotoContext is present and user is not photo owner" -- Pass route params with `taggedPhotoContext`, verify button rendered
5. "does NOT show 'Add to feed' button when user is the photo owner" -- Pass route params where photo.userId === currentUser.uid, verify button NOT rendered
6. "does NOT show 'Add to feed' button when no taggedPhotoContext" -- Pass route params without taggedPhotoContext, verify button NOT rendered
7. "shows 'Added to feed' disabled state when addedToFeedBy includes current user" -- Pass taggedPhotoContext with `addedToFeedBy: { [currentUserId]: { newPhotoId: 'x' } }`, verify disabled button text

Mock navigation, route params, `useAuth`, `usePhotoDetail` or relevant context hooks, `addTaggedPhotoToFeed` from photoTagService. Follow the project's existing screen test patterns (check `__tests__/screens/` for examples).
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest **tests**/components/FeedPhotoCard.test.js **tests**/screens/PhotoDetailScreen.test.js --bail --no-coverage 2>&1 | tail -15</automated>
<manual>Attribution tests pass. PhotoDetailScreen tests pass. Notification handler correctly routes tagged_photo to Conversation screen.</manual>
</verify>
<done> - handleNotificationTapped routes 'tagged' and 'tagged_photo' types to Conversation screen with conversationId and friendProfile - Old Activity screen routing for tags removed - 5 FeedPhotoCard attribution tests covering rendering, absence, press handler, order, icon - 7 PhotoDetailScreen tests covering attribution rendering, photographer navigation, Add to feed button visibility/states - All tests pass
</done>
</task>

</tasks>

<verification>
```bash
# Run all phase 5 tests
cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern="tagged|photoTag|TaggedPhoto|FeedPhotoCard|PhotoDetailScreen" --bail --no-coverage

# Run full test suite to catch regressions

cd "C:/Users/maser/Lapse Clone" && npm test -- --bail --no-coverage 2>&1 | tail -20

```
</verification>

<success_criteria>
- "Photo by @username" renders on reshared photos in FeedPhotoCard (below name/timestamp, above caption)
- Tapping attribution navigates to photographer's profile
- PhotoDetailScreen shows attribution + "Add to feed" button for tagged photo context
- Push notification for tagged_photo type navigates to Conversation screen (not Activity)
- All attribution tests pass (FeedPhotoCard + PhotoDetailScreen)
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-photo-tag-integration/05-03-SUMMARY.md`
</output>
```
