---
phase: 02-message-interactions
plan: 04
type: execute
wave: 2
depends_on:
  - 02-01
  - 02-03
files_modified:
  - src/components/MessageBubble.js
  - src/components/ReactionBadges.js
autonomous: true
requirements:
  - REACT-01
  - REACT-03
  - REPLY-01
  - REPLY-03
  - REPLY-04
  - DEL-02

must_haves:
  truths:
    - 'MessageBubble supports double-tap, long-press, swipe-to-reply, and single-tap gestures via composed Gesture API'
    - 'Reaction emoji badges display below message bubbles with counts'
    - 'Reply messages render with an embedded mini bubble showing original message preview'
    - "Unsent messages render as 'This message was deleted' italic placeholder"
    - "Deleted-for-me messages render as 'You deleted this message' placeholder"
    - 'Swipe-to-reply shows a reply arrow icon behind the sliding message'
  artifacts:
    - path: 'src/components/MessageBubble.js'
      provides: 'Gesture-enabled message bubble with reaction badges, reply rendering, deleted state'
      contains: 'GestureDetector'
    - path: 'src/components/ReactionBadges.js'
      provides: 'Emoji pill badges component for displaying reactions below messages'
      contains: 'ReactionBadges'
  key_links:
    - from: 'src/components/MessageBubble.js'
      to: 'src/components/ReactionBadges.js'
      via: 'renders ReactionBadges below bubble when reactions exist'
      pattern: 'ReactionBadges'
    - from: 'src/components/MessageBubble.js'
      to: 'react-native-gesture-handler'
      via: 'Gesture.Race composing double-tap, long-press, single-tap, pan'
      pattern: "Gesture\\.Race"
---

<objective>
Refactor MessageBubble with gesture composition for all interactions, add ReactionBadges component, reply mini-bubble rendering, and deleted message states.

Purpose: Transform the simple MessageBubble into the fully interactive message component that supports all Phase 2 interactions. This is the core rendering change.
Output: Gesture-enabled MessageBubble with reaction badges, reply context, and deleted states. New ReactionBadges component.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-message-interactions/02-CONTEXT.md
@.planning/phases/02-message-interactions/02-RESEARCH.md
@src/components/MessageBubble.js
@src/hooks/useConversation.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor MessageBubble with gesture composition and deleted/unsent states</name>
  <files>src/components/MessageBubble.js</files>
  <action>
Refactor MessageBubble.js from its current simple Pressable-based component to a gesture-enabled interactive message bubble.

**New imports:**

```javascript
import { Gesture, GestureDetector } from 'react-native-gesture-handler';
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  interpolate,
  runOnJS,
} from 'react-native-reanimated';
import { Ionicons } from '@expo/vector-icons';

import ReactionBadges from './ReactionBadges';
```

**New props (additions to existing):**

- `reactions` â€” object from reactionMap (e.g., `{ heart: [{senderId, messageId}], laugh: [{...}] }`) or null
- `onDoubleTap` â€” callback for double-tap heart
- `onLongPress` â€” callback `(message, layout)` for opening action menu
- `onSwipeReply` â€” callback for swipe-to-reply trigger
- `onReactionPress` â€” callback when tapping a reaction badge (for toggle)
- `replyTo` â€” the message's `replyTo` object (for rendering quoted mini bubble)
- `currentUserId` â€” for determining which reactions are the user's own

**Gesture composition:**
Replace the existing `<Pressable>` wrapper with `<GestureDetector>` using composed gestures:

```javascript
const translateX = useSharedValue(0);
const hasTriggeredHaptic = useSharedValue(false);
const bubbleRef = useRef(null);

const doubleTapGesture = Gesture.Tap()
  .numberOfTaps(2)
  .onEnd(() => {
    runOnJS(handleDoubleTap)();
  });

const longPressGesture = Gesture.LongPress()
  .minDuration(500)
  .onStart(event => {
    runOnJS(handleLongPress)(event);
  });

const singleTapGesture = Gesture.Tap()
  .maxDuration(250)
  .onEnd(() => {
    runOnJS(handleSingleTap)();
  });

const swipeGesture = Gesture.Pan()
  .activeOffsetX(20)
  .failOffsetY([-15, 15])
  .onUpdate(event => {
    'worklet';
    translateX.value = Math.max(0, Math.min(event.translationX, 80));
    if (translateX.value >= 40 && !hasTriggeredHaptic.value) {
      hasTriggeredHaptic.value = true;
      runOnJS(triggerHaptic)();
    }
  })
  .onEnd(event => {
    'worklet';
    if (event.translationX >= 40) {
      runOnJS(handleSwipeReply)();
    }
    translateX.value = withTiming(0, { duration: 200 });
    hasTriggeredHaptic.value = false;
  });

const composed = Gesture.Race(
  swipeGesture,
  Gesture.Exclusive(doubleTapGesture, singleTapGesture),
  longPressGesture
);
```

**handleLongPress:** Must measure the bubble's position using `bubbleRef.current.measureInWindow()` to get `{ x, y, width, height }` and pass to `onLongPress(message, layout)`. Use `useRef` on the bubble View.

**Unsent/deleted state rendering:**

- If `message._isUnsent` is true: render italic gray text "This message was deleted" instead of message content. No gestures active (disable double-tap, long-press, swipe). Still show timestamp if toggled.
- If `message._isDeletedForMe` is true: render italic gray text "You deleted this message" instead of message content. Same gesture disabling.
- Both use a shared `deletedMessageStyle` with italic, gray text (#7B7B9E), no bubble background.

**Reply mini bubble rendering:**
If `message.replyTo` exists, render an embedded mini bubble ABOVE the message content inside the bubble:

```jsx
{
  message.replyTo && (
    <Pressable
      onPress={() => onScrollToMessage?.(message.replyTo.messageId)}
      style={styles.replyPreviewInBubble}
    >
      {message.replyTo.deleted ? (
        <Text style={styles.replyDeletedText}>Original message deleted</Text>
      ) : (
        <>
          <Text style={styles.replyAuthorText} numberOfLines={1}>
            {message.replyTo.senderId === currentUserId ? 'You' : senderName || 'Friend'}
          </Text>
          <Text style={styles.replyContentText} numberOfLines={2}>
            {message.replyTo.type === 'image'
              ? 'ðŸ“· Photo'
              : message.replyTo.type === 'gif'
                ? 'GIF'
                : message.replyTo.text || ''}
          </Text>
        </>
      )}
    </Pressable>
  );
}
```

The mini bubble has a slightly lighter/darker background (depending on sender), a left border accent, and compact padding.

**Swipe animation:**
Wrap the entire message container in `<Animated.View>` with translateX animation. Behind the sliding message, show a reply arrow icon:

```jsx
<Animated.View style={[styles.replyArrowContainer, replyIconAnimatedStyle]}>
  <Ionicons name="return-up-back" size={20} color={colors.textSecondary} />
</Animated.View>
```

The reply arrow fades in as the user swipes right (opacity interpolated from translateX 0->40 maps to 0->1).

**Disable gestures for non-reactable messages:**
If `message.type === 'reaction'` (should not reach here due to filtering, but defensive), or if message is unsent/deleted, use a simpler gesture (single-tap only or none).

**Styles to add:**

- `replyPreviewInBubble` â€” compact padding (6px), slightly different background, left border (2px accent color), marginBottom 4px, borderRadius 6px
- `replyAuthorText` â€” bold, small (10px), pixel font
- `replyContentText` â€” regular, small (11px), numberOfLines 2
- `replyDeletedText` â€” italic, gray (#7B7B9E), small
- `deletedMessageText` â€” italic, gray, centered
- `replyArrowContainer` â€” absolute positioned to the left of the bubble, centered vertically
- `swipeContainer` â€” wraps the whole message row for translateX animation

Maintain all existing styles. The retro 16-bit pixel aesthetic must be preserved â€” use the existing `colors` and `typography` constants.
</action>
<verify>
<automated>npx jest --testPathPattern="**tests**/(components|hooks)" --bail 2>&1 | tail -10</automated>
<manual>Check MessageBubble.js for GestureDetector, Gesture.Race composition, replyTo rendering, deleted state rendering</manual>
</verify>
<done>MessageBubble refactored with composed gestures (double-tap, long-press, swipe, single-tap), reply mini bubble, deleted/unsent states, and swipe-to-reply animation</done>
</task>

<task type="auto">
  <name>Task 2: Create ReactionBadges component</name>
  <files>src/components/ReactionBadges.js, src/components/index.js</files>
  <action>
Create a new component that renders emoji reaction pills below a message bubble.

**src/components/ReactionBadges.js:**

Props:

- `reactions` â€” object from reactionMap: `{ heart: [{senderId, messageId}], laugh: [{senderId, messageId}] }` or null/undefined
- `isCurrentUser` â€” boolean, for alignment (right for sender, left for friend)
- `currentUserId` â€” to highlight user's own reaction
- `onReactionPress` â€” callback `(emoji)` when tapping a reaction pill (for toggle)

Rendering:

- If reactions is null/empty, render nothing
- Map over emoji keys in the reactions object
- Each emoji renders as a small pill/badge:
  ```jsx
  <Pressable
    onPress={() => onReactionPress(emoji)}
    style={[styles.pill, hasOwnReaction && styles.pillHighlight]}
  >
    <Text style={styles.emojiText}>{emojiCharMap[emoji]}</Text>
    {count > 1 && <Text style={styles.countText}>{count}</Text>}
  </Pressable>
  ```

Emoji character map:

```javascript
const EMOJI_MAP = {
  heart: 'â¤ï¸',
  laugh: 'ðŸ˜‚',
  surprise: 'ðŸ˜®',
  sad: 'ðŸ˜¢',
  angry: 'ðŸ˜¡',
  thumbs_up: 'ðŸ‘',
};
```

**Pill styling (retro pixel aesthetic):**

- Background: `rgba(255,255,255,0.1)` for normal, `rgba(0,255,255,0.15)` when user has reacted (highlight)
- Border: 1px solid `rgba(255,255,255,0.2)`, highlighted: `rgba(0,255,255,0.3)`
- BorderRadius: 10px (small pill shape)
- Padding: 2px horizontal, 1px vertical
- Emoji font size: 12px
- Count text: 10px, Silkscreen font (pixel font), white
- Row layout: flexDirection 'row', flexWrap 'wrap', gap 4px
- Alignment: alignSelf based on isCurrentUser (flex-end for sender, flex-start for friend)
- Margin top: 2px from the bubble

**Animation:**

- Pills fade in when first appearing using `Animated.View` with opacity from 0 to 1 (300ms withTiming). Per user decision: "Reaction pills fade in when first appearing (no bounce)".

**Add barrel export:**
In `src/components/index.js`, add:

```javascript
export { default as ReactionBadges } from './ReactionBadges';
```

**Integration in MessageBubble:**
The ReactionBadges component is rendered BELOW the bubble in MessageBubble.js (already handled in Task 1's structure). Verify the integration point is correct: after the Pressable/GestureDetector bubble, before the timestamp, render:

```jsx
{
  reactions && Object.keys(reactions).length > 0 && (
    <ReactionBadges
      reactions={reactions}
      isCurrentUser={isCurrentUser}
      currentUserId={currentUserId}
      onReactionPress={onReactionPress}
    />
  );
}
```

  </action>
  <verify>
    <automated>npx jest --testPathPattern="__tests__/components" --bail 2>&1 | tail -5</automated>
    <manual>Verify ReactionBadges renders pills with emoji + count, alignment matches sender/friend</manual>
  </verify>
  <done>ReactionBadges component renders emoji pills with counts, highlights user's own reactions, fades in on appearance. Exported from barrel. Integrated into MessageBubble render.</done>
</task>

</tasks>

<verification>
- MessageBubble supports all gesture types via Gesture.Race composition
- Double-tap and single-tap don't conflict (Gesture.Exclusive)
- Swipe-to-reply has 40px threshold with haptic at trigger point
- Reply mini bubble renders inside message bubble with quoted context
- Deleted messages show appropriate italic gray placeholder text
- ReactionBadges renders emoji pills with fade-in animation
- No scroll conflicts between swipe gesture and FlatList (activeOffsetX + failOffsetY)
</verification>

<success_criteria>

- MessageBubble fully refactored from Pressable to GestureDetector with 4 composed gestures
- ReactionBadges displays emoji pills below messages with user highlighting
- Reply mini bubble renders with original message preview or "Original message deleted"
- Unsent messages show "This message was deleted"
- Deleted-for-me messages show "You deleted this message"
- Existing message rendering (text, image, GIF) preserved
  </success_criteria>

<output>
After completion, create `.planning/phases/02-message-interactions/02-04-SUMMARY.md`
</output>
