---
phase: 04-snap-streaks
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - src/hooks/useStreaks.js
  - __tests__/hooks/useStreaks.test.js
  - src/screens/NotificationSettingsScreen.js
autonomous: true
requirements:
  - STRK-04
  - STRK-05

must_haves:
  truths:
    - 'useStreaks hook provides real-time streak data for a single conversation'
    - 'useStreakMap hook provides batch streak data for the messages list (single listener)'
    - 'Countdown timer shows time remaining until streak expiry'
    - 'Local countdown hits zero and shows expired state even before Firestore update arrives'
    - 'Streak warning notifications can be disabled via NotificationSettingsScreen toggle'
  artifacts:
    - path: 'src/hooks/useStreaks.js'
      provides: 'useStreak (single) and useStreakMap (batch) hooks with countdown timer'
      exports: ['useStreak', 'useStreakMap']
    - path: '__tests__/hooks/useStreaks.test.js'
      provides: 'Tests for streak hooks including subscription and countdown'
      min_lines: 60
    - path: 'src/screens/NotificationSettingsScreen.js'
      provides: 'streakWarnings toggle in notification settings'
      contains: 'streakWarnings'
  key_links:
    - from: 'src/hooks/useStreaks.js'
      to: 'src/services/firebase/streakService.js'
      via: 'subscribeToStreak and subscribeToUserStreaks imports'
      pattern: 'subscribeToStreak|subscribeToUserStreaks'
    - from: 'src/hooks/useStreaks.js'
      to: 'src/services/firebase/streakService.js'
      via: 'deriveStreakState for state computation'
      pattern: 'deriveStreakState'
---

<objective>
Build the useStreak and useStreakMap hooks that provide real-time streak data to UI components, including a local countdown timer for expiry. Add the streak warning notification preference toggle to NotificationSettingsScreen.

Purpose: The hooks bridge the gap between the server-side streak engine (Plan 01) and the UI components (Plan 04). useStreak serves individual conversation screens; useStreakMap serves the messages list with a single Firestore listener (avoiding N+1 per Research Pitfall 6). The notification toggle gives users control over streak warning push notifications (STRK-05).

Output: useStreaks.js hook file, hook tests, updated NotificationSettingsScreen.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-snap-streaks/04-CONTEXT.md
@.planning/phases/04-snap-streaks/04-RESEARCH.md
@.planning/phases/04-snap-streaks/04-01-SUMMARY.md
@.planning/phases/04-snap-streaks/04-02-SUMMARY.md
@src/hooks/useConversation.js
@src/hooks/useMessages.js
@src/screens/NotificationSettingsScreen.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useStreak and useStreakMap hooks + tests</name>
  <files>src/hooks/useStreaks.js, __tests__/hooks/useStreaks.test.js</files>
  <action>
**1. Create src/hooks/useStreaks.js:**

Export two hooks: `useStreak` (single conversation) and `useStreakMap` (batch for messages list).

**`useStreak(currentUserId, friendId)`:**

Purpose: Provides streak data for one conversation (used by ConversationScreen/ConversationHeader).

Implementation:

- Uses `subscribeToStreak(currentUserId, friendId, callback)` from streakService
- Maintains `streakData` state (raw document data or null)
- Derives `streakState` via `deriveStreakState(streakData, currentUserId)` on every data change
- Derives `streakColor` via `getStreakColor(streakState, streakData?.dayCount || 0)`
- Returns: `{ streakData, streakState, dayCount, streakColor, timeRemaining, isExpired }`
- Cleans up subscription on unmount via returned unsubscribe function in useEffect cleanup
- If either userId is null/undefined, skip subscription (return defaults)

**Local countdown timer (Research Pitfall 7):**

- When `streakData?.expiresAt` exists, run a `setInterval` every 60 seconds that computes `timeRemaining = expiresAt.toMillis() - Date.now()`
- If `timeRemaining <= 0`, set `isExpired = true` locally. This provides instant UI feedback even before the Cloud Function updates the document.
- Clear interval on unmount or when expiresAt changes
- `timeRemaining` is in milliseconds. Consumers can format as needed.

**`useStreakMap(userId)`:**

Purpose: Provides streak data for ALL conversations at once (used by MessagesList/ConversationRow). This is the single-listener approach from Research Pitfall 6.

Implementation:

- Uses `subscribeToUserStreaks(userId, callback)` from streakService
- Maintains a `Map` (or plain object) keyed by streak ID, valued with `{ ...streakData, streakState: deriveStreakState(data, userId) }`
- Returns: `{ streakMap, loading }` where `streakMap` is `{ [streakId]: { dayCount, streakState, streakColor, expiresAt, warning } }`
- On each snapshot callback, recomputes derived state for all streaks
- Cleans up subscription on unmount
- If userId is null/undefined, skip subscription (return empty map)

**Import organization (per project conventions):**

```javascript
import { useState, useEffect, useRef, useCallback, useMemo } from 'react';

import {
  subscribeToStreak,
  subscribeToUserStreaks,
  deriveStreakState,
  getStreakColor,
} from '../services/firebase/streakService';

import logger from '../utils/logger';
```

**2. Create **tests**/hooks/useStreaks.test.js:**

Use `renderHook`, `act`, `waitFor` from `@testing-library/react-native`.

Mock streakService module:

```javascript
const mockSubscribeToStreak = jest.fn();
const mockSubscribeToUserStreaks = jest.fn();
const mockDeriveStreakState = jest.fn();
const mockGetStreakColor = jest.fn();

jest.mock('../../src/services/firebase/streakService', () => ({
  subscribeToStreak: (...args) => mockSubscribeToStreak(...args),
  subscribeToUserStreaks: (...args) => mockSubscribeToUserStreaks(...args),
  deriveStreakState: (...args) => mockDeriveStreakState(...args),
  getStreakColor: (...args) => mockGetStreakColor(...args),
}));
```

**Test cases for useStreak:**

```
describe('useStreak')
  - subscribes to streak on mount with correct userId pair
  - returns null streakData and 'default' state initially
  - updates streakData when subscription fires
  - derives streakState from streakData and currentUserId
  - derives streakColor from streakState and dayCount
  - returns dayCount from streakData
  - cleans up subscription on unmount (unsubscribe called)
  - does not subscribe when currentUserId is null
  - does not subscribe when friendId is null
  - computes timeRemaining from expiresAt
  - sets isExpired=true when timeRemaining <= 0 (local countdown)
```

**Test cases for useStreakMap:**

```
describe('useStreakMap')
  - subscribes to user streaks on mount
  - returns empty streakMap initially
  - populates streakMap when subscription fires with streak array
  - derives streakState for each streak in map
  - cleans up subscription on unmount
  - does not subscribe when userId is null
  - handles empty streak array
```

For countdown timer tests: mock `Date.now()` or use `jest.useFakeTimers()` to advance time and verify `timeRemaining` updates and `isExpired` transitions.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern=useStreaks --forceExit 2>&1 | tail -15</automated>
</verify>
<done>useStreak hook subscribes to a single streak document, derives state/color, and provides a local countdown timer with isExpired fallback. useStreakMap hook subscribes to all user streaks with a single listener and builds a lookup map. All tests pass including countdown timer and cleanup.</done>
</task>

<task type="auto">
  <name>Task 2: Add streak warning notification toggle to NotificationSettingsScreen</name>
  <files>src/screens/NotificationSettingsScreen.js</files>
  <action>
Add a "Streak Warnings" toggle to the NotificationSettingsScreen using the existing toggle pattern.

**1. Read the existing NotificationSettingsScreen to understand the toggle pattern.**

The screen uses a `sections` array with items that have `{ label, key, isToggle: true, value: prefs[key], onToggle: fn }`. Follow this exact pattern.

**2. Add a new toggle item for `streakWarnings`:**

Add to the appropriate section (likely the main notifications section, after existing DM-related toggles):

```javascript
{
  label: 'Streak Warnings',
  key: 'streakWarnings',
  isToggle: true,
  value: preferences.streakWarnings !== false, // Default enabled (opt-out)
  onToggle: () => handleToggle('streakWarnings'),
}
```

The `streakWarnings` field defaults to enabled (undefined/missing = enabled). This matches the pattern used by other notification preferences (e.g., `directMessages !== false`). The `processStreakExpiry` Cloud Function in Plan 01 already checks `prefs.streakWarnings === false` to skip sending.

**3. No additional logic needed** â€” the existing `handleToggle` function writes to `userProfile.notificationPreferences` in Firestore, which the Cloud Function reads. The toggle just needs to be added to the UI items array.

**Important:** Do NOT add a subtitle or description text. Keep it consistent with existing toggle items in the screen (label + switch only).
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern=NotificationSettings 2>&1 | tail -10; grep -c "streakWarnings" "C:/Users/maser/Lapse Clone/src/screens/NotificationSettingsScreen.js"</automated>
<manual>Verify "Streak Warnings" toggle appears in NotificationSettingsScreen</manual>
</verify>
<done>NotificationSettingsScreen includes a "Streak Warnings" toggle that controls the streakWarnings notification preference field. Toggle defaults to enabled (opt-out). Matches existing toggle pattern.</done>
</task>

</tasks>

<verification>
- `npx jest --testPathPattern=useStreaks --forceExit` passes all tests
- `grep 'streakWarnings' src/screens/NotificationSettingsScreen.js` returns matches
- useStreak hook returns streakData, streakState, dayCount, streakColor, timeRemaining, isExpired
- useStreakMap hook returns streakMap keyed by streak ID
- NotificationSettingsScreen shows "Streak Warnings" toggle
</verification>

<success_criteria>

- useStreak provides real-time streak data for single conversations with local countdown timer
- useStreakMap provides batch streak data with single Firestore listener (no N+1)
- Local countdown timer shows expired state before server update arrives
- Streak warning toggle added to notification settings with opt-out default
- All hook tests pass including timer and subscription cleanup
  </success_criteria>

<output>
After completion, create `.planning/phases/04-snap-streaks/04-03-SUMMARY.md`
</output>
