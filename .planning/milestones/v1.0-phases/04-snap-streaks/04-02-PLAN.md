---
phase: 04-snap-streaks
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/firebase/streakService.js
  - __tests__/services/streakService.test.js
  - src/components/StreakIndicator.js
  - __tests__/components/StreakIndicator.test.js
  - src/constants/colors.js
autonomous: true
requirements:
  - STRK-03
  - STRK-04
  - STRK-07

must_haves:
  truths:
    - 'StreakIndicator renders 5 distinct visual states: default, building, pending, active, warning'
    - 'Active state shows day count inside the icon area with tier-appropriate color'
    - "Warning state shows '!' in red, replacing the day count"
    - 'Color deepens by tier: light amber (3-9), orange (10-49), deep orange (50+)'
    - 'Client streak service is read-only (no write operations)'
    - 'State derivation function correctly maps streak document fields to visual states'
  artifacts:
    - path: 'src/services/firebase/streakService.js'
      provides: 'Read-only streak service with subscribe and state derivation'
      exports:
        [
          'subscribeToStreak',
          'subscribeToUserStreaks',
          'deriveStreakState',
          'getStreakColor',
          'generateStreakId',
        ]
    - path: 'src/components/StreakIndicator.js'
      provides: 'Streak-aware snap icon component for all 3 UI locations'
      exports: ['default']
    - path: '__tests__/services/streakService.test.js'
      provides: 'Tests for streak state derivation logic'
      min_lines: 50
    - path: '__tests__/components/StreakIndicator.test.js'
      provides: 'Tests for StreakIndicator rendering in all 5 states'
      min_lines: 50
    - path: 'src/constants/colors.js'
      provides: 'STREAK_COLORS constant with all tier colors'
      contains: 'STREAK_COLORS'
  key_links:
    - from: 'src/components/StreakIndicator.js'
      to: 'src/services/firebase/streakService.js'
      via: 'deriveStreakState and getStreakColor functions'
      pattern: 'deriveStreakState|getStreakColor'
    - from: 'src/services/firebase/streakService.js'
      to: 'src/constants/colors.js'
      via: 'STREAK_COLORS import'
      pattern: 'STREAK_COLORS'
---

<objective>
Build the client-side streak service (read-only state derivation + Firestore subscriptions) and the StreakIndicator component (5 visual states with tier-based color deepening). These are self-contained building blocks consumed by the UI integration plan.

Purpose: Separates pure logic (state derivation, color mapping) from wiring (hook + UI integration). Both the service and component can be built and tested independently of the Cloud Functions, using mock data.

Output: streakService.js with subscription + derivation functions, StreakIndicator.js component, streak color constants, and tests for both.
</objective>

<execution_context>
@C:/Users/maser/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/maser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-snap-streaks/04-CONTEXT.md
@.planning/phases/04-snap-streaks/04-RESEARCH.md
@src/constants/colors.js
@src/components/ConversationRow.js
@src/services/firebase/messageService.js
@src/constants/pixelIcons.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create streakService.js with state derivation and subscriptions + tests</name>
  <files>src/services/firebase/streakService.js, __tests__/services/streakService.test.js, src/constants/colors.js</files>
  <action>
**1. Add STREAK_COLORS to src/constants/colors.js:**

Add a new `streak` section to the colors export object (alongside existing sections like `status`, `icon`, etc.):

```javascript
streak: {
  default: '#7B7B9E',    // Muted gray (matches colors.icon.secondary)
  building: '#D4A574',   // Subtle warm tint
  pending: '#D4A574',    // Same as building (per user decision)
  activeTier1: '#F5A623', // Light amber (day 3-9, matches SNAP_AMBER)
  activeTier2: '#FF8C00', // Orange (day 10-49, matches colors.status.developing)
  activeTier3: '#E65100', // Deep orange (day 50+)
  warning: '#FF3333',    // Red (matches colors.status.danger)
},
```

**2. Create src/services/firebase/streakService.js:**

File header JSDoc explaining: read-only streak service, all writes server-side. Export the following functions:

**`generateStreakId(userId1, userId2)`** — Reuse the exact same deterministic ID pattern as `generateConversationId` from messageService.js: sort both IDs alphabetically, join with underscore. Do NOT import from messageService to avoid circular dependencies — duplicate the 3-line function.

**`deriveStreakState(streak, currentUserId)`** — Pure function. Takes a streak document object and current user ID. Returns one of: `'default'`, `'building'`, `'pending'`, `'active'`, `'warning'`.

Logic:

```
if (!streak || !streak.expiresAt) {
  // No active streak period — check if building
  if (!streak) return 'default';
  const mySnap = streak.lastSnapBy?.[currentUserId];
  const otherUserId = streak.participants?.find(p => p !== currentUserId);
  const theirSnap = otherUserId ? streak.lastSnapBy?.[otherUserId] : null;
  if (mySnap && !theirSnap) return 'pending';
  if (mySnap || theirSnap) return 'building';
  return 'default';
}
if (streak.warning) return 'warning';
if (streak.dayCount >= 3) return 'active';
// dayCount 1-2: building toward visible streak
// Check if current user has snapped in current cycle
const mySnap = streak.lastSnapBy?.[currentUserId];
const otherUserId = streak.participants?.find(p => p !== currentUserId);
const theirSnap = otherUserId ? streak.lastSnapBy?.[otherUserId] : null;
if (mySnap && !theirSnap) return 'pending';
return 'building';
```

**`getStreakColor(streakState, dayCount)`** — Pure function. Maps state + dayCount to a color hex string from STREAK_COLORS.

Logic:

```
if (streakState === 'warning') return colors.streak.warning;
if (streakState === 'active') {
  if (dayCount >= 50) return colors.streak.activeTier3;
  if (dayCount >= 10) return colors.streak.activeTier2;
  return colors.streak.activeTier1;
}
if (streakState === 'pending') return colors.streak.pending;
if (streakState === 'building') return colors.streak.building;
return colors.streak.default;
```

**`subscribeToStreak(userId1, userId2, callback)`** — Subscribes to a single streak document via onSnapshot. Uses generateStreakId to compute document ID. Returns unsubscribe function. Calls callback with `{ id, ...data }` or `null` if document does not exist. Uses `@react-native-firebase/firestore` modular API: `import { getFirestore, doc, onSnapshot } from '@react-native-firebase/firestore'`.

**`subscribeToUserStreaks(userId, callback)`** — Subscribes to ALL streaks for a user using a collection query: `where('participants', 'array-contains', userId)`. This is the single-listener approach from Research Pitfall 6 (avoids N+1 subscriptions). Returns unsubscribe function. Calls callback with an array of streak objects `[{ id, ...data }, ...]`.

Both subscription functions use `onSnapshot` (not `getDoc`). Both follow the existing pattern in the codebase (see useConversation.js subscription pattern from research code examples).

**3. Create **tests**/services/streakService.test.js:**

Follow the project test pattern from TESTING.md:

- Mock logger first
- Mock `@react-native-firebase/firestore` with mockGetFirestore, mockDoc, mockOnSnapshot, mockCollection, mockQuery, mockWhere
- Define mock functions outside jest.mock, reference inside
- Use `require` after mocks

**Test cases:**

```
describe('streakService')
  describe('generateStreakId')
    - generates deterministic ID with lower user ID first
    - generates same ID regardless of argument order
    - joins with underscore separator

  describe('deriveStreakState')
    - returns 'default' when streak is null
    - returns 'default' when streak has no lastSnapBy entries and no expiresAt
    - returns 'building' when only friend has snapped (no expiresAt)
    - returns 'pending' when current user snapped but friend has not (no expiresAt)
    - returns 'building' when dayCount is 1-2 (with expiresAt)
    - returns 'pending' when dayCount 1-2 and current user snapped in current cycle
    - returns 'active' when dayCount >= 3 and warning is false
    - returns 'warning' when warning is true (regardless of dayCount)
    - returns 'active' for dayCount 3 (exact boundary)

  describe('getStreakColor')
    - returns muted gray for default state
    - returns warm tint for building state
    - returns warm tint for pending state (same as building)
    - returns light amber for active day 3-9
    - returns orange for active day 10-49
    - returns deep orange for active day 50+
    - returns red for warning state
    - returns light amber for active day 3 (exact boundary)
    - returns orange for active day 10 (exact boundary)
    - returns deep orange for active day 50 (exact boundary)

  describe('subscribeToStreak')
    - calls onSnapshot with correct document reference
    - returns unsubscribe function
    - calls callback with streak data when document exists
    - calls callback with null when document does not exist

  describe('subscribeToUserStreaks')
    - queries with array-contains for userId
    - returns unsubscribe function
    - calls callback with array of streak objects
```

  </action>
  <verify>
    <automated>cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern=streakService --forceExit 2>&1 | tail -15</automated>
  </verify>
  <done>streakService.js exports generateStreakId, deriveStreakState, getStreakColor, subscribeToStreak, subscribeToUserStreaks. All state derivation tests pass (default, building, pending, active, warning). Color tier tests pass (gray, warm, amber, orange, deep orange, red). Subscription tests validate onSnapshot wiring. STREAK_COLORS added to colors.js.</done>
</task>

<task type="auto">
  <name>Task 2: Create StreakIndicator component + tests</name>
  <files>src/components/StreakIndicator.js, __tests__/components/StreakIndicator.test.js</files>
  <action>
**1. Create src/components/StreakIndicator.js:**

A reusable component that renders the snap icon with streak-aware coloring and content. This component replaces the direct `<PixelIcon name="snap-polaroid" />` calls in ConversationRow, ConversationHeader, and DMInput.

**Props:**

- `streakState` — `'default' | 'building' | 'pending' | 'active' | 'warning'` (default: `'default'`)
- `dayCount` — number (default: 0)
- `size` — icon size (default: 18, matching ConversationRow's existing 18)

**Rendering logic:**

For ALL states: render the base snap-polaroid PixelIcon with color from `getStreakColor(streakState, dayCount)`.

For `'active'` state: overlay the day count number inside/on top of the icon. Use a small `<Text>` element positioned absolutely over the icon center. Font: Silkscreen (matches project pixel font). Font size: dynamically scaled based on `size` prop (roughly `size * 0.4` for single digit, `size * 0.35` for double digit). Color: white or `colors.background.primary` (dark) for contrast against the colored icon. The day count text should replace the flash element visually — position it centered on the icon.

For `'warning'` state: overlay "!" character instead of day count, using the same positioning but in warning red color with white text.

For `'default'`, `'building'`, `'pending'`: just the colored icon, no overlay text.

**Implementation approach:**

```javascript
import React from 'react';
import { View, Text, StyleSheet } from 'react-native';

import PixelIcon from './PixelIcon';

import { getStreakColor } from '../services/firebase/streakService';

import { typography } from '../constants/typography';

const StreakIndicator = ({ streakState = 'default', dayCount = 0, size = 18 }) => {
  const iconColor = getStreakColor(streakState, dayCount);
  const showOverlay = streakState === 'active' || streakState === 'warning';
  const overlayText = streakState === 'warning' ? '!' : String(dayCount);
  const fontSize =
    overlayText.length > 2 ? size * 0.3 : overlayText.length > 1 ? size * 0.35 : size * 0.4;

  return (
    <View style={[styles.container, { width: size, height: size }]}>
      <PixelIcon name="snap-polaroid" size={size} color={iconColor} />
      {showOverlay && (
        <View style={styles.overlayContainer}>
          <Text
            style={[
              styles.overlayText,
              {
                fontSize,
                lineHeight: fontSize * 1.2,
                color: streakState === 'warning' ? '#FFFFFF' : '#FFFFFF',
              },
            ]}
            allowFontScaling={false}
          >
            {overlayText}
          </Text>
        </View>
      )}
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    position: 'relative',
    alignItems: 'center',
    justifyContent: 'center',
  },
  overlayContainer: {
    ...StyleSheet.absoluteFillObject,
    alignItems: 'center',
    justifyContent: 'center',
  },
  overlayText: {
    fontFamily: typography.fontFamily.body, // Silkscreen
    fontWeight: 'bold',
    textAlign: 'center',
  },
});

export default StreakIndicator;
```

**Key decisions:**

- State transitions are instant (no animation per user decision)
- Identical treatment across all 3 UI locations (same component, different size prop)
- The number overlays on top of the PixelIcon rather than modifying the icon definition
- Use Silkscreen font (project's pixel body font) for the overlay numbers

**2. Create **tests**/components/StreakIndicator.test.js:**

Use `@testing-library/react-native` `render` function. Mock PixelIcon and streakService.

**Test cases:**

```
describe('StreakIndicator')
  - renders PixelIcon with snap-polaroid name
  - passes correct default color (muted gray) when no streakState prop
  - passes building color when streakState is building
  - passes pending color when streakState is pending
  - does NOT render overlay text for default state
  - does NOT render overlay text for building state
  - does NOT render overlay text for pending state
  - renders day count text for active state
  - renders correct day count number (e.g., "5" for dayCount=5)
  - renders "!" for warning state
  - passes warning color (red) for warning streakState
  - passes light amber for active day 3
  - passes orange for active day 15
  - passes deep orange for active day 50
  - uses size prop for icon size (default 18)
  - renders with custom size (e.g., 22 for DMInput)
```

Mock `PixelIcon` to a simple View/Text that exposes its props for assertion. Mock `getStreakColor` to return known values.
</action>
<verify>
<automated>cd "C:/Users/maser/Lapse Clone" && npx jest --testPathPattern=StreakIndicator --forceExit 2>&1 | tail -15</automated>
</verify>
<done>StreakIndicator component renders all 5 states correctly: default (muted gray icon), building (warm tint icon), pending (warm tint icon), active (colored icon + day count overlay), warning (red icon + "!" overlay). Color deepening works across tiers. Tests pass for all states and prop combinations.</done>
</task>

</tasks>

<verification>
- `npx jest --testPathPattern=streakService --forceExit` passes all tests
- `npx jest --testPathPattern=StreakIndicator --forceExit` passes all tests
- `src/constants/colors.js` contains `streak` color section with all 7 color values
- `src/services/firebase/streakService.js` has no write operations (only onSnapshot reads)
- `src/components/StreakIndicator.js` renders 5 distinct visual states
</verification>

<success_criteria>

- streakService.js provides pure functions for state derivation and color mapping, plus Firestore subscription helpers
- StreakIndicator component is a drop-in replacement for direct PixelIcon snap-polaroid calls
- Both modules are fully tested with comprehensive edge case coverage
- STREAK_COLORS constants are defined in the design system (colors.js)
- No server-side dependencies (can be tested with mock data)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-snap-streaks/04-02-SUMMARY.md`
</output>
