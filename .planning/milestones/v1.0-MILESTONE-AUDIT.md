---
milestone: v1.0
audited: 2026-02-25T17:00:00Z
status: tech_debt
scores:
  requirements: 38/38
  phases: 5/5
  integration: 5/5
  flows: 5/5
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 02-message-interactions
    items:
      - 'useConversation hook Phase 2 additions (reactionMap computation, reaction filtering, unsent/deleted placeholders) lack dedicated unit tests — tested indirectly through integration'
  - phase: 03-snap-messages
    items:
      - "Stale test assertion: functions/__tests__/snapFunctions.test.js line 522 expects 'direct_message' instead of correct 'snap' — test is actively failing, single-line fix needed"
      - 'INFRA-03: Firestore TTL policy on messages collection expiresAt field — documented in functions/index.js but not yet configured in Firebase console (user deferred)'
      - 'INFRA-04: Firebase Storage lifecycle rule on snap-photos/ path — documented in functions/index.js but not yet configured in GCS console (user deferred)'
  - phase: 04-snap-streaks
    items:
      - 'Info: hoursSinceLastMutual variable name is misleading — divides by DAY_MS so value represents days, not hours. Logic is correct.'
---

# Milestone v1.0 Audit: Flick Messaging Upgrade

**Audited:** 2026-02-25T17:00:00Z
**Status:** TECH_DEBT (all requirements met, no critical blockers, accumulated deferred items)
**Milestone:** v1.0 — Flick Messaging Upgrade
**Phases:** 5/5 complete and verified

---

## Executive Summary

All 38 v1 requirements are satisfied across 5 phases. Every phase has a passing VERIFICATION.md. Cross-phase integration is fully wired — `onNewMessage` handles all 5 message types, streak engine hooks into snap sending, tagged photo pipeline creates DMs and routes notifications correctly. No critical gaps exist. Five items of tech debt are accumulated across 3 phases, none of which block production functionality.

---

## Requirements Coverage (3-Source Cross-Reference)

### Source 1: REQUIREMENTS.md Traceability Table

All 38 requirements marked `[x]` Complete.

### Source 2: Phase VERIFICATION.md Requirements Tables

All 38 requirements have `SATISFIED` status (INFRA-03/04 marked `SATISFIED (deferred)`).

### Source 3: SUMMARY.md `requirements-completed` Frontmatter

All 38 requirements listed in at least one plan SUMMARY's `requirements-completed` field.

### Cross-Reference Matrix

| Requirement | Phase | VERIFICATION      | SUMMARY Listed             | REQUIREMENTS | Final Status  |
| ----------- | ----- | ----------------- | -------------------------- | ------------ | ------------- |
| READ-01     | 1     | passed            | 01-02                      | [x]          | **satisfied** |
| READ-02     | 1     | passed            | 01-01                      | [x]          | **satisfied** |
| READ-03     | 1     | passed            | 01-01, 01-02               | [x]          | **satisfied** |
| INFRA-01    | 1     | passed            | 01-01                      | [x]          | **satisfied** |
| INFRA-02    | 1     | passed            | 01-01                      | [x]          | **satisfied** |
| REACT-01    | 2     | passed            | 02-03, 02-04, 02-06        | [x]          | **satisfied** |
| REACT-02    | 2     | passed            | 02-03, 02-05, 02-06        | [x]          | **satisfied** |
| REACT-03    | 2     | passed            | 02-03, 02-04, 02-06        | [x]          | **satisfied** |
| REACT-04    | 2     | passed            | 02-01, 02-06               | [x]          | **satisfied** |
| REACT-05    | 2     | passed            | 02-02, 02-06               | [x]          | **satisfied** |
| REPLY-01    | 2     | passed            | 02-04, 02-06               | [x]          | **satisfied** |
| REPLY-02    | 2     | passed            | 02-03, 02-05, 02-06        | [x]          | **satisfied** |
| REPLY-03    | 2     | passed            | 02-01, 02-04, 02-06        | [x]          | **satisfied** |
| REPLY-04    | 2     | passed            | 02-04, 02-06               | [x]          | **satisfied** |
| DEL-01      | 2     | passed            | 02-02, 02-06               | [x]          | **satisfied** |
| DEL-02      | 2     | passed            | 02-03, 02-04, 02-06        | [x]          | **satisfied** |
| DEL-03      | 2     | passed            | 02-02, 02-06               | [x]          | **satisfied** |
| SNAP-01     | 3     | passed            | 03-02, 03-04, 03-06, 03-07 | [x]          | **satisfied** |
| SNAP-02     | 3     | passed            | 03-02, 03-06, 03-07        | [x]          | **satisfied** |
| SNAP-03     | 3     | passed            | 03-01, 03-06               | [x]          | **satisfied** |
| SNAP-04     | 3     | passed            | 03-03, 03-04, 03-06        | [x]          | **satisfied** |
| SNAP-05     | 3     | passed            | 03-03, 03-06, 03-08        | [x]          | **satisfied** |
| SNAP-06     | 3     | passed            | 03-01, 03-04, 03-06        | [x]          | **satisfied** |
| SNAP-07     | 3     | passed            | 03-01, 03-05, 03-08        | [x]          | **satisfied** |
| SNAP-08     | 3     | passed            | 03-01, 03-05               | [x]          | **satisfied** |
| INFRA-03    | 3     | passed (deferred) | 03-05                      | [x]          | **satisfied** |
| INFRA-04    | 3     | passed (deferred) | 03-05                      | [x]          | **satisfied** |
| STRK-01     | 4     | passed            | 04-01                      | [x]          | **satisfied** |
| STRK-02     | 4     | passed            | 04-01                      | [x]          | **satisfied** |
| STRK-03     | 4     | passed            | 04-02, 04-04               | [x]          | **satisfied** |
| STRK-04     | 4     | passed            | 04-02, 04-03, 04-04        | [x]          | **satisfied** |
| STRK-05     | 4     | passed            | 04-01, 04-03               | [x]          | **satisfied** |
| STRK-06     | 4     | passed            | 04-01                      | [x]          | **satisfied** |
| STRK-07     | 4     | passed            | 04-01, 04-02               | [x]          | **satisfied** |
| TAG-01      | 5     | passed            | 05-01, 05-03               | [x]          | **satisfied** |
| TAG-02      | 5     | passed            | 05-02, 05-04               | [x]          | **satisfied** |
| TAG-03      | 5     | passed            | 05-01, 05-02, 05-04        | [x]          | **satisfied** |
| TAG-04      | 5     | passed            | 05-03, 05-04               | [x]          | **satisfied** |

**Orphan Detection:** No orphaned requirements. Every REQ-ID in REQUIREMENTS.md traceability table is present in at least one phase VERIFICATION.md.

---

## Phase Verification Summary

| Phase | Name                                   | Status       | Score | Gaps | Tech Debt                            |
| ----- | -------------------------------------- | ------------ | ----- | ---- | ------------------------------------ |
| 1     | Message Infrastructure & Read Receipts | PASSED       | 11/11 | 0    | 0                                    |
| 2     | Message Interactions                   | PASSED       | 12/12 | 0    | 1 (test coverage gap)                |
| 3     | Snap Messages                          | PASSED       | 10/10 | 0    | 3 (stale test, INFRA-03/04 deferred) |
| 4     | Snap Streaks                           | PASSED       | 7/7   | 0    | 1 (variable naming, info)            |
| 5     | Photo Tag Integration                  | HUMAN_NEEDED | 11/11 | 0    | 0                                    |

All phases pass automated verification. Phase 5 status is `human_needed` — all code checks pass but 5 runtime/visual behaviors require device testing.

---

## Cross-Phase Integration

### onNewMessage Hub (functions/index.js)

The `onNewMessage` Cloud Function is the central message routing hub, extended across all 5 phases:

| Message Type | lastMessage Preview     | unreadCount | Push Notification                         | Additional Actions     | Status |
| ------------ | ----------------------- | ----------- | ----------------------------------------- | ---------------------- | ------ |
| text         | Message text            | Incremented | Standard DM notification                  | —                      | WIRED  |
| reaction     | Skipped                 | Skipped     | "Reacted {emoji} to your message"         | —                      | WIRED  |
| reply        | Reply text              | Incremented | Standard DM notification                  | —                      | WIRED  |
| snap         | null (hidden)           | Incremented | "Sent you a snap" with type:'snap'        | `updateStreakOnSnap()` | WIRED  |
| tagged_photo | "Tagged you in a photo" | Incremented | Tag notification with type:'tagged_photo' | —                      | WIRED  |

### Cross-Phase Wiring

| From                                            | To                                                                      | Via                                                  | Verified |
| ----------------------------------------------- | ----------------------------------------------------------------------- | ---------------------------------------------------- | -------- |
| Phase 3 snap send → Phase 4 streak update       | `onNewMessage` → `updateStreakOnSnap()`                                 | `messageType === 'snap'` guard at line 3017          | YES      |
| Phase 5 photo tag → DM message creation         | `sendTaggedPhotoNotification` trigger → `getOrCreateConversationServer` | Firestore onWrite on photos collection               | YES      |
| Phase 1 rules → Phase 3 snap viewedAt           | `firestore.rules` message update rule                                   | Non-sender `hasOnly(['viewedAt', 'screenshotted'])`  | YES      |
| Phase 1 type system → Phase 2/3/5 message types | MessageBubble.js delegation                                             | `isSnap`, `isTaggedPhoto`, reaction filtering        | YES      |
| Phase 3/5 notification → Deep linking           | notificationService.js                                                  | `case 'snap'`, `case 'tagged'`/`case 'tagged_photo'` | YES      |

### E2E Flow Verification

**Flow 1: Text → Read Receipt → React → Reply → Delete**

- Send text → `onNewMessage` updates lastMessage + unreadCount + push ✓
- Recipient opens → `markConversationRead` writes readReceipts timestamp ✓
- Sender sees "Read" via `onSnapshot` on conversation doc ✓
- Double-tap/long-press → `sendReaction` creates reaction message ✓
- Swipe → `sendReply` with denormalized `replyTo` ✓
- Long-press → Unsend → `unsendMessage` CF soft-deletes ✓

**Flow 2: Snap Send → View → Cleanup → Streak**

- DMInput camera → CameraScreen snap mode → SnapPreviewScreen → `uploadAndSendSnap` ✓
- `onNewMessage` handles type:snap, calls `updateStreakOnSnap()` ✓
- Recipient taps SnapBubble → SnapViewer loads via `getSignedSnapUrl` ✓
- Dismiss → `markSnapViewed` writes viewedAt → `onSnapViewed` deletes Storage file ✓
- `cleanupExpiredSnaps` catches orphans every 2 hours ✓

**Flow 3: Tag Friend → DM → Add to Feed → Attribution**

- Tag friend in photo → `sendTaggedPhotoNotification` creates tagged_photo message ✓
- `onNewMessage` handles type:tagged_photo, sends push notification ✓
- Recipient sees TaggedPhotoBubble in conversation ✓
- Tap → `openPhotoDetail()` populates context → PhotoDetail opens ✓
- "Add to feed" → `addTaggedPhotoToFeed` CF creates attributed photo ✓
- Feed shows "Photo by @username" → tap navigates via `contextAvatarPress` ✓

**Flow 4: Streak Warning → Notification → Exchange → Increment**

- `processStreakExpiry` (every 30 min) checks `warningAt <= now` ✓
- Sets `warning: true`, sends push to both users (respects opt-out toggle) ✓
- Users exchange snaps → `updateStreakOnSnap` increments dayCount ✓
- Client receives streak update via `subscribeToStreak` onSnapshot ✓
- StreakIndicator updates in ConversationRow, ConversationHeader, DMInput ✓

**Flow 5: Notification Deep Linking**

- `notificationService.js` routes all notification types to correct screens ✓
- `reaction` → Conversation ✓
- `snap` → Conversation with `autoOpenSnapId` ✓
- `tagged`/`tagged_photo` → Conversation ✓

---

## Tech Debt Summary

### Phase 2: Message Interactions (1 item)

- **useConversation hook test gap:** Phase 2 additions (reactionMap, reaction filtering, unsent/deleted placeholders) are not covered by dedicated unit tests. Tested indirectly through useMessageActions tests and integration. Non-blocking.

### Phase 3: Snap Messages (3 items)

- **Stale test assertion:** `functions/__tests__/snapFunctions.test.js` line 522 asserts `expect(data.type).toBe('direct_message')` — should be `'snap'`. Test is actively failing. Single-line fix needed.
- **INFRA-03 deferred:** Firestore TTL policy on messages collection `expiresAt` field documented but not configured in Firebase console. App functions correctly without it; `cleanupExpiredSnaps` CF provides fallback cleanup.
- **INFRA-04 deferred:** Firebase Storage lifecycle rule on `snap-photos/` path documented but not configured in GCS console. App functions correctly without it; `onSnapViewed` CF provides immediate cleanup.

### Phase 4: Snap Streaks (1 item, info only)

- **Variable naming:** `hoursSinceLastMutual` divides by `DAY_MS`, so value represents days not hours. Logic is correct — naming is misleading but benign.

**Total:** 5 items across 3 phases. None are production blockers.

---

## Human Verification Items (Aggregated)

Across all 5 phases, the following items require device testing:

| #   | Phase | Test                                             | Status  |
| --- | ----- | ------------------------------------------------ | ------- |
| 1   | 1     | Delivered fade-in animation (250ms)              | Pending |
| 2   | 1     | Delivered→Read crossfade transition              | Pending |
| 3   | 1     | Mutual read receipt privacy model                | Pending |
| 4   | 2     | Double-tap heart reaction gesture                | Pending |
| 5   | 2     | Long-press ReactionPicker overlay positioning    | Pending |
| 6   | 2     | Swipe-right reply gesture threshold              | Pending |
| 7   | 2     | Reply mini-bubble rendering + scroll-to-original | Pending |
| 8   | 2     | Unsend real-time propagation to both users       | Pending |
| 9   | 2     | Delete-for-me PixelConfirmDialog                 | Pending |
| 10  | 2     | Reaction push notification with emoji            | Pending |
| 11  | 3     | Full snap flow (capture → send → view → opened)  | Pending |
| 12  | 3     | Snap notification auto-open                      | Pending |
| 13  | 3     | Snap reaction bar (recipient only)               | Pending |
| 14  | 3     | EXIF/orientation cross-platform                  | Pending |
| 15  | 4     | Visual streak icon states (5 states)             | Pending |
| 16  | 4     | End-to-end streak trigger with two accounts      | Pending |
| 17  | 4     | Streak warning toggle persistence                | Pending |
| 18  | 5     | Tagged photo card transparent styling            | Pending |
| 19  | 5     | Add-to-feed PixelSpinner                         | Pending |
| 20  | 5     | Tagged photo card tap → PhotoDetail              | Pending |
| 21  | 5     | Attribution tap → profile above PhotoDetail      | Pending |
| 22  | 5     | Tagged photo push notification routing           | Pending |

---

_Audited: 2026-02-25T17:00:00Z_
_Auditor: Claude (milestone-audit)_
